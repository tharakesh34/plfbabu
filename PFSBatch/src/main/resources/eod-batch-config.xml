<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:lang="http://www.springframework.org/schema/lang" xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang.xsd
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/batch
        http://www.springframework.org/schema/batch/spring-batch-3.0.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd">

	<context:component-scan base-package="com.pennant, com.pennanttech" />

	<import resource="launch-context.xml" />
	<import resource="eod-batch-config-db.xml" />
	<import resource="eod-batch-config-beans.xml" />
	<import resource="eod-batch-config-tasklet.xml" />
	<import resource="eod-batch-config-service.xml" />
	<import resource="interfaceBatchContext.xml" />

	<!-- _____________________________________________ JOB FLOW DEFINITION _________________________________________ -->
	<!-- The job definition for the PLF End of Day -->
	<job id="plfEodJob" xmlns="http://www.springframework.org/schema/batch" incrementer="PFSJobParametersIncrementer">
		<listeners>
			<listener ref="eodJobListener" />
		</listeners>

		<step id="beforeEOD">
			<tasklet ref="beforeEODTaskLet" />
			<next on="*" to="loanCancel" />
			<fail on="FAILED" />
		</step>

		<step id="loanCancel">
			<tasklet ref="loanCancelTaskLet" />
			<next on="*" to="prepareCustomerQueue" />
			<fail on="FAILED" />
		</step>

		<step id="prepareCustomerQueue">
			<tasklet ref="prepareCustomerQueueTaskLet" />
			<next on="*" to="masterStep" />
			<fail on="FAILED" />
		</step>

		<step id="masterStep">
			<partition step="microEOD" partitioner="partitioningMaster">
				<handler task-executor="taskExecutor" />
			</partition>
			<next on="*" to="processInActiveFinances" />
			<fail on="FAILED" />
		</step>

		<step id="processInActiveFinances">
			<tasklet ref="processInActiveFinancesTaskLet" />
			<next on="*" to="prepareCustomerGroupQueue" />
			<fail on="FAILED" />
		</step>
		<step id="prepareCustomerGroupQueue">
			<tasklet ref="prepareCustomerGroupQueueTaskLet" />
			<next on="*" to="limitCustomerGroupsUpdate" />
			<fail on="FAILED" />
		</step>
		<step id="limitCustomerGroupsUpdate">
			<tasklet ref="limitCustomerGroupsUpdateTaskLet">
				<transaction-attributes propagation="NEVER" />
			</tasklet>
			<next on="*" to="institutionLimitUpdate" />
			<fail on="FAILED" />
		</step>
		<step id="institutionLimitUpdate">
			<tasklet ref="institutionLimitUpdateTaskLet" />
			<next on="*" to="limitsUpdate" />
			<fail on="FAILED" />
		</step>
		<step id="limitsUpdate">
			<tasklet ref="limitsUpdateTaskLet" />
			<next on="*" to="datesUpdate" />
			<fail on="FAILED" />
		</step>
		<step id="datesUpdate">
			<tasklet ref="datesUpdateTaskLet" />
			<next on="*" to="snapShotPreparation" />
			<fail on="FAILED" />
		</step>
		<step id="snapShotPreparation">
			<tasklet ref="snapShotPreparationTaskLet" />
			<next on="*" to="dmsRetrieveProcess" />
			<fail on="FAILED" />
		</step>

		<step id="dmsRetrieveProcess">
			<tasklet ref="dmsRetrieveProcessTaskLet" />
			<next on="*" to="gstDownload" />
			<fail on="FAILED" />
		</step>
		<step id="gstDownload">
			<tasklet ref="gSTDownloadTaskLet" />
			<next on="*" to="ledgerDownLoad" />
			<fail on="FAILED" />
		</step>
		<step id="ledgerDownLoad">
			<tasklet ref="ledgerDownloadTaskLet" />
			<next on="*" to="ledgerNotification" />
			<fail on="FAILED" />
		</step>
		<step id="ledgerNotification">
			<tasklet ref="ledgerNotificationTaskLet" />
			<fail on="FAILED" />
			<next on="*" to="collectionDataDownLoad" />
		</step>

		<step id="collectionDataDownLoad">
			<tasklet ref="collectionDataDownLoadTaskLet" />
			<fail on="FAILED" />
			<next on="*" to="collectionNotification" />
		</step>
		<step id="collectionNotification">
			<tasklet ref="collectionNotificationTaskLet" />
			<fail on="FAILED" />
			<next on="*" to="loadCollateralRevaluationData" />
		</step>
		<step id="loadCollateralRevaluationData">
			<tasklet ref="loadCollateralRevaluationDataTaskLet" />
			<next on="*" to="collateralRevaluation" />
			<fail on="FAILED" />
		</step>
		<step id="collateralRevaluation">
			<tasklet>
				<chunk reader="collateralRevaluationItemReader" processor="collateralRevaluationProcessor" writer="collateralRevaluationItemWriter"
					commit-interval="10" />
			</tasklet>
			<next on="*" to="autoKnockOffProcess" />
			<fail on="FAILED" />
		</step>
		<step id="autoKnockOffProcess">
			<tasklet ref="loadAutoKnockOffProcessTasklet" />
			<next on="*" to="autoKnockOffProcessRender" />
			<fail on="FAILED" />
		</step>
		<step id="autoKnockOffProcessRender">
			<tasklet>
				<chunk reader="autoKnockOffProcessItemReader" processor="autoKnockOffProcessor" writer="autoKnockOffProcessItemWriter"
					commit-interval="10" />
			</tasklet>
			<next on="*" to="customerDataPreperation" />
			<fail on="FAILED" />
		</step>
		<step id="customerDataPreperation">
			<tasklet ref="customerDataPreperationTaskLet" />
			<next on="*" to="masterDataPreparation" />
			<fail on="FAILED" />
		</step>

		<step id="masterDataPreparation">
			<tasklet ref="masterDataPreparationTaskLet" />
			<next on="*" to="endOfMonthDecider" />
			<fail on="FAILED" />
		</step>

		<decision id="endOfMonthDecider" decider="endOfMonthDecider">
			<next on="EndOfMonth" to="retailcibil" />
			<end on="NotEndOfMonth" exit-code="COMPLETED" />
			<fail on="FAILED" />
		</decision>
		<step id="retailcibil">
			<tasklet ref="retailcibilTaskLet" />
			<next on="*" to="corporatecibil" />
			<fail on="FAILED" />
		</step>
		<step id="corporatecibil">
			<tasklet ref="corporatecibilTaskLet" />
			<fail on="FAILED" />
			<end on="*" exit-code="COMPLETED" />
		</step>
	</job>
	<step id="microEOD" xmlns="http://www.springframework.org/schema/batch">
		<tasklet ref="microEODTaskLet" allow-start-if-complete="true">
			<transaction-attributes propagation="NEVER" />
		</tasklet>
	</step>

	<bean id="taskExecutor" class="org.springframework.core.task.SimpleAsyncTaskExecutor">
		<constructor-arg value="PLF_EOD_THREAD_" />
		<property name="ConcurrencyLimit" value="100" />
	</bean>

	<bean id="partitioningMaster" class="com.pennant.backend.endofday.tasklet.PartitioningMaster" />
</beans>