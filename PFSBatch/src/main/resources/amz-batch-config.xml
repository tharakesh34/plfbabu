<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:lang="http://www.springframework.org/schema/lang" xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang.xsd
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/batch
        http://www.springframework.org/schema/batch/spring-batch-3.0.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd">

	<context:component-scan base-package="com.pennant, com.pennanttech" />

	<import resource="launch-context.xml" />
	<import resource="eod-batch-config-db.xml" />
	<import resource="classpath:applicationContext-db.xml" />
	<import resource="classpath:applicationContext-jdbc.xml" />

	<!-- Error Details -->
	<bean id="errorDetailDAO" class="com.pennant.backend.dao.errordetail.impl.ErrorDetailDAOImpl" parent="basicDao" />

	<!-- _____________________________________________ JOB FLOW DEFINITION _________________________________________ -->

	<!-- The job definition for the PLF Amortization -->
	<job id="plfAMZJob" xmlns="http://www.springframework.org/schema/batch" incrementer="PFSJobParametersIncrementer">

		<listeners>
			<listener ref="amzJobListener" />
		</listeners>

		<step id="beforeAMZProcess">
			<tasklet ref="beforeAMZProcessTaskLet" />
			<next on="*" to="prepareIncomeAMZDetails" />
			<fail on="FAILED" />
		</step>

		<step id="prepareIncomeAMZDetails">
			<tasklet ref="prepareIncomeAMZDetailsTaskLet" />
			<next on="*" to="prepareAmortizationQueue" />
			<fail on="FAILED" />
		</step>

		<step id="prepareAmortizationQueue">
			<tasklet ref="prepareAmortizationQueueTaskLet" />
			<next on="*" to="amzMasterStep" />
			<fail on="FAILED" />
		</step>

		<step id="amzMasterStep">
			<partition step="amzProcess" partitioner="partitioningMasterAmortization">
				<handler task-executor="taskExecutor" />
			</partition>
			<next on="*" to="afterAMZProcess" />
			<fail on="FAILED" />
		</step>

		<step id="afterAMZProcess">
			<tasklet ref="afterAMZProcessTaskLet" />
			<end on="*" exit-code="COMPLETED" />
			<fail on="FAILED" />
		</step>

	</job>

	<bean id="amzJobListener" class="com.pennant.backend.batch.listeners.AMZJobListener" />

	<bean id="PFSJobParametersIncrementer" class="com.pennant.backend.endofday.jobparameter.PFSJobParametersIncrementer" />

	<step id="amzProcess" xmlns="http://www.springframework.org/schema/batch">
		<tasklet ref="amzProcessTaskLet" allow-start-if-complete="true">
			<transaction-attributes propagation="NEVER" />
		</tasklet>
	</step>

	<bean id="taskExecutor" class="org.springframework.core.task.SimpleAsyncTaskExecutor">
		<property name="ConcurrencyLimit" value="100" />
	</bean>

	<!-- Partitioning Master -->
	<bean id="partitioningMasterAmortization" class="com.pennant.backend.endofday.tasklet.PartitioningMasterAmortization" />

	<!-- TaskLets -->
	<bean id="beforeAMZProcessTaskLet" class="com.pennant.backend.endofday.tasklet.BeforeAMZProcess" />
	<bean id="prepareIncomeAMZDetailsTaskLet" class="com.pennant.backend.endofday.tasklet.PrepareIncomeAMZDetails" />
	<bean id="prepareAmortizationQueueTaskLet" class="com.pennant.backend.endofday.tasklet.PrepareAmortizationQueue" />
	<bean id="amzProcessTaskLet" class="com.pennant.backend.endofday.tasklet.AMZProcess" />
	<bean id="afterAMZProcessTaskLet" class="com.pennant.backend.endofday.tasklet.AfterAMZProcess" />

	<!-- Services -->

	<!-- ProjectedAmortizationService -->
	<bean id="projectedAmortizationService" class="com.pennant.app.core.ProjectedAmortizationService">
		<property name="financeMainDAO" ref="financeMainDAO" />
		<property name="profitDetailsDAO" ref="profitDetailsDAO" />
		<property name="finFeeDetailDAO" ref="finFeeDetailDAO" />
		<property name="manualAdviseDAO" ref="manualAdviseDAO" />
		<property name="finExpenseDetailsDAO" ref="finExpenseDetailsDAO" />
		<property name="projectedAmortizationDAO" ref="projectedAmortizationDAO" />
		<property name="ruleExecutionUtil" ref="ruleExecutionUtil" />
	</bean>

	<!-- Beans -->

	<bean name="ruleExecutionUtil" class="com.pennant.app.util.RuleExecutionUtil">
		<property name="scriptEngine" ref="scriptEngine" />
		<property name="globalVariableService" ref="globalVariableService" />
	</bean>
	<bean name="globalVariableService" class="com.pennant.backend.service.finance.globalvariable.GlobalVariableServiceImpl">
		<property name="pFSParameterDAO" ref="pFSParameterDAO" />
	</bean>

	<bean id="projectedAmortizationDAO" class="com.pennant.backend.dao.amortization.impl.ProjectedAmortizationDAOImpl"
		parent="sequenceDao" />

	<bean id="financeMainDAO" class="com.pennant.backend.dao.finance.impl.FinanceMainDAOImpl" parent="basicDao" />

	<bean id="profitDetailsDAO" class="com.pennant.backend.dao.finance.impl.FinanceProfitDetailDAOImpl" parent="basicDao" />

	<bean id="finFeeDetailDAO" class="com.pennant.backend.dao.finance.impl.FinFeeDetailDAOImpl" parent="sequenceDao" />

	<bean id="finExpenseDetailsDAO" class="com.pennant.backend.dao.finance.impl.FinExpenseDetailsDAOImpl" parent="sequenceDao" />

	<bean id="manualAdviseDAO" class="com.pennant.backend.dao.finance.impl.ManualAdviseDAOImpl" parent="sequenceDao" />

	<!-- Helpers -->

	<bean id="scriptEngine" class="javax.script.ScriptEngine" factory-method="getEngineByName" factory-bean="scriptEngineManager">
		<constructor-arg value="javascript" />
	</bean>

	<bean id="scriptEngineManager" class="javax.script.ScriptEngineManager" />

	<bean name="errorDetailService" class="com.pennant.backend.service.errordetail.impl.ErrorDetailServiceImpl" />
	<bean id="primaryAccountDAO" class="com.pennanttech.pff.external.pan.dao.impl.PrimaryAccountDAOImpl" parent="basicDao" />
</beans>