<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />

	<changeSet id="1" author="Prasad">
		<dropTable tableName="DataMart_Stage_Mapping"
			cascadeConstraints="true" />
		<createTable tableName="DataMart_Stage_Mapping">
			<column name="FieldType" type="varchar(100)" />
			<column name="FieldCode" type="varchar(100)" />
			<column name="FieldCodeValue_char" type="varchar(50)" />
			<column name="FieldCodeValue_Num" type="bigint"></column>
		</createTable>
	</changeSet>
	<changeSet id="2" author="Prasad">
		<sql>
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','ADDDBSN','6',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','ADDDBSP','A',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','AMZ','U',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','DEFRPY','F',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','DISBINS','M',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','EARLYPAY','F',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','EARLYSTL','T',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','EMIDAY','F',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','FEEPAY','E',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','INSTDATE','I',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','LATEPAY','E',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','PAYMTINS','M',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','RATCHG','F',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','REAGING','F',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','REPAY','E',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','SCDCHG','F',null);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Event','WRITEOFF','H',null);

			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','OTHERS',null,1);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','CURRES',null,2);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','RESIOFF',null,3);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','OFFICE',null,4);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','PER',null,5);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','ALTRESI',null,6);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','REGADD',null,7);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','PROPADR',null,8);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','SNA',null,9);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','FRD',null,10);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','GRT',null,11);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','MAL',null,12);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','NTC',null,13);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','PAR',null,14);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','REL',null,15);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','VRG',null,16);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','PREVRES',null,17);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','HEADOFF',null,18);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','PREVOFF',null,19);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','AUTHSIGN',null,20);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','BUS',null,21);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','COH',null,22);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','DLR',null,23);
			Insert into DATAMART_STAGE_MAPPING
			(FIELDTYPE,FIELDCODE,FIELDCODEVALUE_CHAR,FIELDCODEVALUE_NUM) values
			('Address','BRAD',null,24);
		</sql>
	</changeSet>
	<changeSet id="3" author="Prasad">
		<createView viewName="DM_LOANWISE_CHARGE_DTLS_VIEW"
			replaceIfExists="true">
  SELECT ${call.substr}(T1.FINREFERENCE,9,LENGTH(T1.FINREFERENCE))  AGREEMENTID,M.ADVISEID TXNADVICEID,
  Coalesce(M.FEETYPEID,m.bounceid) CHARGEID,NULL CHARGECODEID,coalesce(F.FEETYPEDESC,b.reason) CHARGEDESC,M.ADVISEAMOUNT/CCYMINORCCYUNITS CHARGEAMT,NULL STATUS,
		NULL AMTINPROCESS,M.PAIDAMOUNT/CCYMINORCCYUNITS TXNADJUSTEDAMT,
    M.ADVISEAMOUNT/CCYMINORCCYUNITS ADVICEAMT,M.POSTDATE ADVICEDATE,NULL BUSINESSDATE,
		NULL  PROCESSDATE,'N' PROCESSED_FLAG,'' SEGMENT,NULL BATCH_ID
		FROM FINPFTDETAILS T1
		INNER JOIN FINANCEMAIN T2 ON T1.FINREFERENCE=T2.FINREFERENCE
    INNER JOIN (Select FINREFERENCE,'01'${call.concatenate}FeeId ADVISEID,FEETYPEID,
           (ActualAmount-waivedAmount)ADVISEAMOUNT,PAIDAMOUNT,POSTDATE,null bounceid from finfeedetail 
           where FEETYPEID>0 union all
    Select FINREFERENCE,'02'${call.concatenate}ADVISEID,FEETYPEID,ADVISEAMOUNT,PAIDAMOUNT,POSTDATE,bounceid
    from MANUALADVISE) M ON M.FINREFERENCE=T1.FINREFERENCE
	INNER JOIN RMTCURRENCIES RC ON RC.CCYCODE= T1.FINCCY
    LEFT JOIN FEETYPES F ON F.FEETYPEID = M.FEETYPEID 	
    left join bouncereasons b on b.bounceid = m.bounceid
    WHERE ${call.substr}(T1.FINREFERENCE,9,LENGTH(T1.FINREFERENCE)) IS NOT NULL
	</createView>
	</changeSet>

	<changeSet id="4" author="Prasad">
		<createView viewName="DM_DISB_DETAILS_DAILY_VIEW"
			replaceIfExists="true">
  <![CDATA[SELECT T2.FINAPPROVEDDATE AGREEMENTDATE,${call.substr}(T2.FINREFERENCE,9,LENGTH(T2.FINREFERENCE)) APPLID,T2.FINREFERENCE AGREEMENTNO,
		T3.DISBSEQ DISBURSEMENTNO,T3.DISBDATE DISBURSEMENTDATE,NULL PARENT_AGREEMENTNO,
		T2.FINAMOUNT/CCYMINORCCYUNITS  AMTFIN,(T2.FINAMOUNT - T2.DOWNPAYMENT + T2.FEECHARGEAMT)/CCYMINORCCYUNITS  NET_AMTFIN,
		T7.DISBAMOUNT/CCYMINORCCYUNITS  DISBURSEDAMT,
		CASE WHEN T2.FINASSETVALUE=T2.FINCURRASSETVALUE THEN 'FULLY DISBURSED' ELSE 'PARTIALLY DISBURSED' END DISB_STATUS,
		T1.FIRSTREPAYDATE FIRST_DUE_DATE,ROUND(MONTHS_BETWEEN( T2.MATURITYDATE,T2.FINSTARTDATE)) GROSS_TENURE,T1.NOINST NET_TENURE,
		T2.MATURITYDATE MATURITYDATE,T2.LASTREPAYDATE EXPIRYDATE,NULL NO_OF_ADV_INSTL,
		NULL ADV_EMI_AMT,T2.FIRSTREPAY EMI,T2.FINREPAYMETHOD REPAYMENT_MODE,
		T2.FINTYPE PRODUCTFLAG,P.PROMOTIONID PROMOTIONID,NULL ICICI_LOMBARD,
		NULL BAGIC,NULL BALIC_CHARGES,
		NULL BUSINESSDATE,
		'N' PROCESSED_FLAG,
		NULL PROCESS_DATE,
		NULL SEGMENTS,T9.TOTALFEE/CCYMINORCCYUNITS FEE,NULL DEALER_SUBV,NULL MANU_SUBV_DED,NULL MANU_SUBV_NDED,
		T2.BPIAMOUNT/CCYMINORCCYUNITS PREEMI,
		NULL EXISTING_LANNO,NULL MORTGAGE_FEE,NULL COMMITMENT_FEE,T10.PROCES_FEE/CCYMINORCCYUNITS  PROCESSING_FEE,
		NULL PRE_EMI_RECEIVABLE,T2.INSURANCEAMT/CCYMINORCCYUNITS INSURANCE,
		T2.FINREPAYMETHOD PAYMENTMODE,CASE when ${call.substr}(T2.REPAYFRQ,1,1)='Y' then 'A' else ${call.substr}(T2.REPAYFRQ,1,1) end FREQ,
		FA.LLREFERENCENO CHEQUENUM,${call.substr}(FA.BENEFICIARYACCNO,1,16)  CUST_ACCT_NO,T5.BANKNAME BANKNAME,T6.MICR MICRCODE,NULL BUSINESS_YEAR,
		NULL EMI_CHARGE,NULL PDC_CHARGE,CASE WHEN T2.EFFECTIVERATEOFRETURN>999 THEN 999 ELSE T2.EFFECTIVERATEOFRETURN END IRR_PER,
		T9.TOTALFEE/CCYMINORCCYUNITS FEE_WL,
		NULL ELC_CHARGE,NULL CREDIT_VIDYA_FEES,NULL BATCH_ID 
		FROM FINANCEMAIN T2 
		INNER JOIN FINPFTDETAILS T1 ON T1.FINREFERENCE=T2.FINREFERENCE
		INNER JOIN FINDISBURSEMENTDETAILS T3 ON T3.FINREFERENCE=T2.FINREFERENCE
		INNER JOIN RMTFINANCETYPES T4 ON T4.FINTYPE=T2.FINTYPE
		LEFT JOIN BANKBRANCHES T6 ON T6.BRANCHCODE=T2.FINBRANCH 
		LEFT JOIN BMTBANKDETAIL T5 ON T5.BANKCODE=T6.BANKCODE
		LEFT JOIN PROMOTIONS P ON P.PROMOTIONCODE = T2.PROMOTIONCODE
		INNER JOIN RMTCURRENCIES RC ON RC.CCYCODE=T2.FINCCY
		LEFT JOIN (SELECT FINREFERENCE,SUM(DISBAMOUNT) DISBAMOUNT
		FROM FINDISBURSEMENTDETAILS
		WHERE DISBDATE<=(SELECT TO_DATE(SYSPARMVALUE, 'YYYY-MM-DD')  SYSPARMVALUE FROM SMTPARAMETERS WHERE SYSPARMCODE='APP_DATE')
		GROUP BY FINREFERENCE)T7 ON T7.FINREFERENCE=T2.FINREFERENCE
		LEFT JOIN (SELECT FINREFERENCE,SUM(BALANCEAMT)BALANCEAMT FROM FINEXCESSAMOUNT 
		WHERE AMOUNTTYPE = 'A' GROUP BY FINREFERENCE)T8 ON T8.FINREFERENCE=T2.FINREFERENCE
		LEFT JOIN (SELECT FINREFERENCE,SUM(ACTUALAMOUNT-WAIVEDAMOUNT)TOTALFEE FROM FINFEEDETAIL
		GROUP BY FINREFERENCE)T9 ON T9.FINREFERENCE=T2.FINREFERENCE
		LEFT JOIN (SELECT FINREFERENCE,SUM(ACTUALAMOUNT-WAIVEDAMOUNT)PROCES_FEE 
		FROM FINFEEDETAIL F 
		INNER JOIN FEETYPES FT ON F.FEETYPEID = FT.FEETYPEID
		WHERE FT.FEETYPECODE='PROCFEE'
		GROUP BY FINREFERENCE)T10 ON T10.FINREFERENCE=T2.FINREFERENCE
		LEFT JOIN (SELECT FA.FINREFERENCE,FA.BENEFICIARYACCNO,FA.LLREFERENCENO FROM (
		SELECT FINREFERENCE,MAX(PAYMENTSEQ) MAXPAYMENTSEQ FROM FINADVANCEPAYMENTS
		GROUP BY FINREFERENCE)T INNER JOIN FINADVANCEPAYMENTS FA ON FA.FINREFERENCE=T.FINREFERENCE AND FA.PAYMENTSEQ = T.MAXPAYMENTSEQ)FA ON FA.FINREFERENCE=T2.FINREFERENCE]]>
		</createView>
	</changeSet>

	<changeSet id="5" author="Prasad">
		<createView viewName="DM_APPLICANT_DETAILS_VIEW"
			replaceIfExists="true">
  SELECT DISTINCT T1.CUSTID CUSTOMERID,
		CASE WHEN FP.CUSTID IS NOT NULL THEN 'APPLICANT' WHEN FJ.CUSTCIF IS NOT NULL THEN 'CO APPLICANT' WHEN FG.GUARANTORCIF IS NOT NULL THEN 'GUARANTEER' ELSE 'APPLICANT' 

END CUST_TYPE,T1.CUSTCRCPR PANNO, CUSTADDRHNBR ADDRESS1,T2.CUSTFLATNBR ADDRESS2,CUSTADDRSTREET ADDRESS3,CUSTADDRLINE1 ADDRESS4,CUSTADDRCITY CITY,CUSTADDRPROVINCE 

STATE,CUSTADDRCOUNTRY COUNTRY,CUSTADDRZIP ZIPCODE,CUSTADDRTYPE ADDRESSTYPE,CUSTEMAIL EMAIL,T41.PHONENUMBER PHONE1,T42.PHONENUMBER PHONE2,T4.PHONENUMBER 

MOBILE,T5.PHONENUMBER FAX,CASE WHEN T1.CUSTCOREBANK IS NULL THEN 'N' ELSE 'Y' END EXISTING_CUST_FLAG,
		CASE WHEN CUSTCTGCODE='RETAIL' THEN 'I' ELSE 'C' END INDIV_CORP_FLAG,ROUND(MONTHS_BETWEEN( (SELECT TO_DATE(SYSPARMVALUE, 'YYYY-MM-DD')  SYSPARMVALUE FROM 

SMTPARAMETERS WHERE SYSPARMCODE='APP_DATE'),T1.CUSTDOB)/12) AGE,CUSTDOB DOB,CUSTFNAME FNAME,CUSTMNAME MNAME,CUSTLNAME LNAME,GENDERDESC GENDER,CUSTMARITALSTS 

MARITAL_STATUS,NOOFDEPENDENTS NO_OF_DEPENDENT,ROUND(MONTHS_BETWEEN( (SELECT TO_DATE(SYSPARMVALUE, 'YYYY-MM-DD')  SYSPARMVALUE FROM SMTPARAMETERS WHERE 

SYSPARMCODE='APP_DATE'),T7.CUSTEMPFROM)/12) YEARS_CURRENT_JOB,NULL YEARS_PREV_JOB,NULL QUALIFICATION,NULL RESIDENCETYPE,NULL YEARS_CURR_RESI,E.EMPNAME EMPLOYER_DESC,NULL 

COMPANY_TYPE,T1.CUSTINDUSTRY INDUSTRYID,NULL NATURE_OF_BUSINESS,T7.CUSTEMPTYPE EMPLOYMENT_TYPE,T7.CUSTEMPDESG EMPDESG,NULL OCCUPATION,${add.schema}UDF_CONVERTCURRENCY

(T1.CUSTTOTALINCOME,'INR','INR')  ANNUAL_INCOME,NULL GUARDIAN,
		NULL BUSINESSDATE,'N' PROCESSED_FLAG,NULL PROCESS_DATE,NULL SEGMENTS,CUSTSHRTNAME CUSTOMERNAME,NULL CONTACT_PERSON_NAME,T1.custtypecode CONSTITUTION,BBD.BANKCODE 

CUST_BANK_NAME,NULL CUST_BANK_BRANCH,NULL EMI_CARD_LIMIT,NULL EMI_CARD_ACCEPT_FLAG,NULL EMI_CARD_SWIPE_FLAG,NULL EMI_CARD_ELIG,NULL EMI_CARD_NO,NULL BANK_ECS_MANDATE,CASE 

WHEN M.CUSTID IS NOT NULL THEN 'Y' ELSE 'N' END OPEN_ECS_AVLB,M.STARTDATE OPEN_ECS_DATE,(SELECT EXTRACT(YEAR FROM (TO_DATE(SYSPARMVALUE, 'YYYY-MM-DD')))  SYSPARMVALUE FROM 

SMTPARAMETERS WHERE SYSPARMCODE='APP_DATE') BUSINESS_YEAR,
		CUSTSALUTATIONCODE TITLE,CUSTEMPNAME COMP_NAME,CUSTEMPFROM  YEARS_CURR_JOB,NULL GRADE,NULL FAMILY_CODE,NULL MINOR,NULL GUARDIAN_NEW,CUSTCRCPR UCIN_NO,NULL 

PREFERRED_ELIGIBILITY,NULL PREFERRED_CARD_ACCEPTANCE,NULL PREFERRED_CARD_LIMIT,CUSTDFTBRANCH CUST_BRANCHID,NULL BATCH_ID 
		FROM CUSTOMERS T1 
		LEFT JOIN CUSTOMERADDRESSES T2 ON T1.CUSTID=T2.CUSTID AND CUSTADDRPRIORITY=5
		LEFT JOIN CUSTOMEREMAILS T3 ON T3.CUSTID=T1.CUSTID AND CUSTEMAILPRIORITY=5
		LEFT JOIN CUSTOMERPHONENUMBERS T41 ON T41.PHONECUSTID=T1.CUSTID AND T41.PHONETYPEPRIORITY=5
		LEFT JOIN CUSTOMERPHONENUMBERS T42 ON T42.PHONECUSTID=T1.CUSTID AND T42.PHONETYPEPRIORITY=4
		LEFT JOIN CUSTOMERPHONENUMBERS T4 ON T4.PHONECUSTID=T1.CUSTID AND T4.PHONETYPECODE ='MOBILE'
		LEFT JOIN CUSTOMERPHONENUMBERS T5 ON T5.PHONECUSTID=T1.CUSTID AND T5.PHONETYPECODE= 'FAX'
		LEFT JOIN BMTGENDERS T6 ON T6.GENDERCODE=T1.CUSTGENDERCODE
		LEFT JOIN CUSTOMEREMPDETAILS T7 ON T7.CUSTID = T1.CUSTID AND CURRENTEMPLOYER=1
		LEFT JOIN (SELECT DISTINCT CUSTID FROM FINPFTDETAILS) FP ON FP.CUSTID = T1.CUSTID 
		LEFT JOIN (SELECT DISTINCT CUSTCIF FROM  FINJOINTACCOUNTDETAILS FJ) FJ ON FJ.CUSTCIF = T1.CUSTCIF AND FJ.CUSTCIF  IS NOT NULL
		LEFT JOIN (SELECT DISTINCT GUARANTORCIF FROM FINGUARANTORSDETAILS )FG ON FG.GUARANTORCIF = T1.CUSTCIF AND FG.GUARANTORCIF  IS NOT NULL
		LEFT JOIN EMPLOYERDETAIL E ON E.EMPLOYERID = T7.CUSTEMPNAME
		LEFT JOIN (SELECT CUSTID,MAX(STARTDATE)STARTDATE FROM MANDATES M WHERE OPENMANDATE=1  AND MANDATETYPE='ECS' GROUP BY CUSTID)M ON M.CUSTID = T1.CUSTID
		LEFT JOIN (SELECT B.CUSTID,B.BANKBRANCHID FROM (
		SELECT CUSTID,MAX(LASTMNTON)LASTMNTON 
		FROM BENEFICIARY GROUP BY CUSTID )T  INNER JOIN BENEFICIARY B ON B.CUSTID=T.CUSTID AND B.LASTMNTON=T.LASTMNTON) B ON B.CUSTID =T1.CUSTID
		LEFT JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = B.BANKBRANCHID
		LEFT JOIN BMTBANKDETAIL BBD ON BBD.BANKCODE =BB.BANKCODE
		</createView>
	</changeSet>

	<changeSet id="6" author="Prasad">
		<createView viewName="DM_LOAN_DETAILS_DAILY_VIEW"
			replaceIfExists="true">
  SELECT ${call.substr}(T1.FINREFERENCE,9,LENGTH(T1.FINREFERENCE)) APPLID,T1.FINREFERENCE AGREEMENTNO,T3.CUSTID CUSTOMERID,
		EFFECTIVERATEOFRETURN CUSTOMER_YIELD,
		CASE WHEN T1.FINISACTIVE =1 THEN 'ACTIVE' WHEN T1.CLOSINGSTATUS='C' 
		THEN 'CANCELLED' ELSE 'CLOSED' END STATUS,T4.NPABUCKETID NPA_STAGE,NULL LMS_BUCKET,
		NULL COLL_BUCKET,NULL INSURANCE_APPLIED_FLG,
		NULL BUSINESSDATE,
		'N' PROCESSED_FLAG,NULL PROCESS_DATE,
		'LMS-DII' SEGMENTS,T1.MATURITYDATE CLOSUREDATE,
		NULL TOPUP_AMT,(SELECT EXTRACT(YEAR FROM (TO_DATE(SYSPARMVALUE, 'YYYY-MM-DD')))SYSPARMVALUE FROM SMTPARAMETERS WHERE SYSPARMCODE='APP_DATE') BUSINESS_YEAR,
		M.MANDATEID PDCID,NULL PCFLAG,
		CASE WHEN T1.PRODUCTCATEGORY='ODFCLITY' THEN 'Y' ELSE 'N' END OD_FLAG,
		T1.REPAYMARGIN MARGIN,T1.REPAYSPECIALRATE SPECIALMARGIN,NULL FIXEDTENOR,
		NULL CEEFFECTIVEDATE,T1.REPAYPROFITRATE EFF_RATE,T2.CURREDUCINGRATE PLRRATE,NULL PARTY_CODE,
		COALESCE(T3.CUSTFNAME,'')${call.concatenate}' '${call.concatenate}COALESCE(T3.CUSTMNAME,'')${call.concatenate}' '${call.concatenate}COALESCE(T3.CUSTLNAME,'') PARTY_NAME,
		NULL ZONE,NULL COLLECTION_CENTRE,NULL VIRTUAL_ACCOUNT_NUMBER,
		CASE WHEN T1.schedulemethod='EQUAL' and T1.stepfinance=0 then 'E'
    WHEN T1.schedulemethod='PFT' then 'T'
    WHEN T1.schedulemethod='PRI_PFT' and T1.stepfinance=0 then 'P'
    WHEN T1.schedulemethod='EQUAL' and T1.stepfinance=1 then 'G'
    WHEN T1.schedulemethod='PRI_PFT' and T1.stepfinance=1 then 'R' END INSTALLMENT_TYPE,NULL COMPANYTYPE,
		T1.TOTALPROFIT/CCYMINORCCYUNITS FIANANCE_CHARGES,T1.APPLICATIONNO FILENO,NULL NO_OF_PDCS,
		T9.VasFeeAmt/CCYMINORCCYUNITS LIFEINSURANCE,T6.REMAININGFEE/CCYMINORCCYUNITS SHORTRECEIVED,T3.CUSTSHRTNAME IN_FAVOUR_OFF,NULL MKTGID,
		T7.BALANCEAMT/CCYMINORCCYUNITS PRE_EMI_INT_500071,NULL LOAN_PURPOSE_DTL,NULL LOAN_PURPOSE_DESC,
		T8.TOT_FEE/CCYMINORCCYUNITS LOGIN_FEES,NULL VC_REFERRAL_CD,NULL VC_REFERRAL_NAME,
		NULL PROC_FEES2,T1.FINREPAYMETHOD INSTRUMENT_TYPE,NULL LAN_BARCODE,T1.FINSTARTDATE INTSTART_DATE_REGULAR,
		T1.BPIAMOUNT/CCYMINORCCYUNITS  BPI_RECEIVABLE,NULL BPI_PAYABLE,
		CASE WHEN M.OPENMANDATE=1 THEN 'Y' ELSE 'N' END OPEN_FACILITY_FLAG,NULL BATCH_ID 
		FROM FINANCEMAIN T1
		INNER JOIN FINPFTDETAILS T2 ON T1.FINREFERENCE=T2.FINREFERENCE
		INNER JOIN CUSTOMERS T3 ON T3.CUSTID=T1.CUSTID
		INNER JOIN RMTCURRENCIES RC ON RC.CCYCODE= T2.FINCCY
		LEFT JOIN FINPROVISIONS T4 ON T4.FINREFERENCE=T1.FINREFERENCE
		LEFT JOIN MANDATES M ON M.ORGREFERENCE =T1.FINREFERENCE AND M.MANDATEID = T1.MANDATEID
		LEFT JOIN (SELECT T1.FINREFERENCE , SUM(REMAININGFEE)REMAININGFEE FROM FINFEEDETAIL T1
		WHERE FEESCHEDULEMETHOD = 'DISB'
		GROUP BY T1.FINREFERENCE) T6 ON T1.FINREFERENCE=T6.FINREFERENCE
		LEFT JOIN (SELECT T1.FINREFERENCE , SUM(BALANCEAMT)BALANCEAMT FROM FINEXCESSAMOUNT T1
		WHERE AMOUNTTYPE = 'A' 
		GROUP BY T1.FINREFERENCE) T7 ON T1.FINREFERENCE=T7.FINREFERENCE
		LEFT JOIN (SELECT T1.FINREFERENCE , SUM(ACTUALAMOUNT-WAIVEDAMOUNT)TOT_FEE FROM FINFEEDETAIL T1
		GROUP BY T1.FINREFERENCE) T8 ON T1.FINREFERENCE=T8.FINREFERENCE
    LEFT JOIN (Select T1.Finreference,SUM(ActualAmount-WaivedAmount)VasFeeAmt from finfeedetail T1 
    Left join feetypes T2 on T1.Feetypeid = T2.Feetypeid
    Left join VasRecording T4 on T1.VasReference = T4.VasReference group by T1.Finreference)T9 ON T1.FINREFERENCE=T9.FINREFERENCE
	</createView>
	</changeSet>

	<changeSet id="7" author="Prasad">
		<createView viewName="DM_LOAN_VOUCHER_DETAILS_VIEW"
			replaceIfExists="true">
  SELECT NULL MODULEID,Case when DSM.FIELDCODEVALUE_char is not null then DSM.FIELDCODEVALUE_char else 'X' end STAGEID,
  P.LINKEDTRANID ${call.concatenate} '-'${call.concatenate}TRANSORDER LEA_VOUCHERID,NULL FA_VOUCHERID,
    Case when DSM.FIELDCODEVALUE_char is not null then DSM.FIELDCODEVALUE_char else 'X' end VOUCHERTYPE,P.POSTDATE VOUCHERDATE,P.VALUEDATE VALUEDATE,RB.BANKREFNO BRANCHID,RB.BRANCHCODE BRANCH_CODE,
    RB.BRANCHDESC BRANCHDESC,RCP.BUSINESSAREA BUSINESS_AREA,AM.PROFITCENTERID PROFIT_CENTRE,FM.FINTYPE PRODUCT_FLAG,
    NULL SCHEMEID,PM.PROMOTIONDESC SCHEMEDESC,NULL ASSIGNMENT,${call.substr}(FM.FINREFERENCE,9,
    LENGTH(FM.FINREFERENCE)) AGREEMENTID,FM.FINREFERENCE AGREEMENTNO,FM.FINAPPROVEDDATE AGREEMENTDATE,
    FP.FIRSTDISBDATE DISBURSALDATE,FM.FINISACTIVE LOAN_STATUS,FPR.NPABUCKETID NPA_STAGEID,
    ${call.substr}(P.ACCOUNT,1,12) FINNONE_GLID,AT.ACTYPEDESC GROUPGLDESC,AM.HOSTACCOUNT SAPGL_CODE,
    AM.COSTCENTERID COST_CENTRE,
    COALESCE(CASE WHEN P.DRORCR='D' THEN P.POSTAMOUNT END,0) DRAMT,
    COALESCE(CASE WHEN P.DRORCR='C' THEN P.POSTAMOUNT END,0) CRAMT,
    P.DRORCR DRCR_FLAG,P.POSTAMOUNT DRCR_AMT,P.TRANDESC NARRATION,
    NULL CHEQUEID,
    NULL BUSINESSDATE,
    NULL PROCESSDATE,
    NULL SEGMENT,'N' PROCESSED_FLAG,NULL BATCH_ID
    FROM POSTINGS P 
    INNER JOIN FINANCEMAIN FM ON FM.FINREFERENCE=P.FINREFERENCE
    INNER JOIN FINPFTDETAILS FP ON FM.FINREFERENCE=FP.FINREFERENCE
    INNER JOIN RMTBRANCHES RB ON RB.BRANCHCODE = FM.FINBRANCH
    LEFT JOIN RMTCOUNTRYVSPROVINCE RCP ON RCP.CPPROVINCE = RB.BRANCHPROVINCE
    INNER JOIN ACCOUNTMAPPING AM  ON AM.ACCOUNT = P.ACCOUNT
    INNER JOIN RMTACCOUNTTYPES AT   ON AT.ACTYPE = AM.ACCOUNTTYPE
    LEFT JOIN PROMOTIONS PM ON PM.PROMOTIONCODE = FM.PROMOTIONCODE
    LEFT JOIN FINPROVISIONS FPR ON FPR.FINREFERENCE = FM.PROMOTIONCODE
    LEFT JOIN DataMart_Stage_Mapping DSM on DSM.FieldCode = P.FINEVENT and DSM.FieldType='Event'
	</createView>
	</changeSet>


	<changeSet id="8" author="Prasad">
		<createView viewName="DM_ADDRESS_DETAILS_VIEW"
			replaceIfExists="true">
  SELECT T7.FIELDCODEVALUE_NUM ADDRESSID,
		T1.CUSTID CUSTOMERID,T1.CUSTADDRPROVINCE STATEID,NULL REGIONID,T1.CUSTADDRCITY CITY,
		T2.PHONENUMBER STDISD,T1.CUSTADDRPRIORITY MAILINGADDRESS,CUSTADDRHNBR ADDRESS1,
		CUSTADDRSTREET ADDRESS2,CUSTADDRSTREET ADDRESS3,
		CUSTADDRZIP ZIPCODE,01 COUNTRY,CUSTADDRTYPE ADDRESSTYPE,
		NULL APPLICANT_TYPE,T3.PHONENUMBER PHONE1,T4.PHONENUMBER PHONE2,T5.PHONENUMBER MOBILE,
		CUSTEMAIL EMAIL,NULL BUSINESSDATE,
		'N' PROCESSFLAG,NULL PROCESS_DATE,
		NULL AREA,NULL LANDMARK,NULL BUSINESS_YEAR,NULL BATCH_ID 
		FROM CUSTOMERADDRESSES T1
		INNER JOIN CUSTOMERS T2 ON T1.CUSTID=T2.CUSTID 
		LEFT JOIN CUSTOMERPHONENUMBERS T3 ON T3.PHONECUSTID=T1.CUSTID AND T3.PHONETYPEPRIORITY=5
		LEFT JOIN CUSTOMERPHONENUMBERS T4 ON T4.PHONECUSTID=T1.CUSTID AND T4.PHONETYPEPRIORITY=4
		LEFT JOIN CUSTOMERPHONENUMBERS T5 ON T5.PHONECUSTID=T1.CUSTID AND T5.PHONETYPECODE ='MOBILE'
		LEFT JOIN CUSTOMEREMAILS T6 ON T6.CUSTID=T1.CUSTID AND CUSTEMAILPRIORITY=5
    Left join DATAMART_STAGE_MAPPING T7 on T7.FIELDCODE = T1.CustAddrtype and FIELDTYPE='Address'
	</createView>
	</changeSet>

	<changeSet id="9" author="Prasad">
		<createView viewName="RPT_TransactionEntry_Report"
			replaceIfExists="true">
  Select Loan_Ref,TxnDate,Particlulars,TxnAmount,Event,Ordby,ccyMinorccyunits,ccyEditField from (
  Select finreference Loan_Ref, finApprovedDate TxnDate,'Disbursed Amount' Particlulars,finamount TxnAmount,'ADDDISB' Event,1 Ordby
  from financemain T1 where finamount!=0
  union all
  Select T2.finreference, T2.lastmnton,FeeTypeDesc, ActualAmount-waivedamount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where ActualAmount-waivedamount!=0
  union all
   Select T1.Finreference,T1.lastmnton,'Payment to customer vide '${call.concatenate}PaymentType,
    AmtToBeReleased,'DISBINS' Event,3 Ordby
    from FINADVANCEPAYMENTS T1 inner join Financemain T2 on T2.Finreference = T1.Finreference
    where (Status!='CANCELED' or Status is null) and AmtToBeReleased!=0
  union all
  Select REFERENCE,T1.lastmnton,'Receipt',Amount,'REPAY' Event,4 Ordby
		from FINRECEIPTHEADER T1 inner join 
			 FINRECEIPTDETAIL T2 on T1.RECEIPTID =T2.RECEIPTID 	
       Where (T1.ReceiptModeStatus Not IN ('C') or T1.ReceiptModeStatus is null)
       and PAYMENTTYPE NOT in ('EXCESS') and T1.lastmnton is not null and Amount!=0
       	)T1  inner join finpftdetails t2 on t2.Finreference=t1.Loan_Ref
	 inner join RMTCURRENCIES C on C.ccycode= T2.finccy where (TxnAmount!=0 )
	 </createView>
	</changeSet>

	<changeSet id="10" author="pruthvi">
		<sql>
			delete from REPORTFILTERFIELDS where reportid=(select reportid from
			reportconfiguration where
			menuitemcode='menu_Item_TransactionEntryReport');
			delete from reportconfiguration where
			menuitemcode='menu_Item_TransactionEntryReport';


			Insert into REPORTCONFIGURATION
			values ((select max(reportid)+1 from reportconfiguration),'Transaction
			Entry','Transaction
			Entry',1,'TransactionEntryReport','pfsDatasource',1,'menu_Item_TransactionEntryReport',4,1000,null,null,null,null,null,null,0,current_timestamp,1,1);

			Insert into REPORTFILTERFIELDS values
			((select reportid from reportconfiguration where
			menuitemcode='menu_Item_TransactionEntryReport'),1,'Transaction
			Date','DATE','Transaction
			Date','txndate','---Select----',null,null,null,0,0,0,0,1,1,null,null,null,null,250,0,'=',3,1000,'Approved',null,null,null,null,null,0,current_timestamp,'');
		</sql>
	</changeSet>
	<changeSet id="11" author="Prasad">
		<createView viewName="RPT_TRANSACTIONENTRY_REPORT"
			replaceIfExists="true">
	        Select Loan_Ref,TxnDate,Particlulars,TxnAmount,Event,Ordby,ccyMinorccyunits,ccyEditField from (
  Select finreference Loan_Ref, finApprovedDate TxnDate,'Disbursed Amount' Particlulars,finamount TxnAmount,'ADDDISB' Event,1 Ordby
  from financemain T1 where finamount!=0
  union all
  Select T2.finreference, T2.lastmnton,feetypedesc${call.concatenate}' Deduct from Disbursement Amount', ActualAmount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where ActualAmount!=0 and FeeSchedulemethod='DISB'
   union all
  Select T2.finreference, T2.lastmnton,feetypedesc${call.concatenate}' Add to Loan Amount ', ActualAmount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where ActualAmount!=0 and FeeSchedulemethod='POSP'
      union all
  Select T2.finreference, T2.lastmnton,feetypedesc${call.concatenate}' Schedule to First Installment Amount', ActualAmount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where ActualAmount!=0 and FeeSchedulemethod='STFI'
       union all
  Select T2.finreference, T2.lastmnton,feetypedesc${call.concatenate}' Schedule to Entire Tenor', ActualAmount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where ActualAmount!=0 and FeeSchedulemethod='STET'
        union all
  Select T2.finreference, T2.lastmnton,feetypedesc${call.concatenate}' Schedule to N Terms', ActualAmount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where ActualAmount!=0 and FeeSchedulemethod='STNI'
          union all
  Select T2.finreference, T2.lastmnton,feetypedesc${call.concatenate}' Paid Amount', PaidAmount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where PaidAmount!=0 and FeeSchedulemethod='PBCU'
                union all
  Select T2.finreference, T2.lastmnton,feetypedesc${call.concatenate}' Waived', WaivedAmount, Finevent,2 Ordby
  from financemain T1 inner join 
       finfeedetail T2 on T1.finreference =T2.Finreference
       inner join feetypes T3 on T2.Feetypeid = T3.Feetypeid
      where WaivedAmount!=0 and FeeSchedulemethod='WVEB'   
  
  union all
   Select T1.Finreference,T1.lastmnton,'Payment to customer vide '${call.concatenate}PaymentType,
    AmtToBeReleased,'DISBINS' Event,3 Ordby
    from FINADVANCEPAYMENTS T1 inner join Financemain T2 on T2.Finreference = T1.Finreference
    where (Status!='CANCELED' or Status is null) and AmtToBeReleased!=0
  union all
  Select REFERENCE,T1.lastmnton,'Receipt',Amount,'REPAY' Event,4 Ordby
		from FINRECEIPTHEADER T1 inner join 
			 FINRECEIPTDETAIL T2 on T1.RECEIPTID =T2.RECEIPTID 	
       Where (T1.ReceiptModeStatus Not IN ('C') or T1.ReceiptModeStatus is null)
       and PAYMENTTYPE NOT in ('EXCESS') and T1.lastmnton is not null and Amount!=0
       	)T1  inner join finpftdetails t2 on t2.Finreference=t1.Loan_Ref
	 inner join RMTCURRENCIES C on C.ccycode= T2.finccy where (TxnAmount!=0 )
	    </createView>
	</changeSet>
</databaseChangeLog>