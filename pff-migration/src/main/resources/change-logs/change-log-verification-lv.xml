<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />

	<changeSet id="pre_run_for_pgp" author="Jayant" runAlways="true"
		dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>
	 
	<changeSet id="1.0" author="Durgaprasad G">
		<createTable tableName="verification_lv">
			<column name="Id" type="bigint">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_ID"/>
			</column>
			<column name="VerificationID" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="VerificationFormName" type="varchar(30)"/>
			<column name="AgentCode" type="varchar(20)" />
			<column name="AgentName" type="varchar(50)" />
			<column name="Status" type="int" defaultValue="0"/>
			<column name="Reason" type="bigint" />
			<column name="Remarks" type="varchar(500)" />
			<column name="Date" type="datetime" />	
			<column name="Version" type="int">
				<constraints nullable="false" />
			</column>
			<column name="LastMntBy" type="bigint" />
			<column name="LastMntOn" type="datetime" />
			<column name="RecordStatus" type="varchar(50)" />
			<column name="RoleCode" type="varchar(100)" />
			<column name="NextRoleCode" type="varchar(200)" />
			<column name="TaskId" type="varchar(50)" />
			<column name="NextTaskId" type="varchar(200)" />
			<column name="RecordType" type="varchar(50)" />
			<column name="WorkflowId" type="bigint" />
		</createTable>
	</changeSet>
	
	<changeSet id="1.1" author="Durgaprasad G">
		<createTable tableName="verification_lv_temp">
			<column name="Id" type="bigint">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_TEMP_ID"/>
			</column>
			<column name="VerificationID" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="VerificationFormName" type="varchar(30)"/>
			<column name="AgentCode" type="varchar(20)" />
			<column name="AgentName" type="varchar(50)" />
			<column name="Status" type="int" defaultValue="0"/>
			<column name="Reason" type="bigint" />
			<column name="Remarks" type="varchar(500)" />
			<column name="Date" type="datetime" />
	
			<column name="Version" type="int">
				<constraints nullable="false" />
			</column>
			<column name="LastMntBy" type="bigint" />
			<column name="LastMntOn" type="datetime" />
			<column name="RecordStatus" type="varchar(50)" />
			<column name="RoleCode" type="varchar(100)" />
			<column name="NextRoleCode" type="varchar(200)" />
			<column name="TaskId" type="varchar(50)" />
			<column name="NextTaskId" type="varchar(200)" />
			<column name="RecordType" type="varchar(50)" />
			<column name="WorkflowId" type="bigint" />
		</createTable>
	</changeSet>
	
	<changeSet id="1.2" author="Durgaprasad G">
		<createTable tableName="verification_lv_stage">
			<column name="Id" type="bigint" autoIncrement="true" startWith="1">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_STAGE_ID"/>
			</column>
			<column name="VerificationID" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="VerificationFormName" type="varchar(30)"/>
			<column name="AgentCode" type="varchar(20)" />
			<column name="AgentName" type="varchar(50)" />
			<column name="Status" type="int" defaultValue="0"/>
			<column name="Reason" type="bigint" />
			<column name="Remarks" type="varchar(500)" />
			<column name="Date" type="datetime" />
	
			<column name="Version" type="int">
				<constraints nullable="false" />
			</column>
			<column name="LastMntBy" type="bigint" />
			<column name="LastMntOn" type="datetime" />
			<column name="RecordStatus" type="varchar(50)" />
			<column name="RoleCode" type="varchar(100)" />
			<column name="NextRoleCode" type="varchar(200)" />
			<column name="TaskId" type="varchar(50)" />
			<column name="NextTaskId" type="varchar(200)" />
			<column name="RecordType" type="varchar(50)" />
			<column name="WorkflowId" type="bigint" />
		</createTable>
	</changeSet>
	
	<changeSet id="2.0" author="Durgaprasad G">
		<createTable tableName="verification_lv_details">
			<column name="LvId" type="bigint">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_DET"/>
			</column>
			<column name="seqno" type="int">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_DET"/>
			</column>
			<column name="DocumentId" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="DocumentSubId" type="varchar(50)"/>
			<column name="Remarks1" type="varchar(500)" />
			<column name="Remarks2" type="varchar(500)" />
			<column name="Remarks3" type="varchar(500)" />
			<column name="Version" type="int">
				<constraints nullable="false" />
			</column>
			<column name="LastMntBy" type="bigint" />
			<column name="LastMntOn" type="datetime" />
			<column name="RecordStatus" type="varchar(50)" />
			<column name="RoleCode" type="varchar(100)" />
			<column name="NextRoleCode" type="varchar(200)" />
			<column name="TaskId" type="varchar(50)" />
			<column name="NextTaskId" type="varchar(200)" />
			<column name="RecordType" type="varchar(50)" />
			<column name="WorkflowId" type="bigint" />
		</createTable>
	</changeSet>
	
	<changeSet id="2.1" author="Durgaprasad G">
		<createTable tableName="verification_lv_details_temp">
			<column name="LvId" type="bigint" >
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_DET_T"/>
			</column>
			<column name="seqno" type="int">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_DET_T"/>
			</column>
			<column name="DocumentId" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="DocumentSubId" type="varchar(50)"/>
			<column name="Remarks1" type="varchar(500)" />
			<column name="Remarks2" type="varchar(500)" />
			<column name="Remarks3" type="varchar(500)" />
	
			<column name="Version" type="int">
				<constraints nullable="false" />
			</column>
			<column name="LastMntBy" type="bigint" />
			<column name="LastMntOn" type="datetime" />
			<column name="RecordStatus" type="varchar(50)" />
			<column name="RoleCode" type="varchar(100)" />
			<column name="NextRoleCode" type="varchar(200)" />
			<column name="TaskId" type="varchar(50)" />
			<column name="NextTaskId" type="varchar(200)" />
			<column name="RecordType" type="varchar(50)" />
			<column name="WorkflowId" type="bigint" />
		</createTable>
	</changeSet>
	
	<changeSet id="2.2" author="Durgaprasad G">
		<createTable tableName="verification_lv_details_stage">
			<column name="LvId" type="bigint">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_DET_S"/>
			</column>
			<column name="seqno" type="int">
				<constraints nullable="false" primaryKey="true" primaryKeyName="PK_VERIFICATION_LV_DET_S"/>
			</column>
			<column name="DocumentId" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="DocumentSubId" type="varchar(50)"/>
			<column name="Remarks1" type="varchar(500)" />
			<column name="Remarks2" type="varchar(500)" />
			<column name="Remarks3" type="varchar(500)" />
	
			<column name="Version" type="int">
				<constraints nullable="false" />
			</column>
			<column name="LastMntBy" type="bigint" />
			<column name="LastMntOn" type="datetime" />
			<column name="RecordStatus" type="varchar(50)" />
			<column name="RoleCode" type="varchar(100)" />
			<column name="NextRoleCode" type="varchar(200)" />
			<column name="TaskId" type="varchar(50)" />
			<column name="NextTaskId" type="varchar(200)" />
			<column name="RecordType" type="varchar(50)" />
			<column name="WorkflowId" type="bigint" />
		</createTable>
	</changeSet>
	
	<changeSet id="2.3" author="Durgaprasad G">
		<addForeignKeyConstraint constraintName="fk_verf_det_lvid" referencedTableName="verification_lv" baseColumnNames="LvId" baseTableName="verification_lv_details" referencedColumnNames="Id"/>
		<addForeignKeyConstraint constraintName="fk_verf_det_temp_lvid" referencedTableName="verification_lv_temp" baseColumnNames="LvId" baseTableName="verification_lv_details_temp" referencedColumnNames="Id"/>
		<addForeignKeyConstraint constraintName="fk_verf_det_stage_lvid" referencedTableName="verification_lv_stage" baseColumnNames="LvId" baseTableName="verification_lv_details_stage" referencedColumnNames="Id"/>
		
		<addForeignKeyConstraint constraintName="fk_verification_lv_verid" referencedTableName="verifications" baseColumnNames="VerificationId" baseTableName="verification_lv" referencedColumnNames="Id"/>
		<addForeignKeyConstraint constraintName="fk_verification_lv_temp_verid" referencedTableName="verifications" baseColumnNames="VerificationId" baseTableName="verification_lv_temp" referencedColumnNames="Id"/>
		<addForeignKeyConstraint constraintName="fk_verification_lv_stage_verid" referencedTableName="verifications" baseColumnNames="VerificationId" baseTableName="verification_lv_stage" referencedColumnNames="Id"/>
	</changeSet>
	
	<changeSet id="3.0" author="Durgaprasad G">
		<createView viewName="verification_lv_view" replaceIfExists="true">	
			select  * from (
			select 
				lv.Id, 
				lv.verificationId,  
				lvd.documentId,
				lvd.documentSubId,
				lv.VerificationFormName,			
				lv.agentcode,  
				lv.agentname, 
				lv.date, 
				lv.status,
				lv.reason, 
				r1.code as reasoncode, 
				r1.description as reasondesc, 
				lv.version, 
				lv.lastmntby, 
				lv.lastmnton, 
				lv.recordstatus, 
				lv.rolecode, 
				lv.nextrolecode,
				lv.taskid, 
				lv.nexttaskid, 
				lv.recordtype, 
				lv.workflowid, 
				lv.Remarks,  
				c.custcif as cif,
				v.keyreference, 
				v.referenceFor, 
				v.createdon, 
				v.agency,
				c.custId, 
				c.custcif, 
				c.custshrtname as custname,
				cs.collateralType,
				a.dealerName agencyName
			from verification_lv_temp lv
			inner join verification_lv_details_temp lvd on lvd.lvid = lv.id
			inner join verifications v on v.id = lv.verificationId
			inner join customers c on c.custCif = v.reference
			inner join collateralsetup cs on cs.collateralref = v.referenceFor
			left join reasons_aview r1 on r1.id = lv.reason
			left join amtvehicledealer a on a.dealerid = v.agency
			union all 
			 select 
				lv.Id, 
				lv.verificationId,  
				lvd.documentId,
				lvd.documentSubId,
				lv.VerificationFormName,			
				lv.agentcode,  
				lv.agentname, 
				lv.date, 
				lv.status,
				lv.reason, 
				r1.code as reasoncode, 
				r1.description as reasondesc, 
				lv.version, 
				lv.lastmntby, 
				lv.lastmnton, 
				lv.recordstatus, 
				lv.rolecode, 
				lv.nextrolecode,
				lv.taskid, 
				lv.nexttaskid, 
				lv.recordtype, 
				lv.workflowid, 
				lv.Remarks,  
				c.custcif as cif,
				v.keyreference, 
				v.referenceFor, 
				v.createdon, 
				v.agency,
				c.custId, 
				c.custcif, 
				c.custshrtname as custname,
				cs.collateralType,
				a.dealerName agencyName
			from verification_lv lv
			inner join verification_lv_details lvd on lvd.lvid = lv.id
			inner join verifications v on v.id = lv.verificationId
			inner join customers c on c.custCif = v.reference
			inner join collateralsetup cs on cs.collateralref = v.referenceFor
			left join reasons_aview r1 on r1.id = lv.reason
			left join amtvehicledealer a on a.dealerid = v.agency
			 where not (exists ( select 1 from verification_lv_temp where verification_lv_temp.id = lv.id))
			) t
		 </createView>
	</changeSet>
	<changeSet id="4.0" author="durgaprasad.g">
		<createView viewName="verification_legal_doc_view" replaceIfExists="true">	
			select * from ( select dt.lvreq , 3 docType, dt.doctypecode code, dt.doctypedesc description,  c.custCIF, fm.FinReference, c.custid DocumentId, dd.custdoccategory DocumentSubId, custDocName DocName, '' collateralRef from Financemain_temp fm
			inner join customers c on c.custId = fm.custId
			inner join customerDocuments_view dd on dd.custId = c.custId
			inner join bmtdocumenttypes dt on dt.doctypecode = dd.custdoccategory
			union all
			select dt.lvreq, 2 docType, dt.doctypecode code, dt.doctypedesc description, c.custCIF, fm.FinReference, docid DocumentId, '' DocumentSubId, DocName, '' collateralRef  from Financemain_temp fm
			inner join customers c on c.custId = fm.custId
			inner join documentDetails_view dd on dd.ReferenceId = fm.FinReference
			inner join bmtdocumenttypes dt on dt.doctypecode = dd.doccategory
			union all 
			select dt.lvreq, 1 docType, dt.doctypecode code, dt.doctypedesc description, c.custCIF, fm.FinReference, docid DocumentId, '' DocumentSubId, DocName, cs.collateralRef from Financemain_temp fm
			inner join customers c on c.custId = fm.custId
			inner join collateralsetup cs on cs.depositorId = c.custId
			inner join documentDetails_view dd on dd.ReferenceId = cs.collateralRef
			inner join bmtdocumenttypes dt on dt.doctypecode = dd.doccategory
			) T 
		</createView>
	</changeSet>
	<changeSet id="4.1" author="durgaprasad.g">
		<createView viewName="verification_lv_details_view" replaceIfExists="true">	
			select * from (
			select 
			lvd.lvid, 
			lvd.SeqNo, 
			doc.docType, 
    		doc.docModule, 
			doccategory docName, 
			dt.doctypecode code,
			dt.doctypedesc description,
			lvd.documentid,
			doc.docRefId,  
			lvd.DocumentSubId, 
			lvd.Remarks1, 
			lvd.Remarks2, 
			lvd.Remarks3,
			lvd.version,
            lvd.lastmntby,
            lvd.lastmnton,
            lvd.recordstatus,
            lvd.rolecode,
            lvd.nextrolecode,
            lvd.taskid,
            lvd.nexttaskid,
            lvd.recordtype,
            lvd.workflowid 
			from verification_lv_details_temp lvd
			inner join documentdetails_view doc on doc.docid = lvd.documentid
			inner join bmtdocumenttypes dt on dt.doctypecode = doc.doccategory
			union all
			select 
			lvd.lvid, 
			lvd.SeqNo, 
			doc.docType, 
    		doc.docModule,
			doccategory docName,
			dt.doctypecode code,
			dt.doctypedesc description, 
			lvd.documentid,
			doc.docRefId, 
			lvd.DocumentSubId, 
			lvd.Remarks1, 
			lvd.Remarks2, 
			lvd.Remarks3,
			lvd.version,
            lvd.lastmntby,
            lvd.lastmnton,
            lvd.recordstatus,
            lvd.rolecode,
            lvd.nextrolecode,
            lvd.taskid,
            lvd.nexttaskid,
            lvd.recordtype,
            lvd.workflowid 
			from verification_lv_details lvd
			inner join verification_lv lv on lv.id = lvd.lvid
			inner join documentdetails_view doc on doc.docid = lvd.documentid
			inner join bmtdocumenttypes dt on dt.doctypecode = doc.doccategory
			WHERE NOT (EXISTS ( SELECT 1
					   FROM verification_lv_details_temp
					  WHERE verification_lv_details_temp.lvid = lvd.lvid))
			union all
			select 
			lvd.lvid, 
			lvd.SeqNo, 
			custdocType docType, 
    		'Customer' docModule,
			custdoccategory docName,
			dt.doctypecode code,
			dt.doctypedesc description, 
			lvd.documentid, 
			doc.docRefId,
			lvd.DocumentSubId, 
			lvd.Remarks1, 
			lvd.Remarks2, 
			lvd.Remarks3,
			lvd.version,
            lvd.lastmntby,
            lvd.lastmnton,
            lvd.recordstatus,
            lvd.rolecode,
            lvd.nextrolecode,
            lvd.taskid,
            lvd.nexttaskid,
            lvd.recordtype,
            lvd.workflowid 
			from verification_lv_details_temp lvd
			inner join customerdocuments_view doc on doc.custid = lvd.documentid and doc.custdoccategory = lvd.DocumentSubId
			inner join bmtdocumenttypes dt on dt.doctypecode = doc.custdoccategory
			union all
			select 
			lvd.lvid, 
			lvd.SeqNo, 
			custdocType docType,
    		'Customer' docModule,
			custdoccategory docName, 
			dt.doctypecode code,
			dt.doctypedesc description,
			lvd.documentid, 
			doc.docRefId,
			lvd.DocumentSubId, 
			lvd.Remarks1, 
			lvd.Remarks2, 
			lvd.Remarks3,
			lvd.version,
            lvd.lastmntby,
            lvd.lastmnton,
            lvd.recordstatus,
            lvd.rolecode,
            lvd.nextrolecode,
            lvd.taskid,
            lvd.nexttaskid,
            lvd.recordtype,
            lvd.workflowid  
			from verification_lv_details_temp lvd
			inner join customerdocuments_view doc on doc.custid = lvd.documentid and doc.custdoccategory = lvd.DocumentSubId
			inner join bmtdocumenttypes dt on dt.doctypecode = doc.custdoccategory
			WHERE NOT (EXISTS ( SELECT 1
					  FROM verification_lv_details_temp
					  WHERE verification_lv_details_temp.lvid = lvd.lvid))
			) t
		</createView>
	</changeSet>
	<changeSet id="5.0" author="manikanta.p">
		<sql>
			<![CDATA[
			delete from  LimitCodeDetail where LimitCode = 'LVINIT';
			delete from  LimitCodeDetail where LimitCode = 'LVAPPR';
	
			INSERT INTO limitcodedetail VALUES ((select max(limitid)+1 from limitcodedetail),'LVINIT','Legal Verification Initiation',1);
			INSERT INTO limitcodedetail VALUES ((select max(limitid)+1 from limitcodedetail),'LVAPPR','Legal Verification Approval',1);
			]]>
		</sql>
	</changeSet>
</databaseChangeLog>
 