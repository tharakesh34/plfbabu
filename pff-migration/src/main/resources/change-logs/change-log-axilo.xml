<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="add.schema" value=" " dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />

	<changeSet id="pre_run_for_pgp" author="Jayant" runAlways="true" dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>

	<changeSet id="1" author="murthy.y">
		<comment>Map the PAYMENT_DETAIL3 with DebitAccount Number, this view is on top of core version 14.11.0</comment>
		<createView viewName="INT_DISBURSEMENT_REQUEST_VIEW" replaceIfExists="true">
			SELECT FA. PAYMENTID,
				   FA.FINREFERENCE,
				   'D' CHANNEL, 
				   CASE WHEN FA.PAYMENTTYPE = 'NEFT' THEN 'N' WHEN FA.PAYMENTTYPE = 'RTGS' THEN 'R' WHEN FA.PAYMENTTYPE = 'DD' THEN 'D' WHEN FA.PAYMENTTYPE = 'CHEQUE' THEN 'C' ELSE  FA.PAYMENTTYPE END  DISBURSEMENT_TYPE,
				   FA.AMTTOBERELEASED/CCY.CCYMINORCCYUNITS  AMTTOBERELEASED,
				   FA.DISBDATE,
	               FA.LLDATE,
				   FA.PAYABLELOC,
				   FA.PRINTINGLOC,
				   CU.CUSTCIF,            
				   CU.CUSTSHRTNAME,     
				   '' AS CUSTOMER_MOBILE,
				   CE.CUSTEMAIL       CUSTOMER_EMAIL,
				   CS.CPPROVINCENAME  CUSTOMER_STATE,
				   CC.PCCITYNAME      CUSTOMER_CITY,
				   ''                 CUSTOMER_ADDRESS1,
				   ''                 CUSTOMER_ADDRESS2,
				   ''                 CUSTOMER_ADDRESS3,
				   ''                 CUSTOMER_ADDRESS4,
				   ''                 CUSTOMER_ADDRESS5,
	              BD.BANKNAME BANKNAME,
	              BB.BRANCHCODE,
	              BB.BRANCHDESC BRANCHDESC,
				  PBD.CPPROVINCENAME  BENFICIARY_BRANCH_STATE,
				  PBD.PCCITYNAME      BENFICIARY_BRANCH_CITY,
				   BB.MICR             MICR_CODE,
				   BB.IFSC             IFSC_CODE,
				   FA.BENEFICIARYACCNO,
				   CASE WHEN FA.PAYMENTTYPE = 'CHEQUE' OR  FA.PAYMENTTYPE = 'DD' THEN FA.LIABILITYHOLDNAME ELSE FA.BENEFICIARYNAME END BENEFICIARYNAME,
				   FA.PHONECOUNTRYCODE||FA.PHONEAREACODE||FA.PHONENUMBER AS BENEFICIARY_MOBILE, 
				   BCE.CUSTEMAIL        BENFICIRY_EMAIL,
				   BRS.CPPROVINCENAME  BENFICIARY_STATE,
				   BRC.PCCITYNAME      BENFICIARY_CITY,
				   ''                  BENFICIARY_ADDRESS1,
				   ''                  BENFICIARY_ADDRESS2,
				   ''                  BENFICIARY_ADDRESS3,
				   ''                  BENFICIARY_ADDRESS4,
				   ''                  BENFICIARY_ADDRESS5,
				   ''				           PAYMENT_DETAIL1,
				   ''                  PAYMENT_DETAIL2,
				   PB.ACCOUNTNO        PAYMENT_DETAIL3,
				   ''                  PAYMENT_DETAIL4,
				   ''                  PAYMENT_DETAIL5,
				   ''                  PAYMENT_DETAIL6,
				   ''                  PAYMENT_DETAIL7,     
				   FA.STATUS           STATUS,
				   FA.DESCRIPTION      REMARKS,
				     FA.PAYMENTTYPE      PAYMENTTYPE,
				     FM.FINTYPE,
				     PB.PARTNERBANKID,
				     PB.PARTNERBANKCODE,
				     FA.INPUTDATE,
				     PB.ALWFILEDOWNLOAD,
	                PB.FILENAME,
				     FM.FINISACTIVE,
					 SMD.ENTITYCODE
				   FROM FINADVANCEPAYMENTS FA
				   INNER JOIN (select CUSTID, FINREFERENCE, FINTYPE,  FINISACTIVE from financemain union all select CUSTID, FINREFERENCE, FINTYPE,  FINISACTIVE from financemain_temp where QUICKDISB=1) FM on FM.FINREFERENCE = FA.FINREFERENCE
				   INNER JOIN CUSTOMERS CU ON CU.CUSTID = FM.CUSTID
				   INNER JOIN RMTCURRENCIES CCY ON CCY.CCYCODE = FA.DISBCCY
        		   INNER JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = FA.PARTNERBANKID
				   LEFT JOIN CUSTOMEREMAILS CE ON CE.CUSTID = CU.CUSTID AND CE.CUSTEMAILPRIORITY = 5
				   LEFT JOIN CUSTOMERADDRESSES CA ON CA.CUSTID = CE.CUSTID AND CA.CUSTADDRPRIORITY = 5
				   LEFT JOIN RMTPROVINCEVSCITY CC ON CC.PCCITY = CA.CUSTADDRCITY
				   LEFT JOIN RMTCOUNTRYVSPROVINCE CS ON CS.CPPROVINCE = CC.PCPROVINCE  
				   LEFT JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = FA.BANKBRANCHID
				   LEFT JOIN BMTBANKDETAIL BD ON BD.BANKCODE = BB.BANKCODE
	         	   LEFT JOIN  (select PB.PARTNERBANKID, PBD.BANKNAME, PBB.BRANCHDESC, PBBRC.PCCITYNAME, PBBRS.CPPROVINCENAME from PARTNERBANKS PB INNER JOIN BANKBRANCHES PBB ON PBB.BRANCHCODE = PB.BANKBRANCHCODE INNER JOIN BMTBANKDETAIL PBD ON PBD.BANKCODE = PBB.BANKCODE LEFT JOIN RMTPROVINCEVSCITY PBBRC ON PBBRC.PCCITY = PBB.CITY LEFT JOIN RMTCOUNTRYVSPROVINCE PBBRS ON PBBRS.CPPROVINCE = PBBRC.PCPROVINCE ) PBD ON PBD.PARTNERBANKID = PB.PARTNERBANKID
				   LEFT JOIN BENEFICIARY BR ON BR.BANKBRANCHID = FA.BANKBRANCHID AND BR.ACCNUMBER = FA.BENEFICIARYACCNO AND BR.CUSTID = FM.CUSTID
				   LEFT JOIN CUSTOMERS BC ON BC.CUSTID = BR.CUSTID
				   LEFT JOIN CUSTOMEREMAILS BCE ON BCE.CUSTID = CU.CUSTID AND BCE.CUSTEMAILPRIORITY = 5
				   LEFT JOIN CUSTOMERADDRESSES BRCA ON BRCA.CUSTID = BR.CUSTID AND BRCA.CUSTADDRPRIORITY = 5
				   LEFT JOIN RMTPROVINCEVSCITY BRC ON BRC.PCCITY = BRCA.CUSTADDRCITY
				   LEFT JOIN RMTCOUNTRYVSPROVINCE BRS ON BRS.CPPROVINCE = BRC.PCPROVINCE
				   LEFT JOIN RMTFINANCETYPES RFT ON  FM.FINTYPE=RFT.FINTYPE
				   LEFT JOIN SMTDIVISIONDETAIL SMD ON RFT.FINDIVISION=SMD.DIVISIONCODE
				   WHERE STATUS='APPROVED' AND PAYMENTID NOT IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS) AND PB.PARTNERBANKCODE NOT IN('DUPBANK')
				   
				   UNION ALL
				   
				   SELECT PI. PAYMENTINSTRUCTIONID PAYMENTID,
				   PH.FINREFERENCE,
				   PH.PAYMENTTYPE CHANNEL, 
				   CASE WHEN PI.PAYMENTTYPE = 'NEFT' THEN 'N' WHEN PI.PAYMENTTYPE = 'RTGS' THEN 'R' WHEN PI.PAYMENTTYPE = 'DD' THEN 'D' WHEN PI.PAYMENTTYPE = 'CHEQUE' THEN 'C' ELSE  PI.PAYMENTTYPE END  DISBURSEMENT_TYPE,
				   PI.PAYMENTAMOUNT/CCY.CCYMINORCCYUNITS  AMTTOBERELEASED,
				   PI.POSTDATE DISBDATE, 
				   PI.POSTDATE LLDATE, 
				   PI.PAYABLELOC, 
				   PI.PRINTINGLOC, 
				   CU.CUSTCIF,            
				   CU.CUSTSHRTNAME,     
				   '' AS CUSTOMER_MOBILE,
				   CE.CUSTEMAIL       CUSTOMER_EMAIL,
				   CS.CPPROVINCENAME  CUSTOMER_STATE,
				   CC.PCCITYNAME      CUSTOMER_CITY,
				   ''                 CUSTOMER_ADDRESS1,
				   ''                 CUSTOMER_ADDRESS2,
				   ''                 CUSTOMER_ADDRESS3,
				   ''                 CUSTOMER_ADDRESS4,
				   ''                 CUSTOMER_ADDRESS5,
				   BD.BANKNAME,
				   BB.BRANCHCODE,
				   BB.BRANCHDESC,
				   BBRS.CPPROVINCENAME  BENFICIARY_BRANCH_STATE,
				   BBRC.PCCITYNAME      BENFICIARY_BRANCH_CITY,
				   BB.MICR              MICR_CODE,
				   BB.IFSC              IFSC_CODE,
				   PI.ACCOUNTNO BENEFICIARYACCNO,
				   CASE WHEN PI.PAYMENTTYPE = 'CHEQUE' OR  PI.PAYMENTTYPE = 'DD' THEN PI.FAVOURNAME ELSE PI.ACCTHOLDERNAME END BENEFICIARYNAME,
				   PI.PHONECOUNTRYCODE||PI.PHONENUMBER AS BENEFICIARY_MOBILE,
				   BCE.CUSTEMAIL       BENFICIRY_EMAIL,
				   BRS.CPPROVINCENAME  BENFICIARY_STATE,
				   BRC.PCCITYNAME      BENFICIARY_CITY,
				   ''                  BENFICIARY_ADDRESS1,
				   ''                  BENFICIARY_ADDRESS2,
				   ''                  BENFICIARY_ADDRESS3,
				   ''                  BENFICIARY_ADDRESS4,
				   ''                  BENFICIARY_ADDRESS5,
				   ''				           PAYMENT_DETAIL1,
				   ''                  PAYMENT_DETAIL2,
				   PB.ACCOUNTNO        PAYMENT_DETAIL3,
				   ''                  PAYMENT_DETAIL4,
				   ''                  PAYMENT_DETAIL5,
				   ''                  PAYMENT_DETAIL6,
				   ''                  PAYMENT_DETAIL7,     
				   PI.STATUS           STATUS, 
				   PI.REMARKS          REMARKS,
				   PI.PAYMENTTYPE      PAYMENTTYPE,
				   FM.FINTYPE,
				   PB.PARTNERBANKID,
				   PB.PARTNERBANKCODE,
				   PI.POSTDATE INPUTDATE, 
				   PB.ALWFILEDOWNLOAD,
				   PB.FILENAME,
				   FM.FINISACTIVE,
				    SMD.ENTITYCODE
				   FROM PAYMENTINSTRUCTIONS PI 
				   INNER JOIN PAYMENTHEADER PH ON PH.PAYMENTID = PI.PAYMENTID
				   INNER JOIN (select CUSTID, FINREFERENCE, FINTYPE,  FINISACTIVE from financemain union all select CUSTID, FINREFERENCE, FINTYPE,  FINISACTIVE from financemain_temp where QUICKDISB=1) FM on FM.FINREFERENCE = PH.FINREFERENCE 
				   INNER JOIN CUSTOMERS CU ON CU.CUSTID = FM.CUSTID
				   INNER JOIN RMTCURRENCIES CCY ON CCY.CCYCODE = PI.PAYMENTCCY
				   INNER JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = PI.PARTNERBANKID
				   LEFT JOIN CUSTOMEREMAILS CE ON CE.CUSTID = CU.CUSTID AND CE.CUSTEMAILPRIORITY = 5
				   LEFT JOIN CUSTOMERADDRESSES CA ON CA.CUSTID = CE.CUSTID AND CA.CUSTADDRPRIORITY = 5
				   LEFT JOIN RMTPROVINCEVSCITY CC ON CC.PCCITY = CA.CUSTADDRCITY
				   LEFT JOIN RMTCOUNTRYVSPROVINCE CS ON CS.CPPROVINCE = CC.PCPROVINCE
				   LEFT JOIN CUSTOMERPHONENUMBERS CM ON CM.PHONECUSTID = CU.CUSTID AND CM.PHONETYPECODE = 'MOBILE1' AND CM.PHONETYPEPRIORITY = 5  
				   LEFT JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = PI.BANKBRANCHID
				   LEFT JOIN BMTBANKDETAIL BD ON BD.BANKCODE = BB.BANKCODE
				   LEFT JOIN RMTPROVINCEVSCITY BBRC ON BBRC.PCCITY = BB.CITY
				   LEFT JOIN RMTCOUNTRYVSPROVINCE BBRS ON BBRS.CPPROVINCE = BBRC.PCPROVINCE
				   LEFT JOIN BENEFICIARY BR ON BR.BANKBRANCHID = PI.BANKBRANCHID AND BR.ACCNUMBER = PI.ACCOUNTNO  AND BR.CUSTID = FM.CUSTID
				   LEFT JOIN CUSTOMERS BC ON BC.CUSTID = BR.CUSTID
				   LEFT JOIN CUSTOMEREMAILS BCE ON BCE.CUSTID = CU.CUSTID AND BCE.CUSTEMAILPRIORITY = 5
				   LEFT JOIN CUSTOMERADDRESSES BRCA ON BRCA.CUSTID = BR.CUSTID AND BRCA.CUSTADDRPRIORITY = 5
				   LEFT JOIN RMTPROVINCEVSCITY BRC ON BRC.PCCITY = BRCA.CUSTADDRCITY
				   LEFT JOIN RMTCOUNTRYVSPROVINCE BRS ON BRS.CPPROVINCE = BRC.PCPROVINCE
				    LEFT JOIN RMTFINANCETYPES RFT ON  FM.FINTYPE=RFT.FINTYPE
				   LEFT JOIN SMTDIVISIONDETAIL SMD ON RFT.FINDIVISION=SMD.DIVISIONCODE
				   WHERE PI.STATUS='APPROVED' AND PI.PAYMENTINSTRUCTIONID NOT IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS) AND PB.PARTNERBANKCODE NOT IN('DUPBANK')
		</createView>
	</changeSet>

	<changeSet id="2" author="murthy.y">
		<comment>On top of core version 14.11.0</comment>
		<sql>
			<![CDATA[
				update DATA_ENGINE_COLUMN 
				set RuleForValue = 'if((DISBURSEMENT_TYPE ==  ''N'' )){Result =''NE'';  return;} 
				else if((DISBURSEMENT_TYPE ==  ''R'' )){Result =''RT'';  return;}
				else if((DISBURSEMENT_TYPE ==  ''C'' )){Result =''CC'';  return;}
				else if((DISBURSEMENT_TYPE ==  ''IFT'' )){Result =''FT'';  return;}
				else if((DISBURSEMENT_TYPE ==  ''DD'' )){Result =''DD'';  return;}
				else if((DISBURSEMENT_TYPE ==  ''DD'' )){Result =''DD'';  return;}
				else {Result ='''';  return;}'
				where TABLEID = (select ID from DATA_ENGINE_TABLE where CONFIGID = (select ID from DATA_ENGINE_CONFIG where NAME = 'DISB_HDFC_EXPORT')) and Name = 'DISBURSEMENT_TYPE';
			]]>
		</sql>
	</changeSet>

	<changeSet id="277" author="prabhakar.g">
		<sql>
			<![CDATA[
				update CIBIL_MEMBER_DETAILS  set FILE_FORMATE = 'XLSX' where SEGMENT_TYPE = 'RETAIL';
			]]>
		</sql>
	</changeSet>

	<changeSet id="278" author="kranthikumar.k">
		<sql>
			<![CDATA[
				Insert into REPORTFILTERFIELDS values ((select reportid from reportconfiguration where menuitemcode='menu_Item_NPAReport'),6,'Date','DATERANGE','Date','provisioncaldate',null,'---Select----',null,null,0,0,0,0,6,0,null,null,null,null,150,0,'=',3,1000,'Approved',null,null,null,null,null,0,current_timestamp,null);
			]]>
		</sql>
	</changeSet>

	<changeSet id="279" author="kranthikumar.k">
		<sql>
			<![CDATA[
				INSERT INTO CIBIL_STATES_MAPPING VALUES ('36', 'RETAIL', 'IN', 'TL', 'Telangana', 50, 56, 1, 1000, current_timestamp, 'Approved', '','','','','', 0);
				INSERT INTO CIBIL_STATES_MAPPING VALUES ('36', 'CORP', 'IN', 'TL', 'Telangana', 50, 56, 1, 1000, current_timestamp, 'Approved', '','','','','', 0); 
				INSERT INTO CIBIL_ADDRESS_TYPES_MAPPING VALUES('01', 'RETAIL', 'PERM',  1, 1000, current_timestamp, 'Approved', '', '', '', '', '', 0);
				INSERT INTO CIBIL_ADDRESS_TYPES_MAPPING VALUES('02', 'RETAIL', 'CURR', 1, 1000, current_timestamp, 'Approved', '', '', '', '', '', 0);
				INSERT INTO CIBIL_ADDRESS_TYPES_MAPPING VALUES('03', 'RETAIL', 'OFFICE',  1, 1000, current_timestamp, 'Approved', '', '', '', '', '', 0);
			]]>
		</sql>
	</changeSet>

	<changeSet id="280" author="kranthikumar.k">
		<sql>
			<![CDATA[
				update data_engine_config set parser='3' where name='TRIAL_BALANCE_EXPORT_STATE';

				update data_engine_config set parser='3' where name='TRIAL_BALANCE_EXPORT_CONSOLIDATE';
			]]>
		</sql>
	</changeSet>

	<changeSet id="281" author="kranthikumar.k">
		<comment>File Extension changed to .xlsx</comment>
		<sql>
			<![CDATA[
				update data_engine_config set fileextension='.xlsx' where name='TRIAL_BALANCE_EXPORT_STATE';

				update data_engine_config set fileextension='.xlsx' where name='TRIAL_BALANCE_EXPORT_CONSOLIDATE';
			]]>
		</sql>
	</changeSet>


	<changeSet id="282" author="kranthi.k">
		<comment>Past Due Report Right Added</comment>
		<sql>
		<![CDATA[
			INSERT INTO SECRIGHTS SELECT (SELECT MAX(RIGHTID)+1 FROM SECRIGHTS), 0, 'menuItem_FinDeptReports_PastDue','MENU',0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECRIGHTS WHERE 0=0;

			INSERT INTO SECGROUPRIGHTS VALUES((SELECT MAX(GRPRIGHTID)+1 FROM SECGROUPRIGHTS), (SELECT GRPID FROM SECGROUPS WHERE GRPCODE='REPORTS_ADMIN') ,(SELECT RIGHTID FROM SECRIGHTS WHERE RIGHTNAME='menuItem_FinDeptReports_PastDue'),1,0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0);
		]]>
		</sql>
	</changeSet>

	<changeSet id="283" author="kranthi.k">
		<comment>DateRange Fields Added in Past Due Report Filter Fields</comment>
		<sql>
		<![CDATA[
			Insert into REPORTFILTERFIELDS values ((select reportid from reportconfiguration where menuitemcode='menu_Item_PastDue'),8,'Date','DATERANGE','Date','PastDueFrom',null,'---Select----',null,null,0,0,0,0,6,0,null,null,null,null,150,0,'=',3,1000,'Approved',null,null,null,null,null,0,current_timestamp,null);
		]]>
		</sql>
	</changeSet>

	<changeSet id="284" author="kranthi.k">
		<comment>accholdername length changed to 100 instead of 50</comment>

		<modifyDataType tableName="mandates" columnName="accholdername" newDataType="varchar(100)" />
	</changeSet>

	<changeSet id="285" author="kranthi.k">
		<comment>accholdername length changed to 100 instead of 50</comment>

		<modifyDataType tableName="mandates_temp" columnName="accholdername" newDataType="varchar(100)" />
	</changeSet>

	<changeSet id="286" author="kranthi.k">
		<comment>Posting Report BranchDetails Multiselection Enabled</comment>
		<sql>
		<![CDATA[
			update reportfilterfields set MULTISELECTSEARCH=1 where reportid in (select reportid from reportconfiguration where menuitemcode='menu_Item_Postings') and fieldid=1;
			]]>
		</sql>
	</changeSet>

	<changeSet id="287" author="kranthi.k">
		<sql>
				<![CDATA[
					Insert into SMTPARAMETERS (SYSPARMCODE, SYSPARMDESC, SYSPARMTYPE, SYSPARMMAINT, SYSPARMVALUE, SYSPARMLENGTH, SYSPARMDEC, SYSPARMLIST, SYSPARMVALDMOD, SYSPARMDESCRIPTION, VERSION,LASTMNTBY,LASTMNTON,RECORDSTATUS,ROLECODE,NEXTROLECODE,TASKID,NEXTTASKID,RECORDTYPE,WORKFLOWID) values ('GST_DEFAULT_FROM_STATE',' GST Default From State ','String',1,'Y',1,0,null,null,'GST Default From State',1,1000,current_timestamp,'Approved',null,null,null,null,null,0);
				]]>
		</sql>
	</changeSet>
	<changeSet id="288" author="kranthi.k">
		<sql>
				<![CDATA[
					Insert into SMTPARAMETERS (SYSPARMCODE, SYSPARMDESC, SYSPARMTYPE, SYSPARMMAINT, SYSPARMVALUE, SYSPARMLENGTH, SYSPARMDEC, SYSPARMLIST, SYSPARMVALDMOD, SYSPARMDESCRIPTION, VERSION,LASTMNTBY,LASTMNTON,RECORDSTATUS,ROLECODE,NEXTROLECODE,TASKID,NEXTTASKID,RECORDTYPE,WORKFLOWID) values ('GST_DEFAULT_STATE_CODE','GST Default State Code','String',1,'0021',10,0,null,null,'GST Default State Code',1,1000,current_timestamp,'Approved',null,null,null,null,null,0);
				]]>
		</sql>
	</changeSet>

	<changeSet id="289" author="kranthi.k">
		<sql>
				<![CDATA[
					delete from SMTPARAMETERS where SYSPARMCODE='ALW_SCH_RECAL_LOCK';
					
					Insert into SMTPARAMETERS (SYSPARMCODE, SYSPARMDESC, SYSPARMTYPE, SYSPARMMAINT, SYSPARMVALUE, SYSPARMLENGTH, SYSPARMDEC, SYSPARMLIST, SYSPARMVALDMOD, SYSPARMDESCRIPTION, VERSION,LASTMNTBY,LASTMNTON,RECORDSTATUS,ROLECODE,NEXTROLECODE,TASKID,NEXTTASKID,RECORDTYPE,WORKFLOWID) values ('ALW_SCH_RECAL_LOCK',' Allow Schedule Recal Lock ','String',1,'Y',1,0,null,null,'Allow Schedule Recal Lock',1,1000,current_timestamp,'Approved',null,null,null,null,null,0);
				]]>
		</sql>
	</changeSet>


	<changeSet id="290" author="kranthi.k">
		<sql>
				<![CDATA[
					delete from SMTPARAMETERS where sysparmcode='CUST_LASTNAME_MANDATORY';		
					Insert into SMTPARAMETERS (SYSPARMCODE, SYSPARMDESC, SYSPARMTYPE, SYSPARMMAINT, SYSPARMVALUE, SYSPARMLENGTH, SYSPARMDEC, SYSPARMLIST, SYSPARMVALDMOD, SYSPARMDESCRIPTION, VERSION,LASTMNTBY,LASTMNTON,RECORDSTATUS,ROLECODE,NEXTROLECODE,TASKID,NEXTTASKID,RECORDTYPE,WORKFLOWID) values ('CUST_LASTNAME_MANDATORY',' Customer Last Name Mandatory ','String',1,'N',1,0,null,null,'Customer Last Name Mandatory',1,1000,current_timestamp,'Approved',null,null,null,null,null,0);
				]]>
		</sql>
	</changeSet>

	<changeSet id="291" author="kranthi.k">
		<sql>
				<![CDATA[
					Update SMTParameters set SysParmValue = 'N' where SysParmCode ='HOLD_DISB_INST_POST';	
				]]>
		</sql>
	</changeSet>


	<changeSet id="292" author="kranthi.k">
		<addColumn tableName="Loan_El_Adsb_Ed">
			<column name="InstructionUID" type="bigint" defaultValue="0" />
		</addColumn>
	</changeSet>

	<changeSet id="293" author="kranthi.k">
		<addColumn tableName="Loan_El_Adsb_Ed_Temp">
			<column name="InstructionUID" type="bigint" defaultValue="0" />
		</addColumn>
	</changeSet>


	<changeSet id="294" author="kranthi.k">
		<addColumn tableName="Loan_Eil_Adsb_Ed">
			<column name="InstructionUID" type="bigint" defaultValue="0" />
		</addColumn>
	</changeSet>

	<changeSet id="295" author="kranthi.k">
		<addColumn tableName="Loan_Eil_Adsb_Ed_Temp">
			<column name="InstructionUID" type="bigint" defaultValue="0" />
		</addColumn>
	</changeSet>

	<changeSet id="296" author="kranthi.k">
		<sql>
			<![CDATA[
				DELETE  FROM REPORTFILTERFIELDS WHERE REPORTID IN (SELECT REPORTID FROM REPORTCONFIGURATION WHERE MENUITEMCODE='menu_Item_Presentment') AND FIELDID=3;		
			]]>
		</sql>
	</changeSet>
	
	<changeSet id="297" author="kranthi.k">
		<sql>
			<![CDATA[
				DELETE  FROM REPORTFILTERFIELDS WHERE REPORTID IN (SELECT REPORTID FROM REPORTCONFIGURATION WHERE MENUITEMCODE='menu_Item_Presentment') AND FIELDID=3;		
			]]>
		</sql>
	</changeSet>
	
	<changeSet id="298" author="kranthi.k">
		<createView viewName="INT_MANDATE_REQUEST_VIEW" replaceIfExists="true">
			<![CDATA[
				 SELECT M.MANDATEID,
						M.DOCUMENTNAME,
						BD.BANKSHORTCODE
						BANKCODE,
						BD.BANKNAME,
						case when LB.BRANCHCODE IS NULL THEN CB.BRANCHCODE ELSE LB.BRANCHCODE END BRANCHCODE,
						case when
						LB.BRANCHDESC IS NULL THEN CB.BRANCHDESC ELSE LB.BRANCHDESC END BRANCHDESC,
						CUST.CUSTCIF,
						CUST.CUSTSHRTNAME,
						CUST.CustCoreBank,
						FT.FINTYPEDESC FINTYPE ,
						FIN.FINREFERENCE ,
						COALESCE((SELECT SUM(TotalAmount) from (Select
						MAX(FSD.REPAYAMOUNT+FSD.FEESCHD) TotalAmount
						FROM FINSCHEDULEDETAILS FSD
						INNER JOIN FINANCEMAIN FM ON FM.FINREFERENCE
						=FSD.FINREFERENCE AND FM.CUSTID = M.CUSTID
						GROUP BY FM.FINREFERENCE)T)/CCYMINORCCYUNITS, 0) CUST_EMI,
						COALESCE((SELECT
						SUM(TotalAmount) from (Select MAX(FSD.REPAYAMOUNT+FSD.FEESCHD) TotalAmount FROM FINSCHEDULEDETAILS FSD WHERE
						(REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) AND FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID =
						M.MANDATEID) GROUP BY FINREFERENCE)T)/CCYMINORCCYUNITS, 0) EMI,
						CASE M.OPENMANDATE WHEN 1 THEN 'New Open ECS' ELSE 'No
						Open ECS' END OPENMANDATE,
						M.ACCNUMBER,
						CASE WHEN M.ACCTYPE = '10' then 'Savings Account' WHEN M.ACCTYPE = '11' then
						'Current Account' WHEN M.ACCTYPE = '11' then
						'Cash Credit Account' ELSE M.ACCTYPE END ACCTYPE,
						M.ACCHOLDERNAME,
						BB.MICR,
						BB.IFSC,
						BB.ADDOFBRANCH,
						(select MIN(FIRSTREPAYDATE) from FINPFTDETAILS where FINREFERENCE IN (SELECT
						FINREFERENCE FROM FINANCEMAIN WHERE
						MANDATEID=M.MANDATEID)) FIRSTDUEDATE,
						(select MAX(SCHDATE) from FINSCHEDULEDETAILS
						where (REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) and FINREFERENCE IN (SELECT
						FINREFERENCE FROM FINANCEMAIN WHERE
						MANDATEID=M.MANDATEID)) EMIENDDATE,
						COALESCE (M.MAXLIMIT, 0) MAXLIMIT,
						COALESCE((SELECT SUM(MANDATEDEBITAMOUNT) from (Select MAX(REPAYAMOUNT+FEESCHD) MANDATEDEBITAMOUNT FROM FINSCHEDULEDETAILS WHERE
						(REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) AND FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE
						MANDATEID=M.MANDATEID) GROUP BY FINREFERENCE)T), 0)/CCYMINORCCYUNITS DEBITAMOUNT,
						FIN.NumberOfTerms,
						M.periodicity,
						M.STARTDATE,
						M.EXPIRYDATE,
						FIN.APPLICATIONNO,
						M.MANDATETYPE,
						M.STATUS,
						M.INPUTDATE,
						M.RECORDSTATUS,
						M.RECORDTYPE,
						M.MANDATECCY,
						COALESCE (CCY.CCYMINORCCYUNITS, 100) CCYMINORCCYUNITS,
						M.EntityCode,
						CP.PHONENUMBER,
						CE.CUSTEMAIL,
						PB.PARTNERBANKNAME,
						M.LASTMNTON,
						BB.BranchDesc BANK_BRANCH_NAME
						FROM MANDATES M
					INNER JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = M.BANKBRANCHID
					INNER JOIN BMTBANKDETAIL BD ON BD.BANKCODE=BB.BANKCODE
					INNER JOIN CUSTOMERS CUST ON CUST.CUSTID = M.CUSTID
					INNER JOIN RMTBRANCHES CB ON CB.BRANCHCODE = CUST.CUSTDFTBRANCH
					LEFT JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = M.PARTNERBANKID
					LEFT JOIN CUSTOMEREMAILS CE ON CE.CUSTID = CUST.CUSTID AND CE.CUSTEMAILPRIORITY = 5
					LEFT JOIN CUSTOMERPHONENUMBERS CP ON CP.PHONECUSTID = CUST.CUSTID AND CP.PHONETYPEPRIORITY = 5
					LEFT OUTER JOIN	RMTCURRENCIES CCY ON CCY.CCYCODE = M.MANDATECCY
					LEFT OUTER JOIN FINANCEMAIN FIN ON M.ORGREFERENCE = FIN.FINREFERENCE
					LEFT JOIN RMTBRANCHES LB ON LB.BRANCHCODE = FIN.FINBRANCH
					LEFT OUTER JOIN RMTFINANCETYPES FT ON FIN.FINTYPE = FT.FINTYPE
					WHERE M.STATUS = 'NEW' AND M.MANDATEID NOT IN (select MANDATEID FROM MANDATE_REQUESTS where (status = 'AC' OR status = 'NEW'))
			]]>
		</createView>
	</changeSet>
	</databaseChangeLog>