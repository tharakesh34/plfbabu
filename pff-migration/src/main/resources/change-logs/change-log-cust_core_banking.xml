<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value="" dbms="oracle" />
	<property name="add.schema" value="" dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />

	<changeSet id="pre_run_for_pgp" author="nagavamsi.p" runAlways="true" dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>

	<changeSet id="ST#712_01" author="murthy.y">
		<sql>
			<![CDATA[
				Update Customers set CustCoreBank = -1*CustID;
			]]>
		</sql>
	</changeSet>

	<changeSet id="ST#712_02" author="murthy.y">
		<addNotNullConstraint tableName="Customers" columnName="CustCoreBank" />
	</changeSet>

	<changeSet id="ST#712_03" author="murthy.y">
		<createIndex tableName="Customers" indexName="idx_Customers_CustCoreBank">
			<column name="CustCoreBank" type="varchar(50)" />
		</createIndex>
	</changeSet>

	<changeSet id="ST#712_04" author="murthy.y">
		<sql>
			<![CDATA[
				Update Customers_Temp set CustCoreBank = -1*CustID;
			]]>
		</sql>
	</changeSet>

	<changeSet id="ST#712_05" author="murthy.y">
		<addNotNullConstraint tableName="Customers_Temp" columnName="CustCoreBank" />
	</changeSet>

	<changeSet id="ST#712_06" author="murthy.y">
		<createIndex tableName="Customers_Temp" indexName="idx_Customers_T_CustCoreBank">
			<column name="CustCoreBank" type="varchar(50)" />
		</createIndex>
	</changeSet>

	<changeSet id="ST#712_07" author="saikrishna.b">
		<createTable tableName="EOD_CUSTOMER_QUEUE">
			<column name="ID" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="AppDate" type="dateTime">
				<constraints nullable="false" />
			</column>
			<column name="CutsID" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="CoreBankID" type="varchar(50)">
				<constraints nullable="false" />
			</column>
			<column name="LoanExist" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="LimitRebuild" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="WorkerHost" type="varchar(50)" />
			<column name="ThreadId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="StartTime" type="datetime" />
			<column name="EndTime" type="datetime" />
			<column name="Progress" type="int">
				<constraints nullable="false" />
			</column>
			<column name="ErrorLog" type="varchar(2000)" />
			<column name="ResetCounterId" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="PickUpFlag" type="boolean">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="ST#712_07.1" author="murthy.y">
		<addPrimaryKey tableName="EOD_CUSTOMER_QUEUE" columnNames="ID" constraintName="pk_eod_customer_queue" />
	</changeSet>

	<changeSet id="ST#712_07.2" author="murthy.y" dbms="postgresql, oracle">
		<addDefaultValue columnName="LoanExist" tableName="EOD_CUSTOMER_QUEUE" defaultValue="0" />
		<addDefaultValue columnName="LimitRebuild" tableName="EOD_CUSTOMER_QUEUE" defaultValue="0" />
		<addDefaultValue columnName="ThreadId" tableName="EOD_CUSTOMER_QUEUE" defaultValue="0" />
		<addDefaultValue columnName="Progress" tableName="EOD_CUSTOMER_QUEUE" defaultValue="0" />
		<addDefaultValue columnName="ResetCounterId" tableName="EOD_CUSTOMER_QUEUE" defaultValue="0" />
		<addDefaultValue columnName="PickUpFlag" tableName="EOD_CUSTOMER_QUEUE" defaultValue="0" />
	</changeSet>

	<changeSet id="ST#712_07.2" author="murthy.y" dbms="mssql">
		<sql>
			<![CDATA[	
				ALTER TABLE EOD_CUSTOMER_QUEUE ADD CONSTRAINT DF_EOD_CUSTOMER_QUEUE_LOANEXIST DEFAULT 0 FOR LOANEXIST;
				ALTER TABLE EOD_CUSTOMER_QUEUE ADD CONSTRAINT DF_EOD_CUSTOMER_QUEUE_LIMITREBUILD DEFAULT 0 FOR LIMITREBUILD;
				ALTER TABLE EOD_CUSTOMER_QUEUE ADD CONSTRAINT DF_EOD_CUSTOMER_QUEUE_THREADID DEFAULT 0 FOR THREADID;
				ALTER TABLE EOD_CUSTOMER_QUEUE ADD CONSTRAINT DF_EOD_CUSTOMER_QUEUE_PROGRESS DEFAULT 0 FOR PROGRESS;
				ALTER TABLE EOD_CUSTOMER_QUEUE ADD CONSTRAINT DF_EOD_CUSTOMER_QUEUE_RESETCOUNTERID DEFAULT 0 FOR RESETCOUNTERID;
				ALTER TABLE EOD_CUSTOMER_QUEUE_LOG ADD CONSTRAINT DF_EOD_CUSTOMER_QUEUE_PICKUPFLAG DEFAULT 0 FOR PICKUPFLAG;
			]]>
		</sql>
	</changeSet>

	<changeSet id="ST#712_08" author="murthy.y">
		<createTable tableName="EOD_CUSTOMER_QUEUE_LOG">
			<column name="ID" type="bigint" autoIncrement="true">
				<constraints nullable="false" />
			</column>
			<column name="SeqId" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="AppDate" type="dateTime">
				<constraints nullable="false" />
			</column>
			<column name="CustID" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="CoreBankID" type="varchar(50)" />
			<column name="LoanExist" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="LimitRebuild" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="WorkerHost" type="varchar(50)" />
			<column name="ThreadId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="StartTime" type="datetime" />
			<column name="EndTime" type="datetime" />
			<column name="Progress" type="int">
				<constraints nullable="false" />
			</column>
			<column name="ErrorLog" type="varchar(2000)" />
		</createTable>
	</changeSet>

	<changeSet id="ST#712_08.1" author="murthy.y">
		<addPrimaryKey tableName="EOD_CUSTOMER_QUEUE_LOG" columnNames="ID"
			constraintName="pk_eod_customer_queue_log" />
	</changeSet>
	
	<changeSet id="ST#712_pre" author="Mounika.M" dbms="postgresql">
		<sql>
			<![CDATA[
				select deps_save_and_drop_dependencies ('plf', 'mandates_aview');
			]]>
		</sql>
	</changeSet>

	<changeSet id="ST#712.1" author="Mounika.M">
		<createView viewName="MANDATES_AVIEW" replaceIfExists="true">
			<![CDATA[
				SELECT M.MANDATEID
					, M.CUSTID
					, M.MANDATEREF
					, M.MANDATETYPE
					, M.BANKBRANCHID
					, M.ACCNUMBER
					, M.ACCHOLDERNAME
					, M.JOINTACCHOLDERNAME
					, M.ACCTYPE
					, M.OPENMANDATE
					, M.STARTDATE
					, M.EXPIRYDATE
					, M.MAXLIMIT
					, M.PERIODICITY
					, M.PHONECOUNTRYCODE
					, M.PHONEAREACODE
					, M.PHONENUMBER
					, M.STATUS
					, M.APPROVALID
					, M.VERSION
					, M.LASTMNTBY
					, M.LASTMNTON
					, M.RECORDSTATUS
					, M.ROLECODE
					, M.NEXTROLECODE
					, M.TASKID
					, M.NEXTTASKID
					, M.RECORDTYPE
					, M.WORKFLOWID
					, M.REASON
					, M.MANDATECCY
					, C.CUSTCIF
					, C.CUSTSHRTNAME
					, C.CUSTCOREBANK
					, BB.BANKCODE
					, BB.BRANCHCODE
					, BB.BRANCHDESC
					, BB.MICR
					, BB.IFSC
					, BB.CITY
					, BD.BANKNAME
					, M.INPUTDATE
					, M.INPUTDATE FROMDATE
					, M.INPUTDATE TODATE
					, M.ACTIVE
					, M.DEFAULTMANDATE
					, 1  USEEXISTING
					, M.ORGREFERENCE
					, PC.PCCITYNAME
					, M.DOCUMENTNAME
					, M.DOCUMENTREF
					, M.EXTERNALREF
					, M.ENTITYCODE
					, E.ENTITYDESC
					, M.PRIMARYMANDATEID
					, M.SWAPISACTIVE
					, M.BARCODENUMBER
					, PB.PARTNERBANKCODE
					, PB.PARTNERBANKNAME
					, M.PARTNERBANKID
					, M.EMANDATESOURCE
					, M.EMANDATEREFERENCENO
					, FM.FINTYPE
					, M.HOLDREASON
					, M.SWAPEFFECTIVEDATE
					, M.SECURITYMANDATE
					, M.EMPLOYERID
					, ED.EMPNAME
					, M.EMPLOYEENO
				FROM MANDATES M
				INNER JOIN CUSTOMERS C ON C.CUSTID = M.CUSTID
				LEFT JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = M.BANKBRANCHID
				LEFT JOIN BMTBANKDETAIL BD ON BD.BANKCODE = BB.BANKCODE 
				LEFT JOIN RMTPROVINCEVSCITY PC ON PC.PCCITY = BB.CITY
				LEFT JOIN ENTITY E ON E.ENTITYCODE = M.ENTITYCODE
				LEFT JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = M.PARTNERBANKID
				LEFT JOIN FINANCEMAIN FM ON FM.FINREFERENCE = M.ORGREFERENCE
				LEFT JOIN EMPLOYERDETAIL ED ON ED.EMPLOYERID = M.EMPLOYERID
			]]>
		</createView>
	</changeSet>

	<changeSet id="ST#712_post" author="Mounika.M" dbms="postgresql">
		<sql>
			<![CDATA[
				select deps_restore_dependencies ('plf', 'mandates_aview');
			]]>
		</sql>
	</changeSet>


</databaseChangeLog>