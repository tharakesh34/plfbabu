<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="add.schema" value=" " dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />


	<changeSet id="pre_run_for_pgp" author="Jayant" runAlways="true"
		dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>
	
	<changeSet id="1" author="Siva">
		<sql>
			insert into BMTAMOUNTCODES values('REPAY',0,'bounceCharge_CGST_P','Bounce charge CGST paid',1,1,1000,Current_TimeStamp,'Approved',null,null,null,null,null,0);
			insert into BMTAMOUNTCODES values('REPAY',0,'bounceCharge_SGST_P','Bounce charge SGST paid',1,1,1000,Current_TimeStamp,'Approved',null,null,null,null,null,0);
			insert into BMTAMOUNTCODES values('REPAY',0,'bounceCharge_IGST_P','Bounce charge IGST paid',1,1,1000,Current_TimeStamp,'Approved',null,null,null,null,null,0);
			insert into BMTAMOUNTCODES values('REPAY',0,'bounceCharge_UGST_P','Bounce charge UGST paid',1,1,1000,Current_TimeStamp,'Approved',null,null,null,null,null,0);
		</sql>
	</changeSet>
	<changeSet id="2" author="SrinivasaVarma">
		<comment> New Column added allowInRule </comment>
		<createView viewName="extendedfielddetail_aview"
			replaceIfExists="true">
			select t1.moduleid,  t1.fieldname,  t2.modulename as lovdescmodulename, t2.submodulename as lovdescsubmodulename,
			t1.fieldtype, t1.fieldlength,  t1.fieldprec, t1.fieldlabel, t1.fieldmandatory,
			t1.fieldconstraint,  t1.fieldseqorder, t1.fieldlist, t1.fielddefaultvalue,
			t1.fieldminvalue, t1.fieldmaxvalue, t1.fieldunique, t1.extendedtype, t1.version,
			t1.lastmntby, t1.lastmnton,  t1.recordstatus,  t1.rolecode, t1.nextrolecode,
			t1.taskid,  t1.nexttaskid, t1.recordtype,  t1.workflowid, t1.multiline,  t1.parenttag,
			t1.inputelement, t1.editable,t1.allowInRule
			from extendedfielddetail t1 join extendedfieldheader t2 on t1.moduleid = t2.moduleid
		</createView>
	</changeSet>

	<changeSet id="3" author="SrinivasaVarma">
		<comment> New Column added allowInRule </comment>
		<createView viewName="extendedfielddetail_view"
			replaceIfExists="true">
			SELECT t1.moduleid, t1.fieldname, t2.modulename AS lovdescmodulename, t2.submodulename AS lovdescsubmodulename,
		    t1.fieldtype, t1.fieldlength, t1.fieldprec, t1.fieldlabel,
		    t1.fieldmandatory,
		    t1.fieldconstraint,
		    t1.fieldseqorder,
		    t1.fieldlist,
		    t1.fielddefaultvalue,
		    t1.fieldminvalue,
		    t1.fieldmaxvalue,
		    t1.fieldunique,
		    t1.extendedtype,
		    t1.version,
		    t1.lastmntby,
		    t1.lastmnton,
		    t1.recordstatus,
		    t1.rolecode,
		    t1.nextrolecode,
		    t1.taskid,
		    t1.nexttaskid,
		    t1.recordtype,
		    t1.workflowid,
		    t1.multiline,
		    t1.parenttag,
		    t1.inputelement,
		    t1.editable,
		    t1.allowInRule
		   FROM extendedfielddetail_temp t1 JOIN extendedfieldheader_temp t2 ON t1.moduleid = t2.moduleid
		UNION ALL
		 SELECT t1.moduleid,
		    t1.fieldname,
		    t2.modulename AS lovdescmodulename,
		    t2.submodulename AS lovdescsubmodulename,
		    t1.fieldtype,
		    t1.fieldlength,
		    t1.fieldprec,
		    t1.fieldlabel,
		    t1.fieldmandatory,
		    t1.fieldconstraint,
		    t1.fieldseqorder,
		    t1.fieldlist,
		    t1.fielddefaultvalue,
		    t1.fieldminvalue,
		    t1.fieldmaxvalue,
		    t1.fieldunique,
		    t1.extendedtype,
		    t1.version,
		    t1.lastmntby,
		    t1.lastmnton,
		    t1.recordstatus,
		    t1.rolecode,
		    t1.nextrolecode,
		    t1.taskid,
		    t1.nexttaskid,
		    t1.recordtype,
		    t1.workflowid,
		    t1.multiline,
		    t1.parenttag,
		    t1.inputelement,
		    t1.editable,
		    t1.allowInRule
		   FROM extendedfielddetail t1 JOIN extendedfieldheader t2 ON t1.moduleid = t2.moduleid
		   WHERE NOT (EXISTS ( SELECT 1 FROM extendedfielddetail_temp WHERE extendedfielddetail_temp.moduleid = t1.moduleid AND extendedfielddetail_temp.fieldname = t1.fieldname))
		</createView>
	</changeSet>
	
	<changeSet id="4" author="Siva">
		<addColumn tableName="FinRepayHeader">
			<column name="RealizeUnAmz" type="decimal(18,0)" />
		</addColumn>
		<addColumn tableName="FinRepayHeader_Temp">
			<column name="RealizeUnAmz" type="decimal(18,0)" />
		</addColumn>
	</changeSet>
	
	<changeSet id="5" author="Siva" dbms="oracle">
		<addDefaultValue columnName="RealizeUnAmz" tableName="FinRepayHeader" defaultValue="0"/>
		<addDefaultValue columnName="RealizeUnAmz" tableName="FinRepayHeader_Temp" defaultValue="0"/>
	</changeSet>
	<changeSet id="5" author="Siva" dbms="postgresql">
		<addDefaultValue columnName="RealizeUnAmz" tableName="FinRepayHeader" defaultValue="0"/>
		<addDefaultValue columnName="RealizeUnAmz" tableName="FinRepayHeader_Temp" defaultValue="0"/>
	</changeSet>
		<changeSet id="5" author="Siva" dbms="mssql">
		<sql>
			alter table FinRepayHeader add constraint df_fph_RealizeUnAmz default 0 for RealizeUnAmz;
			alter table FinRepayHeader_Temp add constraint df_fph_t_RealizeUnAmz default 0 for RealizeUnAmz;
		</sql>
	</changeSet>
	<changeSet id="6" author="Siva">
		<sql>
			update FinRepayHeader set RealizeUnAmz = 0 where RealizeUnAmz is null;
			update FinRepayHeader_Temp set RealizeUnAmz = 0 where RealizeUnAmz is null;
		</sql>
	</changeSet>
	<changeSet id="7" author="Ganesh.p">
		<comment> change the severity of the LoanStartDate and DisbursmentDate should be matched error</comment>
		<sql>
			update ERRORDETAILS set severity='E' where code='65032';
		</sql>
	</changeSet>
	<changeSet id="8" author="Manoj">
		<comment> New Table : InterfaceMappingConfiguration for mapping PLF and InterfaceData</comment>
		<createTable tableName="InterfaceMappingConfiguration">
			<column name="ServiceName" type="varchar(100)">
				<constraints nullable="false"/>
			</column>
			<column name="ModuleCode" type="varchar(100)">
				<constraints nullable="false"/>
			</column>
			<column name="SourceCode" type="varchar(30)	">
			</column>
			<column name="DestCode" type="varchar(30)">
			</column>
			<column name="SourceId" type="bigint">
			</column>
			<column name="DestId" type="bigint">
			</column>
			<column name="DestDescription" type="varchar(200)" />
			<column name="active" type="boolean" />
			<column name="version" type="int" />
			<column name="lastmntby" type="bigint" />
			<column name="lastmnton" type="datetime" />
			<column name="recordstatus" type="varchar(50)" />
			<column name="rolecode" type="varchar(100)" />
			<column name="nextrolecode" type="varchar(200)" />
			<column name="taskid" type="varchar(50)" />
			<column name="nexttaskid" type="varchar(200)" />
			<column name="recordtype" type="varchar(50)" />
			<column name="workflowid" type="bigint">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>
	<changeSet id="8_Post" author="manoj" dbms="oracle">
		<addDefaultValue columnName="SourceId" tableName="InterfaceMappingConfiguration" defaultValue="0"/>
		<addDefaultValue columnName="DestId" tableName="InterfaceMappingConfiguration" defaultValue="0"/>
	</changeSet>
	<changeSet id="8_Post" author="manoj" dbms="postgresql">
		<addDefaultValue columnName="SourceId" tableName="InterfaceMappingConfiguration" defaultValue="0"/>
		<addDefaultValue columnName="DestId" tableName="InterfaceMappingConfiguration" defaultValue="0"/>
	</changeSet>
		<changeSet id="8_Post" author="manoj" dbms="mssql">
		<sql>
			alter table InterfaceMappingConfiguration add constraint df_imc_SourceId default 0 for SourceId;
			alter table InterfaceMappingConfiguration add constraint df_imc_DestId default 0 for DestId;
		</sql>
	</changeSet>
	<changeSet id="9" author="Manoj">
		<createIndex tableName="InterfaceMappingConfiguration" indexName="IDX_IMC_MOD_SRC_SM">
			<column name="ModuleCode" type="varchar(100)"/>
			<column name="SourceCode" type="varchar(100)"/>
			<column name="ServiceName" type="varchar(100)"/>
		</createIndex>
	</changeSet>
	<changeSet id="10" author="Manoj">
		<createIndex tableName="InterfaceMappingConfiguration" indexName="IDX_IMC_MOD_SID_SM">
			<column name="ModuleCode" type="varchar(100)"/>
			<column name="SourceId" type="bigint"/>
			<column name="ServiceName" type="varchar(100)"/>
		</createIndex>
	</changeSet>
	<changeSet id="11" author="Manoj">
		<createIndex tableName="InterfaceMappingConfiguration" indexName="IDX_IMC_MOD_SM">
			<column name="ModuleCode" type="varchar(100)"/>
			<column name="ServiceName" type="varchar(100)"/>
		</createIndex>
	</changeSet>

	<!-- <changeSet id="12" author="Ganesh.p">
		<modifyDataType tableName="CollateralCoOwners_Temp"
			columnName="CoOwnerIDType" newDataType="VARCHAR(50)" />
	</changeSet>

	<changeSet id="13" author="Ganesh.p">
		<modifyDataType tableName="CollateralCoOwners"
			columnName="CoOwnerIDType" newDataType="VARCHAR(50)" />
	</changeSet> -->
	<changeSet id="14" author="srikanth.m">
	<addColumn tableName="mandate_requests">
		<column name="ifsc_code" type= "varchar(20)"/>
		<column name="customer_phone" type= "varchar(20)"/>
		<column name="customer_email" type= "varchar(100)"/>
		<column name="folio_number" type= "varchar(20)"/>
		<column name="branch_code" type= "varchar(8)"/>
		<column name="branch_address" type= "varchar(100)"/>
		<column name="auxiliary_field1" type= "varchar(50)"/>
		<column name="auxiliary_field2" type= "varchar(50)"/>
		<column name="auxiliary_field3" type= "varchar(50)"/>
		<column name="auxiliary_field4" type= "varchar(50)"/>
	</addColumn>
</changeSet>
<changeSet id="14.1" author="srikanth.m">
	<addColumn tableName="mandate_response">
		<column name="ifsc_code" type= "varchar(20)"/>
		<column name="customer_phone" type= "varchar(20)"/>
		<column name="customer_email" type= "varchar(100)"/>
		<column name="folio_number" type= "varchar(20)"/>
		<column name="branch_code" type= "varchar(8)"/>
		<column name="branch_address" type= "varchar(100)"/>
		<column name="auxiliary_field1" type= "varchar(50)"/>
		<column name="auxiliary_field2" type= "varchar(50)"/>
		<column name="auxiliary_field3" type= "varchar(50)"/>
		<column name="auxiliary_field4" type= "varchar(50)"/>
	</addColumn>
</changeSet>
<changeSet id="14.2" author="srikanth.m">
	<createView viewName="INT_MANDATE_REQUEST_VIEW" replaceIfExists="true">
 SELECT M.MANDATEID, 
			BD.BANKSHORTCODE BANKCODE,
			BD.BANKNAME,
			case when LB.BRANCHCODE IS NULL THEN CB.BRANCHCODE ELSE LB.BRANCHCODE END BRANCHCODE,
      		case when LB.BRANCHDESC IS NULL THEN CB.BRANCHDESC ELSE LB.BRANCHDESC END BRANCHDESC,
			CUST.CUSTCIF,
			CUST.CUSTSHRTNAME,
			FT.FINTYPEDESC FINTYPE ,
			FIN.FINREFERENCE ,
			COALESCE((SELECT SUM(TotalAmount) from (Select MAX(FSD.REPAYAMOUNT+FSD.FEESCHD) TotalAmount 
													FROM FINSCHEDULEDETAILS FSD 
													INNER JOIN FINANCEMAIN FM ON FM.FINREFERENCE =FSD.FINREFERENCE AND FM.CUSTID = M.CUSTID 
													GROUP BY FM.FINREFERENCE)T)/CCYMINORCCYUNITS, 0) CUST_EMI,
			COALESCE((SELECT SUM(TotalAmount) from (Select MAX(FSD.REPAYAMOUNT+FSD.FEESCHD) TotalAmount FROM FINSCHEDULEDETAILS FSD WHERE (REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) AND FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID = M.MANDATEID) GROUP BY FINREFERENCE)T)/CCYMINORCCYUNITS, 0) EMI,
			  CASE M.OPENMANDATE
			    WHEN 1
			    THEN 'New Open ECS'
			    ELSE 'No Open ECS'
			  END OPENMANDATE,
			M.ACCNUMBER,
			M.ACCTYPE,
			M.ACCHOLDERNAME,
			BB.MICR,
			BB.IFSC,
			BB.ADDOFBRANCH,
			(select MIN(FIRSTREPAYDATE) from FINPFTDETAILS where FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID=M.MANDATEID)) FIRSTDUEDATE,
			(select MAX(SCHDATE) from FINSCHEDULEDETAILS where (REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) and FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID=M.MANDATEID)) EMIENDDATE,
			 COALESCE (M.MAXLIMIT/CCYMINORCCYUNITS, 0) MAXLIMIT, 
     		 COALESCE((SELECT SUM(MANDATEDEBITAMOUNT) from (Select MAX(REPAYAMOUNT+FEESCHD) MANDATEDEBITAMOUNT FROM FINSCHEDULEDETAILS WHERE (REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) AND FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID=M.MANDATEID)
     		 GROUP BY FINREFERENCE)T), 0)/CCYMINORCCYUNITS DEBITAMOUNT,
			  M.STARTDATE,
			  M.EXPIRYDATE,
			  FIN.APPLICATIONNO,
			  M.MANDATETYPE,
			  M.STATUS,
			  M.INPUTDATE,
			  M.RECORDSTATUS,
			  M.RECORDTYPE,
        	M.MANDATECCY,
			  COALESCE (CCY.CCYMINORCCYUNITS, 100) CCYMINORCCYUNITS,M.EntityCode
			FROM MANDATES M
			INNER JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = M.BANKBRANCHID
			INNER JOIN BMTBANKDETAIL BD ON BD.BANKCODE=BB.BANKCODE 
			INNER JOIN CUSTOMERS CUST   ON CUST.CUSTID = M.CUSTID
			INNER JOIN RMTBRANCHES CB ON CB.BRANCHCODE = CUST.CUSTDFTBRANCH 
			LEFT JOIN CUSTOMEREMAILS CE ON CE.CUSTID = CUST.CUSTID AND CE.CUSTEMAILPRIORITY = 5
			LEFT JOIN CUSTOMERPHONENUMBERS CP ON CP.PHONECUSTID = CUST.CUSTID AND CP.PHONETYPEPRIORITY = 5
			LEFT OUTER JOIN RMTCURRENCIES CCY ON CCY.CCYCODE = M.MANDATECCY
			LEFT OUTER JOIN FINANCEMAIN FIN ON M.ORGREFERENCE=FIN.FINREFERENCE
			LEFT JOIN RMTBRANCHES LB ON LB.BRANCHCODE = FIN.FINBRANCH 
			LEFT OUTER JOIN RMTFINANCETYPES FT ON FIN.FINTYPE =FT.FINTYPE 
			WHERE M.STATUS = 'NEW' AND M.MANDATEID NOT IN  (select MANDATEID FROM MANDATE_REQUESTS where (status = 'AC' OR status = 'NEW'))
		</createView>
</changeSet>
<changeSet id="14.3" author="srikanth.m">
<createView viewName="INT_MANDATE_REQUEST_VIEW" replaceIfExists="true">
SELECT M.MANDATEID, 
			BD.BANKSHORTCODE BANKCODE,
			BD.BANKNAME,
			case when LB.BRANCHCODE IS NULL THEN CB.BRANCHCODE ELSE LB.BRANCHCODE END BRANCHCODE,
      		case when LB.BRANCHDESC IS NULL THEN CB.BRANCHDESC ELSE LB.BRANCHDESC END BRANCHDESC,
			CUST.CUSTCIF,
			CUST.CUSTSHRTNAME,
			FT.FINTYPEDESC FINTYPE ,
			FIN.FINREFERENCE ,
			COALESCE((SELECT SUM(TotalAmount) from (Select MAX(FSD.REPAYAMOUNT+FSD.FEESCHD) TotalAmount 
													FROM FINSCHEDULEDETAILS FSD 
													INNER JOIN FINANCEMAIN FM ON FM.FINREFERENCE =FSD.FINREFERENCE AND FM.CUSTID = M.CUSTID 
													GROUP BY FM.FINREFERENCE)T)/CCYMINORCCYUNITS, 0) CUST_EMI,
			COALESCE((SELECT SUM(TotalAmount) from (Select MAX(FSD.REPAYAMOUNT+FSD.FEESCHD) TotalAmount FROM FINSCHEDULEDETAILS FSD WHERE (REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) AND FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID = M.MANDATEID) GROUP BY FINREFERENCE)T)/CCYMINORCCYUNITS, 0) EMI,
			  CASE M.OPENMANDATE
			    WHEN 1
			    THEN 'New Open ECS'
			    ELSE 'No Open ECS'
			  END OPENMANDATE,
			M.ACCNUMBER,
			M.ACCTYPE,
			M.ACCHOLDERNAME,
			BB.MICR,
			BB.IFSC,
			BB.ADDOFBRANCH,
			(select MIN(FIRSTREPAYDATE) from FINPFTDETAILS where FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID=M.MANDATEID)) FIRSTDUEDATE,
			(select MAX(SCHDATE) from FINSCHEDULEDETAILS where (REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) and FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID=M.MANDATEID)) EMIENDDATE,
			 COALESCE (M.MAXLIMIT/CCYMINORCCYUNITS, 0) MAXLIMIT, 
     		 COALESCE((SELECT SUM(MANDATEDEBITAMOUNT) from (Select MAX(REPAYAMOUNT+FEESCHD) MANDATEDEBITAMOUNT FROM FINSCHEDULEDETAILS WHERE (REPAYONSCHDATE = 1 OR PFTONSCHDATE = 1) AND FINREFERENCE IN (SELECT FINREFERENCE FROM FINANCEMAIN WHERE MANDATEID=M.MANDATEID)
     		 GROUP BY FINREFERENCE)T), 0)/CCYMINORCCYUNITS DEBITAMOUNT,
			  M.STARTDATE,
			  M.EXPIRYDATE,
			  FIN.APPLICATIONNO,
			  M.MANDATETYPE,
			  M.STATUS,
			  M.INPUTDATE,
			  M.RECORDSTATUS,
			  M.RECORDTYPE,
        	M.MANDATECCY,
			  COALESCE (CCY.CCYMINORCCYUNITS, 100) CCYMINORCCYUNITS,M.EntityCode,
              CP.PHONENUMBER,
			CE.CUSTEMAIL
			FROM MANDATES M
			INNER JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = M.BANKBRANCHID
			INNER JOIN BMTBANKDETAIL BD ON BD.BANKCODE=BB.BANKCODE 
			INNER JOIN CUSTOMERS CUST   ON CUST.CUSTID = M.CUSTID
			INNER JOIN RMTBRANCHES CB ON CB.BRANCHCODE = CUST.CUSTDFTBRANCH 
			LEFT JOIN CUSTOMEREMAILS CE ON CE.CUSTID = CUST.CUSTID AND CE.CUSTEMAILPRIORITY = 5
			LEFT JOIN CUSTOMERPHONENUMBERS CP ON CP.PHONECUSTID = CUST.CUSTID AND CP.PHONETYPEPRIORITY = 5
			LEFT OUTER JOIN RMTCURRENCIES CCY ON CCY.CCYCODE = M.MANDATECCY
			LEFT OUTER JOIN FINANCEMAIN FIN ON M.ORGREFERENCE=FIN.FINREFERENCE
			LEFT JOIN RMTBRANCHES LB ON LB.BRANCHCODE = FIN.FINBRANCH 
			LEFT OUTER JOIN RMTFINANCETYPES FT ON FIN.FINTYPE =FT.FINTYPE 
			WHERE M.STATUS = 'NEW' AND M.MANDATEID NOT IN  (select MANDATEID FROM MANDATE_REQUESTS where (status = 'AC' OR status = 'NEW'))
			</createView>
</changeSet>
</databaseChangeLog>
	