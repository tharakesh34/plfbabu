<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="add.schema" value=" " dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />


	<changeSet id="pre_run_for_pgp" author="Jayant" runAlways="true"
		dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>

	
	<changeSet id="154.1" author="Vinay">
		<addColumn tableName="FinCovenantType">
			<column name="alwOtc" type="boolean" defaultValue="0" />
		</addColumn>
	</changeSet>
	<changeSet id="155.1" author="Vinay">
		<sql>
			update FinCovenantType set alwOtc = 0;
		</sql>
	</changeSet>
	<changeSet id="154.2" author="Vinay">
		<addColumn tableName="FinCovenantType_Temp">
			<column name="alwOtc" type="boolean" defaultValue="0" />
		</addColumn>
	</changeSet>
	<changeSet id="155.2" author="Vinay">
		<sql>
			update FinCovenantType_Temp set alwOtc = 0;
		</sql>
	</changeSet>
	<changeSet id="154" author="Madhubabu">
		<comment> alwotc added </comment>
		<createView viewName="fincovenanttype_eaview" replaceIfExists="true">
			SELECT t.finreference,
		    t.custid,
		    t.covenanttype,
		    t.description,
		    t.mandrole,
		    t.alwwaiver,
		    t.alwpostpone,
		    t.alwotc,
		    t.postponedays,
		    t.covenanttypedesc,
		    t.categorycode,
		    t.receivabledate,
		    t.version,
		    t.lastmntby,
		    t.lastmnton,
		    t.recordstatus,
		    t.rolecode,
		    t.nextrolecode,
		    t.taskid,
		    t.nexttaskid,
		    t.recordtype,
		    t.workflowid,
        CASE
            WHEN t.docreceiveddate IS NULL THEN cd.lastmnton
            ELSE t.docreceiveddate
        END AS docreceiveddate
   FROM ( SELECT t1.finreference,
            t4.custid,
            t1.covenanttype,
            t1.description,
            t1.mandrole,
            t1.alwwaiver,
            t1.alwpostpone,
         	t1.alwotc,
            t1.postponedays,
            t3.doctypedesc AS covenanttypedesc,
            t5.code AS categorycode,
            t1.receivabledate,
            t1.version,
            t1.lastmntby,
            t1.lastmnton,
            t1.recordstatus,
            t1.rolecode,
            t1.nextrolecode,
            t1.taskid,
            t1.nexttaskid,
            t1.recordtype,
            t1.workflowid,
            t7.docreceiveddate
           FROM fincovenanttype t1
             JOIN bmtdocumenttypes t3 ON t3.doctypecode = t1.covenanttype
             LEFT JOIN documentcategory t5 ON t5.id = t3.categoryid
             JOIN financemain t4 ON t4.finreference = t1.finreference
             LEFT JOIN documentdetails t7 ON t7.referenceid = t1.finreference AND t1.covenanttype = t7.doccategory) t
     		LEFT JOIN customerdocuments cd ON cd.custid = t.custid AND t.covenanttype = cd.custdoccategory
		</createView>
	</changeSet>
	<changeSet id="155" author="Madhubabu">
		<comment> alwotc added </comment>
		<createView viewName="fincovenanttype_eview" replaceIfExists="true">
			SELECT t.finreference,
		    t.custid,
		    t.covenanttype,
		    t.description,
		    t.mandrole,
		    t.alwwaiver,
		    t.alwpostpone,
		    t.alwotc,
		    t.postponedays,
		    t.covenanttypedesc,
		    t.categorycode,
		    t.receivabledate,
		    t.version,
		    t.lastmntby,
		    t.lastmnton,
		    t.recordstatus,
		    t.rolecode,
		    t.nextrolecode,
		    t.taskid,
		    t.nexttaskid,
		    t.recordtype,
		    t.workflowid,
        CASE
            WHEN t.docreceiveddate IS NULL THEN cd.lastmnton
            ELSE t.docreceiveddate
        END AS docreceiveddate
   FROM ( SELECT t1.finreference,
            t4.custid,
            t1.covenanttype,
            t1.description,
            t1.mandrole,
            t1.alwwaiver,
            t1.alwpostpone,
            t1.postponedays,
         	t1.alwotc,
            t3.doctypedesc AS covenanttypedesc,
            t5.code AS categorycode,
            t1.receivabledate,
            t1.version,
            t1.lastmntby,
            t1.lastmnton,
            t1.recordstatus,
            t1.rolecode,
            t1.nextrolecode,
            t1.taskid,
            t1.nexttaskid,
            t1.recordtype,
            t1.workflowid,
            t7.docreceiveddate
           FROM fincovenanttype_temp t1
             JOIN bmtdocumenttypes t3 ON t3.doctypecode = t1.covenanttype
             LEFT JOIN documentcategory t5 ON t5.id = t3.categoryid
             JOIN financemain t4 ON t4.finreference = t1.finreference
             LEFT JOIN documentdetails t7 ON t7.referenceid = t1.finreference AND t1.covenanttype = t7.doccategory
        UNION ALL
         SELECT t1.finreference,
            t4.custid,
            t1.covenanttype,
            t1.description,
            t1.mandrole,
            t1.alwwaiver,
            t1.alwpostpone,
            t1.postponedays,
         	t1.alwotc,
            t3.doctypedesc AS covenanttypedesc,
            t5.code AS categorycode,
            t1.receivabledate,
            t1.version,
            t1.lastmntby,
            t1.lastmnton,
            t1.recordstatus,
            t1.rolecode,
            t1.nextrolecode,
            t1.taskid,
            t1.nexttaskid,
            t1.recordtype,
            t1.workflowid,
            t7.docreceiveddate
           FROM fincovenanttype t1
             JOIN bmtdocumenttypes t3 ON t3.doctypecode = t1.covenanttype
             LEFT JOIN documentcategory t5 ON t5.id = t3.categoryid
             JOIN financemain t4 ON t4.finreference = t1.finreference
             LEFT JOIN documentdetails t7 ON t7.referenceid = t1.finreference AND t1.covenanttype = t7.doccategory
          WHERE NOT (EXISTS ( SELECT 1
                   FROM fincovenanttype_temp
                  WHERE fincovenanttype_temp.finreference = t1.finreference AND fincovenanttype_temp.covenanttype = t1.covenanttype))) t
     LEFT JOIN customerdocuments cd ON cd.custid = t.custid AND t.covenanttype = cd.custdoccategory
		</createView>
	</changeSet>
		<changeSet id="156" author="Ganesh.p">
		<addColumn tableName="PRESENTMENT_REQ_DETAILS">
			<column name="CycleDate" type="datetime"></column>
		</addColumn>
	</changeSet>
	<changeSet id="157" author="Ganesh.p">
		<addColumn tableName="PRESENTMENT_REQ_DETAILS_TEMP">
			<column name="CycleDate" type="datetime"></column>
		</addColumn>
	</changeSet>
	<changeSet id="158" author="Durgaprasad G">
	<comment> alwotc added </comment>
		<createView viewName="fincovenanttype_aview" replaceIfExists="true">
			SELECT t1.finreference,
		    t1.covenanttype,
		    t1.description,
		    t1.mandrole,
		    t1.alwwaiver,
		    t1.alwpostpone,
		    t1.postponedays,
		    t1.alwotc,
		    t3.doctypedesc AS covenanttypedesc,
			t5.Code AS categoryCode,
		    t4.roledesc AS mandroledesc,
		    t1.receivabledate,
		    t1.version,
		    t1.lastmntby,
		    t1.lastmnton,
		    t1.recordstatus,
		    t1.rolecode,
		    t1.nextrolecode,
		    t1.taskid,
		    t1.nexttaskid,
		    t1.recordtype,
		    t1.workflowid
		   FROM fincovenanttype t1
		     JOIN financemain t2 ON t2.finreference = t1.finreference
		     JOIN bmtdocumenttypes t3 ON t3.doctypecode = t1.covenanttype
			 Left Join DocumentCategory t5 ON t5.Id = t3.categoryId
		     JOIN secroles t4 ON t4.rolecd = t1.mandrole
		</createView>
	</changeSet>
	
	<changeSet id="159" author="Durgaprasad G">
	<comment> alwotc added </comment>
		<createView viewName="fincovenanttype_tview" replaceIfExists="true">
			 SELECT t1.finreference,
		    t1.covenanttype,
		    t1.description,
		    t1.mandrole,
		    t1.alwwaiver,
		    t1.alwpostpone,
		    t1.postponedays,
		    t1.alwotc,
		    t3.doctypedesc AS covenanttypedesc,
		    t5.Code AS categoryCode,
		    t4.roledesc AS mandroledesc,
		    t1.receivabledate,
		    t1.version,
		    t1.lastmntby,
		    t1.lastmnton,
		    t1.recordstatus,
		    t1.rolecode,
		    t1.nextrolecode,
		    t1.taskid,
		    t1.nexttaskid,
		    t1.recordtype,
		    t1.workflowid
		   FROM fincovenanttype_temp t1
		     JOIN financemain_temp t2 ON t2.finreference = t1.finreference
		     JOIN bmtdocumenttypes t3 ON t3.doctypecode = t1.covenanttype
			 Left Join DocumentCategory t5 ON t5.Id = t3.categoryId
		     JOIN secroles t4 ON t4.rolecd = t1.mandrole
     </createView>
	</changeSet>
	
	<changeSet id="160" author="Durgaprasad G">
	<comment> alwotc added </comment>
		<createView viewName="fincovenanttype_view" replaceIfExists="true">
		SELECT t1.finreference,
	    t1.covenanttype,
	    t1.description,
	    t1.mandrole,
	    t1.alwwaiver,
	    t1.alwpostpone,
	    t1.postponedays,
	    t1.alwotc,
	    t3.doctypedesc AS covenanttypedesc,
	    t5.Code AS categoryCode,
	    t4.roledesc AS mandroledesc,
	    t1.receivabledate,
	    t1.version,
	    t1.lastmntby,
	    t1.lastmnton,
	    t1.recordstatus,
	    t1.rolecode,
	    t1.nextrolecode,
	    t1.taskid,
	    t1.nexttaskid,
	    t1.recordtype,
	    t1.workflowid
	   FROM fincovenanttype_temp t1
	     JOIN bmtdocumenttypes t3 ON t3.doctypecode = t1.covenanttype
		 Left Join DocumentCategory t5 ON t5.Id = t3.categoryId
	     LEFT JOIN secroles t4 ON t4.rolecd = t1.mandrole
	UNION ALL
	 SELECT t1.finreference,
	    t1.covenanttype,
	    t1.description,
	    t1.mandrole,
	    t1.alwwaiver,
	    t1.alwpostpone,
	    t1.postponedays,
	    t1.alwotc,
	    t3.doctypedesc AS covenanttypedesc,
	    t5.Code AS categoryCode,
	    t4.roledesc AS mandroledesc,
	    t1.receivabledate,
	    t1.version,
	    t1.lastmntby,
	    t1.lastmnton,
	    t1.recordstatus,
	    t1.rolecode,
	    t1.nextrolecode,
	    t1.taskid,
	    t1.nexttaskid,
	    t1.recordtype,
	    t1.workflowid
	   FROM fincovenanttype t1
	     JOIN bmtdocumenttypes t3 ON t3.doctypecode = t1.covenanttype
		  Left Join DocumentCategory t5 ON t5.Id = t3.categoryId
	     LEFT JOIN secroles t4 ON t4.rolecd = t1.mandrole
	  WHERE NOT (EXISTS ( SELECT 1
	           FROM fincovenanttype_temp
	          WHERE fincovenanttype_temp.finreference = t1.finreference AND fincovenanttype_temp.covenanttype = t1.covenanttype))
	 </createView>
	</changeSet>
</databaseChangeLog>
	