<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="add.schema" value=" " dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />

	<changeSet id="pre_run_for_pgp" author="satish" runAlways="true" dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>

	<changeSet id="1" author="murthy.y">
		<createSequence sequenceName="SEQ_FINANCEMAIN" incrementBy="1" startValue="1" minValue="1"
			maxValue="999999999999999999" />
	</changeSet>

	<changeSet id="2" author="murthy.y">
		<createTable tableName="FINID_MAPPING">
			<column name="FINID" type="bigint" autoIncrement="true">
				<constraints primaryKey="true" primaryKeyName="PK_FINID_MAPPING" />
			</column>
			<column name="FinReference" type="varchar(20)">
				<constraints unique="true" uniqueConstraintName="UK_FINID_MAPPING_FINREF" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="3" author="murthy.y">
		<sql>
			<![CDATA[
				insert into FINID_MAPPING (FinReference) 
				select distinct  FinReference from (
				select FinReference from FinanceMain
				union all
				select FinReference from FinanceMain_Temp
				union all
				select FinReference from RejectFinanceMain
				union all
				select FinReference from WIFFinanceMain
				) T
			]]>
		</sql>
	</changeSet>

	<changeSet id="3.1" author="murth.y" dbms="oracle" runAlways="true">
		<sql splitStatements="false">
		<![CDATA[
			declare
			v_maxval INTEGER;
			begin
			select COALESCE(max(FINID), 0) + 1 into v_maxval from FINID_MAPPING;
			EXECUTE IMMEDIATE 'alter sequence SEQ_FINANCEMAIN restart start with ' || v_maxval;
			end;
			]]>
		</sql>
	</changeSet>

	<changeSet id="3.1" author="murth.y" dbms="postgresql" runAlways="true">
		<sql splitStatements="false">
		<![CDATA[
			do $$
			declare
			v_maxval INTEGER;
			begin
			select COALESCE(max(FINID), 0) + 1 into v_maxval from
			FINID_MAPPING;
			EXECUTE 'alter sequence SEQ_FINANCEMAIN restart start with ' || v_maxval;
			end;
			$$;
			]]>
		</sql>
	</changeSet>

	<changeSet id="3.1" author="murth.y" dbms="mssql" runAlways="true">
		<sql splitStatements="false">
		<![CDATA[
			DECLARE @SQLCmd VARCHAR(MAX);
			DECLARE @Seq BIGINT;
			SELECT @Seq=COALESCE(max(FINID), 0) + 1 from FINID_MAPPING;
			
			SET @SQLCmd = '
			ALTER SEQUENCE SEQ_FINANCEMAIN
			RESTART WITH ' + CAST( @Seq AS VARCHAR(30));
			
			EXEC SP_EXECUTESQL  @SQLCmd;
			]]>
		</sql>
	</changeSet>

</databaseChangeLog>