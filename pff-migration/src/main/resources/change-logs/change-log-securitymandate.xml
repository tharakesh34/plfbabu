<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value="" dbms="oracle" />
	<property name="add.schema" value="" dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />

	<changeSet id="pre_run_for_pgp" author="nagavamsi.p" runAlways="true" dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>
	
	<changeSet id="ST#710.1" author="saikiran.n">
		<addColumn tableName="FinanceMain_temp">
			<column name="SecurityMandateID" type="bigint" />
		</addColumn>
	</changeSet>
	
	<changeSet id="ST#710.2" author="saikiran.n">
		<addColumn tableName="FinanceMain">
			<column name="SecurityMandateID" type="bigint" />
		</addColumn>
	</changeSet>
	
	<changeSet id="ST#710.3" author="saikiran.n">
		<sql>
			<![CDATA[
				 Update FinanceMain set SecurityMandateId = (select m.MandateId from Mandates m Where FinanceMain.FinReference = m.OrgReference and m.SecurityMandate = 1);
			]]>
		</sql>
	</changeSet>
	
	
	<changeSet id="PSD#211905_pre" author="saikiran.n" dbms="postgresql">
		<sql>
			<![CDATA[
				select deps_save_and_drop_dependencies ('plf', 'financeenquiry_view');
		 	]]>
		</sql>
	</changeSet>

	<changeSet id="PSD#211905" author="saikiran.n">
		<createView viewName="FINANCEENQUIRY_VIEW" replaceIfExists="true">
		  <![CDATA[
				SELECT FM.FINID,
					FM.FINREFERENCE,
					FM.FINBRANCH,
					FM.FINTYPE,
					FM.FINCCY,
					FM.SCHEDULEMETHOD,
					FM.PROFITDAYSBASIS,
					FM.FINSTARTDATE,
					FM.CALTERMS NUMBEROFTERMS,
					FM.CUSTID,
					FM.FINAMOUNT,
					FM.GRCPERIODENDDATE,
					FM.MATURITYDATE,
					FM.FINREPAYMENTAMOUNT,
					FM.FINISACTIVE,
					FM.ALLOWGRCPERIOD,
					FM.DOWNPAYMENT,
					FM.MIGRATEDFINANCE,
					FM.LASTREPAYDATE,
					FM.LASTREPAYPFTDATE,
					FM.FINCURRASSETVALUE,
					FM.BLACKLISTED,
					FM.FEECHARGEAMT,
					FM.CLOSINGSTATUS,
					FM.GRACETERMS,
					FM.ALWMULTIDISB,
					FM.DEFFERMENTS,
					FM.FINSTATUS ,
					FM.MANDATEID,
					FM.FINREPAYMETHOD,
					FM.FINASSETVALUE,
					FM.SANBSDSCHDLE,
					FM.PROMOTIONSEQID,
					FM.SVAMOUNT,
					FM.CBAMOUNT,
					(FM.FINCURRASSETVALUE+ FM.FEECHARGEAMT) FINANCINGAMOUNT,
					(FM.FINCURRASSETVALUE- FM.FINREPAYMENTAMOUNT+ FM.FEECHARGEAMT) CURFINAMOUNT,
					RF.FINTYPEDESC LOVDESCFINTYPENAME,
					RF.FINSCHEDULEON LOVDESCFINSCHEDULEON,
					RF.FINDIVISION LOVDESCFINDIVISION,
					RF.FINCATEGORY LOVDESCPRODUCTCODENAME,
					RF.FINISALWDIFFERMENT LOVDESCFINALWDEFERMENT,
					C.CUSTCIF LOVDESCCUSTCIF,
					C.CUSTSHRTNAME LOVDESCCUSTSHRTNAME,
					RB.BRANCHDESC LOVDESCFINBRANCHNAME,
					RC.CUSTTYPECTG,
					COALESCE(FP.NOINST,0) NOINST,
					FM.TOTALCPZ,
					FM.FINOCRREQUIRED,
					FM.ALWGRCADJ,
					FM.ENDGRCPERIODAFTRFULLDISB,
					FM.AUTOINCGRCENDDATE,
					FM.RECORDSTATUS,
					FM.WRITEOFFLOAN,
					FM.RESTRUCTURE,
					FM.SUBVENTIONFROM,
					FM.MANUFACTURERDEALERID,
					AV.DEALERNAME MANUFACTURERDEALERNAME,
					AV.CODE MANUFACTURERDEALERCODE,
					FM.ESCROW,
					FM.CUSTBANKID,
					CB.ACCOUNTNUMBER CUSTACCTNUMBER,
					CB.ACCOUNTHOLDERNAME CUSTACCTHOLDERNAME,
					FM.SECURITYMANDATEID
				FROM FINANCEMAIN FM
				INNER JOIN RMTFINANCETYPES RF ON RF.FINTYPE = FM.FINTYPE
				INNER JOIN CUSTOMERS C ON C.CUSTID = FM.CUSTID
				INNER JOIN RMTBRANCHES RB ON RB.BRANCHCODE = FM.FINBRANCH
				INNER JOIN RMTCUSTTYPES RC ON RC.CUSTTYPECODE = C.CUSTTYPECODE 
				LEFT JOIN FINPFTDETAILS FP ON FP.FINID = FM.FINID
				LEFT JOIN AMTVEHICLEDEALER AV ON AV.DEALERID = FM.MANUFACTURERDEALERID 
				LEFT JOIN CUSTOMERBANKINFO CB ON CB.BANKID = FM.CUSTBANKID
			]]>
		</createView>
	</changeSet>

	<changeSet id="PSD#211905_post" author="saikiran.n" dbms="postgresql">
		<sql>
			<![CDATA[
				select deps_restore_dependencies ('plf', 'financeenquiry_view');
			]]>
		</sql>
	</changeSet>
	
	</databaseChangeLog>