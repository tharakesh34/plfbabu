<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />
	
	<changeSet id="pre_run_for_pgp" author="Jayant" runAlways="true"
			dbms="postgresql">
			<sql>
				Set search_path = plf,public,pg_catalog;
			</sql>
	</changeSet>
	<changeSet id="1" author="Jayant">
		<createTable tableName="license_file">
			<column name="id" type="bigint" >
				<constraints primaryKey="true" primaryKeyName="pk_license_file" nullable="false" />
			</column>
			<column name="name" type="varchar(100)">
				<constraints nullable="false"/>
			</column>
			<column name="content" type="blob">
				<constraints nullable="false"/>
			</column>
			<column name="uploaded_by" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="uploaded_on" type="datetime">
				<constraints nullable="false"/>
			</column>
			<column name="active" type="boolean">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>
	<changeSet id="2" author="Jayant">
		<createTable tableName="app_log">
			<column name="id" type="bigint" >
				<constraints nullable="false" />
			</column>
			<column name="code" type="varchar(6)">
				<constraints nullable="false"/>
			</column>
			<column name="value" type="varchar(500)">
				<constraints nullable="false"/>
			</column>
			<column name="created_on" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="updated_on" type="datetime">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>	
	<changeSet id="3" author="Jayant">
		<addPrimaryKey tableName="app_log" columnNames="id, code" constraintName="pk_app_logs"/>
	</changeSet>
	<changeSet id="4" author="Jayant">
		<addForeignKeyConstraint constraintName="fk_license_file" referencedTableName="license_file" 
		baseColumnNames="id" baseTableName="app_log" referencedColumnNames="id"/>
	</changeSet>
	<changeSet id="5" author="Jayant">
		<sql>
			delete from SecUserOperations where OprId IN (Select OprId  From SecOperations Where OprCode='LICENSE_UPLOAD');
			DELETE FROM SecOperationRoles Where OprId=(Select OprId  From SecOperations Where OprCode='LICENSE_UPLOAD') AND RoleID=(Select  RoleID  From SecRoles Where RoleCd='LICENSE_UPLOAD');
			DELETE FROM SECOPERATIONS Where OprCode='LICENSE_UPLOAD';
			DELETE FROM SecRoleGroups Where GrpId=(Select GrpId  From SecGroups Where GrpCode='LICENSE_UPLOAD') AND RoleID=(Select  RoleID  From SecRoles Where RoleCd='LICENSE_UPLOAD');
			DELETE FROM SECGROUPRIGHTS Where GRPID=(SELECT GRPID  FROM SECGROUPS WHERE GRPCODE='LICENSE_UPLOAD') AND RIGHTID=(SELECT RIGHTID FROM SECRIGHTS WHERE RIGHTNAME='menuItem_License_LicenseUpload');
			DELETE FROM SECROLES Where RoleCd='LICENSE_UPLOAD';
			DELETE FROM SECGROUPS Where GRPCODE='LICENSE_UPLOAD';
			delete from secgrouprights where rightId IN (select RightId from SECRIGHTS where RIGHTNAME='menuItem_License_LicenseUpload');
			DELETE FROM SECRIGHTS Where RIGHTNAME='menuItem_License_LicenseUpload';
			
			
			UPDATE SEQSECRIGHTS SET SEQNO= (SELECT MAX(RIGHTID) FROM SECRIGHTS);
			INSERT INTO SECRIGHTS SELECT (SELECT MAX(RIGHTID)+1 FROM SECRIGHTS), 0, 'menuItem_License_LicenseUpload','MENU',0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECRIGHTS WHERE 0=0; 
			UPDATE SEQSECRIGHTS SET SEQNO= (SELECT MAX(RIGHTID) FROM SECRIGHTS);
			
			UPDATE SEQSECGROUPS SET SEQNO= (SELECT MAX(GRPID) FROM SECGROUPS);
			INSERT INTO SECGROUPS SELECT (SELECT MAX(GRPID)+1 FROM SECGROUPS), 'LICENSE_UPLOAD', 'Gropup to upload license file', 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECGROUPS WHERE 0=0;
			UPDATE SEQSECGROUPS SET SEQNO= (SELECT MAX(GRPID) FROM SECGROUPS);
			
			UPDATE SEQSECGROUPRIGHTS SET SEQNO = (SELECT MAX(GRPRIGHTID) FROM SECGROUPRIGHTS);
			INSERT INTO SECGROUPRIGHTS VALUES((SELECT MAX(GRPRIGHTID)+1 FROM SECGROUPRIGHTS), (SELECT GRPID  FROM SECGROUPS WHERE GRPCODE='LICENSE_UPLOAD') ,(SELECT RIGHTID FROM SECRIGHTS WHERE RIGHTNAME='menuItem_License_LicenseUpload'), 1, 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0);
			UPDATE SEQSECGROUPRIGHTS SET SEQNO = (SELECT MAX(GRPRIGHTID) FROM SECGROUPRIGHTS);
			
			UPDATE SEQSECROLES SET SEQNO= (SELECT MAX(ROLEID) FROM SECROLES);
			INSERT INTO SECROLES SELECT (SELECT MAX(ROLEID)+1 FROM SECROLES),1, 'LICENSE_UPLOAD', 'Role to upload license file','', 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECROLES WHERE 0=0;
			UPDATE SEQSECROLES SET SEQNO= (SELECT MAX(ROLEID) FROM SECROLES);
			
			UPDATE SEQSECROLEGROUPS SET SEQNO= (SELECT MAX(ROLEGRPID) FROM SECROLEGROUPS);
			INSERT INTO SecRoleGroups values((Select MAX(RoleGrpID)+1 From SecRoleGroups),(Select GrpId  From SecGroups Where GrpCode='LICENSE_UPLOAD'), (Select  RoleID  From SecRoles Where RoleCd='LICENSE_UPLOAD'),0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0); 
			UPDATE SEQSECROLEGROUPS SET SEQNO= (SELECT MAX(ROLEGRPID) FROM SECROLEGROUPS);
			
			UPDATE SEQSECOPERATIONS SET SEQNO= (SELECT MAX(OPRID) FROM SECOPERATIONS);
			INSERT INTO SECOPERATIONS SELECT (SELECT MAX(OPRID)+1 FROM SECOPERATIONS), 'LICENSE_UPLOAD', 'Operation to upload license file', 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECOPERATIONS WHERE 0=0;
			UPDATE SEQSECOPERATIONS SET SEQNO= (SELECT MAX(OPRID) FROM SECOPERATIONS);
			
			UPDATE SEQSECOPERATIONROLES SET SEQNO= (SELECT MAX(OPRROLEID) FROM SECOPERATIONROLES);
			INSERT INTO SecOperationRoles values((Select MAX(OprRoleID)+1 From SecOperationRoles),(Select OprId  From SecOperations Where OprCode='LICENSE_UPLOAD'), (Select  RoleID  From SecRoles Where RoleCd='LICENSE_UPLOAD'),0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0); 
			UPDATE SEQSECOPERATIONROLES SET SEQNO= (SELECT MAX(OPRROLEID) FROM SECOPERATIONROLES);
			
			UPDATE SeqSecUserOperations set SEQNO = (SELECT MAX(usrOprId) FROM SecUserOperations);
			INSERT INTO SecUserOperations values((Select MAX(usrOprId)+1 From SecUserOperations),(Select usrId  From SecUsers Where usrLogin='ADMIN_MAKER'), (Select  OprId  From SecOperations Where OprCode='LICENSE_UPLOAD'),0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0); 
			UPDATE SeqSecUserOperations set SEQNO= (SELECT MAX(usrOprId) FROM SecUserOperations);
		</sql>
	</changeSet>
</databaseChangeLog>