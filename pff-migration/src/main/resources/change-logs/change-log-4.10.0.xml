<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value="" dbms="oracle" />
	<property name="add.schema" value="" dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />


	 <changeSet id="pre_run_for_pgp" author="Jayant" runAlways="true"
		dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>

	
	

	<changeSet id="1" author="Kesav">
		<comment>View altered</comment>
		<createView viewName="DepositCheques_TView" replaceIfExists="true">
			Select	 	T1.Id, T1.MovementId, T1.ReceiptId, T1.ReceiptMode, T1.Amount, T1.RevLinkedTranId, T1.Status,
						T1.Version, T1.LastMntBy, T1.LastMntOn, T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,
						T2.ReceiptPurpose, T2.Remarks, 
						T3.FavourNumber, T3.ReceivedDate, T3.FundingAc,
						T4.FinReference, 
						T5.CustShrtName,
						T6.PartnerBankCode, T6.PartnerBankName
			From 		DepositCheques_Temp T1	
			Inner Join 	(select Reference, ReceiptId, ReceiptPurpose, Remarks from finreceiptheader_temp T
						 union all
						 select Reference, ReceiptId, ReceiptPurpose, Remarks from finreceiptheader T
						 WHERE  NOT EXISTS (SELECT 1 FROM finreceiptheader_temp  WHERE ReceiptId = T.ReceiptId)) T2 On T2.ReceiptId = T1.ReceiptId
			Inner Join 	(select ReceiptId,FavourNumber, ReceivedDate, FundingAc from finreceiptdetail_Temp T
						 union all
						 select ReceiptId, FavourNumber, ReceivedDate, FundingAc from finreceiptdetail T
						 WHERE  NOT EXISTS (SELECT 1 FROM finreceiptdetail_Temp  WHERE ReceiptId = T.ReceiptId)) T3 On T3.ReceiptId = T1.ReceiptId
			Inner Join 	financemain T4 ON T2.reference = T4.finreference
			Inner JOIN 	customers T5 ON T4.custid = T5.custid
			Inner JoIN  PartnerBanks T6 ON T6.PartnerBankId = T3.FundingAc
		</createView>
	</changeSet>
	
	<changeSet id="2" author="Kesav">
		<comment>View altered</comment>
		<createView viewName="DepositCheques_View" replaceIfExists="true">
			Select	 	T1.Id, T1.MovementId, T1.ReceiptId, T1.ReceiptMode, T1.Amount, T1.RevLinkedTranId, T1.Status,
						T1.Version, T1.LastMntBy, T1.LastMntOn, T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,
						T2.ReceiptPurpose, T2.Remarks, 
						T3.FavourNumber, T3.ReceivedDate, T3.FundingAc,
						T4.FinReference, 
						T5.CustShrtName,
						T6.PartnerBankCode, T6.PartnerBankName
			From 		DepositCheques_Temp T1	
			Inner Join 	(select Reference, ReceiptId, ReceiptPurpose, Remarks from finreceiptheader_temp T
						 union all
						 select Reference, ReceiptId, ReceiptPurpose, Remarks from finreceiptheader T
						 WHERE  NOT EXISTS (SELECT 1 FROM finreceiptheader_temp  WHERE ReceiptId = T.ReceiptId)) T2 On T2.ReceiptId = T1.ReceiptId
			Inner Join 	(select ReceiptId,FavourNumber, ReceivedDate, FundingAc from finreceiptdetail_Temp T
						 union all
						 select ReceiptId, FavourNumber, ReceivedDate, FundingAc from finreceiptdetail T
						 WHERE  NOT EXISTS (SELECT 1 FROM finreceiptdetail_Temp  WHERE ReceiptId = T.ReceiptId)) T3 On T3.ReceiptId = T1.ReceiptId
			Inner Join 	financemain T4 ON T2.reference = T4.finreference
			Inner JOIN 	customers T5 ON T4.custid = T5.custid
			Inner JoIN  PartnerBanks T6 ON T6.PartnerBankId = T3.FundingAc
			
			Union All
			
			Select	 	T1.Id, T1.MovementId, T1.ReceiptId, T1.ReceiptMode, T1.Amount, T1.RevLinkedTranId, T1.Status,
						T1.Version, T1.LastMntBy, T1.LastMntOn, T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,
						T2.ReceiptPurpose, T2.Remarks, 
						T3.FavourNumber, T3.ReceivedDate, T3.FundingAc,
						T4.FinReference, 
						T5.CustShrtName,
						T6.PartnerBankCode, T6.PartnerBankName
			From 		DepositCheques T1	
			Inner Join 	(Select Reference, ReceiptId, ReceiptPurpose, Remarks from finreceiptheader_temp T
						 union all
						 Select Reference, ReceiptId, ReceiptPurpose, Remarks from finreceiptheader T
						 WHERE  NOT EXISTS (SELECT 1 FROM finreceiptheader_temp  WHERE ReceiptId = T.ReceiptId)) T2 On T2.ReceiptId = T1.ReceiptId
			Inner Join 	(Select ReceiptId,FavourNumber, ReceivedDate, FundingAc from finreceiptdetail_Temp T
						 union all
						 Select ReceiptId, FavourNumber, ReceivedDate, FundingAc from finreceiptdetail T
						 WHERE  NOT EXISTS (SELECT 1 FROM finreceiptdetail_Temp  WHERE ReceiptId = T.ReceiptId)) T3 On T3.ReceiptId = T1.ReceiptId
			Inner Join 	financemain T4 ON T2.reference = T4.finreference
			Inner JOIN 	customers T5 ON T4.custid = T5.custid
			Inner JoIN  PartnerBanks T6 ON T6.PartnerBankId = T3.FundingAc
			
			WHERE NOT  (EXISTS ( SELECT 1 FROM DepositCheques_Temp WHERE DepositCheques_Temp.Id = T1.Id))		
		</createView>
	</changeSet>
	
	
	<changeSet id="3" author="Akhilesh.k">
		 <sql>
			UPDATE SEQSECRIGHTS SET SEQNO= (SELECT MAX(RIGHTID) FROM SECRIGHTS);
			UPDATE SEQSECGROUPS SET SEQNO= (SELECT MAX(GRPID) FROM SECGROUPS);
			UPDATE SEQSECROLEGROUPS SET SEQNO= (SELECT MAX(Rolegrpid) FROM SECROLEGROUPS);	
			UPDATE SEQSECGROUPRIGHTS SET SEQNO= (SELECT MAX(Grprightid) FROM SECGROUPRIGHTS);	
			UPDATE SEQSECROLES SET SEQNO= (SELECT MAX(roleid) FROM SECROLES );	
			UPDATE SEQSECOPERATIONS SET SEQNO= (SELECT MAX(oprid) FROM SECOPERATIONS);	
			UPDATE SEQSecOperationRoles SET SEQNO= (SELECT MAX(OprRoleID) FROM SecOperationRoles);	
			
			INSERT INTO SECRIGHTS SELECT (SELECT MAX(RIGHTID)+1 FROM SECRIGHTS), 0, 'menu_Item_DisbursmentHostReferenceReport','DisbHostRefRep',0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECRIGHTS WHERE 0=0; 
			
			INSERT INTO SECGROUPS SELECT (SELECT MAX(GRPID)+1 FROM SECGROUPS), 'DISBURSEMENT_HOST_REFERENCE_REPORT', 'Disbursement Host Reference Detail Report', 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECGROUPS WHERE 0=0;
			INSERT INTO SECGROUPRIGHTS VALUES((SELECT MAX(GRPRIGHTID)+1 FROM SECGROUPRIGHTS), (SELECT GRPID  FROM SECGROUPS WHERE GRPCODE='DISBURSEMENT_HOST_REFERENCE_REPORT') ,(SELECT RIGHTID FROM SECRIGHTS WHERE RIGHTNAME='menu_Item_DisbursmentHostReferenceReport'), 1, 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0);
			
			INSERT INTO SECROLES SELECT (select MAX(RoleID)+1 from SecRoles),1,'DISBURSEMENT_HOST_REFERENCE_REPORT','Disbursement Host Reference Detail Report','',0,1000,null,' ',' ',null,' ',' ',' ',0 FROM SeqSecRoles WHERE 0=0;
			INSERT INTO SecRoleGroups values((Select MAX(RoleGrpID)+1 From SecRoleGroups),(Select GrpId  From SecGroups Where GrpCode='DISBURSEMENT_HOST_REFERENCE_REPORT'), (Select  RoleID  From SecRoles Where RoleCd='DISBURSEMENT_HOST_REFERENCE_REPORT'),0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0); 
			INSERT INTO SECOPERATIONS SELECT (SELECT MAX(OPRID)+1 FROM SECOPERATIONS), 'DISBURSEMENT_HOST_REFERENCE_REPORT_OPERATION', 'Disbursement host reference report operation.', 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECOPERATIONS WHERE 0=0;
			INSERT INTO SecOperationRoles values((Select MAX(OprRoleID)+1 From SecOperationRoles),(Select OprId  From SecOperations Where OprCode='DISBURSEMENT_HOST_REFERENCE_REPORT_OPERATION'), (Select  RoleID  From SecRoles Where RoleCd='DISBURSEMENT_HOST_REFERENCE_REPORT'),0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0); 
			
			UPDATE SEQSECRIGHTS SET SEQNO= (SELECT MAX(RIGHTID) FROM SECRIGHTS);
			UPDATE SEQSECGROUPS SET SEQNO= (SELECT MAX(GRPID) FROM SECGROUPS);
			UPDATE SEQSECROLEGROUPS SET SEQNO= (SELECT MAX(Rolegrpid) FROM SECROLEGROUPS);	
			UPDATE SEQSECGROUPRIGHTS SET SEQNO= (SELECT MAX(Grprightid) FROM SECGROUPRIGHTS);	
			UPDATE SEQSECROLES SET SEQNO= (SELECT MAX(roleid) FROM SECROLES );	
			UPDATE SEQSECOPERATIONS SET SEQNO= (SELECT MAX(oprid) FROM SECOPERATIONS);	
			UPDATE SEQSecOperationRoles SET SEQNO= (SELECT MAX(OprRoleID) FROM SecOperationRoles);
		 </sql>
	</changeSet>
	
	<changeSet id="4" author="Akhilesh.k">
		 <sql>
			UPDATE SEQSECRIGHTS SET SEQNO= (SELECT MAX(RIGHTID) FROM SECRIGHTS);
			UPDATE SEQSECGROUPRIGHTS SET SEQNO= (SELECT MAX(Grprightid) FROM SECGROUPRIGHTS);	
		
			INSERT INTO SECRIGHTS SELECT (SEmenu_Item_DisbursmentHostReferenceReportLECT MAX(RIGHTID)+1 FROM SECRIGHTS), 0, 'CollateralAssignmentDetailDialog_HostReference','CollateralAssignmentDetailDialog',0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0 FROM SEQSECRIGHTS WHERE 0=0; 
			
			INSERT INTO SECGROUPRIGHTS VALUES((SELECT MAX(GRPRIGHTID)+1 FROM SECGROUPRIGHTS), (SELECT GRPID  FROM SECGROUPS WHERE GRPCODE='COLLATERALASSIGN_NEW') ,(SELECT RIGHTID FROM SECRIGHTS WHERE RIGHTNAME='CollateralAssignmentDetailDialog_HostReference'), 1, 0,1000,CURRENT_TIMESTAMP,' ',' ',' ',' ',' ',' ',0);
	
			
			UPDATE SEQSECRIGHTS SET SEQNO= (SELECT MAX(RIGHTID) FROM SECRIGHTS);
			UPDATE SEQSECGROUPRIGHTS SET SEQNO= (SELECT MAX(Grprightid) FROM SECGROUPRIGHTS);	
		 </sql>
	</changeSet>
	
		
	</databaseChangeLog>