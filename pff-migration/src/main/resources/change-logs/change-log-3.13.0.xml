<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />
	
	<changeSet id="01" author="Durgaprasad G">
	 <dropColumn tableName="INT_DSBIMPS_REQUEST" columnName="Channel"/>
	</changeSet>
	
	<changeSet id="02" author="Durgaprasad G">
	  <sql>
			DELETE from BMTAmountCodes Where allowedevent = 'PAYMTINS' AND amountCode = 'pi_payableAdvice';
			DELETE from BMTAmountCodes Where allowedevent = 'PAYMTINS' AND amountCode = 'pi_excessAmount';
			DELETE from BMTAmountCodes Where allowedevent = 'PAYMTINS' AND amountCode = 'pi_emiInAdvance';
			DELETE from BMTAmountCodes Where allowedevent = 'PAYMTINS' AND amountCode = 'pi_paymentAmount';
			
			Insert into BMTAmountCodes Values ('PAYMTINS','0','pi_payableAdvice', 'Payable advise Amount', '1', 1, 1005, Current_TimeStamp, 'Approved', null, null, null, null, null, 0 ); 
			Insert into BMTAmountCodes Values ('PAYMTINS','0','pi_excessAmount', 'Excess Amount', '1', 1, 1005,  Current_TimeStamp, 'Approved', null, null, null, null, null, 0 ); 
			Insert into BMTAmountCodes Values ('PAYMTINS','0','pi_emiInAdvance', 'EMI in Advance Amount', '1', 1, 1005, Current_TimeStamp, 'Approved', null, null, null, null, null, 0 ); 
			Insert into BMTAmountCodes Values ('PAYMTINS','0','pi_paymentAmount', 'Payment Amount', '1', 1, 1005, Current_TimeStamp, 'Approved', null, null, null, null, null, 0 ); 
	 </sql>
	</changeSet>
	
	<changeSet id="03" author="Durgaprasad G">
	 <sql>
	 Update DATA_ENGINE_TABLE set STATUSUPDATE = 'UPDATE DISBURSEMENT_REQUESTS SET BATCH_ID = :FILEID, STATUS = ''AC'' WHERE ID IN (:ID)
	 QUERY:UPDATE FINADVANCEPAYMENTS SET STATUS = ''AC'' WHERE PAYMENTID IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS WHERE ID IN (:ID) AND STATUS = ''AC'')
	 QUERY:UPDATE PAYMENTINSTRUCTIONS SET STATUS = ''AC'' WHERE PAYMENTINSTRUCTIONID IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS WHERE ID IN (:ID) AND STATUS = ''AC'')' WHERE CONFIGID = 
	 (Select id from DATA_ENGINE_CONFIG WHERE NAME = 'DISB_HDFC_EXPORT');
	 
	  Update DATA_ENGINE_TABLE set STATUSUPDATE = 'UPDATE DISBURSEMENT_REQUESTS SET BATCH_ID = :FILEID, STATUS = ''AC'' WHERE ID IN (:ID)
	 QUERY:UPDATE FINADVANCEPAYMENTS SET STATUS = ''AC'' WHERE PAYMENTID IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS WHERE ID IN (:ID) AND STATUS = ''AC'')
	 QUERY:UPDATE PAYMENTINSTRUCTIONS SET STATUS = ''AC'' WHERE PAYMENTINSTRUCTIONID IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS WHERE ID IN (:ID) AND STATUS = ''AC'')' WHERE CONFIGID = 
	 (Select id from DATA_ENGINE_CONFIG WHERE NAME = 'DISB_OTHER_NEFT_RTGS_EXPORT');
	
	  Update DATA_ENGINE_TABLE set STATUSUPDATE = 'UPDATE DISBURSEMENT_REQUESTS SET BATCH_ID = :FILEID, STATUS = ''AC'' WHERE ID IN (:ID)
	 QUERY:UPDATE FINADVANCEPAYMENTS SET STATUS = ''AC'' WHERE PAYMENTID IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS WHERE ID IN (:ID) AND STATUS = ''AC'')
	 QUERY:UPDATE PAYMENTINSTRUCTIONS SET STATUS = ''AC'' WHERE PAYMENTINSTRUCTIONID IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS WHERE ID IN (:ID) AND STATUS = ''AC'')' WHERE CONFIGID = 
	 (Select id from DATA_ENGINE_CONFIG WHERE NAME = 'DISB_OTHER_CHEQUE_DD_EXPORT');
	 </sql>
	</changeSet>
	
	<changeSet id="04" author="Durgaprasad G">
	 <createView viewName="DE_DISBURSE_FILE_CONTROL_VIEW" replaceIfExists="true">
	  SELECT DISTINCT(DS.ID), DC.NAME, DC.UPLOADPATH FILELOCATION, DS.FILENAME, DS.ENDTIME, DS.STATUS, 
			PB.ALWFILEDOWNLOAD,  PB.PARTNERBANKID, PB.PARTNERBANKCODE, PB.PARTNERBANKNAME, FA.PAYMENTTYPE
			FROM DATA_ENGINE_CONFIG DC
			INNER JOIN DATA_ENGINE_STATUS DS ON DS.NAME = DC.NAME 
			INNER JOIN DISBURSEMENT_REQUESTS DR ON DR.BATCH_ID =DS.ID
      		INNER JOIN FINADVANCEPAYMENTS FA ON FA.PAYMENTID = DR.DISBURSEMENT_ID
			INNER JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = FA.PARTNERBANKID
      WHERE NOT EXISTS (SELECT ID FROM DATA_ENGINE_DOWNLOAD_HISTORY WHERE ID = DS.ID)
	  UNION ALL
	  SELECT DISTINCT(DS.ID), DC.NAME, DC.UPLOADPATH FILELOCATION, DS.FILENAME, DS.ENDTIME, DS.STATUS, 
			PB.ALWFILEDOWNLOAD,  PB.PARTNERBANKID, PB.PARTNERBANKCODE, PB.PARTNERBANKNAME, PI.PAYMENTTYPE
			FROM DATA_ENGINE_CONFIG DC
			INNER JOIN DATA_ENGINE_STATUS DS ON DS.NAME = DC.NAME 
			INNER JOIN DISBURSEMENT_REQUESTS DR ON DR.BATCH_ID =DS.ID
      		INNER JOIN PAYMENTINSTRUCTIONS PI ON PI.PAYMENTINSTRUCTIONID = DR.DISBURSEMENT_ID
			INNER JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = PI.PARTNERBANKID
      WHERE NOT EXISTS (SELECT ID FROM DATA_ENGINE_DOWNLOAD_HISTORY WHERE ID = DS.ID) ORDER BY ID DESC
	 </createView>
	</changeSet>
	
	<changeSet id="05" author="Durgaprasad G">
	 <createView viewName="INT_DISBURSEMENT_REQUEST_VIEW" replaceIfExists="true">
			   SELECT   
			   FA. PAYMENTID,
			   FA.FINREFERENCE,
			   '' CHANNEL, 
			   CASE WHEN FA.PAYMENTTYPE = 'NEFT' THEN 'N' WHEN FA.PAYMENTTYPE = 'RTGS' THEN 'R' WHEN FA.PAYMENTTYPE = 'DD' THEN 'D' WHEN FA.PAYMENTTYPE = 'CHEQUE' THEN 'C' ELSE  FA.PAYMENTTYPE END  DISBURSEMENT_TYPE,
			   FA.AMTTOBERELEASED/CCY.CCYMINORCCYUNITS  AMTTOBERELEASED,
			   FA.DISBDATE,
               FA.LLDATE,
			   FA.PAYABLELOC,
			   FA.PRINTINGLOC,
			   CU.CUSTCIF,            
			   CU.CUSTSHRTNAME,     
			   '' AS CUSTOMER_MOBILE,
			   CE.CUSTEMAIL       CUSTOMER_EMAIL,
			   CS.CPPROVINCENAME  CUSTOMER_STATE,
			   CC.PCCITYNAME      CUSTOMER_CITY,
			   ''                 CUSTOMER_ADDRESS1,
			   ''                 CUSTOMER_ADDRESS2,
			   ''                 CUSTOMER_ADDRESS3,
			   ''                 CUSTOMER_ADDRESS4,
			   ''                 CUSTOMER_ADDRESS5,
              BD.BANKNAME BANKNAME,
              BB.BRANCHCODE,
              BB.BRANCHDESC BRANCHDESC,
			  PBD.CPPROVINCENAME  BENFICIARY_BRANCH_STATE,
			  PBD.PCCITYNAME      BENFICIARY_BRANCH_CITY,
			   BB.MICR             MICR_CODE,
			   BB.IFSC             IFSC_CODE,
			   FA.BENEFICIARYACCNO,
			   CASE WHEN FA.PAYMENTTYPE = 'CHEQUE' OR  FA.PAYMENTTYPE = 'DD' THEN FA.LIABILITYHOLDNAME ELSE FA.BENEFICIARYNAME END BENEFICIARYNAME,
			   FA.PHONECOUNTRYCODE||FA.PHONEAREACODE||FA.PHONENUMBER AS BENEFICIARY_MOBILE, 
			   BCE.CUSTEMAIL        BENFICIRY_EMAIL,
			   BRS.CPPROVINCENAME  BENFICIARY_STATE,
			   BRC.PCCITYNAME      BENFICIARY_CITY,
			   ''                  BENFICIARY_ADDRESS1,
			   ''                  BENFICIARY_ADDRESS2,
			   ''                  BENFICIARY_ADDRESS3,
			   ''                  BENFICIARY_ADDRESS4,
			   ''                  BENFICIARY_ADDRESS5,
			   ''				   PAYMENT_DETAIL1,
			   ''                  PAYMENT_DETAIL2,
			   ''                  PAYMENT_DETAIL3,
			   ''                  PAYMENT_DETAIL4,
			   ''                  PAYMENT_DETAIL5,
			   ''                  PAYMENT_DETAIL6,
			   ''                  PAYMENT_DETAIL7,     
			   FA.STATUS           STATUS,
			   FA.DESCRIPTION      REMARKS,
			     FA.PAYMENTTYPE      PAYMENTTYPE,
			     FM.FINTYPE,
			     PB.PARTNERBANKID,
			     PB.PARTNERBANKCODE,
			     FA.INPUTDATE,
			     PB.ALWFILEDOWNLOAD,
                PB.FILENAME,
			     FM.FINISACTIVE
			   FROM FINADVANCEPAYMENTS FA
			   INNER JOIN FINANCEMAIN FM ON FM.FINREFERENCE = FA.FINREFERENCE
			   INNER JOIN CUSTOMERS CU ON CU.CUSTID = FM.CUSTID
			   INNER JOIN RMTCURRENCIES CCY ON CCY.CCYCODE = FA.DISBCCY
               INNER JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = FA.PARTNERBANKID
			   LEFT JOIN CUSTOMEREMAILS CE ON CE.CUSTID = CU.CUSTID AND CE.CUSTEMAILPRIORITY = 3
			   LEFT JOIN CUSTOMERADDRESSES CA ON CA.CUSTID = CE.CUSTID AND CA.CUSTADDRPRIORITY = 5
			   LEFT JOIN RMTPROVINCEVSCITY CC ON CC.PCCITY = CA.CUSTADDRCITY
			   LEFT JOIN RMTCOUNTRYVSPROVINCE CS ON CS.CPPROVINCE = CC.PCPROVINCE  
			   LEFT JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = FA.BANKBRANCHID
			   LEFT JOIN BMTBANKDETAIL BD ON BD.BANKCODE = BB.BANKCODE
         	   LEFT JOIN  (select PB.PARTNERBANKID, PBD.BANKNAME, PBB.BRANCHDESC, PBBRC.PCCITYNAME, PBBRS.CPPROVINCENAME from PARTNERBANKS PB INNER JOIN BANKBRANCHES PBB ON PBB.BANKBRANCHID = PB.BANKBRANCHCODE INNER JOIN BMTBANKDETAIL PBD ON PBD.BANKCODE = PBB.BANKCODE LEFT JOIN RMTPROVINCEVSCITY PBBRC ON PBBRC.PCCITY = PBB.CITY LEFT JOIN RMTCOUNTRYVSPROVINCE PBBRS ON PBBRS.CPPROVINCE = PBBRC.PCPROVINCE ) PBD ON PBD.PARTNERBANKID = PB.PARTNERBANKID
			   LEFT JOIN BENEFICIARY BR ON BR.BANKBRANCHID = FA.BANKBRANCHID AND BR.ACCNUMBER = FA.BENEFICIARYACCNO
			   LEFT JOIN CUSTOMERS BC ON BC.CUSTID = BR.CUSTID
			   LEFT JOIN CUSTOMEREMAILS BCE ON BCE.CUSTID = CU.CUSTID AND BCE.CUSTEMAILPRIORITY = 3
			   LEFT JOIN CUSTOMERADDRESSES BRCA ON BRCA.CUSTID = BR.CUSTID AND BRCA.CUSTADDRPRIORITY = 5
			   LEFT JOIN RMTPROVINCEVSCITY BRC ON BRC.PCCITY = BRCA.CUSTADDRCITY
			   LEFT JOIN RMTCOUNTRYVSPROVINCE BRS ON BRS.CPPROVINCE = BRC.PCPROVINCE
			   WHERE STATUS='APPROVED' AND PAYMENTID NOT IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS)
			   
			   UNION ALL
			   
			   SELECT PI. PAYMENTINSTRUCTIONID PAYMENTID,
			   PH.FINREFERENCE,
			   PH.PAYMENTTYPE CHANNEL, 
			   CASE WHEN PI.PAYMENTTYPE = 'NEFT' THEN 'N' WHEN PI.PAYMENTTYPE = 'RTGS' THEN 'R' WHEN PI.PAYMENTTYPE = 'DD' THEN 'D' WHEN PI.PAYMENTTYPE = 'CHEQUE' THEN 'C' ELSE  PI.PAYMENTTYPE END  DISBURSEMENT_TYPE,
			   PI.PAYMENTAMOUNT/CCY.CCYMINORCCYUNITS  AMTTOBERELEASED,
			   PI.POSTDATE DISBDATE, 
			   PI.POSTDATE LLDATE, 
			   PI.PAYABLELOC, 
			   PI.PRINTINGLOC, 
			   CU.CUSTCIF,            
			   CU.CUSTSHRTNAME,     
			   '' AS CUSTOMER_MOBILE,
			   CE.CUSTEMAIL       CUSTOMER_EMAIL,
			   CS.CPPROVINCENAME  CUSTOMER_STATE,
			   CC.PCCITYNAME      CUSTOMER_CITY,
			   ''                 CUSTOMER_ADDRESS1,
			   ''                 CUSTOMER_ADDRESS2,
			   ''                 CUSTOMER_ADDRESS3,
			   ''                 CUSTOMER_ADDRESS4,
			   ''                 CUSTOMER_ADDRESS5,
			   BD.BANKNAME,
			   BB.BRANCHCODE,
			   BB.BRANCHDESC,
			   BBRS.CPPROVINCENAME  BENFICIARY_BRANCH_STATE,
			   BBRC.PCCITYNAME      BENFICIARY_BRANCH_CITY,
			   BB.MICR              MICR_CODE,
			   BB.IFSC              IFSC_CODE,
			   PI.ACCOUNTNO BENEFICIARYACCNO,
			   CASE WHEN PI.PAYMENTTYPE = 'CHEQUE' OR  PI.PAYMENTTYPE = 'DD' THEN PI.FAVOURNAME ELSE PI.ACCTHOLDERNAME END BENEFICIARYNAME,
			   PI.PHONECOUNTRYCODE||PI.PHONENUMBER AS BENEFICIARY_MOBILE,
			   BCE.CUSTEMAIL       BENFICIRY_EMAIL,
			   BRS.CPPROVINCENAME  BENFICIARY_STATE,
			   BRC.PCCITYNAME      BENFICIARY_CITY,
			   ''                  BENFICIARY_ADDRESS1,
			   ''                  BENFICIARY_ADDRESS2,
			   ''                  BENFICIARY_ADDRESS3,
			   ''                  BENFICIARY_ADDRESS4,
			   ''                  BENFICIARY_ADDRESS5,
			   ''				   PAYMENT_DETAIL1,
			   ''                  PAYMENT_DETAIL2,
			   ''                  PAYMENT_DETAIL3,
			   ''                  PAYMENT_DETAIL4,
			   ''                  PAYMENT_DETAIL5,
			   ''                  PAYMENT_DETAIL6,
			   ''                  PAYMENT_DETAIL7,     
			   PI.STATUS           STATUS, 
			   PI.REMARKS          REMARKS,
			   PI.PAYMENTTYPE      PAYMENTTYPE,
			   FM.FINTYPE,
			   PB.PARTNERBANKID,
			   PB.PARTNERBANKCODE,
			   PI.POSTDATE INPUTDATE, 
			   PB.ALWFILEDOWNLOAD,
			   PB.FILENAME,
			   FM.FINISACTIVE
			   FROM PAYMENTINSTRUCTIONS PI 
			   INNER JOIN PAYMENTHEADER PH ON PH.PAYMENTID = PI.PAYMENTID
			   INNER JOIN FINANCEMAIN FM ON FM.FINREFERENCE = PH.FINREFERENCE
			   INNER JOIN CUSTOMERS CU ON CU.CUSTID = FM.CUSTID
			   INNER JOIN RMTCURRENCIES CCY ON CCY.CCYCODE = PI.PAYMENTCCY
			   INNER JOIN PARTNERBANKS PB ON PB.PARTNERBANKID = PI.PARTNERBANKID
			   LEFT JOIN CUSTOMEREMAILS CE ON CE.CUSTID = CU.CUSTID AND CE.CUSTEMAILPRIORITY = 3
			   LEFT JOIN CUSTOMERADDRESSES CA ON CA.CUSTID = CE.CUSTID AND CA.CUSTADDRPRIORITY = 5
			   LEFT JOIN RMTPROVINCEVSCITY CC ON CC.PCCITY = CA.CUSTADDRCITY
			   LEFT JOIN RMTCOUNTRYVSPROVINCE CS ON CS.CPPROVINCE = CC.PCPROVINCE
			   LEFT JOIN CUSTOMERPHONENUMBERS CM ON CM.PHONECUSTID = CU.CUSTID AND CM.PHONETYPECODE = 'MOBILE1' AND CM.PHONETYPEPRIORITY = 5  
			   LEFT JOIN BANKBRANCHES BB ON BB.BANKBRANCHID = PI.BANKBRANCHID
			   LEFT JOIN BMTBANKDETAIL BD ON BD.BANKCODE = BB.BANKCODE
			   LEFT JOIN RMTPROVINCEVSCITY BBRC ON BBRC.PCCITY = BB.CITY
			   LEFT JOIN RMTCOUNTRYVSPROVINCE BBRS ON BBRS.CPPROVINCE = BBRC.PCPROVINCE
			   LEFT JOIN BENEFICIARY BR ON BR.BANKBRANCHID = PI.BANKBRANCHID AND BR.ACCNUMBER = PI.ACCOUNTNO
			   LEFT JOIN CUSTOMERS BC ON BC.CUSTID = BR.CUSTID
			   LEFT JOIN CUSTOMEREMAILS BCE ON BCE.CUSTID = CU.CUSTID AND BCE.CUSTEMAILPRIORITY = 3
			   LEFT JOIN CUSTOMERADDRESSES BRCA ON BRCA.CUSTID = BR.CUSTID AND BRCA.CUSTADDRPRIORITY = 5
			   LEFT JOIN RMTPROVINCEVSCITY BRC ON BRC.PCCITY = BRCA.CUSTADDRCITY
			   LEFT JOIN RMTCOUNTRYVSPROVINCE BRS ON BRS.CPPROVINCE = BRC.PCPROVINCE
			   WHERE PI.STATUS='APPROVED' AND PI.PAYMENTINSTRUCTIONID NOT IN (SELECT DISBURSEMENT_ID FROM DISBURSEMENT_REQUESTS)
	 
	 
	 </createView>
	
	</changeSet>
</databaseChangeLog>