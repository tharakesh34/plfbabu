<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value="" dbms="oracle" />
	<property name="add.schema" value="" dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />


	 <changeSet id="pre_run_for_pgp" author="Adarsh" runAlways="true"
		dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>
	
	<changeSet id="1" author="Vinay">
		<sql>
			update FinanceDeviations set Module = 'ELIGIBILITY' where Module = 'EILIBILITY';
			update FinanceDeviations_Temp set Module = 'ELIGIBILITY' where Module = 'EILIBILITY';
		</sql>
	</changeSet>
	
	<changeSet id="2" author="Kesav">
		<comment>lovdescfindivision column added</comment>
		<createView viewName="finreceiptheader_fview" replaceIfExists="true">
			SELECT t1.receiptid, t1.receiptdate, t1.receipttype, t1.recagainst, t1.reference, t1.receiptpurpose, t1.receiptmode, t1.excessadjustto, t1.allocationtype, t1.receiptamount, t1.effectschdmethod, 
			 t1.receiptmodestatus, t1.version, t1.lastmntby, t1.lastmnton, t1.recordstatus, t1.rolecode, t1.nextrolecode, t1.taskid, t1.nexttaskid, t1.recordtype, t1.workflowid, t2.fintype, t2.finbranch, 
			 t3.custcif, t3.custshrtname, t2.finccy, t1.realizationdate, t1.cancelreason, t4.fintypedesc, t6.branchdesc AS finbranchdesc, t5.ccydesc AS finccydesc, t7.rejectdesc AS cancelreasondesc, 
			 t2.finisactive, t2.schedulemethod, t2.profitdaysbasis AS pftdaysbasis, t1.waviedamt, t3.custid, t1.totfeeamount, t1.bouncedate, t1.remarks, t1.rcdmaintainsts, t1.depositprocess, t1.depositbranch, 
			 t1.lpiamount, t1.lppamount, t1.gstlpiamount, t1.gstlppamount, t1.instructionuid, t4.findivision lovdescfindivision
			 FROM finreceiptheader_temp t1  
			 JOIN financemain_temp t2 ON t1.reference = t2.finreference 
			 JOIN customers t3 ON t2.custid = t3.custid 
			 JOIN rmtfinancetypes t4 ON t2.fintype = t4.fintype 
			 JOIN rmtcurrencies t5 ON t2.finccy = t5.ccycode 
			 JOIN rmtbranches t6 ON t2.finbranch = t6.branchcode 
			 LEFT JOIN bmtrejectcodes t7 ON t1.cancelreason = t7.rejectcode		
		</createView>
	</changeSet>
	
	<changeSet id="3" author="Kesav">
		<comment>lovdescfindivision column added</comment>
		<createView viewName="finreceiptheader_feview" replaceIfExists="true">
			SELECT t1.receiptid, t1.receiptdate, t1.receipttype, t1.recagainst, t1.reference, t1.receiptpurpose, t1.receiptmode, t1.excessadjustto, t1.allocationtype, t1.receiptamount, t1.effectschdmethod, 
			 t1.receiptmodestatus, t1.version, t1.lastmntby, t1.lastmnton, t1.recordstatus, t1.rolecode, t1.nextrolecode, t1.taskid, t1.nexttaskid, t1.recordtype, t1.workflowid, t2.fintype, t2.finbranch, 
			 t3.custcif, t3.custshrtname, t2.finccy, t1.realizationdate, t1.cancelreason, t4.fintypedesc, t6.branchdesc AS finbranchdesc, t5.ccydesc AS finccydesc, t7.rejectdesc AS cancelreasondesc, 
			 t2.finisactive, t2.schedulemethod, t2.profitdaysbasis AS pftdaysbasis, t1.waviedamt, t3.custid, t1.totfeeamount, t1.bouncedate, t1.remarks, t1.rcdmaintainsts, t1.depositprocess, 
			 t1.depositbranch, t1.lpiamount, t1.lppamount, t1.gstlpiamount, t1.gstlppamount, t1.instructionuid, t4.findivision lovdescfindivision
			FROM finreceiptheader_temp t1  
			JOIN financemain_temp t2 ON t1.reference = t2.finreference  
			JOIN customers t3 ON t2.custid = t3.custid  
			JOIN rmtfinancetypes t4 ON t2.fintype = t4.fintype 
			JOIN rmtcurrencies t5 ON t2.finccy = t5.ccycode 
			JOIN rmtbranches t6 ON t2.finbranch = t6.branchcode
			LEFT JOIN bmtrejectcodes t7 ON t1.cancelreason = t7.rejectcode
			
			UNION ALL
			
			SELECT t1.receiptid, t1.receiptdate, t1.receipttype, t1.recagainst, t1.reference, t1.receiptpurpose, t1.receiptmode, t1.excessadjustto, t1.allocationtype, t1.receiptamount, t1.effectschdmethod, 
			t1.receiptmodestatus, t1.version, t1.lastmntby, t1.lastmnton, t1.recordstatus, t1.rolecode, t1.nextrolecode, t1.taskid, t1.nexttaskid, t1.recordtype, t1.workflowid, t2.fintype, t2.finbranch, 
			t3.custcif, t3.custshrtname, t2.finccy, t1.realizationdate, t1.cancelreason, t4.fintypedesc, t6.branchdesc AS finbranchdesc, t5.ccydesc AS finccydesc, t7.rejectdesc AS cancelreasondesc, 
			t2.finisactive, t2.schedulemethod, t2.profitdaysbasis AS pftdaysbasis, t1.waviedamt, t3.custid, t1.totfeeamount, t1.bouncedate, t1.remarks, t1.rcdmaintainsts, t1.depositprocess, 
			t1.depositbranch, t1.lpiamount, t1.lppamount, t1.gstlpiamount, t1.gstlppamount, t1.instructionuid, t4.findivision lovdescfindivision
			FROM finreceiptheader t1
			JOIN (SELECT financemain_temp.finreference, financemain_temp.finbranch, financemain_temp.fintype, financemain_temp.finccy, financemain_temp.schedulemethod, financemain_temp.profitdaysbasis, 
							financemain_temp.finisactive, financemain_temp.custid 
				   FROM 	financemain_temp
				   UNION    
				   SELECT 	financemain.finreference, financemain.finbranch, financemain.fintype, financemain.finccy, financemain.schedulemethod, financemain.profitdaysbasis, financemain.finisactive,
							financemain.custid
				   FROM financemain) t2 ON t1.reference = t2.finreference  
				   JOIN customers t3 ON t2.custid = t3.custid  
				   JOIN rmtfinancetypes t4 ON t2.fintype = t4.fintype  
				   JOIN rmtcurrencies t5 ON t2.finccy = t5.ccycode  
				   JOIN rmtbranches t6 ON t2.finbranch = t6.branchcode  
				   LEFT JOIN bmtrejectcodes t7 ON t1.cancelreason = t7.rejectcode
			 WHERE NOT (EXISTS ( SELECT 1 FROM finreceiptheader_temp WHERE finreceiptheader_temp.receiptid = t1.receiptid))		
		</createView>
	</changeSet>
	
	<changeSet id="4" author="aditya.a">
	<sql>
		<![CDATA[
			update RMTFinanceTypes set TaxNoMand = 0 where TaxNoMand is null;
			update RMTFinanceTypes_temp set TaxNoMand = 0 where TaxNoMand is null;
		]]>
	</sql>
   </changeSet>
   <changeSet id="4.1" author="aditya.a">
	<addNotNullConstraint tableName="RMTFinanceTypes" columnName="TaxNoMand"/>
	<addNotNullConstraint tableName="RMTFinanceTypes_temp" columnName="TaxNoMand"/>
   </changeSet>

	<changeSet id="5" author="vijaykumar.L">
		<sql>
			alter table QUERYDETAIL alter column ASSIGNEDROLE varchar(100);
			alter table QUERYDETAIL_TEMP alter column ASSIGNEDROLE varchar(100);
		</sql>
	</changeSet>
   
</databaseChangeLog>