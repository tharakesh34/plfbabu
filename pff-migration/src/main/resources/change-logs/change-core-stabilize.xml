<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />

	<changeSet id="pre_run_for_pgp" author="satyanarayana.g" runAlways="true" dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>

	<changeSet id="1" author="satyanarayana.g">
		<addNotNullConstraint tableName="bmtdocumenttypes" columnName="docispdfextrequired" columnDataType="boolean" />
		<addNotNullConstraint tableName="bmtdocumenttypes_temp" columnName="docispdfextrequired" columnDataType="boolean" />
	</changeSet>

	<changeSet id="2" author="satyanarayana.g">
		<addNotNullConstraint tableName="PinCodes" columnName="serviceable" columnDataType="smallint" />
		<addNotNullConstraint tableName="PinCodes_temp" columnName="serviceable" columnDataType="smallint" />
	</changeSet>

	<changeSet id="3" author="satyanarayana.g">
		<dropNotNullConstraint tableName="customerempdetails_temp" columnName="custempname" columnDataType="bigint" />
		<dropNotNullConstraint tableName="customerempdetails" columnName="custempname" columnDataType="bigint" />
	</changeSet>

	<changeSet id="4" author="satyanarayana.g">
		<createView viewName="customerempdetails_view" replaceIfExists="true">
			SELECT ce.custempid,
		    ce.custid,
		    ce.custempname,
		    ce.custempfrom,
		    ce.custempto,
		    ce.custempdesg,
		    de.gendesgdesc lovdesccustempdesgname,
		    ce.custempdept,
		    dp.gendeptdesc lovdesccustempdeptname,
		    ce.custemptype,
		    et.emptypedesc lovdesccustemptypename,
		    ce.version,
		    ce.lastmntby,
		    ce.lastmnton,
		    ce.recordstatus,
		    ce.rolecode,
		    ce.nextrolecode,
		    ce.taskid,
		    ce.nexttaskid,
		    ce.recordtype,
		    ce.workflowid,
		    emp.empname lovdesccustempname,
		    ce.currentemployer,
		    ce.companyname
		   FROM ((((customerempdetails_temp ce
		     INNER JOIN rmtgendesignations de ON ((ce.custempdesg = de.gendesignation)))
		     LEFT JOIN rmtgendepartments dp ON ((ce.custempdept = dp.gendepartment)))
		     INNER JOIN rmtemptypes et ON ((ce.custemptype = et.emptype)))
		     LEFT JOIN employerdetail emp ON ((ce.custempname = emp.employerid)))
		UNION ALL
		 SELECT ce.custempid,
		    ce.custid,
		    ce.custempname,
		    ce.custempfrom,
		    ce.custempto,
		    ce.custempdesg,
		    de.gendesgdesc lovdesccustempdesgname,
		    ce.custempdept,
		    dp.gendeptdesc lovdesccustempdeptname,
		    ce.custemptype,
		    et.emptypedesc lovdesccustemptypename,
		    ce.version,
		    ce.lastmntby,
		    ce.lastmnton,
		    ce.recordstatus,
		    ce.rolecode,
		    ce.nextrolecode,
		    ce.taskid,
		    ce.nexttaskid,
		    ce.recordtype,
		    ce.workflowid,
		    emp.empname lovdesccustempname,
		    ce.currentemployer,
		    ce.companyname
		   FROM ((((customerempdetails ce
		     INNER JOIN rmtgendesignations de ON ((ce.custempdesg = de.gendesignation)))
		     LEFT JOIN rmtgendepartments dp ON ((ce.custempdept = dp.gendepartment)))
		     INNER JOIN rmtemptypes et ON ((ce.custemptype = et.emptype)))
		     LEFT JOIN employerdetail emp ON ((ce.custempname = emp.employerid)))
		  WHERE (NOT (EXISTS ( SELECT 1 AS expr1
		           FROM customerempdetails_temp
		          WHERE (customerempdetails_temp.custempid = ce.custempid))))
		</createView>
	</changeSet>
	<changeSet id="5" author="satyanarayana.g">
		<createView viewName="customerempdetails_aview" replaceIfExists="true">
			SELECT ce.custempid,
		    ce.custid,
		    ce.custempname,
		    ce.custempfrom,
		    ce.custempto,
		    ce.custempdesg,
		    de.gendesgdesc AS lovdesccustempdesgname,
		    ce.custempdept,
		    dp.gendeptdesc AS lovdesccustempdeptname,
		    ce.custemptype,
		    et.emptypedesc AS lovdesccustemptypename,
		    ce.version,
		    ce.lastmntby,
		    ce.lastmnton,
		    ce.recordstatus,
		    ce.rolecode,
		    ce.nextrolecode,
		    ce.taskid,
		    ce.nexttaskid,
		    ce.recordtype,
		    ce.workflowid,
		    emp.empname AS lovdesccustempname,
		    ce.currentemployer,
		    ce.companyname
		   FROM ((((customerempdetails ce
		     INNER JOIN rmtgendesignations de ON ((ce.custempdesg = de.gendesignation)))
		     LEFT JOIN rmtgendepartments dp ON ((ce.custempdept = dp.gendepartment)))
		     INNER JOIN rmtemptypes et ON ((ce.custemptype = et.emptype)))
		     LEFT JOIN employerdetail emp ON ((ce.custempname = emp.employerid)))
		</createView>
	</changeSet>

	<changeSet id="6" author="murthy.y">
		<createTable tableName="income_details_bk">
			<column name="id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="linkId" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="incomeType" type="varchar(8)">
				<constraints nullable="false" />
			</column>
			<column name="incomeExpense" type="varchar(8)">
				<constraints nullable="false" />
			</column>
			<column name="category" type="varchar(20)">
				<constraints nullable="false" />
			</column>
			<column name="income" type="number(18,0)">
				<constraints nullable="false" />
			</column>
			<column name="margin" type="number(18,0)">
				<constraints nullable="false" />
			</column>
			<column name="auxiliary1" type="varchar(10)" />
			<column name="auxiliary2" type="varchar(10)" />
			<column name="auxiliary3" type="varchar(10)" />
			<column name="auxiliary4" type="varchar(10)" />
			<column name="auxiliary5" type="varchar(10)" />
			<column name="Version" type="int">
				<constraints nullable="false" />
			</column>
			<column name="LastMntBy" type="bigint" />
			<column name="LastMntOn" type="datetime" />
			<column name="RecordStatus" type="varchar(50)" />
			<column name="RoleCode" type="varchar(100)" />
			<column name="NextRoleCode" type="varchar(200)" />
			<column name="TaskId" type="varchar(50)" />
			<column name="NextTaskId" type="varchar(200)" />
			<column name="RecordType" type="varchar(50)" />
			<column name="WorkflowId" type="bigint" />
		</createTable>
	</changeSet>

	<changeSet id="7" author="murthy.y">
		<sql>
			<![CDATA[
				insert into income_details_bk select * from income_details;
			]]>
		</sql>
	</changeSet>

	<changeSet id="8_pre" author="murthy.y" dbms="postgresql">
		<sql>
			select deps_save_and_drop_dependencies('plf','income_details');
		</sql>
	</changeSet>

	<changeSet id="8" author="murthy.y">
		<dropTable tableName="income_details" />
	</changeSet>

	<changeSet id="8.1" author="murthy.y">
		<renameTable newTableName="income_details" oldTableName="income_details_bk" />
	</changeSet>

	<changeSet id="8_post" author="murthy.y" dbms="postgresql">
		<sql>
			select deps_restore_dependencies('plf','income_details');
		</sql>
	</changeSet>

	<changeSet id="8.2_pre" author="murthy.y" dbms="postgresql">
		<sql>
			select deps_save_and_drop_dependencies('plf','income_details');
		</sql>
	</changeSet>

	<changeSet id="8.2" author="murthy.y" dbms="postgresql">
		<modifyDataType tableName="income_details" columnName="incomeType" newDataType="citext" />
		<modifyDataType tableName="income_details" columnName="incomeExpense" newDataType="citext" />
		<modifyDataType tableName="income_details" columnName="category" newDataType="citext" />
	</changeSet>

	<changeSet id="8.2_post" author="murthy.y" dbms="postgresql">
		<sql>
			select deps_restore_dependencies('plf','income_details');
		</sql>
	</changeSet>
</databaseChangeLog>