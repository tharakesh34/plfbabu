<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />
	
	<changeSet id="01" author="Irfan">
<renameColumn tableName="RMTACCOUNTTYPES" oldColumnName="gSTApplicable" newColumnName="taxApplicable"/>
<renameColumn tableName="RMTACCOUNTTYPES" oldColumnName="hSNNumber" newColumnName="aCCADDLVAR1"/>
<renameColumn tableName="RMTACCOUNTTYPES" oldColumnName="natureService" newColumnName="aCCADDLVAR2"/>
<renameColumn tableName="RMTACCOUNTTYPES" oldColumnName="revChrgApplicable" newColumnName="aCCADDLCHAR1"/>
<renameColumn tableName="RMTACCOUNTTYPES_TEMP" oldColumnName="gSTApplicable" newColumnName="taxApplicable"/>
<renameColumn tableName="RMTACCOUNTTYPES_TEMP" oldColumnName="hSNNumber" newColumnName="aCCADDLVAR1"/>
<renameColumn tableName="RMTACCOUNTTYPES_TEMP" oldColumnName="natureService" newColumnName="aCCADDLVAR2"/>
<renameColumn tableName="RMTACCOUNTTYPES_TEMP" oldColumnName="revChrgApplicable" newColumnName="aCCADDLCHAR1"/>
</changeSet>
<changeSet id="02" author="Irfan">
<addColumn tableName="RMTACCOUNTTYPES">
	<column name="aCCADDLVAR3" type="varchar(50)"/>
	<column name="aCCADDLVAR4" type="varchar(50)"/>
</addColumn>
<addColumn tableName="RMTACCOUNTTYPES_TEMP">
	<column name="aCCADDLVAR3" type="varchar(50)"/>
	<column name="aCCADDLVAR4" type="varchar(50)"/>
</addColumn>

</changeSet>

<changeSet id="03" author="Irfan">
	<createView viewName="RMTACCOUNTTYPES_VIEW" replaceIfExists="true">
	
	SELECT    T1.AcType, T1.AcTypeDesc,  T1.AcPurpose, T1.AcHeadCode, T1.InternalAc, T1.CustSysAc, 
			  T1.AcLmtCategory, T1.AcTypeIsActive,T1.ProfitCenterID,T1.CostCenterID, T1.TaxApplicable,  T1.ACCADDLVAR1, T1.ACCADDLVAR2, T1.ACCADDLCHAR1,
			  T1.ACCADDLVAR3, T1.ACCADDLVAR4, T1.Version, T1.LastMntBy, T1.LastMntOn, T1.RecordStatus, T1.RoleCode,
			 T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,T1.AssertOrLiability,
			 T1.OnBalanceSheet,T1.AllowOverDraw,T1.AcTypeGrpId,T2.GroupCode,T2.GroupDescription,T2.AcctTypeLevel,
			 T4.ProfitCenterCode,T4.ProfitCenterDesc,T3.CostCenterCode,T3.CostCenterDesc
			 FROM         RMTAccountTypes_Temp T1 Left Join
									AccountTypeGroup T2 ON T1.AcTypeGrpId=T2.GroupId INNER JOIN
											ProfitCenters T4 ON T1.ProfitCenterID = T4.ProfitCenterID
											LEFT JOIN
											CostCenters T3 ON T1.CostCenterID = T3.CostCenterID 
			 UNION ALL
			SELECT    T1.AcType, T1.AcTypeDesc,  T1.AcPurpose, T1.AcHeadCode, T1.InternalAc, T1.CustSysAc, 
			T1.AcLmtCategory, T1.AcTypeIsActive, T1.ProfitCenterID,T1.CostCenterID, T1.TaxApplicable,  T1.ACCADDLVAR1, T1.ACCADDLVAR2, T1.ACCADDLCHAR1,
			 T1.ACCADDLVAR3, T1.ACCADDLVAR4,T1.Version, T1.LastMntBy, T1.LastMntOn, T1.RecordStatus, T1.RoleCode,
			 T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,T1.AssertOrLiability,
			 T1.OnBalanceSheet,T1.AllowOverDraw,T1.AcTypeGrpId,T2.GroupCode,T2.GroupDescription,T2.AcctTypeLevel,
			 T4.ProfitCenterCode,T4.ProfitCenterDesc,T3.CostCenterCode,T3.CostCenterDesc
			 FROM         RMTAccountTypes T1 Left Join
									AccountTypeGroup T2 ON T1.AcTypeGrpId=T2.GroupId INNER JOIN
											ProfitCenters T4 ON T1.ProfitCenterID = T4.ProfitCenterID
											LEFT JOIN
											CostCenters T3 ON T1.CostCenterID = T3.CostCenterID 
			 WHERE     (NOT EXISTS
			 (SELECT     1 Expr1
			 FROM          RMTAccountTypes_Temp
			 WHERE      (AcType = T1.AcType)))
	
	</createView>

</changeSet>

<changeSet id="04" author="Irfan">
	<createView viewName="RMTACCOUNTTYPES_AVIEW" replaceIfExists="true">
		SELECT    T1.AcType, T1.AcTypeDesc, T1.AcPurpose, T1.AcHeadCode, T1.InternalAc, T1.CustSysAc, 
		T1.AcLmtCategory, T1.AcTypeIsActive, T1.ProfitCenterID, T1.CostCenterID, T1.TaxApplicable,  T1.ACCADDLVAR1, T1.ACCADDLVAR2, T1.ACCADDLCHAR1, 
		T1.ACCADDLVAR3, T1.ACCADDLVAR4, T1.Version, T1.LastMntBy, T1.LastMntOn, T1.RecordStatus, T1.RoleCode,
					 T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,T1.AssertOrLiability,
		       T1.OnBalanceSheet,T1.AllowOverDraw,T1.AcTypeGrpId,T2.GroupCode,T2.GroupDescription,T2.AcctTypeLevel,
		       T4.ProfitCenterCode,T4.ProfitCenterDesc,T3.CostCenterCode,T3.CostCenterDesc
					 FROM         RMTAccountTypes T1 Left Join
											AccountTypeGroup T2 ON T1.AcTypeGrpId=T2.GroupId 
											INNER JOIN
											ProfitCenters T4 ON T1.ProfitCenterID = T4.ProfitCenterID
											LEFT JOIN
											CostCenters T3 ON T1.CostCenterID = T3.CostCenterID
	
	</createView>

</changeSet>
	
	
	
		
	<changeSet id="1" author="Vinay">
		<createTable tableName="TAXDETAIL_TEMP">
			<column name="ID" type="bigint">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="COUNTRY" type="char(2)">
                        <constraints nullable="false"/>
                        </column>
			<column name="STATECODE" type="varchar(8)">
                        <constraints nullable="false" />
                        </column>
			<column name="ENTITYCODE" type="varchar(8)">
                        <constraints nullable="false" />
                        </column>
			<column name="TAXCODE" type="varchar(100)">
                        <constraints nullable="false" />
                        </column>
			<column name="ADDRESSLINE1" type="varchar(100)">
                        <constraints nullable="false" />
                        </column>
                        <column name="ADDRESSLINE2" type="varchar(100)"/>
			<column name="ADDRESSLINE3" type="varchar(100)"/>
                        <column name="ADDRESSLINE4" type="varchar(100)"/>
			<column name="PINCODE" type="varchar(10)">
                        <constraints nullable="false" />
                        </column>
                        <column name="CITYCODE" type="varchar(50)">
                        <constraints nullable="false" />
                        </column>
			<column name="Version" type="NUMBER(10,0)" />
			<column name="Lastmntby" type="NUMBER(19,0)" />
			<column name="Lastmnton" type="datetime" />
			<column name="Recordstatus" type="nvarchar(50)" />
			<column name="Rolecode" type="nvarchar(50)" />
			<column name="Nextrolecode" type="nvarchar(200)" />
			<column name="Taskid" type="nvarchar(50)" />
			<column name="Nexttaskid" type="nvarchar(200)" />
			<column name="Recordtype" type="nvarchar(50)" />
			<column name="Workflowid" type="NUMBER(19,0)" />
			
		</createTable>
	</changeSet>
	
	<changeSet id="2" author="Vinay">
		<addUniqueConstraint columnNames="TAXCODE"
			constraintName="UK_TAXCODE" deferrable="true" disabled="true"
			initiallyDeferred="true" tableName="TAXDETAIL_TEMP" />
	</changeSet>
	
	<changeSet id="3" author="Vinay">
		<addForeignKeyConstraint constraintName="FK_COUNTRY_TAXDETAIL_TEMP"
			referencedTableName="BMTCountries" referencedColumnNames="CountryCode"
			baseTableName="TAXDETAIL_TEMP" baseColumnNames="COUNTRY" />
	</changeSet>
	
	<changeSet id="4" author="Vinay">
		<addForeignKeyConstraint constraintName="FK_STATECODE_TAXDETAIL_TEMP"
			referencedTableName="RMTCountryVsProvince" referencedColumnNames="CPProvince"
			baseTableName="TAXDETAIL_TEMP" baseColumnNames="STATECODE" />
	</changeSet>
	
	<changeSet id="5" author="Vinay">
		<addForeignKeyConstraint constraintName="FK_ENTITYCODE_TAXDETAIL_TEMP"
			referencedTableName="Entities" referencedColumnNames="EntityCode"
			baseTableName="TAXDETAIL_TEMP" baseColumnNames="ENTITYCODE" />
	</changeSet>
	
	<changeSet id="6" author="Vinay">
		<addForeignKeyConstraint constraintName="FK_CITYCODE_TAXDETAIL_TEMP"
			referencedTableName="RMTProvinceVsCity" referencedColumnNames="PCCITY"
			baseTableName="TAXDETAIL_TEMP" baseColumnNames="CITYCODE" />
	</changeSet>
	
	<changeSet id="7" author="Vinay">
	<createView viewName="TAXDETAIL_AView" replaceIfExists="true">

SELECT		T1.Id, T1.Country,T2.CountryDesc CountryName, T1.StateCode, T3.CPProvinceName ProvinceName, T1.EntityCode, T4.EntityDesc EntityDesc ,T1.TaxCode, T1.AddressLine1, T1.AddressLine2, T1.AddressLine3, T1.AddressLine4, T1.PinCode, T1.CityCode,T6.PCCITYNAME CityName	
			, T1.Version , T1.LastMntBy, T1.LastMntOn,T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId
FROM    	TAXDETAIL  T1 INNER JOIN
BMTCountries  T2 ON T1.Country = T2.CountryCode  INNER JOIN
RMTCountryVsProvince T3 ON T1.StateCode = T3.CPProvince INNER JOIN
Entities T4 ON T1.EntityCode = T4.EntityCode INNER JOIN
PinCodes T5 ON T1.PinCode = T5.PinCode INNER JOIN
RMTProvinceVsCity T6 ON T1.CityCode = T6.PCCITY

</createView>
</changeSet>


<changeSet id="9" author="Vinay">
<createView viewName="TAXDETAIL_View" replaceIfExists="true">

SELECT		T1.Id, T1.Country,T2.CountryDesc CountryName, T1.StateCode, T3.CPProvinceName ProvinceName, T1.EntityCode, T4.EntityDesc EntityDesc ,T1.TaxCode, T1.AddressLine1, T1.AddressLine2, T1.AddressLine3, T1.AddressLine4, T1.PinCode, T1.CityCode,T6.PCCITYNAME CityName	
			, T1.Version , T1.LastMntBy, T1.LastMntOn,T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId
FROM    	TAXDETAIL_TEMP  T1 INNER JOIN
BMTCountries  T2 ON T1.Country = T2.CountryCode  INNER JOIN
RMTCountryVsProvince T3 ON T1.StateCode = T3.CPProvince INNER JOIN
Entities T4 ON T1.EntityCode = T4.EntityCode INNER JOIN
PinCodes T5 ON T1.PinCode = T5.PinCode INNER JOIN
RMTProvinceVsCity T6 ON T1.CityCode = T6.PCCITY

UNION ALL

SELECT		T1.Id, T1.Country,T2.CountryDesc CountryName, T1.StateCode, T3.CPProvinceName ProvinceName, T1.EntityCode, T4.EntityDesc EntityDesc ,T1.TaxCode, T1.AddressLine1, T1.AddressLine2, T1.AddressLine3, T1.AddressLine4, T1.PinCode, T1.CityCode,T6.PCCITYNAME CityName	
			, T1.Version , T1.LastMntBy, T1.LastMntOn,T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId
FROM    	TAXDETAIL  T1 INNER JOIN
BMTCountries  T2 ON T1.Country = T2.CountryCode  INNER JOIN
RMTCountryVsProvince T3 ON T1.StateCode = T3.CPProvince INNER JOIN
Entities T4 ON T1.EntityCode = T4.EntityCode INNER JOIN
PinCodes T5 ON T1.PinCode = T5.PinCode INNER JOIN
RMTProvinceVsCity T6 ON T1.CityCode = T6.PCCITY

WHERE     NOT EXISTS (SELECT 1 FROM TAXDETAIL_TEMP WHERE Id = T1.Id)
</createView>
</changeSet>
	<changeSet id="10" author="Vinay" dbms="oracle">	
   		<sql splitStatements="false">
     		 begin
              execute immediate 'CREATE SEQUENCE SeqTAXDETAIL START WITH 1 INCREMENT BY 1 MAXVALUE 9223372036854775807 NOCYCLE';  
     		 end;  
     	 </sql>
 	</changeSet>
 
 	<changeSet id="11" author="Vinay" dbms="postgresql">	
   		<sql splitStatements="false">
   			do $$
			 begin
  		 execute 'CREATE SEQUENCE SeqTAXDETAIL START  1 INCREMENT BY 1 ';  
			 end;  
			$$;
	    </sql>
 	</changeSet>
 
 	<changeSet id="12" author="Vinay" dbms="mssql">
		<sql splitStatements="false">
			CREATE TABLE SeqTAXDETAIL(
			SeqNo 				bigint IDENTITY(1,1) NOT NULL,
			Value 				int NOT NULL
			);	
		</sql>
	</changeSet>
</databaseChangeLog>