<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />

		
<changeSet id="01" author="DurgaPrasad G">			
	<createTable tableName="DATA_ENGINE_PROCESS_LOG">
		<column name="ID" type="bigint">
		 	<constraints primaryKey="true" nullable="false" />
		 </column>
		 <column name="REFID" type="bigint"/>
		 <column name="REFNO" type="varchar(50)"/>
		  <column name="CATEGORY" type="char(10)">
		 	<constraints nullable="false" />
		 </column>
		  <column name="STATUS" type="char(1)">
		 	<constraints nullable="false" />
		 </column>
		 <column name="REASON" type="varchar(1000)"/>
		  <column name="FILEID" type="bigint">
		 	<constraints nullable="false" />
		 </column>
		  <column name="PROCESSEDON" type="datetime">
		 	<constraints nullable="false" />
		 </column>
		  <column name="PROCESSEDBY" type="bigint">
		 	<constraints nullable="false" />
		 </column>
		 <column name="VALUEDATE" type="datetime">
		 	<constraints nullable="false" />
		 </column>
		  <column name="AddField1" type="varchar(1000)"/>
		  <column name="AddField2" type="varchar(1000)"/>
		  <column name="AddField3" type="varchar(1000)"/>
		  <column name="AddField4" type="varchar(1000)"/>
		  <column name="AddField5" type="datetime"/>
		  <column name="AddField6" type="datetime"/>
		  <column name="AddField7" type="datetime"/>
		  <column name="AddField8" type="datetime"/>
	</createTable>
</changeSet>

<changeSet id="02" author="DurgaPrasad G">
		<addForeignKeyConstraint constraintName="FK_DEPL_ID"
			referencedTableName="DATA_ENGINE_STATUS" referencedColumnNames="ID"
			baseTableName="DATA_ENGINE_PROCESS_LOG" baseColumnNames="FILEID" />
</changeSet>


<changeSet  id="03" author="DurgaPrasad G">
    <renameColumn   newColumnName="REFERENCECOLUMN"  oldColumnName="PARENTNAME"  tableName="DATA_ENGINE_COLUMN"/>
</changeSet>

<changeSet  id="04" author="Pruthvi">
<createTable tableName="DEDUP_EOD_CUST_DEMO_DTL">	
			
			<column name="BATCHID" type="decimal(12,0)">
				<constraints nullable="false" />
			</column>
			 <column name="CUSTOMERNO" type="decimal(8,0)"/>
	        <column name="SOURCESYSID" type="varchar(5)"/>
			<column name="FIRSTNAME" type="varchar(90)"/>
			<column name="MIDDLENAME" type="varchar(90)"/>
			<column name="LASTNAME" type="varchar(90)"/>
			<column name="DOB" type="datetime"/>
			<column name="PAN" type="varchar(30)"/>
			<column name="DRIVINGLICENSENUMBER" type="varchar(45)"/>
			<column name="VOTERID" type="varchar(20)"/>
			<column name="DATEOFINCORPORATION" type="datetime"/>
			<column name="TANNO" type="varchar(15)"/>					
			<column name="PROCESSTYPE" type="varchar(2)">
				<constraints nullable="false" />
			</column>
			<column name="APPLICANTTYPE" type="varchar(1)">
				<constraints nullable="false" />
			</column>
			 <column name="EMPOYERNAME" type="varchar(105)"/>
			<column name="FATHERNAME" type="varchar(105)"/>
			<column name="PASSPORTNO" type="varchar(45)"/>
			<column name="ACCOUNTNUMBER" type="varchar(20)"/>
			<column name="CREDITCARDNUMBER" type="varchar(60)"/>
			<column name="PROCESSFLAG" type="varchar(1)">
			<constraints nullable="false" />
			</column>
			<column name="ERRORCODE" type="varchar(1)"/>
			<column name="ERRORDESC" type="varchar(100)"/>
			<column name="CUSTOMERID" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="SOURCESYSTEM" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="PSXBATCHID" type="decimal(18,0)"/>
			<column name="UCINFLAG" type="varchar(10)"/>
			<column name="EODBATCHID" type="decimal(18,0)"/>
			<column name="INSERTTS" type="datetime">
			<constraints nullable="false" />
			</column>			
			 <column name="GENDER" type="varchar(20)"/>
			<column name="AADHARNO" type="varchar(12)"/>
			<column name="CIN" type="varchar(100)"/>
			<column name="DIN" type="varchar(20)"/>
			<column name="REGISTRATIONNO" type="varchar(20)"/>
			<column name="CANUMBER" type="varchar(100)"/>
			<column name="SEGMENT" type="varchar(5)">
			<constraints nullable="false" />
			</column>
			</createTable>
		

<createTable tableName="DEDUP_EOD_CUST_ADDR_DTL">		
			<column name="BATCHID" type="decimal(12,0)">
			<constraints nullable="false" />
			</column>
			<column name="CUSTOMERNO" type="decimal(8,0)"/>
			<column name="SOURCESYSID" type="varchar(5)">
			<constraints nullable="false" />
			</column>
			<column name="SEGMENT" type="varchar(5)">
			<constraints nullable="false" />
			</column>
			<column name="ADDRESSTYPE" type="varchar(24)">
			<constraints nullable="false" />
			</column>
			<column name="ADDRESS1" type="varchar(255)">
			<constraints nullable="false" />
			</column>
			<column name="ADDRESS2" type="varchar(255)"/>
			<column name="ADDRESS3" type="varchar(255)"/>
			
			<column name="STATE" type="varchar(100)">
			<constraints nullable="false" />
			</column>
			<column name="CITY" type="varchar(105)">
			<constraints nullable="false" />
			</column>
			<column name="PIN" type="varchar(24)">
			<constraints nullable="false" />
			</column>
			
			<column name="LANDLINE1" type="varchar(48)"/>
			<column name="LANDLINE2" type="varchar(48)"/>
			<column name="MOBILE" type="varchar(105)"/>
			<column name="AREA" type="varchar(120)"/>
			
			<column name="LANDMARK" type="varchar(105)"/>
			<column name="STD" type="varchar(48)"/>
			<column name="PROCESSTYPE" type="varchar(2)"/>
			<column name="EMAIL" type="varchar(105)"/>
			
			<column name="PROCESSFLAG" type="varchar(1)">
			<constraints nullable="false" />
			</column>
			<column name="ERRORCODE" type="varchar(1)"/>
			<column name="ERRORDESC" type="varchar(100)"/>
			<column name="CUSTOMERID" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="SOURCESYSTEM" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="PSXBATCHID" type="decimal(18,0)"/>
			<column name="EODBATCHID" type="decimal(18,0)"/>
			
</createTable>	


<createTable tableName="PUSH_PULL_CONTROL_T">	
<column name="BATCHID" type="decimal(12,0)">
			<constraints nullable="false" />
			</column>
			<column name="STATUS" type="varchar(1)">
			<constraints nullable="false" />
			</column>
			<column name="INSERTTIMESTAMP" type="datetime">
			<constraints nullable="false" />
			</column>
			<column name="COMPLETIONTIMESTAMP" type="datetime"/>
			<column name="ERRDESCRIPTION" type="varchar(500)"/>
			<column name="ERRORCODE" type="varchar(500)"/>
</createTable>	

<createTable tableName="DEDUP_EOD_CUST_LOAN_DTL">	

<column name="BATCHID" type="decimal(12,0)">
			<constraints nullable="false" />
			</column>
			<column name="CUSTOMERNO" type="decimal(8,0)"/>
			<column name="SOURCESYSID" type="varchar(5)">
			<constraints nullable="false" />
			</column>
			<column name="SEGMENT" type="varchar(5)">
			<constraints nullable="false" />
			</column>
			<column name="DEALID" type="varchar(20)"/>
			<column name="LANNO" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="CUSTOMERTYPE" type="varchar(1)">
			<constraints nullable="false" />
			</column>
			<column name="APPLNNO" type="decimal(10,0)">
			<constraints nullable="false" />
			</column>
			<column name="PRODUCTCODE" type="varchar(10)">
			<constraints nullable="false" />
			</column>
			<column name="PROCESSTYPE" type="varchar(2)">
			<constraints nullable="false" />
			</column>
			<column name="PROCESSFLAG" type="varchar(1)">
			<constraints nullable="false" />
			</column>
			<column name="ERRORCODE" type="varchar(1)"/>
			<column name="ERRORDESC" type="varchar(100)"/>
			<column name="PSXBATCHID" type="decimal(18,0)"/>
			<column name="PSXID" type="decimal(12,0)"/>
			<column name="CUSTOMERID" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="SOURCESYSTEM" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="EODBATCHID" type="decimal(18,0)"/>
</createTable>	


<createTable tableName="DEDUP_EOD_CUST_REP_DTL">
<column name="BATCHID" type="decimal(12,0)">
			<constraints nullable="false" />
			</column>
			<column name="SOURCESYSID" type="varchar(5)">
			<constraints nullable="false" />
			</column>
			<column name="CUSTOMERID" type="varchar(20)">
			<constraints nullable="false" />
			</column>
			<column name="FILLERSTRING1" type="varchar(255)">
			<constraints nullable="false" />
			</column>
			<column name="FILLERSTRING2" type="varchar(255)"/>
			<column name="FILLERSTRING3" type="varchar(255)"/>
			<column name="FILLERSTRING4" type="varchar(255)"/>
			<column name="FILLERSTRING5" type="varchar(255)"/>
			<column name="FILLERDATE1" type="datetime"/>
			<column name="FILLERDATE2" type="datetime"/>
			
			<column name="FILLERNUMBER1" type="decimal(16,0)"/>
			<column name="FILLERNUMBER2" type="decimal(16,0)"/>
			<column name="FILLERNUMBER3" type="decimal(16,0)"/>
			<column name="FILLERNUMBER4" type="decimal(16,0)"/>
			<column name="FILLERNUMBER5" type="decimal(16,0)"/>
			
			<column name="PSXBATCHID" type="decimal(18,0)"/>
			<column name="PSXID" type="decimal(12,0)"/>
			<column name="SOURCESYSTEM" type="varchar(20)"/>
			<column name="EODBATCHID" type="decimal(18,0)"/>
			<column name="FILLERSTRING6" type="varchar(255)"/>
			<column name="FILLERSTRING7" type="varchar(255)"/>
			<column name="FILLERSTRING8" type="varchar(255)"/>
			<column name="PROCESSTYPE" type="varchar(2)"/>
			<column name="FILLERSTRING9" type="varchar(255)"/>

</createTable>	

<createTable tableName="POSIDEXCUSTUPDATE">
<column name="CUSTOMERNO" type="decimal(8,0)"/>
<column name="DATASOURCE" type="varchar(3)"/>
<column name="UCINNO" type="varchar(20)">
<constraints nullable="false" />
			</column>
<column name="SEGMENT" type="varchar(5)">
<constraints nullable="false" />
			</column>
<column name="BATCHID" type="varchar(12)"/>
<column name="BASETYPEFLAG" type="varchar(20)">
<constraints nullable="false" />
			</column>
<column name="PSXBATCHID" type="decimal(18,0)"/>
<column name="PROCESSEDFLAG" type="varchar(1)">
<constraints nullable="false" />
			</column>
<column name="CUSTOMERID" type="varchar(20)"/>
<column name="SOURCESYSID" type="decimal"/>
</createTable>
</changeSet>

<changeSet  id="06.1" author="Pruthvi">
<createTable tableName="Disbursement_Payment_Details">
<column name="HeaderBatchID" type="decimal(10,0)">
<constraints nullable="false" />
			</column>
<column name="DisbursementReference" type="decimal(10,0)">
<constraints nullable="false" />
			</column>
			<column name="PaymentType" type="varchar(8)"/>
			<column name="BankCode" type="varchar(8)"/>
			<column name="DisbursementAmount" type="decimal(18,0)">
<constraints nullable="false" />
			</column>
			<column name="InstrumentNumber" type="varchar(12)"/>
				<column name="TransactionDate" type="datetime">
<constraints nullable="false" />
			</column>
			<column name="BankReferenceNumber" type="varchar(50)">
<constraints nullable="false" />
			</column>
			<column name="OtherReferenceNumber" type="varchar(50)"/>
			<column name="TransactionStatus" type="varchar(1)"/>
			<column name="RejectReason" type="varchar(100)"/>
			<column name="BeneficaryCode" type="varchar(14)"/>
			<column name="BeneficaryAccountNo" type="varchar(25)"/>
			<column name="BeneficaryName" type="varchar(200)"/>
			<column name="PaymentRemarks1" type="varchar(30)"/>
			<column name="PaymentRemarks2" type="varchar(30)"/>
			<column name="PaymentRemarks3" type="varchar(30)"/>
			<column name="PaymentRemarks4" type="varchar(30)"/>
			<column name="IFSCCode" type="varchar(15)"/>
			<column name="MICRCode" type="varchar(15)"/>
			<column name="PLFStatus" type="varchar(1)"/>
			<column name="PLFRejectReason" type="varchar(100)"/>
</createTable>

<createTable tableName="Interface_Header">
	<column name="HeaderID" type="decimal(10,0)">
<constraints nullable="false" />
			</column>
				<column name="InterfaceCategory" type="varchar(1)">
<constraints nullable="false" />
			</column>
				<column name="InterfaceType" type="varchar(20)">
<constraints nullable="false" />
			</column>
				<column name="FileName" type="varchar(50)">
<constraints nullable="false" />
			</column>
				<column name="ConfigID" type="bigint">
<constraints nullable="false" />
			</column>
			<column name="Status" type="varchar(1)"/>
			<column name="NoofRecordsProcessed" type="decimal(20,0)"/>
			<column name="InputTime" type="datetime"/>
			<column name="ProcessedTime" type="datetime"/>

</createTable>
</changeSet>

<changeSet  id="06" author="Pruthvi" dbms="mssql">
<createView viewName="INT_ALM_VIEW" replaceIfExists="true">
select Right(F.FinReference,8) AGREEMENTID,F.ApplicationNo AGREEMENTNO,F.FinType PRODUCTFLAG,'' NPA_STAGEID ,
(FP.TotalPriBal+Fp.TotalPftBal)/CcyMinorCcyUnits INSTLAMT,FP.TotalPriBal/CcyMinorCcyUnits PRINCOMP,Fp.TotalPftBal/CcyMinorCcyUnits INTCOMP,Fp.FirstRepayDate DUEDATE,
Fp.AccruePft/CcyMinorCcyUnits ACCRUEDAMT,'' ACCRUEDON,Fp.AccruePft/CcyMinorCcyUnits CUMULATIVE_ACCRUAL_AMT,'N' ADVFLAG
from FinanceMain F
Inner join FinPftDetails FP on Fp.FinReference=F.FinReference
Inner Join RMTCurrencies RC on RC.CcyCode=F.FinCcy
</createView>
</changeSet>
<changeSet  id="06" author="Pruthvi" dbms="oracle">
<createView viewName="INT_ALM_VIEW" replaceIfExists="true">
select substr(F.FinReference,length(F.FinReference)-7,length(F.FinReference)) AGREEMENTID,F.ApplicationNo AGREEMENTNO,F.FinType PRODUCTFLAG,'' NPA_STAGEID ,
(FP.TotalPriBal+Fp.TotalPftBal)/CcyMinorCcyUnits INSTLAMT,FP.TotalPriBal/CcyMinorCcyUnits PRINCOMP,Fp.TotalPftBal/CcyMinorCcyUnits INTCOMP,Fp.FirstRepayDate DUEDATE,
Fp.AccruePft/CcyMinorCcyUnits ACCRUEDAMT,'' ACCRUEDON,Fp.AccruePft/CcyMinorCcyUnits CUMULATIVE_ACCRUAL_AMT,'N' ADVFLAG
from FinanceMain F
Inner join FinPftDetails FP on Fp.FinReference=F.FinReference
Inner Join RMTCurrencies RC on RC.CcyCode=F.FinCcy
</createView>
</changeSet>
<changeSet id="07" author="Madhubabu" dbms="mssql">
<sql>
	alter table finadvancepayments add paymentid bigint	
</sql>
</changeSet>
<changeSet id="07.1" author="Madhubabu" dbms="mssql">
<sql splitStatements="false">
Update finadvancepayments set paymentid = row_num from (	
	Select ROW_NUMBER () over(order by finreference,Paymentseq)row_num,finreference,Paymentseq from finadvancepayments)T
	where T.finreference = finadvancepayments.finreference and T.Paymentseq=finadvancepayments.Paymentseq;
	
	alter table finadvancepayments alter column paymentid bigint not null;
	
	Declare @ex bigint;
			Set  @ex =(Select MAX(paymentid)+1  from finadvancepayments);	
		CREATE TABLE SEQADVPAYMENT(
			SeqNo 				bigint IDENTITY(1,1) NOT NULL,
			Value 				int NOT NULL
			);	
		Exec('DBCC CHECKIDENT(''SEQADVPAYMENT'', RESEED,'+@ex+' )');
		</sql>
</changeSet>
<changeSet id="07" author="Madhubabu" dbms="postgresql">
		<sql>
			 alter table finadvancepayments add paymentid bigint;
	
	Update finadvancepayments set paymentid = row_num from (	
	Select ROW_NUMBER () over(order by finreference,Paymentseq)row_num,finreference,Paymentseq from finadvancepayments)T
	where T.finreference = finadvancepayments.finreference and T.Paymentseq=finadvancepayments.Paymentseq;
	
	alter table finadvancepayments alter column paymentid bigint not null;
		</sql>
	</changeSet>
		<changeSet id="07.1" author="Madhubabu" dbms="postgresql">	
   		<sql splitStatements="false">
   			do $$
			 declare ex integer;
			 begin
			
			  Select MAX(paymentid)+1 from finadvancepayments into ex;
			 execute 'CREATE SEQUENCE SEQADVPAYMENT START  ' || ex || ' INCREMENT BY 1 ';  
			 end;  
			$$;
     	</sql>
     	</changeSet>
     	
	
	<changeSet id="07" author="Madhubabu" dbms="oracle">
		<sql>
			 alter table finadvancepayments add paymentid number(19,0);
	
		Update finadvancepayments m set paymentid = (Select row_num from ((Select ROW_NUMBER () over(order by finreference,Paymentseq)row_num,finreference,Paymentseq from finadvancepayments)) T
	where T.finreference = m.finreference and T.Paymentseq=m.Paymentseq) where exists (select 1 from finadvancepayments T
  where T.finreference = m.finreference and T.Paymentseq=m.Paymentseq);
	
	alter table finadvancepayments modify column paymentid not null;
		</sql>
	</changeSet>
		<changeSet id="07.1" author="Madhubabu" dbms="oracle">	
   		<sql splitStatements="false">   			
			 declare ex integer;
			 begin
			
			  Select MAX(paymentid)+1 into ex from finadvancepayments;
			 execute 'CREATE SEQUENCE SEQADVPAYMENT START WITH ' || ex || ' INCREMENT BY 1 MAXVALUE 9223372036854775807 NOCYCLE';  
			 end;  			
     	</sql>
     	</changeSet>
</databaseChangeLog>
