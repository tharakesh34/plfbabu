<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value="" dbms="oracle" />
	<property name="add.schema" value="" dbms="postgresql" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PLFAVANSEQC.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()" dbms="postgresql" />


	<changeSet id="pre_run_for_pgp" author="Adarsh" runAlways="true" dbms="postgresql">
		<sql>
			Set search_path = plf,public,pg_catalog;
		</sql>
	</changeSet>

	<changeSet id="1" author="vijaya.a">
		<comment>commodity file upload</comment>
			<sql>
			<![CDATA[
				DELETE FROM DATA_ENGINE_LOG WHERE ID IN (SELECT ID FROM DATA_ENGINE_STATUS WHERE NAME ='COLLETARAL_VALUE_UPDATE');
				DELETE FROM DATA_ENGINE_DOWNLOAD_HISTORY WHERE ID IN (SELECT ID FROM DATA_ENGINE_STATUS WHERE NAME ='COLLETARAL_VALUE_UPDATE');
				DELETE FROM DATA_ENGINE_STATUS WHERE NAME ='COLLETARAL_VALUE_UPDATE';

				DELETE FROM DATA_ENGINE_COLUMN where TABLEID IN (select ID from DATA_ENGINE_TABLE WHERE CONFIGID = (select ID from DATA_ENGINE_CONFIG where Name = 'COLLETARAL_VALUE_UPDATE'));
				DELETE FROM DATA_ENGINE_TABLE where CONFIGID IN (select ID from DATA_ENGINE_CONFIG where Name = 'COLLETARAL_VALUE_UPDATE');
				DELETE FROM DATA_ENGINE_CONFIG where Name = 'COLLETARAL_VALUE_UPDATE';

				INSERT INTO DATA_ENGINE_CONFIG VALUES ((SELECT COALESCE(MAX(ID), 0) + 1 FROM DATA_ENGINE_CONFIG), 'COLLETARAL_VALUE_UPDATE', 'Colletaral value update', 12, 'Colletaral', NULL, NULL, NULL , 0, 0, NULL, 'HSNCode,  CurrentValue, CommodityType, Code, Description', '', 'A', 'D:/Colletaral/Values', 'COLLETARAL_', '.xls', 0, NULL, '${ddMMYYYYHms}', NULL, 0, NULL, 1, 1); 
				INSERT INTO DATA_ENGINE_TABLE  VALUES ((SELECT COALESCE(MAX(ID), 0) + 1 FROM DATA_ENGINE_TABLE), (Select Id FROM DATA_ENGINE_CONFIG WHERE Name = 'COLLETARAL_VALUE_UPDATE'), 'COLLETARAL_VALUES',  0, '', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, 0, 0);

				INSERT INTO DATA_ENGINE_COLUMN VALUES ((SELECT COALESCE(MAX(ID), 0) + 1 FROM DATA_ENGINE_COLUMN), (Select Id FROM DATA_ENGINE_TABLE WHERE Name = 'COLLETARAL_VALUES' and CONFIGID = (Select Id FROM DATA_ENGINE_CONFIG WHERE Name = 'COLLETARAL_VALUE_UPDATE')), 'HSNCode', 0, 'N', NULL, NULL, NULL, NULL, 0, NULL, NULL, NULL, NULL, 'M');
  				INSERT INTO DATA_ENGINE_COLUMN VALUES ((SELECT COALESCE(MAX(ID), 0) + 1 FROM DATA_ENGINE_COLUMN), (Select Id FROM DATA_ENGINE_TABLE WHERE Name = 'COLLETARAL_VALUES' and CONFIGID = (Select Id FROM DATA_ENGINE_CONFIG WHERE Name = 'COLLETARAL_VALUE_UPDATE')), 'CurrentValue', 0, 'N', NULL, NULL, NULL, NULL, 1, NULL, NULL, NULL, NULL, 'M');
				INSERT INTO DATA_ENGINE_COLUMN VALUES ((SELECT COALESCE(MAX(ID), 0) + 1 FROM DATA_ENGINE_COLUMN), (Select Id FROM DATA_ENGINE_TABLE WHERE Name = 'COLLETARAL_VALUES' and CONFIGID = (Select Id FROM DATA_ENGINE_CONFIG WHERE Name = 'COLLETARAL_VALUE_UPDATE')), 'CommodityType', 0, 'N', NULL, NULL, NULL, NULL, 2, NULL, NULL, NULL, NULL, 'O');	
				INSERT INTO DATA_ENGINE_COLUMN VALUES ((SELECT COALESCE(MAX(ID), 0) + 1 FROM DATA_ENGINE_COLUMN), (Select Id FROM DATA_ENGINE_TABLE WHERE Name = 'COLLETARAL_VALUES' and CONFIGID = (Select Id FROM DATA_ENGINE_CONFIG WHERE Name = 'COLLETARAL_VALUE_UPDATE')), 'Code', 0, 'N', NULL, NULL, NULL, NULL, 3, NULL, NULL, NULL, NULL, 'O');
				INSERT INTO DATA_ENGINE_COLUMN VALUES ((SELECT COALESCE(MAX(ID), 0) + 1 FROM DATA_ENGINE_COLUMN), (Select Id FROM DATA_ENGINE_TABLE WHERE Name = 'COLLETARAL_VALUES' and CONFIGID = (Select Id FROM DATA_ENGINE_CONFIG WHERE Name = 'COLLETARAL_VALUE_UPDATE')), 'Description', 0, 'N', NULL, NULL, NULL, NULL, 4, NULL, NULL, NULL, NULL, 'O');

				UPDATE SEQ_DATA_ENGINE_CONFIG SET SeqNo=(Select coalesce(MAX(ID), 1) FROM DATA_ENGINE_CONFIG);
				UPDATE SEQ_DATA_ENGINE_TABLE  SET SeqNo=(Select coalesce(MAX(ID), 1) FROM DATA_ENGINE_TABLE);
				UPDATE SEQ_DATA_ENGINE_COLUMN SET SeqNo=(Select coalesce(MAX(ID), 1) FROM DATA_ENGINE_COLUMN);
			]]>
			</sql>
	</changeSet>
	
	<changeSet id="2" author="vijaya.a">
		<addUniqueConstraint tableName="Commodities" columnNames="HSNCode" />
	</changeSet>
	
	<changeSet id="2.1" author="vijaya.a">
		<addUniqueConstraint tableName="Commodities_Temp" columnNames="HSNCode" />
	</changeSet>
	
	<changeSet id="2.2" author="vijaya.a">
		<addUniqueConstraint tableName="Commodities" columnNames="CommodityType, Code, HSNCode" />
	</changeSet>
	
	<changeSet id="2.3" author="vijaya.a">
		<addUniqueConstraint tableName="Commodities_Temp" columnNames="CommodityType, Code, HSNCode" />
	</changeSet>
	
	
	
</databaseChangeLog>