<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />


	<changeSet id="1" author="Prasad">
	<comment>Data mart Loan wise repayment scheudle view</comment>
	<createView viewName="DM_LOANWISE_REPAYSCHEDULE_VIEW  " replaceIfExists="true">	 
	 SELECT T1.FINREFERENCE AGREEMENTNO,${call.substr}(T1.FINREFERENCE,9,${call.collength}(T1.FINREFERENCE)) AGREEMENTID,
		${call.substr}(T1.FINREFERENCE,9,${call.collength}(T1.FINREFERENCE))${call.concatenate}T2.INSTNUMBER PROPINSTLID,T2.INSTNUMBER EMI_NO,T2.SCHDATE DUEDATE,
		T2.BALANCEFORPFTCAL/CCYMINORCCYUNITS  OPENING_PRINCIPAL,
		T2.REPAYAMOUNT/CCYMINORCCYUNITS  INSTALMENT_AMT,
		T2.PRINCIPALSCHD/CCYMINORCCYUNITS  PRINCIPAL_AMT,
		T2.PROFITSCHD/CCYMINORCCYUNITS  INTEREST_AMT,
		T2.CLOSINGBALANCE/CCYMINORCCYUNITS  CLOSING_PRINCIPAL,T2.SCHDMETHOD INSTAL_TYPE,
		NULL TOTAL_AMOUNT_DUE,
		T1.FINASSETVALUE/CCYMINORCCYUNITS DROPLINE_LIMIT,
		(FINASSETVALUE-FINCURRASSETVALUE)/CCYMINORCCYUNITS ACT_AVAILABLE_LIMIT,
		FP.TOTALPRISCHD/CCYMINORCCYUNITS ACT_UTILISATION_LIMIT,CASE WHEN BPIORHOLIDAY='H' THEN 'Y' ELSE 'N' END EMI_HOLIDAY,
		NULL BATCH_ID,
		NULL BUSINESSDATE
		FROM FINANCEMAIN T1
		INNER JOIN FINPFTDETAILS FP ON T1.FINREFERENCE=FP.FINREFERENCE
		INNER JOIN FINSCHEDULEDETAILS T2 ON T1.FINREFERENCE=T2.FINREFERENCE
		INNER JOIN RMTCURRENCIES RC ON RC.CCYCODE= T1.FINCCY
    WHERE DISBONSCHDATE=0 and repayamount>0
	</createView>
	</changeSet>
	<changeSet id="2" author="Jayant" dbms="oracle">
	    <createProcedure>
	        CREATE OR REPLACE PROCEDURE SP_INVALIDVIEWS IS
	        begin 
         FOR cur IN (SELECT OBJECT_NAME, OBJECT_TYPE
         			 FROM USER_OBJECTS
         			 WHERE object_type in ('PACKAGE','FUNCTION','PROCEDURE','TRIGGER','VIEW','SYNONYM')
         			 AND status = 'INVALID' ) LOOP 
         	BEGIN
		         if cur.OBJECT_TYPE = 'PACKAGE BODY' then 
		         	EXECUTE IMMEDIATE 'alter ' || cur.OBJECT_TYPE || ' "' || cur.OBJECT_NAME || '" compile body'; 
		         else 
		         	EXECUTE IMMEDIATE 'alter ' || cur.OBJECT_TYPE || ' "' || cur.OBJECT_NAME || '" compile'; 
		         end if; 
			EXCEPTION
  				WHEN OTHERS THEN NULL; 
			END;
         end loop; 
         end;
	    </createProcedure>
	</changeSet>
	<changeSet id="3.1" author="murthy.y">
		<dropView viewName="INT_ALM_VIEW"/>
	</changeSet>
	<changeSet id="3.2" author="murthy.y">
		<dropView viewName="INT_CF_CONTROL_VIEW"/>
	</changeSet>
	<changeSet id="3.3" author="murthy.y">
		<dropView viewName="INT_DISBURSEMENT_EXPORT_VIEW"/>
	</changeSet>
	<changeSet id="3.4" author="murthy.y">
		<dropView viewName="INT_POSIDEX_UPDATE_EOD_VIEW"/>
	</changeSet>
	<changeSet id="3.5" author="murthy.y">
		<dropView viewName="INTERFACE_MANDATE_REG_VIEW"/>
	</changeSet>
	
	<changeSet id="4.1" author="murthy.y">
		<addColumn tableName="DATA_ENGINE_COLUMN">
        	<column name="CONSTRAINTTYPE" type="varchar(100)" defaultValue="O"/>
    	</addColumn>
	</changeSet>
	<changeSet id="4.2" author="murthy.y">
		<sql>
			<![CDATA[
				update DATA_ENGINE_COLUMN set CONSTRAINTTYPE = 'M' 
				where TABLEID IN (select ID from DATA_ENGINE_TABLE 
				where CONFIGID IN (select ID from data_engine_config 
				where Name = 'DISB_HDFC_IMPORT')) and Name = 'STATUS';
			]]>
		</sql>
	</changeSet>
		<changeSet id="4" author="Jayant"  dbms="oracle">
	    <sql splitStatements="false">
	        begin
	        	SP_INVALIDVIEWS;
	        	RESEED_SEQUENCE_TABLES;
	        end;
	    </sql>
	</changeSet>


<changeSet id="5" author="Prakash">
		<addColumn tableName="ReportFilterFields">
			<column name="FilterFileds" type="VARCHAR2(300 BYTE)" />
		</addColumn>
</changeSet>

	<changeSet id="6" author="Prakash">
		<createView replaceIfExists="true" viewName="ReportFilterFields_View">
	           SELECT     T1.ReportId, T1.FieldID, T1.FieldName, T1.FieldType, T1.FieldLabel, T1.FieldDBName, T1.AppUtilMethodName, 
                      T1.ModuleName, T1.LovHiddenFieldMethod, T1.LovTextFieldMethod, T1.MultiSelectSearch, 
                      T1.FieldLength, T1.FieldMaxValue, T1.FieldMinValue, T1.SeqOrder, T1.Mandatory, 
                      T1.FieldConstraint, T1.FieldErrorMessage, T1.WhereCondition, T1.StaticValue, T1.FieldWidth,
                       T1.FilterRequired, T1.DefaultFilter, T1.Version, T1.LastMntBy, T1.LastMntOn, T1.RecordStatus,
                        T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,T1.filterFileds
				FROM         ReportFilterFields T1
	      
</createView>
</changeSet>
</databaseChangeLog>