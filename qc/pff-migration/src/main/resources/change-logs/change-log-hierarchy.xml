<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
         
        <changeSet author="shinde.b" id="1">
				<createTable tableName="ClusterHierarchey">
		            <column name="entity" type="varchar(8)">
						<constraints primaryKey="true" nullable="false" primaryKeyName="PK_CLUSTRHRCHY_ENTTY"/>
					</column>
					<column name="clusterType" type="varchar(20)">
						<constraints primaryKey="true" nullable="false" />
					</column>
					<column name="seqOrder" type="int">
						<constraints  nullable="false"/>
					</column>	
					<column name="Version" type="int" />
					<column name="LastMntBy" type="bigint" />
					<column name="LastMntOn" type="datetime" />
					<column name="RecordStatus" type="varchar(50)" /> 
					<column name="RoleCode" type="varchar(100)" />
					<column name="NextRoleCode" type="varchar(200)" />
					<column name="TaskId" type="varchar(50)" />
					<column name="NextTaskId" type="varchar(200)" />
					<column name="RecordType" type="varchar(50)" />
					<column name="WorkflowId" type="bigint" />
				</createTable>
	  </changeSet>
	  <changeSet id="2" author="shinde.b" dbms="postgresql">
	  	<modifyDataType tableName="ClusterHierarchey" columnName="entity" newDataType="citext"/>
	  </changeSet>
    <changeSet author="shinde.b" id="3">
		<addForeignKeyConstraint constraintName="FK_CH_Entity"
			baseTableName="ClusterHierarchey" baseColumnNames="entity"
			referencedColumnNames="entitycode" referencedTableName="entities" />
	</changeSet>
     <changeSet id="4" author="shinde.b">
           <addUniqueConstraint columnNames="entity,seqOrder" tableName="ClusterHierarchey"/>
	 </changeSet>
    <changeSet id="5"  author="shinde.b">
          <sql> 
                INSERT INTO SecGroups SELECT (select (SeqNo+1) from SeqSecGroups), 'CLUSTERHIERARCHEY_VIEW', 'Allow to view ClusterHierarchey', 0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroups WHERE 0=0;
				INSERT INTO SecGroups SELECT (select (SeqNo+2) from SeqSecGroups), 'CLUSTERHIERARCHEY_MAKER', 'WF Maker for ClusterHierarchey', 0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroups WHERE 0=0;
				INSERT INTO SecGroups SELECT (select (SeqNo+3) from SeqSecGroups), 'CLUSTERHIERARCHEY_APPROVER', 'WF Approver for ClusterHierarchey', 0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroups WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+1) from SeqSecRights),0,'menuCat_ApplicationMaster','MENU',0,1000,'2018-11-21  12:36:26','Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+2) from SeqSecRights),0,'menuCat_ApplicationMasterEnquiry','MENU',0,1000,'2018-11-21  12:36:26','Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+3) from SeqSecRights),0,'menuItem_ApplicationMaster_ClusterHierarchey','MENU',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+4) from SeqSecRights),0,'menuItem_ApplicationMaster_ClusterHierarcheyEnquiry','MENU',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+5) from SeqSecRights),2,'button_ClusterHierarcheyList_PrintList','ClusterHierarcheyList',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+6) from SeqSecRights),2,'button_ClusterHierarcheyList_NewClusterHierarchey','ClusterHierarcheyList',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+7) from SeqSecRights),2,'button_ClusterHierarcheyDialog_btnNew','ClusterHierarcheyDialog',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+8) from SeqSecRights),2,'button_ClusterHierarcheyDialog_btnEdit','ClusterHierarcheyDialog',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+9) from SeqSecRights),2,'button_ClusterHierarcheyDialog_btnDelete','ClusterHierarcheyDialog',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+10) from SeqSecRights),2,'button_ClusterHierarcheyDialog_btnSave','ClusterHierarcheyDialog',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+10+1) from SeqSecRights),3,'ClusterHierarcheyDialog_Entity','ClusterHierarcheyDialog',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+10+2) from SeqSecRights),3,'ClusterHierarcheyDialog_ClusterType','ClusterHierarcheyDialog',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecRights SELECT (select (SeqNo+10+3) from SeqSecRights),3,'ClusterHierarcheyDialog_seqOrder','ClusterHierarcheyDialog',0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+1) from SeqSecGroupRights), (select (SeqNo+1) from SeqSecGroups), (select max(RightID) from SecRights WHERE RightName='menuCat_ApplicationMasterEnquiry'),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+2) from SeqSecGroupRights), (select (SeqNo+1) from SeqSecGroups), (select (SeqNo+4) from SeqSecRights),1,0,10000,current_timestamp,' ',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+3) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select max(RightID) from SecRights WHERE RightName='menuCat_ApplicationMaster'),1,0,10000,current_timestamp,' ',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+4) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select (SeqNo+3) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+5) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select (SeqNo+6) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+6) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select (SeqNo+9) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+7) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select (SeqNo+10) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+8+1) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select (SeqNo+10+1) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+8+2) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select (SeqNo+10+2) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+8+3) from SeqSecGroupRights), (select (SeqNo+2) from SeqSecGroups), (select (SeqNo+10+3) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+9+3) from SeqSecGroupRights), (select (SeqNo+3) from SeqSecGroups), (select max(RightID) from SecRights WHERE RightName='menuCat_ApplicationMaster'),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+10+3) from SeqSecGroupRights), (select (SeqNo+3) from SeqSecGroups), (select (SeqNo+3) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				INSERT INTO SecGroupRights SELECT (select (SeqNo+11+3) from SeqSecGroupRights), (select (SeqNo+3) from SeqSecGroups), (select (SeqNo+10) from SeqSecRights),1,0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecGroupRights WHERE 0=0;
				update SeqSecGroupRights set SeqNo = (SeqNo+11+3) ;
				INSERT INTO SecRoleGroups SELECT (select (SeqNo+1) from SeqSecRoleGroups), (select (SeqNo+2) from SeqSecGroups), (select roleid from SecRoles where RoleCd='MSTGRP1_MAKER'), 0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRoleGroups WHERE 0=0;
				INSERT INTO SecRoleGroups SELECT (select (SeqNo+2) from SeqSecRoleGroups), (select (SeqNo+3) from SeqSecGroups), (select roleid from SecRoles where RoleCd='MSTGRP1_APPROVER'), 0,1000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0 FROM SeqSecRoleGroups WHERE 0=0;
				update SeqSecRoleGroups set SeqNo = (SeqNo+2) ;
				INSERT INTO PTMenuDetails SELECT (select (SeqNo+1) from SeqPTMenuDetails),(SELECT AppID FROM PTApplicationDetails WHERE AppCode='PFS'),'ClusterHierarchey','menu_Item_ClusterHierarchey','/WEB-INF/pages/ApplicationMaster/ClusterHierarchey/ClusterHierarcheyList.zul',0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0,'menuItem_ApplicationMaster_ClusterHierarchey' FROM SeqPTMenuDetails WHERE 0=0;
				INSERT INTO PTMenuDetails SELECT (select (SeqNo+2) from SeqPTMenuDetails),(SELECT AppID FROM PTApplicationDetails WHERE AppCode='PFS'),'ClusterHierarcheyEnquiry','menu_Item_ClusterHierarcheyEnquiry?enqiryModule=Y" ','/WEB-INF/pages/ApplicationMaster/ClusterHierarchey/ClusterHierarcheyEnquiryList.zul',0,10000,current_timestamp,'Approved',' ',' ',' ',' ',' ',0,'menuItem_ApplicationMaster_ClusterHierarchey' FROM SeqPTMenuDetails WHERE 0=0;
				update SeqPTMenuDetails set SeqNo = (SeqNo+2) ;
				update SeqSecGroups set SeqNo = (SeqNo+3) ;
				update SeqSecRights set SeqNo = (SeqNo+10+3) ;
              </sql>
       </changeSet>
    <changeSet id="6" author="shinde.b">
        <createTable tableName="ClusterHierarchey_Temp">
			<column name="Entity" type="varchar(8)"/>
			<column name="ClusterType" type="varchar(20)"/>
			<column name="seqOrder" type="int"/>
			<column name="version" type="int"/>
			<column name="lastmntby" type="bigint"/>
			<column name="lastmnton" type="datetime"/>
			<column name="recordstatus" type="varchar(50)"/>
			<column name="rolecode" type="varchar(100)"/>
			<column name="nextrolecode" type="varchar(200)"/>
			<column name="taskid" type="varchar(50)"/>
			<column name="nexttaskid" type="varchar(200)"/>
			<column name="recordtype" type="varchar(50)"/>
			<column name="workflowid" type="bigint">
				<constraints nullable="false"/>
			</column>
       </createTable>
  </changeSet>
     <changeSet id="7" author="shinde.b">
       <createView viewName="ClusterHierarchey_AView" replaceIfExists="true">
		SELECT	T1.Entity, T1.ClusterType, T1.seqOrder		
					, T1.Version , T1.LastMntBy, T1.LastMntOn,T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId
		FROM  ClusterHierarchey T1 
     </createView>
		</changeSet>
			<changeSet id="11.3" author="shinde.b">
			<createView viewName="ClusterHierarchey_View" replaceIfExists="true">
			SELECT	T1.Entity, T1.ClusterType, T1.seqOrder		
						, T1.Version , T1.LastMntBy, T1.LastMntOn,T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId
			FROM   ClusterHierarchey_Temp T1 
			UNION ALL
			
			SELECT	T1.Entity, T1.ClusterType, T1.seqOrder		
						, T1.Version , T1.LastMntBy, T1.LastMntOn,T1.RecordStatus, T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId
			FROM   ClusterHierarchey T1 
			WHERE  NOT EXISTS (SELECT 1 FROM ClusterHierarchey_TEMP WHERE Entity = T1.Entity)
		</createView>
	 </changeSet>
	</databaseChangeLog>