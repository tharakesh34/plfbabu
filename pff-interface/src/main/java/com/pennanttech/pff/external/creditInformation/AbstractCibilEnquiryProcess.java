package com.pennanttech.pff.external.creditInformation;

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.net.InetSocketAddress;
import java.net.Socket;
import java.net.SocketAddress;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.DecimalFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Objects;
import java.util.Properties;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.time.DateUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.RowCallbackHandler;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.zkoss.json.JSONArray;

import com.jayway.jsonpath.JsonPath;
import com.jayway.jsonpath.PathNotFoundException;
import com.pennant.app.util.SysParamUtil;
import com.pennant.backend.model.audit.AuditHeader;
import com.pennant.backend.model.customermasters.Customer;
import com.pennant.backend.model.customermasters.CustomerAddres;
import com.pennant.backend.model.customermasters.CustomerDetails;
import com.pennant.backend.model.customermasters.CustomerDocument;
import com.pennant.backend.model.customermasters.CustomerPhoneNumber;
import com.pennant.backend.model.extendedfield.ExtendedFieldHeader;
import com.pennant.backend.model.extendedfield.ExtendedFieldRender;
import com.pennant.backend.model.finance.FinanceDetail;
import com.pennant.backend.model.finance.FinanceMain;
import com.pennant.backend.model.finance.JointAccountDetail;
import com.pennant.backend.model.solutionfactory.ExtendedFieldDetail;
import com.pennant.backend.util.PennantConstants;
import com.pennanttech.logging.model.InterfaceLogDetail;
import com.pennanttech.pennapps.core.App;
import com.pennanttech.pennapps.core.resource.Literal;
import com.pennanttech.pennapps.core.util.DateUtil;
import com.pennanttech.pennapps.jdbc.search.Filter;
import com.pennanttech.pennapps.jdbc.search.Search;
import com.pennanttech.pennapps.jdbc.search.SearchProcessor;
import com.pennanttech.pff.InterfaceConstants;
import com.pennanttech.pff.dao.CreditInterfaceDAO;
import com.pennanttech.pff.external.AbstractInterface;
import com.pennanttech.pff.external.CreditInformation;
import com.pennanttech.pff.external.util.StaticListUtil;
import com.pennanttech.pff.logging.dao.InterfaceLoggingDAO;
import com.pennanttech.pff.model.cibil.CibilMemberDetail;

public class AbstractCibilEnquiryProcess extends AbstractInterface implements CreditInformation {
	private static final Logger logger = LogManager.getLogger(AbstractCibilEnquiryProcess.class);

	JSONObject jsonObject;
	JSONObject primaryApplicant;
	JSONObject secondaryApplicant;
	JSONObject cd;
	JSONArray cdetails;
	@Autowired(required = false)
	CibilResponseDetails responseDetails;

	@Autowired
	SearchProcessor searchProcessor;

	private CibilMemberDetail memberDetails;
	private String CBIL_ENQUIRY_SCORE_TYPE;
	private Map<String, String> parameters = new HashMap<>();
	private Map<String, String> cibilStateCodes = new HashMap<>();
	private Map<String, String> cibilStateCodesForRequest = new HashMap<>();
	private Map<String, String> cibilIdTypes = new HashMap<>();
	private Map<String, String> cibilIdTypesForRequest = new HashMap<>();
	private Map<String, String> cibilPhoneTypes = new HashMap<>();
	private Map<String, String> cibilloanTypes = new HashMap<>();
	private Map<String, String> cibilOccupationTypes = StaticListUtil.getCibilOccupationCode();
	private Map<String, String> cibilIncomeIndicator = StaticListUtil.getCibilIncomeIndicator();
	private Map<String, String> cibilMonthlyAnnualIncomeIndicator = StaticListUtil
			.getCibilMonthlyAnnualIncomeIndicator();
	private Map<String, String> cibilAddrCategory = StaticListUtil.getCibilAddrCategory();
	private Map<String, String> cibilResidenceCode = StaticListUtil.getCibilResidenceCode();
	private Map<String, String> cibilOwnershipTypes = StaticListUtil.getCibilOnwerShipTypes();
	private Map<String, String> cibilPaymentFreqTypes = StaticListUtil.getCibilPaymentFreqTypes();
	private final String responseSize = "1";
	@Autowired(required = false)
	private InterfaceLoggingDAO interfaceLoggingDAO;
	private BigDecimal cibilDefaultLoanAmt = BigDecimal.valueOf(999999999);

	@Autowired(required = false)
	private CreditInterfaceDAO creditInterfaceDao;
	private final String extConfigFileName = "RetailCibilConsumer.properties";
	private boolean cibil_Button;
	private int noOfAccountsIn30dpdL12M = 0;
	private int noOfAccountsIn1dpdL6M = 0;

	private boolean amountOverdue = false;

	public AbstractCibilEnquiryProcess() {
		super();
	}

	/**
	 * Method to get the CIBIL details of the Customer and set these details to ExtendedFieldDetails.
	 * 
	 * @param auditHeader
	 * @return auditHeader
	 * @throws Exception
	 */
	@Override
	public AuditHeader getCreditEnquiryDetails(AuditHeader auditHeader, boolean isFromCustomer) throws Exception {
		logger.debug(Literal.ENTERING);

		String cibilReq = SysParamUtil.getValueAsString("CBIL_PROCESS_REQ");

		if ("N".equals(cibilReq)) {
			return auditHeader;
		}

		Customer customer = null;
		FinanceDetail financeDetail = null;
		CustomerDetails customerDetails = null;

		if (isFromCustomer) {
			customerDetails = (CustomerDetails) auditHeader.getAuditDetail().getModelData();
			customer = customerDetails.getCustomer();
		} else {
			financeDetail = (FinanceDetail) auditHeader.getAuditDetail().getModelData();
			customerDetails = financeDetail.getCustomerDetails();
			customer = customerDetails.getCustomer();
		}

		loadParameters();
		loadAccountTypes();
		loadCibilStateCodes();
		loadCibilStateCodesforRequest();
		loadCibilIdTypes();
		loadCibilIdTypesforRequest();
		loadCibilPhoneTypes();
		loadCibilLoanTypes();
		cibil_Button = false;

		if (StringUtils.equals("RETAIL", customer.getCustCtgCode())) {
			// Check score for primary applicant.
			processRetailCustomer(financeDetail, customerDetails, false);
		}

		// Check score for co-applicants.
		getCoAppCustomer(financeDetail);

		return auditHeader;
	}

	/**
	 * Method to get the CIBIL details of the Customer and set these details to ExtendedFieldDetails.
	 * 
	 * @param auditHeader
	 * @return auditHeader
	 * @throws Exception
	 */
	@Override
	public CustomerDetails procesCreditEnquiry(CustomerDetails customerDetails, FinanceMain financeMain,
			boolean override) throws Exception {
		logger.debug(Literal.ENTERING);

		try {

			String cibilReq = SysParamUtil.getValueAsString("CBIL_PROCESS_REQ");

			if ("N".equals(cibilReq)) {
				customerDetails.setCibilExecuted(false);
				return customerDetails;
			}

			Customer customer = null;
			customer = customerDetails.getCustomer();
			loadParameters();
			loadAccountTypes();
			loadCibilStateCodes();
			loadCibilStateCodesforRequest();
			loadCibilIdTypes();
			loadCibilIdTypesforRequest();
			loadCibilPhoneTypes();
			loadCibilLoanTypes();
			cibil_Button = true;

			if (StringUtils.equals("RETAIL", customer.getCustCtgCode())) {

				Timestamp reqSentOn = new Timestamp(System.currentTimeMillis());
				Map<String, Object> appplicationdata = new HashMap<>();
				String builder = prepareRequest(financeMain, customerDetails, customer.getCustCIF(), reqSentOn,
						appplicationdata);

				if (builder == null) {
					customerDetails.setCibilExecuted(false);
					return customerDetails;
				}

				StringBuilder tableName = new StringBuilder();
				tableName.append(InterfaceConstants.MODULE_CUSTOMER);
				tableName.append("_");
				tableName.append(customer.getCustCtgCode());
				tableName.append("_ED");

				String prvString = "";
				Map<String, Object> mapoldData = creditInterfaceDao.getExtendedField(customer.getCustCIF(),
						tableName.toString());

				if (mapoldData != null && mapoldData.containsKey("cibilRequest")) {
					Object data = mapoldData.get("cibilRequest");
					if (data != null) {
						prvString = data.toString();
					}
				}

				if (StringUtils.equals(prvString, builder) && !override) {
					// return warning
					customerDetails.setCibilALreadyRun(true);
					//Cibil initiated successfully,Then only entered into.
					String errorDetails = mapoldData.get("errordetails").toString();
					if ("".equals(errorDetails)) {
						String jsonResponse = mapoldData.get("jsonresponse").toString();
						Object dateProcessed = JsonPath.read(jsonResponse, "$.cibilHeader.DateProcessed");
						if (dateProcessed != null) {
							int days = getCibilIntiDays(dateProcessed.toString());
							int cibilReInitDays = SysParamUtil.getValueAsInt("CIBIL_REINTI_DAYS");
							if (cibilReInitDays != 0) {
								if (days != -1 && days <= cibilReInitDays) {
									customerDetails.setReInitiateCibil(false);
								}
							}
						}
					}
					return customerDetails;
				}

				// Check score for primary applicant.
				Map<String, Object> mapdata = excuteCibil(customer.getCustCIF(), reqSentOn, appplicationdata, builder,
						null, customerDetails);

				if (mapdata != null && !mapdata.isEmpty()) {
					Map<String, Object> mapvalidData = validateExtendedMapValues(mapdata);
					appplicationdata.put("cibilRequest", builder);
					appplicationdata.put("JsonResponse", jsonObject.toString());
					appplicationdata.putAll(mapvalidData);

				}

				appplicationdata.put("Reference", customer.getCustCIF());

				if (!appplicationdata.containsKey("SeqNo")) {
					appplicationdata.put("SeqNo", 1);
				}
				if (!appplicationdata.containsKey("Version")) {
					appplicationdata.put("Version", 0);
				}
				if (!appplicationdata.containsKey("LastMntOn")) {
					appplicationdata.put("LastMntOn", new Timestamp(System.currentTimeMillis()));
				}
				if (!appplicationdata.containsKey("LastMntBy")) {
					appplicationdata.put("LastMntBy", 0);
				}
				if (!appplicationdata.containsKey("RecordStatus")) {
					appplicationdata.put("RecordStatus", "");
				}
				if (!appplicationdata.containsKey("RoleCode")) {
					appplicationdata.put("RoleCode", "");
				}
				if (!appplicationdata.containsKey("NextRoleCode")) {
					appplicationdata.put("NextRoleCode", "");
				}
				if (!appplicationdata.containsKey("TaskId")) {
					appplicationdata.put("TaskId", "");
				}
				if (!appplicationdata.containsKey("NextTaskId")) {
					appplicationdata.put("NextTaskId", "");
				}
				if (!appplicationdata.containsKey("RecordType")) {
					appplicationdata.put("RecordType", "");
				}
				if (!appplicationdata.containsKey("WorkflowId")) {
					appplicationdata.put("WorkflowId", 0);
				}

				prepareResponseObj(appplicationdata, customerDetails);

				Map<String, Object> extFieldMap = creditInterfaceDao.getExtendedField(customer.getCustCIF(),
						tableName.toString());
				if (extFieldMap == null) {
					if (customerDetails.getExtendedFieldRender() != null) {
						customerDetails.getExtendedFieldRender().setReference(customer.getCustCIF());
						customerDetails.getExtendedFieldRender().setRecordType(PennantConstants.RECORD_TYPE_UPD);
						customerDetails.getExtendedFieldRender().setNewRecord(false);
					}
					creditInterfaceDao.saveExtendedDetails(appplicationdata, "", tableName.toString());
				} else {
					int seqNo = (int) extFieldMap.get("SeqNo");
					creditInterfaceDao.updateExtendedDetails(customer.getCustCIF(), seqNo, appplicationdata, "",
							tableName.toString());
				}

			}
		} catch (Exception e) {
			logger.error(Literal.EXCEPTION, e);
			customerDetails.setCibilExecuted(false);
		}

		// save it to database

		return customerDetails;
	}

	/**
	 * Method for process the CIBIL details of Applicant.
	 * 
	 * @param financeDetail
	 * @param customerDetails
	 */
	private void processRetailCustomer(FinanceDetail financeDetail, CustomerDetails customerDetails, boolean coApp) {

		FinanceMain financeMain = financeDetail.getFinScheduleData().getFinanceMain();
		String reference = customerDetails.getCustomer().getCustCIF();
		Timestamp reqSentOn = new Timestamp(System.currentTimeMillis());
		Map<String, Object> appplicationdata = new HashMap<>();

		String builder = prepareRequest(financeMain, customerDetails, reference, reqSentOn, appplicationdata);

		if (builder == null) {
			return;
		}

		String prvString = "";// TODO;
		if (customerDetails.getExtendedFieldRender().getMapValues().get("cibilRequest") != null) {
			prvString = (String) customerDetails.getExtendedFieldRender().getMapValues().get("cibilRequest");
		}

		if (StringUtils.equals(prvString, builder)) {
			return;
		}

		Map<String, Object> mapdata = excuteCibil(reference, reqSentOn, appplicationdata, builder, null,
				customerDetails);

		if (mapdata != null && !mapdata.isEmpty()) {
			Map<String, Object> mapvalidData = validateExtendedMapValues(mapdata);
			appplicationdata.put("JsonResponse", jsonObject.toString());
			appplicationdata.put("cibilRequest", builder);
			appplicationdata.putAll(mapvalidData);

		}

		if (coApp) {
			prepareResponseObjforCoapp(appplicationdata, customerDetails, financeDetail);
		} else {
			prepareResponseObj(appplicationdata, customerDetails);
		}
	}

	public Map<String, Object> excuteCibil(String reference, Timestamp reqSentOn, Map<String, Object> appplicationdata,
			String builder, String response2, CustomerDetails customerDetails) {
		String response = response2;
		loadParameters();
		Map<String, Object> mapdata = null;
		try {
			if (!StringUtils.equalsIgnoreCase("true", App.getProperty("external.cibil.soapService"))) {
				response = sendRequest(builder.toString());
				doInterfaceLogging(reference, builder.toString(), response, null, null, reqSentOn,
						InterfaceConstants.STATUS_SUCCESS);
			}
			//for sample response kept in COmment line
			//response="TUEF12951807                     0000NB48938888_UATC2C             100215238428822112019111846PN03N010111MANOJ KUMAR07080907197208012ID03I010102010210AIGPK0039FPT03T01011022243026510302039001YPT03T02011084895010700302019001YPT03T03011022243026510302029001YPT03T04011090284866000202910302019001YEC03C010122SANTANUM2001@YAHOO.COMSC10CIBILTUSCR010201020210030822112019040500853PA03A010117MANOJ SIDDHIVILLA06022707064000020802010902011008221120199001YPA03A020122MANOJ SIDDHIVILLA TYTR06022707064000020802010902011008211120199001YPA03A030133ERREWREW, YTRYTR, YRYTRYT, UYTUYT06022707064000020802020902011008070820199001YPA03A040140ERREWREW, YTRYTR, YRYTRYT, UYTUYT JHGJHG0231HJ, KJHJKH, KJHKH JHGJHG, JHGJH06022707064000020802010902011008070820199001YTL04T0010213NOT DISCLOSED0402100501108082702200811080101201912041966130399928540890590590620610610610610620610610610610590590620610612954089059059062061061061061062061061061061059059062061061300801012019310801022016360550000TL04T0020213NOT DISCLOSED04021005011080827122006090822102008100828012010110831122013120511883130102803000300801012010310801012010360534000440203TL04T0030213NOT DISCLOSED040210050110808240620050908070920171108220920171205600431304351928540890590590620610610610610620610610610610590590620610612954000000000000000000000000000000000000000000000000000000300801092017310801102014TL04T0040213NOT DISCLOSED040210050110808280420050908250920171108300920171205657561304536428540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801092017310801102014IQ04I0010108221120190408VALUEFIN0502080606144000IQ04I0020108221120190413NOT DISCLOSED05020006011IQ04I0030108211120190408VALUEFIN0502080606144000IQ04I0040108171020190413NOT DISCLOSED05020006073000000IQ04I0050108101020190413NOT DISCLOSED050208060570000IQ04I0060108200820190413NOT DISCLOSED05020206076400000IQ04I0070108080820190413NOT DISCLOSED0502050606200000IQ04I0080108070820190413NOT DISCLOSED0502050606200000IQ04I0090108310720190413NOT DISCLOSED0502050606300000IQ04I0100108200720190413NOT DISCLOSED0502080603100IQ04I0110108130720190413NOT DISCLOSED0502000606600000IQ04I0120108020720190413NOT DISCLOSED0502050606460000IQ04I0130108130620190413NOT DISCLOSED0502050606100000IQ04I0140108110620190413NOT DISCLOSED0502000606600000IQ04I0150108060520190413NOT DISCLOSED0502050606100000IQ04I0160108030520190413NOT DISCLOSED0502050606500000IQ04I0170108170420190413NOT DISCLOSED0502050606400000IQ04I0180108270320190413NOT DISCLOSED0502050606300000IQ04I0190108070220190413NOT DISCLOSED050200060550000IQ04I0200108101120180413NOT DISCLOSED05020106071200000IQ04I0210108091120180413NOT DISCLOSED05020106071200000IQ04I0220108030820180413NOT DISCLOSED0502000606600000IQ04I0230108310720180413NOT DISCLOSED0502010606903948IQ04I0240108050720180413NOT DISCLOSED050240060522000ES0700028430102**";
			//response = "TUEF12GHFL                       0000NB76841001_UATC2CNPE          100215280069905032020145607PN03N010106DINESH0308KATHURIA0416S/O SULTAN SINGH07081806196908012ID03I010102010210AASPK8763BID03I020102020208Z3278111ID03I030102040215P04021999116413ID03I040102060212495518272482PT03T01011077748693650302009001YPT03T02011096997701230302009001YPT03T0301109810047365030203PT03T04011098112436650302019001YEC03C010125ACCOUNTS@SHARDAGRAFIX.COMEC03C020132DINESH4KATHURIA@SHARDAGRAFIX.COMEC03C030120SHARDAGRAFIX@ETH.NETEC03C040124DINESHKATHURIA@GMAIL.COMEM03E01010251020830112018030204SC10CIBILTUSC2010204020210030805032020040500707250205PA03A010115RBIENCLAVE ASDF06020707061100630802041008040320209001YPA03A020118R B I ENCLAVE ASDF06020707061100630802041008040320209001YPA03A030127R B I ENCLAVE R B I ENCLAVE06020707061100630802041008040320209001YPA03A040119R B I ENCLAVE DELHI0219R B I ENCLAVE DELHI0505DELHI06020707061100630802010902011008040320209001YTL04T0010213NOT DISCLOSED0402050501108080310201809082712201811083112201812071500000130714746222809000000000300801122018310801102018TL04T0020213NOT DISCLOSED0402510501408082809201811083112201812073000000130727627112812000000000000300801122018310801092018TL04T0030213NOT DISCLOSED040251050140808020820180908021120181108301120181207500000013074561059281200000000000030080111201831080108201835020039023640061782644402034506534792TL04T0040213NOT DISCLOSED0402610501108083004201809083011201811083011201812071800000130715595662824000000000000000000000000300801112018310801042018440203TL04T0050213NOT DISCLOSED04020505011080821032018090801012019110831012019120665000013065183782833000000000000000000000000000000000300801012019310801032018380514.00390237400522216440203450522216TL04T0060213NOT DISCLOSED0402520501408082112201711083011201812072500000130719407332836000000000000000000000000000000000000300801112018310801122017350200380519.00390236400591640450591640TL04T0070213NOT DISCLOSED0402610501408081412201709080912201811083112201812073000000130716281852839000000000000XXX000000000000XXXXXX000000300801122018310801122017440203TL04T0080213NOT DISCLOSED040251050140808121220170908181220181108311220181207100000013065513192839000000000000000000000000000000000000STD300801122018310801122017TL04T0090213NOT DISCLOSED0402540501408083011201711083112201812072500000130718141522842000000000000000000000000000000000000000000300801122018310801112017380518.50390236400591010440203TL04T0100213NOT DISCLOSED0402610501408083011201709080512201811083112201812074510000130724669252842000000000000000000XXX000000000XXXXXXSTDSTD300801122018310801112017TL04T0110213NOT DISCLOSED0402320501408081311201709080701201911083101201912063250001306245663284500000000000000000000000000000000000000000000030080101201931080111201744020345048560TL04T0120213NOT DISCLOSED040210050110808091120170908110120191108050220191305277932845000000000000000000000000000000000000000000000300801022019310801122017440203TL04T0130213NOT DISCLOSED0402320501408082310201709080501201911083101201912071600000130712093692848000000000000000000000000000000000000000000000000300801012019310801102017440203450542135TL04T0140213NOT DISCLOSED040210050110808211020170908050120191108280220191207141100013071066528285100000000000000000000000000000000000000000000000000030080102201931080110201736067000003706700000440203450537160TL04T0150213NOT DISCLOSED040251050140808270620171108311220181207300000013069914172854000000000000000000000000000000000000000000XXXXXXXXX0003008011220183108010720174006150498TL04T0160213NOT DISCLOSED04021005011080801052017090828022019100828022019110810032019120611550413010285400000000000000000000000000000000000000000000000000000029180000000000000000003008010320193108010420173606156000440203450536044TL04T0170213NOT DISCLOSED04020105011080820042017090807012019110831012019120732379001307258922828540000000000000000000000000000000000000000000000000000002912000000000000300801012019310801042017440203450550468TL04T0180213NOT DISCLOSED040261050140808280220170908071220181108311220181207201151113069776402839STDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTD300801122018310801122017390236TL04T0190213NOT DISCLOSED040251050140808220220170908181220181108311220181207302994613064511012854000000000000000000000000000000000000STD0000000000000002915000000000000000300801122018310801022017TL04T0200213NOT DISCLOSED0402510501408083105201609080212201811083112201812074500000130692685328540000000000000000000000000000000000000000000000000000002939000000000000000000000000000000000000000300801122018310801062016TL04T0210213NOT DISCLOSED0402510501308083105201609080812201710080812201711083112201712074015000130102854STDSTD000000000000000000000000XXX0000000000000000000002906XXX000300801122017310801052016TL04T0220213NOT DISCLOSED0402510501408082505201609080506201810080308201811083108201812074530000130102854000XXX0000000000000000000000000000000000000000000000002930000000000000000000000000000000300801082018310801052016350200390236400616548044020345075986402TL04T0230213NOT DISCLOSED040201050140808310820150908050120191108310120191207764995013074642862285400000000000000000000000000000000000000000000000000000029540000000000000000000000000000000000000000000000000000003008010120193108010220164402034506125816TL04T0240213NOT DISCLOSED0402610501408083006201509080711201710082911201711083112201812072500000130102854STDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTD2954STDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTD300801122018310801012016390248TL04T0250213NOT DISCLOSED0402510501408082506201509080504201611083004201612072985540130719921282803000300801042016310801042016350200390224400614977344020345071347957TL04T0260213NOT DISCLOSED0402510501108081906201509081812201710081812201711083112201712074000000130102854000000000000000000000000000000000000000000000000XXX0002936000000000000XXX000000000000000000000300801122017310801072015440203TL04T0270213NOT DISCLOSED0402510501408082404201509080205201610083105201611083105201712072550000130102854000000000000000000000000000000000XXX0000000000000000002924000000000000000000000000300801052017310801042015TL04T0280213NOT DISCLOSED040251050110808280220150908021120171008021120171108301120171207300000013010285400000000000000000000000000000000000000000000000000000029450000000000000000000000000000000000000000000003008011120173108010320154402034506509757TL04T0290213NOT DISCLOSED0402510501408083009201409080205201610083105201611083105201712071676000130102854000000000000000000000000000000000XXX0000000000000000002942000000000000000000000000000000000000000000300801052017310801102014TL04T0300213NOT DISCLOSED0402010501408083008201409080501201911083101201912071363000130663898928540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801012019310801022016440203450522981TL04T0310213NOT DISCLOSED04020505011080829072014090816112017100816112017110830112017120730000001301028540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801112017310801122014380514.003902494005819794402034506851988TL04T0320213NOT DISCLOSED04020105014080808042014090807012019110831012019120748605401307195343128540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801012019310801022016440203450581320TL04T0330213NOT DISCLOSED0402010501408082403201409080501201911083101201912063600001305230592854000000000000000000000000000000000000000000000000000000295400000000000000000000000000000000000000000000000000000030080101201931080102201644020345047828TL04T0340213NOT DISCLOSED0402010501408082910201309080511201810080511201811083011201812065500001301028540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801112018310801122015440203450511688TL04T0350213NOT DISCLOSED04025105014080829082013090805032015100828032015110831052017120730300001301028540000000000000000000000000000000000000000000000000000002936000000000000000XXXXXXXXX000000000000300801052017310801122014TL04T0360213NOT DISCLOSED04020005014080810072013090807092018100807092018110830092018120780000001301028540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801092018310801102015440203450519345TL04T0370213NOT DISCLOSED0402050501108082801201309082907201410082907201411083107201412072500000130102806000000300801072014310801062014380514.0039024940056831644020345071854508TL04T0380213NOT DISCLOSED0402030501408080809201209080102201811083112201812078200000130765263222854000000000000XXXXXXXXXXXXXXXXXX0000000000000000000000002954000000000000000000000000000000000000000000000000000000300801122018310801012016400591723TL04T0390213NOT DISCLOSED0402020501408082208201209081202201811083112201812076200000130750361602854000000000000XXXXXXXXXXXXXXXXXX0000000000000000000000002954000000000000000000000001000000000000000000000000000000300801122018310801012016400562945TL04T0400213NOT DISCLOSED0402100501108081505201209081101201911082501201912071065991130682528128540000000000000110000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801012019310801022016360715000003706150000380640.8004402034506128232TL04T0410213NOT DISCLOSED0402510501408082304201209083008201310083008201311083112201412072025000130102803000300801082013310801082013TL04T0420213NOT DISCLOSED0402050501108082603201209082801201310082801201311083101201312071500000130102833000000000000000000000000000000000300801012013310801032012380515.5039024940054212744020345071342015TL04T0430213NOT DISCLOSED040210050110808011020110908010220191108180220191307100975728540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801022019310801032016440203TL04T0440213NOT DISCLOSED0402100501108081001201009081111201011082802201712062055271302-12854000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801022017310801032014TL04T0450213NOT DISCLOSED040210050110808110620090908110120191108250120191206140208130582697285400000000000000000000000000000000000000000000000000000029540000000000000000000000000000000000000000000000000000003008010120193108010220163606139000380640.800440203450549774TL04T0460213NOT DISCLOSED040202050110808260520090908290820121008290820121108310820121207700000013010285400000000000000000000000000000000000000000000000000000029540000000000000000000000000000000000000000000000000000003008010820123108010920093502013903198400593376440203TL04T0470213NOT DISCLOSED040205050110808171020081008300420091108310320161206700000130102854STDSTDXXXSTDSTDXXXSTDSTDSTDXXXXXXXXXXXXXXXSTDXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801032016310801042013TL04T0480213NOT DISCLOSED0402510501408083009200809081006200910082907200911083107200912071708000130102830000000000XXX000000000000STDSTD300801072009310801102008TL04T0490213NOT DISCLOSED0402050501108081009200809081702201110082503201111083103201112071500000130102839000000000000000000000000026000000000000300801032011310801032010TL04T0500213NOT DISCLOSED040210050110808150720080908041020111008221020111108310120161206206842130102854000000000000000000000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX3008010120163108010220133606200000390236440203TL04T0510213NOT DISCLOSED04020505011080803072008090805072011100805072011110828022014120715000001301028540000000000000000000000000000000000000000000000000000002954XXX000XXX000000000000000000000000000000000000000000000300801072011310801082008TL04T0520213NOT DISCLOSED040210050110808240620080908130820121008210820121108120120131304136614032002854000000000000XXX000000000000XXX0000000000000000000000002954000000000000000000000000000000000000000000000000000000300801082012310801092009440203TL04T0530213NOT DISCLOSED040210050110808240420080908040520111008100720121108280220141205654621303-412854000000000000000000000000000XXX0000000000000000000000002954099068038000000000000069038XXX000XXX000067037XXX000XXX300801072012310801082009TL04T0540213NOT DISCLOSED04020505011080822042008090828042011100811052011110831052011120713000001301028540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801052011310801062008TL04T0550213NOT DISCLOSED040210050110808190220080908141220091008150120101108310120101206109512130102854000067037XXX000XXX000XXX037XXXXXXXXX000XXXXXXXXXXXXXXX2918XXXXXXXXXXXXXXXXXX300801012010310801022008TL04T0560213NOT DISCLOSED0402050501108081502200809081501201110081502201111083009201512071000000130102854STDSTDSTDXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801092015310801102012380519.00390236400536660440203TL04T0570213NOT DISCLOSED040210050110808120220080908260320111008020120121108311220151206264710130102854000000000000000000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX30080112201531080101201336042500440203TL04T0580213NOT DISCLOSED040205050110808090220080908150720091008200720091108290220161206888000130102854000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX000XXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801022016310801032013TL04T0590213NOT DISCLOSED040201050110808250120080908290420091008220520091108310520091206582000130102851000000000000000000000000000000000000000000XXX000000300801052009310801012008TL04T0600213NOT DISCLOSED0402050501108081312200709080112201110080112201111083112201112067000001301028540000000000000000000000000000000000000000000000000000002954000XXX000000000000000XXX000000000000000000000000000000300801122011310801012009380515.00390248400519482440203450513559TL04T0610213NOT DISCLOSED0402050501108082809200709080802201210080902201211083011201312071411000130102854000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2948XXXXXXXXXXXX000000000000XXXXXXXXXXXXXXXSTDSTDSTD300801022012310801032009TL04T0620213NOT DISCLOSED0402050501108082109200709082907200910082907200911083105201712071000000130102854000000XXXXXXXXXXXXXXXXXXXXXXXX0000000000000000000000002954000000000000XXX000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801052017310801062014390236TL04T0630213NOT DISCLOSED04021005011080807092007090811112010100822102012110825072013120534833130102854000000000000000000000000000000000000000XXX000000000XXX2954XXX000000XXX000000000XXX000000XXX000000000XXX000000000300801102012310801112009360535000370521000380517.88440203450533999TL04T0640213NOT DISCLOSED04020505011080814082007090818072009100818072009110831032013120710000001301028540000000000000000000000000000000000000000000000000000002918000000000000000000300801072009310801082007380518.00400529375440203TL04T0650213NOT DISCLOSED040205050110808100720070908140720091008140720091108310720131206500000130102854STD000000STD000000019019019020019020021STD0000000000002921000000000000000000000300801072009310801072007TL04T0660213NOT DISCLOSED0402050501108080907200709080307200810080307200811082802201412071000000130102818000000000000000000300801072008310801022008TL04T0670213NOT DISCLOSED040210050110808050320070908130120141008130120141108300120141305-21702854000000000000000XXX000000000000000XXX0000000000000000002954000000000XXXXXX000000XXX000000000000000000000000000XXX300801012014310801022011440203TL04T0680213NOT DISCLOSED0402510501108082802200709080909200810080610200811083110200812071500000130102854STDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTD2903STD300801102008310801042007TL04T0690213NOT DISCLOSED04021005011080805022007090823092009100813102010110831122015120584771130102854000000000000000000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX30080112201531080101201336042500440203TL04T0700213NOT DISCLOSED0402050501108080202200709080609200810080410200811083110200812071560000130102803STD300801102008310801102008TL04T0710213NOT DISCLOSED040205050110808020220070908090220081008110220081108290220161206725500130102854000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX000XXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801022016310801032013TL04T0720213NOT DISCLOSED0402050501108081801200709081002201110081702201111083107201312071500000130102854STDXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXSTDSTDSTDSTD2927STDXXXSTDSTDXXXSTDXXXSTDSTD300801022011310801122008TL04T0730213NOT DISCLOSED0402050501108082312200609082204200810082504200811083004200812071300000130102851000000000000000000000000000000000000000XXX000000000300801042008310801122006TL04T0740213NOT DISCLOSED04021005011080804102006100805072007110831122007130102830STDSTDSTDSTDSTDSTDSTDSTDSTDSTD300801072007310801102006TL04T0750213NOT DISCLOSED040205050110808250920060908050120081008170120081108310320091206683000130102839000000000000000000000000000000000000000300801012008310801012007TL04T0760213NOT DISCLOSED040205050110808120920060908310820091008310820091108301120131206600000130102806STDSTD300801082009310801072009TL04T0770213NOT DISCLOSED0402050501108082408200609081006201510081006201511083006201512068000001301028540000000000000000000000000000000000000000000000000000002954000000000000000000000000000000000000000000000000000000300801062015310801072012350200380518.00390260440203TL04T0780213NOT DISCLOSED040205050110808100820060908300420091008310720091108311020131206366000130102854000XXXXXX0000000000000000000000000000000000000000000002954000000000000000000000000000000000XXX000000000000000000300801072009310801082006TL04T0790213NOT DISCLOSED0402510501108082402200609080702200710082602200711082802200712071500000130102839STDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTD300801022007310801022006TL04T0800213NOT DISCLOSED0402050501108082402200609081512200610082312200611083112200612071200000130102833000000000000000000000000000000000300801122006310801022006TL04T0810213NOT DISCLOSED0402050501108082911200509081701200710081701200711083108200712071000000130102836STDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTDSTD300801012007310801022006TL04T0820213NOT DISCLOSED040205050110808241020050908130920061008180920061108301120131206500000130102803STD300801092006310801092006TL04T0830213NOT DISCLOSED040205050110808250820051008060520091108300920101206500000130102854000XXX000000000XXXXXX000000000000000XXX0000000000000002954000000000000000000000000000000000000000000000000000000300801052009310801062006TL04T0840213NOT DISCLOSED0402510501108082907200509081402200610080403200611083103200612071000000130102824STDSTDSTDSTDSTDSTDSTDSTD300801032006310801082005TL04T0850213NOT DISCLOSED040205050110808060520050908020220071008020220071108290220161206500000130102854000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX000XXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801022016310801032013TL04T0860213NOT DISCLOSED0402050501108081503200509081002200610082502200611082802200612071000000130102836000000000000000000000000000000000000300801022006310801032005TL04T0870213NOT DISCLOSED040205050110808091020040908251020051008261020051108301120131206500000130102833STDXXXSTDSTDSTDSTDSTDSTDSTDSTDSTD300801102005310801122004TL04T0880213NOT DISCLOSED0402510501108080809200409081307200510080608200511083108200512071000000130102836STDSTDSTDSTDSTDSTDSTDSTDXXXSTDSTDSTD300801082005310801092004TL04T0890213NOT DISCLOSED040205050110808180620041008051120071108311220091206600000130102803000300801112007310801112007TL04T0900213NOT DISCLOSED040205050110808150420040908060520051008060520051108290220161206400000130102854000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX000XXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801022016310801032013TL04T0910213NOT DISCLOSED040205050110808270220040908100320051008150320051108311220051206850000130102836000000000000000000000000000000000000300801032005310801042004TL04T0920213NOT DISCLOSED040200050110808251220030908130920041008140920041108300920041206500000130102809STDSTDSTD300801092004310801072004TL04T0930213NOT DISCLOSED040205050110808100520020908150420041008170420041108290220161206300000130102854000XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX000XXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801022016310801032013TL04T0940213NOT DISCLOSED040210050110808180120000908221220111108311220181205788691304-1052854000000000000000000000000000000000000000000000000000000295400000000000000000000000000000000000000000000000000000030080112201831080101201636055000037045000TL04T0950213NOT DISCLOSED040205050110808140920070908120920081008150920081108300620101206750000130102803XXX300801092008310801092008TL04T0960213NOT DISCLOSED040205050110808270920060908120920081008150920081108300620101206450000130102803XXX300801092008310801092008TL04T0970213NOT DISCLOSED04021005011080808122005100813032007110803052010130102848XXXXXX000000028000000000000028000028000000000000300801032007310801122005TL04T0980213NOT DISCLOSED04021005011080801112005100801032007110822052010130102803XXX300801032007310801032007TL04T0990213NOT DISCLOSED040205050110808311220040908291120051008291120051108310820071206935000130102827XXXXXXSTDSTDSTDXXXXXXXXXXXX300801112005310801032005TL04T1000213NOT DISCLOSED040210050110808190719961008250219991108250620111206734086130102854XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX3008010620113108010720088606      8706      TL04T1010213NOT DISCLOSED040210050110808061219940908010719991008271019991108250720111206769755130102854XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2954XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX300801072011310801082008IQ04I0010108050320200408ENSEMBLE05020206071000000IQ04I0020108050320200408ENSEMBLE05020206071000000IQ04I0030108050320200408ENSEMBLE05020206011IQ04I0040108050320200408ENSEMBLE0502020606100000IQ04I0050108050320200408ENSEMBLE05020206071000000IQ04I0060108050320200408ENSEMBLE05020206071000000IQ04I0070108050320200408ENSEMBLE05020206071000000IQ04I0080108050320200408ENSEMBLE05020206071000000IQ04I0090108040320200408ENSEMBLE05020206071000000IQ04I0100108040320200408ENSEMBLE05020206071000000IQ04I0110108040320200408ENSEMBLE05020006011IQ04I0120108040320200408ENSEMBLE05020006011IQ04I0130108040320200408ENSEMBLE05020206071000000IQ04I0140108040320200408ENSEMBLE05020206071000000IQ04I0150108040320200408ENSEMBLE05020206071000000IQ04I0160108040320200408ENSEMBLE05020206071000000IQ04I0170108040320200408ENSEMBLE05020006011IQ04I0180108040320200408ENSEMBLE05020006011IQ04I0190108040320200408ENSEMBLE05020006011IQ04I0200108040320200408ENSEMBLE05020206071000000IQ04I0210108040320200408ENSEMBLE05020206011IQ04I0220108030320200408ENSEMBLE05020206072000000IQ04I0230108030320200408ENSEMBLE05020206072000000IQ04I0240108030320200408ENSEMBLE05020206072000000IQ04I0250108030320200408ENSEMBLE05020206072000000IQ04I0260108240220200413NOT DISCLOSED0502050606200000IQ04I0270108200220190413NOT DISCLOSED050203060840000000IQ04I0280108150220190413NOT DISCLOSED05023206072500000IQ04I0290108150220190413NOT DISCLOSED05020006011IQ04I0300108150220190413NOT DISCLOSED05025206072500000IQ04I0310108150220190413NOT DISCLOSED05025206072500000IQ04I0320108120220190413NOT DISCLOSED05025106071200000IQ04I0330108120220190413NOT DISCLOSED05023206074700000IQ04I0340108120220190413NOT DISCLOSED05023206072900000IQ04I0350108120220190413NOT DISCLOSED05023206072500000IQ04I0360108110220190413NOT DISCLOSED05025106072000000IQ04I0370108110220190413NOT DISCLOSED05023206072500000IQ04I0380108110220190413NOT DISCLOSED05020906072000000IQ04I0390108080220190413NOT DISCLOSED05025106072000000IQ04I0400108080220190413NOT DISCLOSED05025106072000000IQ04I0410108080220190413NOT DISCLOSED0502050606500000IQ04I0420108300120190413NOT DISCLOSED05025106073000000IQ04I0430108270120190413NOT DISCLOSED05026106071000000IQ04I0440108270120190413NOT DISCLOSED05026106071000000IQ04I0450108230120190413NOT DISCLOSED05020006011IQ04I0460108220120190413NOT DISCLOSED05026106072500000IQ04I0470108220120190413NOT DISCLOSED05025106075000000IQ04I0480108180120190413NOT DISCLOSED05020506072500000IQ04I0490108110120190413NOT DISCLOSED05025106041000IQ04I0500108191120180413NOT DISCLOSED050202060840000000IQ04I0510108011120180413NOT DISCLOSED05025106076000000IQ04I0520108291020180413NOT DISCLOSED050201060850000000IQ04I0530108031020180413NOT DISCLOSED05025106072000000IQ04I0540108270920180413NOT DISCLOSED05025106073000000IQ04I0550108270920180413NOT DISCLOSED05020006073500000IQ04I0560108240920180413NOT DISCLOSED05025106073000000IQ04I0570108240920180413NOT DISCLOSED05025106073000000IQ04I0580108220920180413NOT DISCLOSED05020006075000000IQ04I0590108220920180413NOT DISCLOSED05025106072500000IQ04I0600108200920180413NOT DISCLOSED0502000606300000IQ04I0610108160820180413NOT DISCLOSED05025106011IQ04I0620108110820180413NOT DISCLOSED0502510606100000IQ04I0630108060820180413NOT DISCLOSED050203060849000000IQ04I0640108280720180413NOT DISCLOSED05020906074500000IQ04I0650108260720180413NOT DISCLOSED05020506074000000IQ04I0660108250720180413NOT DISCLOSED05020006011IQ04I0670108240720180413NOT DISCLOSED050203060849000000IQ04I0680108230720180413NOT DISCLOSED05020906071000000IQ04I0690108230720180413NOT DISCLOSED05025106074000000IQ04I0700108230720180413NOT DISCLOSED05025106074000000IQ04I0710108210720180413NOT DISCLOSED05025106074000000IQ04I0720108170720180413NOT DISCLOSED05025106073500000IQ04I0730108160720180413NOT DISCLOSED05026106072000000IQ04I0740108160720180413NOT DISCLOSED05026106072000000IQ04I0750108160720180413NOT DISCLOSED05025106071500000IQ04I0760108160720180413NOT DISCLOSED05025106071500000IQ04I0770108160720180413NOT DISCLOSED05025106041000IQ04I0780108140720180413NOT DISCLOSED05025106074000000IQ04I0790108130720180413NOT DISCLOSED05020906074500000IQ04I0800108130720180413NOT DISCLOSED05025106073000000IQ04I0810108130720180413NOT DISCLOSED050251060510000IQ04I0820108130720180413NOT DISCLOSED05026106075000000IQ04I0830108230520180413NOT DISCLOSED050202060840000000IQ04I0840108240420180413NOT DISCLOSED05025106072065000IQ04I0850108110420180413NOT DISCLOSED05025106071000000IQ04I0860108110420180413NOT DISCLOSED05025106072000000IQ04I0870108100420180413NOT DISCLOSED05025106072000000IQ04I0880108090420180413NOT DISCLOSED05025106072000000IQ04I0890108090420180413NOT DISCLOSED0502120606100000IQ04I0900108190320180413NOT DISCLOSED050200060843054000IQ04I0910108160320180413NOT DISCLOSED05020506072000000IQ04I0920108260220180413NOT DISCLOSED050232060510000IQ04I0930108071220170413NOT DISCLOSED05025106072000000IQ04I0940108271120170413NOT DISCLOSED05025106075000000IQ04I0950108211120170413NOT DISCLOSED05025106072000000IQ04I0960108201120170413NOT DISCLOSED050212060825000000IQ04I0970108171120170413NOT DISCLOSED050251060810000000IQ04I0980108091120170413NOT DISCLOSED050203060830000000IQ04I0990108091120170413NOT DISCLOSED050203060825000000IQ04I1000108081120170413NOT DISCLOSED05026106075000000IQ04I1010108071120170413NOT DISCLOSED05020006074500000IQ04I1020108031120170413NOT DISCLOSED05025106075000000IQ04I1030108031120170413NOT DISCLOSED05025106075000000IQ04I1040108301020170413NOT DISCLOSED0502100603100IQ04I1050108301020170413NOT DISCLOSED05025106075000000IQ04I1060108301020170413NOT DISCLOSED05026106071200000IQ04I1070108301020170413NOT DISCLOSED05025106075000000IQ04I1080108281020170413NOT DISCLOSED05021006041000IQ04I1090108251020170413NOT DISCLOSED050210060550000IQ04I1100108111020170413NOT DISCLOSED05020006072500000IQ04I1110108101020170413NOT DISCLOSED05023206071800000IQ04I1120108101020170413NOT DISCLOSED0502320606400000IQ04I1130108101020170413NOT DISCLOSED05023206071800000IQ04I1140108101020170413NOT DISCLOSED0502320606400000IQ04I1150108101020170413NOT DISCLOSED05023206072000000IQ04I1160108091020170413NOT DISCLOSED050251060810000000IQ04I1170108061020170413NOT DISCLOSED05020006072500000IQ04I1180108260920170413NOT DISCLOSED050200060843054000IQ04I1190108300520170413NOT DISCLOSED05026106073500000IQ04I1200108290520170413NOT DISCLOSED0502050606100000IQ04I1210108250520170413NOT DISCLOSED0502050606100000IQ04I1220108060520170413NOT DISCLOSED05020006074000000IQ04I1230108300420170413NOT DISCLOSED050210060550000IQ04I1240108180420170413NOT DISCLOSED05025106075000000IQ04I1250108150420170413NOT DISCLOSED05020106073150000IQ04I1260108130420170413NOT DISCLOSED05020106073556329IQ04I1270108220320170413NOT DISCLOSED0502050606500000IQ04I1280108210320170413NOT DISCLOSED050200060843000000IQ04I1290108170320170413NOT DISCLOSED050200060843000000IQ04I1300108270220170413NOT DISCLOSED05020106072800000IQ04I1310108230220170413NOT DISCLOSED05025106075000000IQ04I1320108150220170413NOT DISCLOSED0502510606100000IQ04I1330108100220170413NOT DISCLOSED0502050606500000IQ04I1340108080220170413NOT DISCLOSED05020506075000000IQ04I1350108020220170413NOT DISCLOSED05026106075000000IQ04I1360108180120170413NOT DISCLOSED05020006041000IQ04I1370108120120170413NOT DISCLOSED05020006041000IQ04I1380108090120170413NOT DISCLOSED05021006041000IQ04I1390108031020160413NOT DISCLOSED05025206075000000IQ04I1400108200820160413NOT DISCLOSED05025106041000IQ04I1410108050820160413NOT DISCLOSED05025106074000000IQ04I1420108030620160413NOT DISCLOSED05020006011IQ04I1430108180520160413NOT DISCLOSED05020006074500000IQ04I1440108120520160413NOT DISCLOSED05020006075000000IQ04I1450108120520160413NOT DISCLOSED05020006074000000IQ04I1460108060520160413NOT DISCLOSED05025106072500000IQ04I1470108290420160413NOT DISCLOSED0502050606100000IQ04I1480108270420160413NOT DISCLOSED05020506072500000IQ04I1490108260420160413NOT DISCLOSED05025106041000IQ04I1500108260420160413NOT DISCLOSED05020506072500000IQ04I1510108260420160413NOT DISCLOSED05020006011IQ04I1520108190420160413NOT DISCLOSED050200060843000000IQ04I1530108091020150413NOT DISCLOSED050203060850000000IQ04I1540108270820150413NOT DISCLOSED05025106071500000IQ04I1550108270820150413NOT DISCLOSED05020106077650000IQ04I1560108280720150413NOT DISCLOSED05025106072500000IQ04I1570108280720150413NOT DISCLOSED05025106072500000IQ04I1580108190620150413NOT DISCLOSED05025206075000000IQ04I1590108130620150413NOT DISCLOSED05020006073000000IQ04I1600108120620150413NOT DISCLOSED0502050606500000IQ04I1610108110620150413NOT DISCLOSED05025106071000000IQ04I1620108090620150413NOT DISCLOSED05025106072500000IQ04I1630108080620150413NOT DISCLOSED05020006075000000IQ04I1640108080620150413NOT DISCLOSED05025106071500000IQ04I1650108030620150413NOT DISCLOSED05025106074000000IQ04I1660108290520150413NOT DISCLOSED05025206075000000IQ04I1670108290520150413NOT DISCLOSED05025106072500000IQ04I1680108290520150413NOT DISCLOSED05025106071000000IQ04I1690108290520150413NOT DISCLOSED05025106071000000IQ04I1700108270520150413NOT DISCLOSED05025106072500000IQ04I1710108090520150413NOT DISCLOSED05020106076790000IQ04I1720108160420150413NOT DISCLOSED050200060848000000IQ04I1730108050320150413NOT DISCLOSED05020006011IQ04I1740108110220150413NOT DISCLOSED050202060870000000IQ04I1750108050220150413NOT DISCLOSED0502000606100000IQ04I1760108040220150413NOT DISCLOSED05025106074000000IQ04I1770108231120140413NOT DISCLOSED050202060820000000IQ04I1780108290920140413NOT DISCLOSED05020006011IQ04I1790108190920140413NOT DISCLOSED05021006041000IQ04I1800108280820140413NOT DISCLOSED05020106071363000IQ04I1810108120720140413NOT DISCLOSED05020506072000000IQ04I1820108210420140413NOT DISCLOSED050200060828000000IQ04I1830108170420140413NOT DISCLOSED050200060828000000IQ04I1840108300320140413NOT DISCLOSED05020106074760000IQ04I1850108210320140413NOT DISCLOSED0502010606360000IQ04I1860108150120140413NOT DISCLOSED050200060830000000IQ04I1870108281120130413NOT DISCLOSED050200060810000000IQ04I1880108271120130413NOT DISCLOSED05020306011IQ04I1890108271120130413NOT DISCLOSED050203060830000000IQ04I1900108241020130413NOT DISCLOSED0502010606400000IQ04I1910108241020130413NOT DISCLOSED0502010606400000IQ04I1920108241020130413NOT DISCLOSED0502010606550000IQ04I1930108241020130413NOT DISCLOSED0502010606550000IQ04I1940108070820130413NOT DISCLOSED05025106072500000IQ04I1950108070820130413NOT DISCLOSED05025106072500000IQ04I1960108070820130413NOT DISCLOSED05020006011IQ04I1970108130620130413NOT DISCLOSED050200060820000000IQ04I1980108110620130413NOT DISCLOSED050200060830000000IQ04I1990108290420130413NOT DISCLOSED05021006041000IQ04I2000108040420130413NOT DISCLOSED050203060815000000IQ04I2010108130320130413NOT DISCLOSED050200060815000000IQ04I2020108080320130413NOT DISCLOSED050202060810000000IQ04I2030108140220130413NOT DISCLOSED05020106071950000IQ04I2040108210120130413NOT DISCLOSED05020506072000000IQ04I2050108161120120413NOT DISCLOSED050202060810000000IQ04I2060108250820120413NOT DISCLOSED050210060550000IQ04I2070108110820120413NOT DISCLOSED050202060830000000IQ04I2080108080820120413NOT DISCLOSED050202060830000000IQ04I2090108270720120413NOT DISCLOSED050202060830000000IQ04I2100108090720120413NOT DISCLOSED050202060830000000IQ04I2110108270620120413NOT DISCLOSED05020206071000000IQ04I2120108050520120413NOT DISCLOSED0502100606100000IQ04I2130108140420120413NOT DISCLOSED05025106072500000IQ04I2140108140420120413NOT DISCLOSED05025106072500000IQ04I2150108140420120413NOT DISCLOSED05020006072500000IQ04I2160108210320120413NOT DISCLOSED05020506071500000IQ04I2170108140320120413NOT DISCLOSED0502510606100000IQ04I2180108140320120413NOT DISCLOSED05020206071000000IQ04I2190108161120110413NOT DISCLOSED05020206071000000IQ04I2200108161120110413NOT DISCLOSED0502510606100000IQ04I2210108171020110413NOT DISCLOSED050200060560000IQ04I2220108061020110413NOT DISCLOSED05021006041000IQ04I2230108031020110413NOT DISCLOSED0502010606200000IQ04I2240108080420110413NOT DISCLOSED050202060810000000IQ04I2250108250120110413NOT DISCLOSED05020506071510000IQ04I2260108170120110413NOT DISCLOSED05020006071000000IQ04I2270108221220100413NOT DISCLOSED050202060810000000IQ04I2280108300820100413NOT DISCLOSED05020106071000000IQ04I2290108130420100413NOT DISCLOSED05025106073500000IQ04I2300108180320100413NOT DISCLOSED0502000606366000IQ04I2310108160320100413NOT DISCLOSED05025106072000000IQ04I2320108110320100413NOT DISCLOSED05020206075000000IQ04I2330108090120100413NOT DISCLOSED0502100606100000IQ04I2340108230720090413NOT DISCLOSED0502050606100000IQ04I2350108110620090413NOT DISCLOSED050210060550000IQ04I2360108160320090413NOT DISCLOSED050210060510000IQ04I2370108090320090413NOT DISCLOSED050202060820000000IQ04I2380108250220090413NOT DISCLOSED050205060520000IQ04I2390108160220090413NOT DISCLOSED05025106072000000IQ04I2400108200120090413NOT DISCLOSED050210060550000IQ04I2410108191220080413NOT DISCLOSED0502050606100000IQ04I2420108211120080413NOT DISCLOSED050205060570000IQ04I2430108291020080413NOT DISCLOSED0502050606600000IQ04I2440108280920080413NOT DISCLOSED05020506071000000IQ04I2450108260920080413NOT DISCLOSED0502050606500000IQ04I2460108250920080413NOT DISCLOSED0502050606150000IQ04I2470108240920080413NOT DISCLOSED0502050606600000IQ04I2480108220920080413NOT DISCLOSED05020506071000000IQ04I2490108190920080413NOT DISCLOSED0502050606500000IQ04I2500108180920080413NOT DISCLOSED05025106072000000IQ04I2510108260820080413NOT DISCLOSED05020506071500000IQ04I2520108190820080413NOT DISCLOSED050205060565000IQ04I2530108190820080413NOT DISCLOSED05020506071500000IQ04I2540108160820080413NOT DISCLOSED05025106071500000IQ04I2550108080820080413NOT DISCLOSED0502050606250000IQ04I2560108080820080413NOT DISCLOSED0502050606250000IQ04I2570108300720080413NOT DISCLOSED050200060550000IQ04I2580108290720080413NOT DISCLOSED0502050606300000IQ04I2590108240720080413NOT DISCLOSED0502050606150000IQ04I2600108180720080413NOT DISCLOSED05020506071500000IQ04I2610108100720080413NOT DISCLOSED05020506071000000IQ04I2620108140620080413NOT DISCLOSED05025106073500000IQ04I2630108100620080413NOT DISCLOSED050210060550000IQ04I2640108260420080413NOT DISCLOSED0502050606500000IQ04I2650108170420080413NOT DISCLOSED0502050606500000IQ04I2660108280320080413NOT DISCLOSED0502050606600000IQ04I2670108180320080413NOT DISCLOSED0502050606100000IQ04I2680108270220080413NOT DISCLOSED0502050606600000IQ04I2690108150220080413NOT DISCLOSED0502050606100000IQ04I2700108080220080413NOT DISCLOSED05020006071000000IQ04I2710108080220080413NOT DISCLOSED05020506071000000IQ04I2720108050220080413NOT DISCLOSED0502050606600000IQ04I2730108010220080413NOT DISCLOSED05020006071000000IQ04I2740108030120080413NOT DISCLOSED050200060520000IQ04I2750108020120080413NOT DISCLOSED05020506071000000IQ04I2760108281220070413NOT DISCLOSED05025406071000000IQ04I2770108241220070413NOT DISCLOSED0502000606750000IQ04I2780108221220070413NOT DISCLOSED0502050606600000IQ04I2790108201220070413NOT DISCLOSED0502050606500000IQ04I2800108141220070413NOT DISCLOSED0502050606500000IQ04I2810108111220070413NOT DISCLOSED05020506071000000IQ04I2820108111220070413NOT DISCLOSED0502050606700000IQ04I2830108270920070413NOT DISCLOSED05020506071500000IQ04I2840108240920070413NOT DISCLOSED0502050606500000IQ04I2850108210920070413NOT DISCLOSED0502050606100000IQ04I2860108140920070413NOT DISCLOSED050210060510000IQ04I2870108130920070413NOT DISCLOSED0502050606100000IQ04I2880108070920070413NOT DISCLOSED050210060525000IQ04I2890108290820070413NOT DISCLOSED05020506071500000IQ04I2900108200820070413NOT DISCLOSED050205060860000000IQ04I2910108160820070413NOT DISCLOSED05020506071500000IQ04I2920108110820070413NOT DISCLOSED05020506071500000IQ04I2930108310720070413NOT DISCLOSED0502050606500000IQ04I2940108310720070413NOT DISCLOSED05020506071000000IQ04I2950108290620070413NOT DISCLOSED05020506071000000IQ04I2960108260620070413NOT DISCLOSED05020506071500000IQ04I2970108120620070413NOT DISCLOSED05020506071000000IQ04I2980108010620070413NOT DISCLOSED05020106071600000IQ04I2990108100320070413NOT DISCLOSED050210060560000IQ04I3000108020320070413NOT DISCLOSED050200060550000IQ04I3010108220220070413NOT DISCLOSED0502050606250000IQ04I3020108050220070413NOT DISCLOSED0502100603100IQ04I3030108020220070413NOT DISCLOSED05025106072000000IQ04I3040108020220070413NOT DISCLOSED0502050606110000IQ04I3050108250120070413NOT DISCLOSED05025106071800000IQ04I3060108200120070413NOT DISCLOSED05025106071800000IQ04I3070108200120070413NOT DISCLOSED0502050606400000IQ04I3080108190120070413NOT DISCLOSED05025106071800000IQ04I3090108170120070413NOT DISCLOSED05020506071500000IQ04I3100108150120070413NOT DISCLOSED05025106072500000IQ04I3110108120120070413NOT DISCLOSED050200060550000IQ04I3120108301220060413NOT DISCLOSED0502050606600000IQ04I3130108071220060413NOT DISCLOSED05025106072500000IQ04I3140108061220060413NOT DISCLOSED0502050606500000IQ04I3150108061220060413NOT DISCLOSED050205060510000IQ04I3160108011220060413NOT DISCLOSED05025106072500000IQ04I3170108270920060413NOT DISCLOSED0502050606500000IQ04I3180108040920060413NOT DISCLOSED050210060515000IQ04I3190108310820060413NOT DISCLOSED0502050606100000IQ04I3200108300820060413NOT DISCLOSED05020506071000000IQ04I3210108300820060413NOT DISCLOSED05025106072000000IQ04I3220108260820060413NOT DISCLOSED05020006071000000IQ04I3230108160820060413NOT DISCLOSED0502010606366000IQ04I3240108040820060413NOT DISCLOSED0502050606800000IQ04I3250108280720060413NOT DISCLOSED0502000606100000IQ04I3260108200720060413NOT DISCLOSED0502010606360000IQ04I3270108050720060413NOT DISCLOSED0502050606800000IQ04I3280108050720060413NOT DISCLOSED0502010606360000IQ04I3290108300620060413NOT DISCLOSED0502050606100000IQ04I3300108240620060413NOT DISCLOSED0502010606360000IQ04I3310108160620060413NOT DISCLOSED0502050606100000IQ04I3320108160620060413NOT DISCLOSED0502010606360000IQ04I3330108100320060413NOT DISCLOSED05020506071000000IQ04I3340108160220060413NOT DISCLOSED05020506071000000IQ04I3350108200120060413NOT DISCLOSED0502510606100000IQ04I3360108141120050413NOT DISCLOSED0502050606100000IQ04I3370108020820050413NOT DISCLOSED05020606071000000IQ04I3380108270720050413NOT DISCLOSED0502050606100000IQ04I3390108230920040413NOT DISCLOSED0502050606150000ES0700394500102**";

			logger.debug("Cibil TUEF Response: " + response);
			appplicationdata.put("CibilResponse", response);
			jsonObject = new JSONObject();
			primaryApplicant = new JSONObject();

			responseDetails = new CibilResponseDetails();
			if (response.startsWith("ERRR")) {
				parseErrorResponse(response);
				String error = getActualError(response);
				doInterfaceLogging(reference, builder.toString(), response, "999", error, reqSentOn,
						InterfaceConstants.STATUS_FAILED);
				appplicationdata.put(InterfaceConstants.RSN_CODE, error);
				//Add below code for setting actual error that is generated by cibil
				String cibilSegment = getCibilSegment(primaryApplicant.getString("URSegment"));
				if (!StringUtils.isBlank(cibilSegment)) {
					error += " in " + cibilSegment;
					customerDetails.setActualError(error);
					customerDetails.setCibilExecuted(false);
				}
				logger.debug("Error Respone: " + jsonObject.toString());

			} else {
				/*
				 * doInterfaceLogging(reference, builder.toString(), response, null, null, reqSentOn,
				 * InterfaceConstants.STATUS_SUCCESS);
				 */
				loadCibilLoanTypes();
				parseHeaderResponse(response);
				HashMap<String, String> detailsResult = responseDetails.getCibilResponseArray(response);
				jsonObject = parseDetailsresponse(detailsResult);
				jsonObject.put("PrimaryApplicant", primaryApplicant);
				if (App.getProperty("cibil.secondaryMatches.report") != null
						&& StringUtils.equalsIgnoreCase(App.getProperty("cibil.secondaryMatches.report"), "true")) {
					JSONArray secondaryApplicantArray = getSecondaryApplicantDetails(response);
					jsonObject.put("SecondaryApplicant", secondaryApplicantArray);
					logger.debug("JSON Respone : " + jsonObject.toString());

				}
				mapdata = getPropValueFromResp(jsonObject.toString(), extConfigFileName);
				appplicationdata.put(InterfaceConstants.RSN_CODE, "");
				appplicationdata.put("JsonResponse", jsonObject.toString());
				logger.debug("Success Respone :" + jsonObject.toString());
			}

		} catch (Exception e) {
			logger.debug(Literal.EXCEPTION, e);

			String error = e.getMessage();
			if (error == null) {
				error = e.getStackTrace().toString();
			}
			if (error.length() > 200) {
				error.substring(0, 200);
			}

			appplicationdata.put(InterfaceConstants.RSN_CODE, error);
			doInterfaceLogging(reference, builder.toString(), response, "999", error, reqSentOn,
					InterfaceConstants.STATUS_FAILED);
		}
		return mapdata;
	}

	private JSONArray getSecondaryApplicantDetails(String response) {
		JSONArray array = new JSONArray();

		int secondaryIndex = 1;
		if (StringUtils.contains(response, "**TUEF")) {
			String[] res = response.split("TUEF");

			for (String response1 : res) {
				if (secondaryIndex >= 3) {
					secondaryApplicant = new JSONObject();
					HashMap<String, String> detailsResult = responseDetails.getCibilResponseArray(response1);
					try {
						secondaryApplicant = parseSecondaryDetailsresponse(detailsResult);
						array.add(secondaryApplicant);
					} catch (Exception e) {
						e.printStackTrace();
						logger.error(e);
					}
				}
				secondaryIndex++;
			}
		}
		return array;

	}

	/**
	 * Method for process the CIBIL details of Applicant.
	 * 
	 * @param financeDetail
	 */
	private void getCoAppCustomer(FinanceDetail financeDetail) {

		List<JointAccountDetail> coapplicants = financeDetail.getJountAccountDetailList();
		if (coapplicants == null || coapplicants.isEmpty()) {
			return;
		}

		List<Long> coApplicantIDs = new ArrayList<Long>(1);
		for (JointAccountDetail coApplicant : coapplicants) {
			coApplicantIDs.add(coApplicant.getCustID());
		}
		List<CustomerDetails> coApplicantCustomers = getCoApplicants(coApplicantIDs);

		for (CustomerDetails customerDetails : coApplicantCustomers) {
			if (StringUtils.equals("RETAIL", customerDetails.getCustomer().getCustCtgCode())) {
				processRetailCustomer(financeDetail, customerDetails, true);
			}
		}

		logger.debug(Literal.LEAVING);
	}

	/**
	 * Method for get the CoApplicants with ExtendedField Details
	 * 
	 * @param customerIds
	 * @return
	 */
	protected List<CustomerDetails> getCoApplicantsWithExtFields(List<Long> customerIds) {
		logger.debug(Literal.ENTERING);
		StringBuilder tableName = new StringBuilder("");
		ExtendedFieldHeader extendedFieldHeader = null;
		Map<String, Object> extMapValues = null;
		List<CustomerDetails> customerDetailList = new ArrayList<>(1);
		List<Customer> coAppCustomers = creditInterfaceDao.getCustomerByID(customerIds, "_AVIEW");

		String module = InterfaceConstants.MODULE_CUSTOMER;

		for (Customer customer : coAppCustomers) {
			CustomerDetails customerDetails = new CustomerDetails();
			customerDetails.setCustID(customer.getCustID());
			customerDetails.setCustCIF(customer.getCustCIF());
			extendedFieldHeader = creditInterfaceDao.getExtendedFieldHeaderByModuleName(module,
					customer.getCustCtgCode());
			if (extendedFieldHeader != null) {
				ExtendedFieldRender extendedFieldRender = new ExtendedFieldRender();
				extendedFieldRender.setReference(customer.getCustCIF());

				tableName.append(module);
				tableName.append("_");
				tableName.append(customer.getCustCtgCode());
				tableName.append("_ED");
				extMapValues = creditInterfaceDao.getExtendedField(customer.getCustCIF(), tableName.toString());
				extendedFieldRender.setSeqNo(Integer.valueOf(extMapValues.get("SeqNo").toString()));

				extendedFieldRender.setMapValues(extMapValues);
				customerDetails.setExtendedFieldHeader(extendedFieldHeader);
				customerDetails.setExtendedFieldRender(extendedFieldRender);
				tableName.setLength(0);
				customerDetailList.add(customerDetails);
			}
		}
		logger.debug(Literal.LEAVING);
		return customerDetailList;
	}

	protected List<CustomerDetails> getCoApplicants(List<Long> coApplicantIDs) {
		return creditInterfaceDao.getCoApplicants(coApplicantIDs, "_VIEW");
	}

	private String prepareRequest(FinanceMain financeMain, CustomerDetails customerDetails, String reference,
			Timestamp reqSentOn, Map<String, Object> appplicationdata) {
		StringBuilder builder = new StringBuilder();
		try {
			prepareCibilHeader(builder, customerDetails, financeMain);
			prepareCustomerNameSegment(builder, customerDetails);
			prepareIdentificationSegment(builder, customerDetails);
			prepareTelephoneSegment(builder, customerDetails);
			prepareAddressSegment(builder, customerDetails);
			prepareEndSegment(builder);
			logger.debug("Request String : " + builder.toString());
		} catch (Exception e) {
			logger.debug(Literal.EXCEPTION, e);

			String error = e.getMessage();
			if (error == null) {
				error = e.getStackTrace().toString();
			}
			if (error.length() > 200) {
				error.substring(0, 200);
			}
			appplicationdata.put(InterfaceConstants.RSN_CODE, e.getMessage());
			doInterfaceLogging(reference, builder.toString(), null, null, error, reqSentOn,
					InterfaceConstants.STATUS_FAILED);

		}
		return builder.toString();
	}

	/**
	 * Method for load the properties file, then iterate the keys of that file and map to jsonResponse.
	 * 
	 * @param jsonResponse
	 * @param extConfigFileName
	 * @return extendedMappedValues
	 */
	private Map<String, Object> getPropValueFromResp(String jsonResponse, String extConfigFileName)
			throws FileNotFoundException {
		logger.debug(Literal.ENTERING);

		Map<String, Object> extendedFieldMap = new HashMap<>(1);
		Properties properties = new Properties();
		InputStream inputStream = this.getClass().getResourceAsStream("/properties/RetailCibilConsumer.properties");

		try {
			properties.load(inputStream);
		} catch (IOException ioException) {
			logger.debug(ioException.getMessage());
		}
		Enumeration<?> e = properties.propertyNames();
		while (e.hasMoreElements()) {
			String key = (String) e.nextElement();
			Object value = null;
			try {
				value = JsonPath.read(jsonResponse, properties.getProperty(key));
			} catch (PathNotFoundException pathNotFoundException) {
				value = null;
			}
			extendedFieldMap.put(key, value);
		}
		logger.debug(Literal.LEAVING);
		return extendedFieldMap;
	}

	private void loadParameters() {
		if (!StringUtils.equalsIgnoreCase("true", App.getProperty("external.cibil.soapService"))) {
			Search search = new Search(CibilMemberDetail.class);
			search.addTabelName("cibil_member_details");
			search.addFilter(new Filter("segment_Type", PennantConstants.PFF_CUSTCTG_INDIV));

			if (searchProcessor.getResults(search) != null && searchProcessor.getResults(search) instanceof List) {
				memberDetails = (CibilMemberDetail) searchProcessor.getResults(search).get(0);
			} else {
				memberDetails = (CibilMemberDetail) searchProcessor.getResults(search);
			}

		}

		this.CBIL_ENQUIRY_SCORE_TYPE = SysParamUtil.getValueAsString("CBIL_ENQUIRY_SCORE_TYPE");
	}

	private void loadAccountTypes() {
		logger.info("Loading AccountTypes..");

		StringBuilder sql = new StringBuilder();
		sql.append("SELECT CODE, FIN_TYPE FROM CIBIL_ACCOUNT_TYPES_MAPPING WHERE SEGMENT_TYPE = :SEGMENT_TYPE");

		MapSqlParameterSource paramMap = new MapSqlParameterSource();
		paramMap.addValue("SEGMENT_TYPE", PennantConstants.PFF_CUSTCTG_INDIV);

		namedJdbcTemplate.query(sql.toString(), paramMap, new RowCallbackHandler() {
			@Override
			public void processRow(ResultSet rs) throws SQLException {
				parameters.put(rs.getString("FIN_TYPE"), rs.getString("CODE"));
			}
		});
	}

	private void loadCibilStateCodes() {
		logger.info("Loading Cibil StateCodes..");

		StringBuilder sql = new StringBuilder();
		sql.append("SELECT CODE, DESCRIPTION FROM CIBIL_STATES_MAPPING WHERE SEGMENT_TYPE = :SEGMENT_TYPE");

		MapSqlParameterSource paramMap = new MapSqlParameterSource();
		paramMap.addValue("SEGMENT_TYPE", PennantConstants.PFF_CUSTCTG_INDIV);

		namedJdbcTemplate.query(sql.toString(), paramMap, new RowCallbackHandler() {
			@Override
			public void processRow(ResultSet rs) throws SQLException {
				cibilStateCodes.put(rs.getString("CODE"), rs.getString("DESCRIPTION"));
			}
		});
	}

	private void loadCibilStateCodesforRequest() {
		logger.info("Loading Cibil StateCodes for Request..");

		StringBuilder sql = new StringBuilder();
		sql.append("SELECT CPPROVINCE, CODE FROM CIBIL_STATES_MAPPING WHERE SEGMENT_TYPE = :SEGMENT_TYPE");

		MapSqlParameterSource paramMap = new MapSqlParameterSource();
		paramMap.addValue("SEGMENT_TYPE", PennantConstants.PFF_CUSTCTG_INDIV);

		namedJdbcTemplate.query(sql.toString(), paramMap, new RowCallbackHandler() {
			@Override
			public void processRow(ResultSet rs) throws SQLException {
				cibilStateCodesForRequest.put(rs.getString("CPPROVINCE"), rs.getString("CODE"));
			}
		});
	}

	private void loadCibilIdTypes() {
		logger.info("Loading Cibil Id Types..");

		StringBuilder sql = new StringBuilder();
		sql.append("SELECT CODE, DESCRIPTION FROM CIBIL_DOCUMENT_TYPES ");

		MapSqlParameterSource paramMap = new MapSqlParameterSource();

		namedJdbcTemplate.query(sql.toString(), paramMap, new RowCallbackHandler() {
			@Override
			public void processRow(ResultSet rs) throws SQLException {
				cibilIdTypes.put(rs.getString("CODE"), rs.getString("DESCRIPTION"));
			}
		});
	}

	private void loadCibilIdTypesforRequest() {
		logger.info("Loading Cibil Id Types..");

		StringBuilder sql = new StringBuilder();
		sql.append("SELECT CODE, DOCTYPECODE FROM CIBIL_DOCUMENT_TYPES_MAPPING");

		MapSqlParameterSource paramMap = new MapSqlParameterSource();

		namedJdbcTemplate.query(sql.toString(), paramMap, new RowCallbackHandler() {
			@Override
			public void processRow(ResultSet rs) throws SQLException {
				cibilIdTypesForRequest.put(rs.getString("DOCTYPECODE"), rs.getString("CODE"));
			}
		});
	}

	private void loadCibilPhoneTypes() {
		logger.info("Loading Cibil Phone Types..");
		MapSqlParameterSource paramMap;

		StringBuilder sql = new StringBuilder();
		paramMap = new MapSqlParameterSource();

		sql.append("SELECT CODE, DESCRIPTION FROM CIBIL_PHONE_TYPES");

		namedJdbcTemplate.query(sql.toString(), paramMap, new RowCallbackHandler() {
			@Override
			public void processRow(ResultSet rs) throws SQLException {
				cibilPhoneTypes.put(rs.getString("CODE"), rs.getString("DESCRIPTION"));
			}
		});
	}

	private void loadCibilLoanTypes() {
		logger.info("Loading Cibil LoanTypes..");

		StringBuilder sql = new StringBuilder();
		sql.append("SELECT CODE, DESCRIPTION FROM CIBIL_ACCOUNT_TYPES  WHERE SEGMENT_TYPE = :SEGMENT_TYPE");

		MapSqlParameterSource paramMap = new MapSqlParameterSource();
		paramMap.addValue("SEGMENT_TYPE", PennantConstants.PFF_CUSTCTG_INDIV);

		namedJdbcTemplate.query(sql.toString(), paramMap, new RowCallbackHandler() {
			@Override
			public void processRow(ResultSet rs) throws SQLException {
				cibilloanTypes.put(rs.getString("CODE"), rs.getString("DESCRIPTION"));
			}
		});
	}

	/**
	 * 
	 * The TUEF Enquiry Header Segment marks the beginning of the Enquiry Record, and:
	 * <li>It is a Required segment.
	 * <li>It is of a fixed size of 115 bytes.
	 * <li>It can appear only once per Enquiry Record.
	 * <li>All the fields must be provided otherwise the entire Enquiry Record is rejected</li>.
	 * <li>All fields must be valid.</li>
	 * 
	 */
	private void prepareCibilHeader(StringBuilder builder, CustomerDetails customerDetails, FinanceMain financeMain)
			throws Exception {
		logger.debug(Literal.ENTERING);

		builder.append(InterfaceConstants.Enquiry_Header_Segment);
		builder.append(InterfaceConstants.Enquiry_Header_version);
		builder.append(StringUtils.rightPad(memberDetails.getMemberCode(), 25, ""));
		builder.append(StringUtils.rightPad("", 2, ""));
		builder.append(StringUtils.rightPad(memberDetails.getMemberId(), 30, ""));
		builder.append(StringUtils.rightPad(memberDetails.getMemberPassword(), 30, ""));

		String enqPurpose = null;
		if (financeMain != null) {
			enqPurpose = parameters.get(financeMain.getFinType());
		}
		if (enqPurpose != null) {
			builder.append(enqPurpose);
		} else {
			builder.append("00");
		}

		int currencyEditField = SysParamUtil.getValueAsInt("APP_DFT_CURR_EDIT_FIELD");

		BigDecimal finAmount = BigDecimal.ONE;
		if (financeMain != null) {
			finAmount = financeMain.getFinAssetValue();
			finAmount = formateAmount(finAmount, currencyEditField);
			if (finAmount.compareTo(cibilDefaultLoanAmt) < 0) {
				finAmount = cibilDefaultLoanAmt;
			}
		}
		builder.append(StringUtils.leftPad(String.valueOf(finAmount), 9, "0"));
		builder.append(StringUtils.rightPad("", 03, ""));
		builder.append(CBIL_ENQUIRY_SCORE_TYPE);
		builder.append(InterfaceConstants.Output_Format);
		builder.append(responseSize);
		builder.append(InterfaceConstants.Input_Output_Media);
		builder.append(InterfaceConstants.Authentication_Method);

		logger.debug(Literal.LEAVING);

	}

	public static BigDecimal formateAmount(BigDecimal amount, int dec) {
		BigDecimal bigDecimal = BigDecimal.ZERO;

		if (amount != null) {
			bigDecimal = amount.divide(new BigDecimal(Math.pow(10, dec)));
		}
		return bigDecimal;
	}

	/**
	 * The PN Segment describes personal consumer information, and:
	 * <li>It is a Required segment.</li>
	 * <li>It is variable in length and can be of a maximum size of 174 bytes.</li>
	 * <li>It occurs only once per record.</li>
	 * <li>Tag 06 is reserved for future use.</li>
	 */

	private void prepareCustomerNameSegment(StringBuilder builder, CustomerDetails customerDetails) throws Exception {
		logger.debug(Literal.ENTERING);
		writeValue(builder, InterfaceConstants.Name_Segment, "N01", "03");
		writeCustomerName(builder, customerDetails.getCustomer());
		writeValue(builder, "07",
				DateUtil.format(customerDetails.getCustomer().getCustDOB(), InterfaceConstants.cibildateFormat), "08");
		if ("M".equals(customerDetails.getCustomer().getCustGenderCode())) {
			writeValue(builder, "08", "2", "01");
		} else if ("F".equals(customerDetails.getCustomer().getCustGenderCode())) {
			writeValue(builder, "08", "1", "01");
		} else {
			writeValue(builder, "08", "3", "01");
		}

		logger.debug(Literal.LEAVING);

	}

	/**
	 * 
	 * The ID Segment contains identification information about the consumer applying for credit, and:  This is a
	 * Required segment (with ID Type of 01, 02, 03, or 04) when no valid Telephone (PT) segment is provided except when
	 * the Enquiry Purpose (Positions 94-95 of the TUEF Enquiry Header Segment) is “Account Review”, “Retro Enquiry” or
	 * “Locate Plus”.
	 * <li>It is variable in length and can be a maximum of 47 bytes.</li>
	 * <li>This can occur maximum of 8 times per Enquiry Record.</li>
	 * <li>The ID Type(s) should be unique within the same Enquiry Record.</li>
	 * 
	 */
	private void prepareIdentificationSegment(StringBuilder builder, CustomerDetails customerDetails) {
		logger.debug(Literal.ENTERING);

		List<CustomerDocument> documents = customerDetails.getCustomerDocumentsList();

		int i = 0;

		for (CustomerDocument document : documents) {

			String code = document.getCustDocCategory();

			if (!cibilIdTypesForRequest.containsKey(code)) {
				continue;
			}

			if (++i > 8) {
				break;
			}

			writeValue(builder, InterfaceConstants.Identification_Segment, "I0" + i, "03");
			writeValue(builder, "01", cibilIdTypesForRequest.get(code), "02");
			writeValue(builder, "02", document.getCustDocTitle(), 30, "ID");

		}

		logger.debug(Literal.LEAVING);
	}

	/**
	 * The PT Segment contains the known phone numbers of the consumer, and:
	 * <li> This is a Required segment when no valid Identification (ID) segment with either Income Tax ID Number,
	 * Passport Number, Voter ID Number or Driver’s License Number is provided except when the Enquiry Purpose</li>
	 * <li>It is variable in length and can be of a maximum size of 51 bytes</li>
	 * <li>This can occur maximum of 4 times per Enquiry Record.</li>
	 */
	private void prepareTelephoneSegment(StringBuilder builder, CustomerDetails customerDetails) {
		List<CustomerPhoneNumber> phoneNumbers = customerDetails.getCustomerPhoneNumList();

		if (phoneNumbers == null || phoneNumbers.isEmpty()) {
			return;
		}

		int i = 0;
		for (CustomerPhoneNumber phoneNumber : phoneNumbers) {
			if (++i > 4) {
				break;
			}

			writeValue(builder, InterfaceConstants.Telephone_Segment,
					"T" + StringUtils.leftPad(String.valueOf(i), 2, "0"), "03");
			writeValue(builder, "01", phoneNumber.getPhoneNumber(), 20, "PT");

			if (phoneNumber.getPhoneTypeCode() != null) {
				if (phoneNumber.getPhoneTypeCode().equals("MOBILE1") || phoneNumber.getPhoneTypeCode().equals("MOBILE2")
						|| phoneNumber.getPhoneTypeCode().equals("OFFMOB")) {
					writeValue(builder, "03", "01", "02");
				} else if (phoneNumber.getPhoneTypeCode().equals("HOME")) {
					writeValue(builder, "03", "02", "02");
				} else if (phoneNumber.getPhoneTypeCode().equals("OFFICE")
						|| phoneNumber.getPhoneTypeCode().equals("OFFFAX")) {
					writeValue(builder, "03", "03", "02");
				} else {
					writeValue(builder, "03", "00", "02");
				}
			} else {
				writeValue(builder, "03", "00", "02");
			}
		}

	}

	/**
	 * The PA Segment(s) contain(s) the known address(es) of the consumer, and
	 * <li>It is a Required segment.</li>
	 * <li>It is variable in length and can be a maximum of 259 bytes.</li>
	 * <li>It occurs at least once, but no more than twice per Enquiry Record. Where possible, enter the Current Address
	 * in the first Address Segment and the Permanent Address in the second Address Segment</li>.
	 */
	private void prepareAddressSegment(StringBuilder builder, CustomerDetails customerDetails) throws Exception {

		List<CustomerAddres> addresses = customerDetails.getAddressList();

		int i = 0;
		for (CustomerAddres address : addresses) {
			if (++i > 2) {
				break;
			}
			writeValue(builder, InterfaceConstants.Address_Segment,
					"A".concat(StringUtils.leftPad(String.valueOf(i), 2, "0")), "03");
			writeCustomerAddress(builder, address);
			String state = address.getCustAddrProvince();
			state = cibilStateCodesForRequest.get(state);
			writeValue(builder, "06", state, "02");
			writeValue(builder, "07", address.getCustAddrZIP(), 10, InterfaceConstants.Address_Segment);

			if (address.getCustAddrType() != null) {
				if (address.getCustAddrType().equals("PER")) {
					writeValue(builder, "08", "01", "02");
				} else if (address.getCustAddrType().equals("CURRES")) {
					writeValue(builder, "08", "02", "02");
				} else if (address.getCustAddrType().equals("HEADOFF") || address.getCustAddrType().equals("BUS")) {
					writeValue(builder, "08", "03", "02");
				} else {
					writeValue(builder, "08", "04", "02");
				}
			} else {
				writeValue(builder, "08", "04", "02");
			}
		}

	}

	/**
	 * The ES Segment marks the end of the Enquiry Record, and:
	 * <li>It is a Required segment.</li>
	 * <li>It is of a fixed size of 15 bytes.</li>
	 * <li>It can appear only once per Enquiry Record.</li>
	 */
	private void prepareEndSegment(StringBuilder builder) {
		builder.append(InterfaceConstants.End_Segment);
		builder.append(StringUtils.leftPad(
				String.valueOf(builder.toString().length() + (InterfaceConstants.EndCharacterLength)), 5, "0"));
		builder.append((InterfaceConstants.EndCharacters).toString());
	}

	/**
	 * Append the fixed length tags to provided StringBuilder
	 * 
	 * @param builder
	 *            The StringBuilder to append the tags.
	 * @param fieldTag
	 *            Filed Tag
	 * @param value
	 *            Filed value
	 * @param size
	 *            length of the value
	 */
	private void writeValue(StringBuilder builder, String fieldTag, String value, String size) {
		writeValue(builder, concat(fieldTag, size, value));
	}

	private String concat(String fieldTag, String length, String value) {
		return fieldTag.concat(length).concat(value);
	}

	private void writeValue(StringBuilder builder, String value) {
		builder.append(value);
	}

	/**
	 * Append variable length tags to provided StringBuilder
	 * 
	 * @param builder
	 *            The StringBuilder tags.
	 * @param fieldTag
	 *            Field Tag
	 * @param value
	 *            Field Value
	 * @param maxLength
	 *            Max length of the tag
	 * @throws IllegalArgumentException
	 */
	private void writeValue(StringBuilder builder, String fieldTag, String value, int maxLength, String segment) {
		if (StringUtils.isBlank(value)) {
			return;
		}

		int size = value.length();
		String length = null;

		if (maxLength < 99) {
			length = StringUtils.leftPad(String.valueOf(size), 2, "0");
		} else if (maxLength < 999) {
			length = StringUtils.leftPad(String.valueOf(size), 3, "0");
		} else if (maxLength < 9999) {
			length = StringUtils.leftPad(String.valueOf(size), 4, "0");
		}

		if (value.length() > maxLength) {
			throw new IllegalArgumentException(
					String.format("Max length exceeded for the tag %s in segment %s", fieldTag, segment));
		}

		builder.append(concat(fieldTag, length, value));

	}

	private void writeCustomerName(StringBuilder writer, Customer customer) throws Exception {
		StringBuilder builder = new StringBuilder();

		if (customer.getCustFName() != null) {
			builder.append(StringUtils.trimToEmpty(customer.getCustFName()));
			if (customer.getCustMName() != null || customer.getCustLName() != null) {
				builder.append(" ");
			}
		}

		if (customer.getCustMName() != null) {
			builder.append(StringUtils.trimToEmpty(customer.getCustMName()));
			if (customer.getCustLName() != null) {
				builder.append(" ");
			}
		}

		if (customer.getCustLName() != null) {
			builder.append(StringUtils.trimToEmpty(customer.getCustLName()));
		}

		String customerName = builder.toString();
		try {
			Pattern regex = Pattern.compile("[^\\s\"']+|\"[^\"]*\"|'[^']*'");
			Matcher regexMatcher = regex.matcher(customerName);

			builder = new StringBuilder();
			int field = 0;
			while (regexMatcher.find()) {
				if (field >= 5) {
					break;
				}

				String name = regexMatcher.group();

				if ((builder.length() + name.length()) < 26) {
					if (builder.length() > 0) {
						builder.append(" ");
					}
					builder.append(name);

				} else {
					writeValue(writer, "0".concat(String.valueOf(++field)),
							StringUtils.substring(builder.toString(), 0, 26), 26, InterfaceConstants.Name_Segment);
					builder = new StringBuilder();
					builder.append(name);
				}

			}

			if (builder.length() > 0) {
				if (builder.length() > 26) {
					writeValue(writer, "0".concat(String.valueOf(++field)),
							StringUtils.substring(builder.toString(), 0, 26), 26, InterfaceConstants.Name_Segment);
				} else {
					writeValue(writer, "0".concat(String.valueOf(++field)), builder.toString(), 26,
							InterfaceConstants.Name_Segment);
				}
			}
		} catch (Exception e) {
			logger.error(Literal.EXCEPTION, e);
			throw e;
		}
	}

	private void writeCustomerAddress(StringBuilder writer, CustomerAddres custAddr) throws IOException {
		StringBuilder builder = new StringBuilder();

		if (custAddr.getCustAddrHNbr() != null) {
			builder.append(StringUtils.trimToEmpty(custAddr.getCustAddrHNbr()));
			if (custAddr.getCustFlatNbr() != null || custAddr.getCustAddrStreet() != null
					|| custAddr.getCustAddrLine1() != null || custAddr.getCustAddrLine2() != null) {
				builder.append(" ");
			}
		}

		if (custAddr.getCustAddrStreet() != null) {
			builder.append(StringUtils.trimToEmpty(custAddr.getCustAddrStreet()));
			if (custAddr.getCustFlatNbr() != null || custAddr.getCustAddrLine1() != null
					|| custAddr.getCustAddrLine2() != null) {
				builder.append(" ");
			}
		}

		if (custAddr.getCustFlatNbr() != null) {
			builder.append(StringUtils.trimToEmpty(custAddr.getCustFlatNbr()));
			if (custAddr.getCustAddrLine1() != null || custAddr.getCustAddrLine2() != null) {
				builder.append(" ");
			}
		}

		if (custAddr.getCustAddrLine1() != null) {
			builder.append(StringUtils.trimToEmpty(custAddr.getCustAddrLine1()));
			if (custAddr.getCustAddrLine2() != null) {
				builder.append(" ");
			}
		}

		if (custAddr.getCustAddrLine2() != null) {
			builder.append(StringUtils.trimToEmpty(custAddr.getCustAddrLine2()));
		}

		String custAddress = builder.toString();
		try {

			Pattern regex = Pattern.compile("[^\\s\"']+|\"[^\"]*\"|'[^']*'");
			Matcher regexMatcher = regex.matcher(custAddress);

			builder = new StringBuilder();
			int field = 0;
			while (regexMatcher.find()) {
				if (field >= 5) {
					break;
				}

				String address = regexMatcher.group();

				if ((builder.length() + address.length()) < 40) {
					if (builder.length() > 0) {
						builder.append(" ");
					}
					builder.append(address);

				} else {
					writeValue(writer, "0".concat(String.valueOf(++field)),
							StringUtils.substring(builder.toString(), 0, 40), 40, InterfaceConstants.Address_Segment);
					builder = new StringBuilder();
					builder.append(address);
				}
			}

			if (builder.length() > 0) {
				if (builder.length() > 40) {
					writeValue(writer, "0".concat(String.valueOf(++field)),
							StringUtils.substring(builder.toString(), 0, 40), 40, "PA");
				} else {
					writeValue(writer, "0".concat(String.valueOf(++field)), builder.toString(), 40,
							InterfaceConstants.Address_Segment);
				}
			}
		} catch (Exception e) {
			logger.error(Literal.EXCEPTION, e);
		}
	}

	/**
	 * Sends the Request through SocketIp
	 * 
	 * @param requestmessage
	 * @return response
	 * @throws Exception
	 */
	private String sendRequest(String requestMessage) throws Exception {
		logger.debug(Literal.ENTERING);

		StringBuilder builder = new StringBuilder();

		String socketIp = SysParamUtil.getValueAsString("CIBIL_SOCKET_IP");
		int port = SysParamUtil.getValueAsInt("CIBIL_SOCKET_PORT");
		int timeout = SysParamUtil.getValueAsInt("CIBIL_SOCKET_TIMEOUT");
		/*
		 * String socketIp = "192.168.150.140"; int port = 7506; int timeout =
		 * SysParamUtil.getValueAsInt("CIBIL_SOCKET_TIMEOUT");
		 */
		try {
			SocketAddress sockaddr = new InetSocketAddress(socketIp, port);
			Socket socket = new Socket();
			socket.setSoTimeout(timeout);
			socket.connect(sockaddr);
			logger.debug("Connected to CIBIL");
			OutputStream out = socket.getOutputStream();
			InputStream in = socket.getInputStream();

			int i = 19;
			char c = (char) i;
			requestMessage = requestMessage + c;
			out.write(requestMessage.getBytes(), 0, requestMessage.getBytes().length);
			out.flush();

			// Receive the same string back from the server
			BufferedReader reader = new BufferedReader(new InputStreamReader(in));

			String line;
			while ((line = reader.readLine()) != null) {
				builder.append(line);
			}

			socket.close();

		} catch (Exception e) {
			logger.debug(e.getMessage());
			throw e;
		} finally {

			/*
			 * if (socket != null && !socket.isClosed()) { socket.close(); }
			 */
		}
		return builder.toString();
	}

	private void parseErrorResponse(String response) throws Exception {
		logger.debug(Literal.ENTERING);
		String header = response.substring(0, 18);
		parseErrorHeder(header);
		// get the details Map as key value format where key is segment and
		// value as segment data.
		HashMap<String, String> detailsResult = responseDetails.getCibilResponseArray(response);
		parseDetailsresponse(detailsResult);

		logger.debug(Literal.LEAVING);

	}

	private String getActualError(String response) {
		String str = response.substring(54, 56);
		switch (str) {
		case "03":
			return "Invalid Version in Enquiry Header Segment";
		case "04":
			return "Invalid Field Length";
		case "05":
			return "Invalid Total Length";
		case "06":
			return "Invalid Enquiry Purpose";
		case "07":
			return "Invalid Enquiry Amount";
		case "08":
			return "Invalid Enquiry Member User ID/Password	";
		case "09":
			return "Required Enquiry Segment Missing";
		case "10":
			return "Invalid Enquiry Data";
		case "11":
			return "CIBIL System Error";
		case "12":
			return "Invalid Segment Tag";
		case "13":
			return "Invalid Segment Order";
		case "14":
			return "Invalid Field Tag Order";
		case "15":
			return "Missing Required Field";
		case "16":
			return "Requested Response Size Exceeded";
		case "17":
			return "Invalid Input/Output Media";
		default:
			return "Invalid Request";
		}
	}

	/**
	 * Method for prepare Success logging
	 * 
	 * @param reference
	 * @param requets
	 * @param response
	 * @param errorCode
	 * @param errorDesc
	 * @param reqSentOn
	 * @param status
	 */
	private void doInterfaceLogging(String reference, String requets, String response, String errorCode,
			String errorDesc, Timestamp reqSentOn, String status) {
		logger.debug(Literal.ENTERING);
		InterfaceLogDetail iLogDetail = new InterfaceLogDetail();
		iLogDetail.setReference(reference);

		if (cibil_Button) {
			iLogDetail.setServiceName("CIBIL_B");
		} else {
			iLogDetail.setServiceName("CIBIL");
		}
		iLogDetail.setEndPoint(SysParamUtil.getValueAsString("CIBIL_SOCKET_IP"));
		iLogDetail.setRequest(requets);
		iLogDetail.setReqSentOn(reqSentOn);

		iLogDetail.setResponse(response);
		iLogDetail.setRespReceivedOn(new Timestamp(System.currentTimeMillis()));
		iLogDetail.setStatus(status);
		iLogDetail.setErrorCode(errorCode);
		if (errorDesc != null && errorDesc.length() > 200) {
			iLogDetail.setErrorDesc(errorDesc.substring(0, 190));
		} else {
			iLogDetail.setErrorDesc(errorDesc);

		}

		logInterfaceDetails(iLogDetail);
		logger.debug(Literal.LEAVING);
	}

	private void parseHeaderResponse(String cibilResponse) {
		logger.debug(Literal.ENTERING);
		String responseHeader = cibilResponse.substring(0, 94);
		jsonResopnseHeader(responseHeader);
		logger.debug(Literal.LEAVING);
	}

	/**
	 * parses the response from CIBIL and puts in JSON object
	 * 
	 * @param detailsResult
	 */

	private JSONObject parseDetailsresponse(HashMap<String, String> detailsResult) throws Exception {
		logger.debug(Literal.ENTERING);

		String extRestructured = "0";
		String extSettled = "0";
		String extSuitFiled = "0";
		String extWrittenOff = "0";
		String extCreditAmuntOverdue = "0";
		String extWrittenOffNonCredit = "0";
		String extWrittenOffCredit = "0";
		String extDerog = "0";
		boolean dpdPaymentFlag = false;

		String key = null;
		try {
			LinkedHashMap<String, String> requiredValue = new LinkedHashMap<String, String>();
			Iterator<String> itr = detailsResult.keySet().iterator();
			while (itr.hasNext()) {
				key = itr.next();
				// Name Segment Non repeated segment
				if ("PN".equals(key)) {
					String pnSegment = detailsResult.get("PN");
					String[] required = pnSegment.split("PN03N01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String PnKey = it.next();

						for (int i = 0; i < StaticListUtil.getNameSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getNameSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getNameSegmentFieldTypes().get(i).getLabel();
							if (PnKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								primaryApplicant.put(label, requiredValue.get(value));

							}
						}
					}

					String gender = primaryApplicant.get("Gender").toString();
					if ("1".equals(gender)) {
						primaryApplicant.put("Gender", "Female");
					} else if ("2".equals(gender)) {
						primaryApplicant.put("Gender", "Male");
					}

					String dob = primaryApplicant.get("DateofBirth").toString();
					String date = getFormattedDate(dob);

					primaryApplicant.put("DateofBirth", date);
				}
				// Id Segment repeated segment
				if ("ID".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject id = null;
					String idSegment = detailsResult.get("ID");
					String[] required = idSegment.split("ID03I0");

					for (int i = 1; i < required.length; i++) {
						String idNo = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", idNo);
						Iterator<String> it = requiredValue.keySet().iterator();
						id = new JSONObject();

						while (it.hasNext()) {
							String idKey = it.next();
							for (int j = 0; j < StaticListUtil.getIdSegmentFieldTypes().size(); j++) {
								String value = StaticListUtil.getIdSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getIdSegmentFieldTypes().get(j).getLabel();
								if (idKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									id.put(label, requiredValue.get(value));

								}
							}
						}

						String idType = id.get("IDType").toString();
						id.put("IDType", cibilIdTypes.get(idType));

						if (!jsonObject.isNull("IssueDate")) {
							String dob = jsonObject.get("IssueDate").toString();
							String date = getFormattedDate(dob);
							primaryApplicant.put("IssueDate", date);
						}

						if (!jsonObject.isNull("ExpirationDate")) {
							String dob = jsonObject.get("ExpirationDate").toString();
							String date = getFormattedDate(dob);
							primaryApplicant.put("ExpirationDate", date);
						}

						Array.add(id);
						id = null;
					}

					primaryApplicant.put("ID", Array);

				}

				// Telephone Segment repeated segment
				if ("PT".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject pt = null;

					String ptSegment = detailsResult.get("PT");
					String[] required = ptSegment.split("PT03T0");
					for (int i = 1; i < required.length; i++) {
						String telePhone = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", telePhone);
						Iterator<String> it = requiredValue.keySet().iterator();
						pt = new JSONObject();
						while (it.hasNext()) {
							String ptKey = it.next();
							for (int j = 0; j < StaticListUtil.getTelePhoneSegmentFieldTypes().size(); j++) {
								String value = StaticListUtil.getTelePhoneSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getTelePhoneSegmentFieldTypes().get(j).getLabel();

								if (ptKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									pt.put(label, requiredValue.get(value));
								}
							}
						}

						if (!pt.isNull("TelephoneType")) {
							String phoneType = pt.get("TelephoneType").toString();
							pt.put("TelephoneType", cibilPhoneTypes.get(phoneType));
						}

						Array.add(pt);
						pt = null;
					}
					primaryApplicant.put("TelephoneSegment", Array);
				}

				// Email Contact Segment repeated segment
				if ("EC".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject ec = null;
					String ecSegment = detailsResult.get("EC");
					String[] required = ecSegment.split("EC03C0");
					for (int i = 1; i < required.length; i++) {
						String email = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", email);
						Iterator<String> it = requiredValue.keySet().iterator();
						ec = new JSONObject();
						while (it.hasNext()) {
							String ecKey = it.next();
							if (ecKey.equals("00") && !StringUtils.trimToEmpty(requiredValue.get("00")).equals("")) {
								ec.put("EMail", requiredValue.get("00"));
							}
							if (ecKey.equals("01") && !StringUtils.trimToEmpty(requiredValue.get("01")).equals("")) {
								ec.put("EMailID", requiredValue.get("01"));
							}
						}
						Array.add(ec);
						ec = null;
					}
					primaryApplicant.put("EmailContactSegment", Array);
				}
				// Employment Segment Non repeated segment
				if ("EM".equals(key)) {
					String pnSegment = detailsResult.get("EM");
					String[] required = pnSegment.split("EM03E01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String PnKey = it.next();

						for (int i = 0; i < StaticListUtil.getEmpSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getEmpSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getEmpSegmentFieldTypes().get(i).getLabel();
							if (PnKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								jsonObject.put(label, requiredValue.get(value));
							}
						}
					}

					if (!jsonObject.isNull("OccupationCode")) {
						String occCode = (String) jsonObject.get("OccupationCode");
						primaryApplicant.put("OccupationCode", cibilOccupationTypes.get(occCode));
					}

					if (!jsonObject.isNull("NetORGrossIncomeIndicator")) {
						String netOrGrossIndicator = (String) jsonObject.get("NetORGrossIncomeIndicator");
						primaryApplicant.put("NetORGrossIncomeIndicator",
								cibilIncomeIndicator.get(netOrGrossIndicator));
					}

					if (!jsonObject.isNull("MonthlyORAnnualIncomeIndicator")) {
						String monOrAnnualIncomeIndicator = (String) jsonObject.get("MonthlyORAnnualIncomeIndicator");
						primaryApplicant.put("MonthlyORAnnualIncomeIndicator",
								cibilMonthlyAnnualIncomeIndicator.get(monOrAnnualIncomeIndicator));
					}
				}
				// Enquiry Account Number Segment repeated segment
				if ("PI".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject pi = null;

					String piSegment = detailsResult.get("PI");
					String[] required = piSegment.split("PI03I0");
					for (int i = 1; i < required.length; i++) {
						String accNo = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", accNo);
						Iterator<String> it = requiredValue.keySet().iterator();
						pi = new JSONObject();
						while (it.hasNext()) {
							String piKey = it.next();
							if (piKey.equals("00") && !StringUtils.trimToEmpty(requiredValue.get("00")).equals("")) {
								pi.put("Accno", requiredValue.get("00"));
							}
							if (piKey.equals("01") && !StringUtils.trimToEmpty(requiredValue.get("01")).equals("")) {
								pi.put("EnqAccountNumber", requiredValue.get("01"));
							}
						}
						Array.add(pi);
						pi = null;
					}

					primaryApplicant.put("EnquiryAccountNumberSegment", Array);

				}
				// Score Segment Non repeated segment
				//				if ("SC".equals(key)) {
				//					String scSegment = detailsResult.get("SC");
				//					String[] req = scSegment.split("SC10");
				//					if (req[1].substring(0, 10).equals("CIBILTUSCR")) {
				//						primaryApplicant.put("ScoreName", "CIBILTUSCR");
				//					}
				//					

				if ("SC".equals(key)) {
					String scSegment = detailsResult.get("SC");
					String scoreName = null;
					if (StringUtils.equalsIgnoreCase(scSegment.substring(0, 4), "SC10")) {
						String[] req = scSegment.split("SC10");

						scoreName = req[1].substring(0, 10);

						if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("01") || this.CBIL_ENQUIRY_SCORE_TYPE.equals("03"))
							primaryApplicant.put("ScoreName", scoreName);

						else if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("04"))
							primaryApplicant.put("ScoreName", scoreName);

						else if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("08"))
							primaryApplicant.put("ScoreName", scoreName);

						else if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("12"))
							primaryApplicant.put("ScoreName", scoreName);

					} else if (StringUtils.equalsAnyIgnoreCase(scSegment.substring(0, 4), "SC07")) {
						String[] req = scSegment.split("SC07");
						scoreName = req[1].substring(0, 7);
						if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("02"))
							primaryApplicant.put("ScoreName", scoreName);
					}
					String[] reqScSegment = scSegment.split(scoreName);

					requiredValue = responseDetails.getCibilResponseDetails(reqScSegment[1]);
					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String ScKey = it.next();
						for (int i = 0; i < StaticListUtil.getScoreSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getScoreSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getScoreSegmentFieldTypes().get(i).getLabel();
							if (ScKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								primaryApplicant.put(label, requiredValue.get(value));
							}
						}
					}
				}

				// Address Segment Repeated Segment
				if ("PA".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject pa = null;

					String paSegment = detailsResult.get("PA");
					String[] required = paSegment.split("PA03A0");
					for (int i = 1; i < required.length; i++) {
						String address = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", address);
						Iterator<String> it = requiredValue.keySet().iterator();
						pa = new JSONObject();
						while (it.hasNext()) {
							String paKey = it.next();

							for (int j = 0; j < StaticListUtil.getAddressSegmentFieldTypes().size(); j++) {

								String value = StaticListUtil.getAddressSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getAddressSegmentFieldTypes().get(j).getLabel();

								if (paKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									pa.put(label, requiredValue.get(value));
								}
							}
						}

						if (!pa.isNull("StateCode")) {
							String stateCode = pa.get("StateCode").toString();
							pa.put("StateCode", cibilStateCodes.get(stateCode));
						}

						if (!pa.isNull("AddressCategory")) {
							String addCategory = (String) pa.get("AddressCategory");
							pa.put("AddressCategory", cibilAddrCategory.get(addCategory));
						}

						if (!pa.isNull("ResidenceCode")) {
							String residenceCode = (String) pa.get("ResidenceCode");
							pa.put("ResidenceCode", cibilResidenceCode.get(residenceCode));
						}

						if (!pa.isNull("DateReported")) {
							String date = pa.get("DateReported").toString();
							String formatteddate = getFormattedDate(date);
							pa.put("DateReported", formatteddate);
						}

						Array.add(pa);
						pa = null;
					}
					primaryApplicant.put("AddressSegment", Array);
				}

				// Account Segment repeated Segment
				if ("TL".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject tl = null;
					String tlSegment = detailsResult.get("TL");
					String[] required = tlSegment.split("TL04T");
					for (int i = 1; i < required.length; i++) {
						String AccSno = required[i].substring(0, 3);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(3, required[i].length()));
						requiredValue.put("00", AccSno);
						Iterator<String> it = requiredValue.keySet().iterator();
						tl = new JSONObject();
						while (it.hasNext()) {
							String tlKey = it.next();

							for (int j = 0; j < StaticListUtil.getAccountSegmentFieldTypes().size(); j++) {

								String value = StaticListUtil.getAccountSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getAccountSegmentFieldTypes().get(j).getLabel();

								if (tlKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									tl.put(label, requiredValue.get(value));
								}
							}

						}

						if (!tl.isNull("DateOpenedORDisbursed")) {
							String date = tl.get("DateOpenedORDisbursed").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateOpenedORDisbursed", formatteddate);
						}

						if (!tl.isNull("DateofLastPayment")) {
							String date = tl.get("DateofLastPayment").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateofLastPayment", formatteddate);
						}

						if (!tl.isNull("DateClosed")) {
							String date = tl.get("DateClosed").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateClosed", formatteddate);
							tl.put("AccountStatus", "Closed");
						} else {
							tl.put("AccountStatus", "Active");
						}

						if (!tl.isNull("DateReportedandCertified")) {
							String date = tl.get("DateReportedandCertified").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateReportedandCertified", formatteddate);
						}

						if (!tl.isNull("PaymentHistoryStartDate")) {
							String date = tl.get("PaymentHistoryStartDate").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("PaymentHistoryStartDate", formatteddate);
						}
						String formatteddate = null;
						if (!tl.isNull("PaymentHistoryEndDate")) {
							String date = tl.get("PaymentHistoryEndDate").toString();
							formatteddate = getFormattedDate(date);
							tl.put("PaymentHistoryEndDate", formatteddate);
						}
						String ownershipCode = null;
						if (!tl.isNull("OwnershipIndicator")) {
							ownershipCode = (String) tl.get("OwnershipIndicator");
							tl.put("OwnershipIndicator", cibilOwnershipTypes.get(ownershipCode));
						}
						String accType = null;
						String accountType = null;
						if (!tl.isNull("AccountType")) {
							accType = (String) tl.get("AccountType");
							accountType = cibilloanTypes.get(accType + "  ");
							tl.put("AccountType", accountType);
						}
						String HighCreditORSanctionedAmount = null;
						if (!tl.isNull("HighCreditORSanctionedAmount")) {
							String data = tl.get("HighCreditORSanctionedAmount").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							HighCreditORSanctionedAmount = formatAmount(amount, 2, false);
							tl.put("HighCreditORSanctionedAmount", HighCreditORSanctionedAmount);
						}

						if (!tl.isNull("CurrentBalance")) {
							String data = tl.get("CurrentBalance").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							tl.put("CurrentBalance", formattedAmount);
						}
						String amountOverDue = null;
						BigDecimal overDue = BigDecimal.ZERO;
						if (!tl.isNull("AmountOverdue")) {
							String data = tl.get("AmountOverdue").toString();
							overDue = BigDecimal.valueOf(Long.valueOf(data));
							amountOverDue = formatAmount(overDue, 2, false);
							tl.put("AmountOverdue", amountOverDue);
						}

						String CreditLimit = null;
						if (!tl.isNull("CreditLimit")) {
							String data = tl.get("CreditLimit").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							CreditLimit = formatAmount(amount, 2, false);
							tl.put("CreditLimit", CreditLimit);
						}
						getAccountSegmentExtFields(primaryApplicant, formatteddate, ownershipCode, accType,
								HighCreditORSanctionedAmount, amountOverDue, CreditLimit, accountType);

						if (!tl.isNull("CashLimit")) {
							String data = tl.get("CashLimit").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							tl.put("CashLimit", formattedAmount);
						}

						if (!tl.isNull("EMIAmount")) {
							String data = tl.get("EMIAmount").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							tl.put("EMIAmount", formattedAmount);
						}
						if (!tl.isNull("PaymentFrequency")) {
							String paymentFreq = (String) tl.get("PaymentFrequency");
							tl.put("PaymentFrequency", cibilPaymentFreqTypes.get(paymentFreq));
						}

						//Suit Filed for GHFs
						if (!tl.isNull("SuitFiledORSWilful_Default")) {
							String SuitFiledORSWilful_Default = (String) tl.get("SuitFiledORSWilful_Default");
							tl.put("SuitFiledORSWilful_Default",
									getSuitFiledORSWilfulDefault(SuitFiledORSWilful_Default));
							if (accountType != null && StringUtils.equals(SuitFiledORSWilful_Default, "01")) {
								tl.put("SuitFiled", "1");
								if (!StringUtils.equals(extSuitFiled, "1")) {
									extSuitFiled = "1";
								}
							} else {
								tl.put("SuitFiled", "0");
							}
						}
						//Write-Off,WrittenoffandSettledStatus values can get these Restructured and Settled 
						String writtenoffandSettledStatus = null;
						if (!tl.isNull("WrittenoffandSettledStatus")) {
							writtenoffandSettledStatus = (String) tl.get("WrittenoffandSettledStatus");
							tl.put("WrittenoffandSettledStatus",
									getwriteOfSettlementsStatus(writtenoffandSettledStatus));
							if (accountType != null && (!accountType.equals("Credit Card")
									&& StringUtils.equals(writtenoffandSettledStatus, "02"))) {
								tl.put("WrittenOff", "1");
								if (!StringUtils.equals(extWrittenOff, "1")) {
									extWrittenOff = "1";
								}
							} else {
								tl.put("WrittenOff", "0");
							}
							if (accountType != null && StringUtils.equals(writtenoffandSettledStatus, "03")) {
								tl.put("Settled", "1");
								if (!StringUtils.equals(extSettled, "1")) {
									extSettled = "1";
								}
							} else {
								tl.put("Settled", "0");
							}
							if (accountType != null && (StringUtils.equals(writtenoffandSettledStatus, "00")
									|| StringUtils.equals(writtenoffandSettledStatus, "01"))) {
								tl.put("Restructured", "1");
							} else {
								tl.put("Restructured", "0");
							}
						}

						if (!tl.isNull("PaymentHistory1") && !tl.isNull("PaymentHistoryEndDate")
								&& !tl.isNull("PaymentHistoryStartDate")) {
							String paymentHistory = (String) tl.get("PaymentHistory1");
							String paymentHistoryStDate = (String) tl.get("PaymentHistoryStartDate");

							SimpleDateFormat sdf = new SimpleDateFormat(InterfaceConstants.dateFormat);
							Date date = sdf.parse(paymentHistoryStDate);

							getNoOfAccountsIn30And60DpdIn12M(paymentHistory, date);
							int startMonth = DateUtil.getMonth(date);
							String startYear = String.valueOf(DateUtil.getYear(date));
							int reqYear = Integer.parseInt(startYear.substring(2));

							List<String> ph = java.util.Arrays.asList(paymentHistory.split("(?<=\\G...)"));

							String currentDate = DateUtil.format(new Date(), "MM-yyyy");
							String paymentHstDate = DateUtil.format(date, "MM-yyyy");
							if (StringUtils.equals(currentDate, paymentHstDate)
									&& !StringUtils.equals(ph.get(0), "000")) {
								dpdPaymentFlag = true;
							}

							String finalKey = "";
							for (String t : ph) {
								t = t.concat("(" + startMonth + "-" + reqYear + ")   ");
								startMonth = startMonth - 1;
								if (startMonth == 0) {
									startMonth = 12;
									reqYear = reqYear - 1;
								}

								finalKey = finalKey.concat(t);
							}

							tl.put("PaymentHistory1", finalKey);

							if (getDerogDetails(finalKey, false)) {
								tl.put("Derog", "1");
								if (!StringUtils.equals(extDerog, "1")) {
									extDerog = "1";
								}
							} else {
								tl.put("Derog", "0");
							}
						}

						if ((amountOverDue != null && accountType != null) && (accountType.equals("Credit Card")
								&& overDue.compareTo(new BigDecimal(30000)) > 0 && dpdPaymentFlag)) {
							tl.put("CreditAmuntOverdue", "1");
							if (!StringUtils.equals(extCreditAmuntOverdue, "1")) {
								extCreditAmuntOverdue = "1";
							}
						} else {
							tl.put("CreditAmuntOverdue", "0");
						}

						if ((amountOverDue != null && accountType != null) && (!accountType.equals("Credit Card")
								&& overDue.compareTo(BigDecimal.ZERO) > 0 && dpdPaymentFlag)) {
							tl.put("WrittenOffNonCredit", "1");
							if (!StringUtils.equals(extWrittenOffNonCredit, "1")) {
								extWrittenOffNonCredit = "1";
							}
						} else {
							tl.put("WittenOffNonCredit", "0");
						}

						BigDecimal writtenOffAmuntTol = BigDecimal.ZERO;
						if (!tl.isNull("WrittenoffAmountTotal")) {
							String data = tl.get("WrittenoffAmountTotal").toString();
							writtenOffAmuntTol = BigDecimal.valueOf(Long.valueOf(data));
						}
						if ((accountType != null && writtenoffandSettledStatus != null)
								&& (accountType.equals("Credit Card")
										&& StringUtils.equals(writtenoffandSettledStatus, "02")
										&& writtenOffAmuntTol.compareTo(new BigDecimal(30000)) > 0)) {
							tl.put("WrittenOffCredit", "1");
							if (!StringUtils.equals(extWrittenOffCredit, "1")) {
								extWrittenOffCredit = "1";
							}
						} else {
							tl.put("WrittenOffCredit", "0");
						}

						Array.add(tl);
					}
					primaryApplicant.put("AccountSegment", Array);
					primaryApplicant.put("NoOfAccountsIn30dpdL12M", noOfAccountsIn30dpdL12M);
					primaryApplicant.put("NoOfAccountsIn1dpdL6M", noOfAccountsIn1dpdL6M);
					primaryApplicant.put("ExtSettled", extSettled);
					primaryApplicant.put("ExtWrittenOff", extWrittenOff);
					primaryApplicant.put("ExtRestructured", extRestructured);
					primaryApplicant.put("ExtSuitFiled", extSuitFiled);
					primaryApplicant.put("ExtCreditAmuntOverdue", extCreditAmuntOverdue);
					primaryApplicant.put("ExtWrittenOffNonCredit", extWrittenOffNonCredit);
					primaryApplicant.put("ExtWrittenOffCredit", extWrittenOffCredit);
					primaryApplicant.put("ExtDerog", extDerog);
					System.out.println("response :::" + primaryApplicant);
					noOfAccountsIn30dpdL12M = 0;
					noOfAccountsIn1dpdL6M = 0;
				}

				// Enquiry Segment repeated segment
				if ("IQ".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject iq = null;

					String iqSegment = detailsResult.get("IQ");
					String[] required = iqSegment.split("IQ04I");
					for (int i = 1; i < required.length; i++) {
						String EnqSno = required[i].substring(0, 3);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(3, required[i].length()));
						requiredValue.put("00", EnqSno);
						Iterator<String> it = requiredValue.keySet().iterator();
						iq = new JSONObject();
						while (it.hasNext()) {
							String iqKey = it.next();
							for (int j = 0; j < StaticListUtil.getEnqSegmentFieldTypes().size(); j++) {

								String value = StaticListUtil.getEnqSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getEnqSegmentFieldTypes().get(j).getLabel();

								if (iqKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									iq.put(label, requiredValue.get(value));
								}
							}
						}

						if (!iq.isNull("EnquiryPurpose")) {
							String enqPurpose = iq.get("EnquiryPurpose").toString();
							if (StringUtils.equalsIgnoreCase(enqPurpose, "00")) {
								iq.put("EnquiryPurpose", "Others");
							} else {
								iq.put("EnquiryPurpose", cibilloanTypes.get(enqPurpose + "  "));
							}
						}

						if (!iq.isNull("DateofEnquiry")) {
							String date = iq.get("DateofEnquiry").toString();
							String formatteddate = getFormattedDate(date);
							iq.put("DateofEnquiry", formatteddate);
						}

						if (!iq.isNull("EnquiryAmount")) {
							String data = iq.get("EnquiryAmount").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							iq.put("EnquiryAmount", formattedAmount);
						}

						Array.add(iq);
						iq = null;
					}
					primaryApplicant.put("EnquirySegment", Array);
				}
				// Consumer Dispute Remarks Segment(DR) non repeated segment
				if ("DR".equals(key)) {

					String drSegment = detailsResult.get("DR");
					String[] required = drSegment.split("DR03D01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String drKey = it.next();

						for (int i = 0; i < StaticListUtil.getDrSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getDrSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getDrSegmentFieldTypes().get(i).getLabel();

							if (drKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								primaryApplicant.put(label, requiredValue.get(value));
							}
						}
					}

				}
				// Error Segment-Non repeated segment
				if ("UR".equals(key)) {

					String drSegment = detailsResult.get("UR");
					String[] required = drSegment.split("UR03U01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String drKey = it.next();

						for (int i = 0; i < StaticListUtil.getUrSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getUrSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getUrSegmentFieldTypes().get(i).getLabel();

							if (drKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								primaryApplicant.put(label, requiredValue.get(value));
								primaryApplicant.put("URSegment", requiredValue.get(value));
							}
						}
					}

				}
				// End Segment non repeated segment
				if ("ES".equals(key)) {
					String drSegment = detailsResult.get("ES");
					String[] required = drSegment.split("ES07");
					primaryApplicant.put("LengthofTransmission", required[1].substring(0, 7));
					primaryApplicant.put("EndCharacters", required[1].substring(7, 11) + "**");

				}

			}

			/*
			 * // Account Segment repeated Segment JSONArray Array = new JSONArray(); JSONObject jo = null; String
			 * tlSegment = detailsResult.get("TL"); String[] required = tlSegment.split("TL04T"); for (int i = 1; i <
			 * required.length; i++) {
			 * 
			 * String AccSno = required[i].substring(0, 3); requiredValue =
			 * responseDetails.getCibilResponseDetails(required[i].substring(3, required[i].length()));
			 * requiredValue.put("00", AccSno); Iterator<String> it = requiredValue.keySet().iterator(); jo = new
			 * JSONObject(); while (it.hasNext()) { String tlKey = it.next();
			 * 
			 * for (int j = 0; j < StaticListUtil.getAccountSummary().size(); j++) {
			 * 
			 * String value = StaticListUtil.getAccountSummary().get(j).getValue(); String label =
			 * StaticListUtil.getAccountSummary().get(j).getLabel();
			 * 
			 * if (tlKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) { jo.put(label,
			 * requiredValue.get(value)); } }
			 * 
			 * }
			 * 
			 * 
			 * 
			 * Array.add(jo); jo = null; } jsonObject.put("AccountSegment", Array);
			 */

			logger.debug(Literal.LEAVING);
		} catch (Exception e) {
			logger.debug("Error parsing response in  " + key + " segment");
			throw e;

		}
		return jsonObject;
	}

	private void getNoOfAccountsIn30And60DpdIn12M(String paymentHistory, Date paymentHistoryStDate) {
		Date wait30Date = null;
		Date wait60Date = null;
		Date date = new Date();
		try {
			wait30Date = DateUtils.addMonths(date, -1);
			wait30Date = DateUtils.addMonths(wait30Date, -6);
			wait60Date = DateUtils.addMonths(wait30Date, -12);
			if (paymentHistoryStDate.before(wait30Date)) {
				List<String> ph = java.util.Arrays.asList(paymentHistory.split("(?<=\\G...)"));
				int i = 6;
				int count = 1;
				for (String t : ph) {
					if (count <= i) {
						int delinquency = Integer.valueOf(t);
						if (delinquency != 0 && delinquency >= 1) {
							noOfAccountsIn30dpdL12M++;
						}
					}
					count++;
				}

			}
			if (noOfAccountsIn30dpdL12M == 0) {
				if (paymentHistoryStDate.before(wait60Date)) {
					List<String> ph = java.util.Arrays.asList(paymentHistory.split("(?<=\\G...)"));
					int count = 1;
					int i = 12;

					for (String t : ph) {
						if (count <= i) {
							int delinquency = Integer.valueOf(t);
							if (delinquency != 0 && delinquency >= 30) {
								noOfAccountsIn1dpdL6M++;
							}

						}
						count++;
					}

				}
			}
		} catch (Exception e) {
			logger.info(e);
		}

	}

	private boolean getDerogDetails(String finalKey, boolean derg) {
		Set<String> derogs = new HashSet<>();
		derogs.add("STD");
		derogs.add("SMA");
		derogs.add("DBT");
		derogs.add("LSS");
		if (derogs.contains(finalKey)) {
			derg = true;
		}
		return derg;

	}

	private String getwriteOfSettlementsStatus(String writtenoffandSettledStatus) {
		String settledStatus = "";
		switch (writtenoffandSettledStatus) {
		case "00":
			settledStatus = "Restructured Loan";
			break;
		case "01":
			settledStatus = "Restructured Loan (Govt. Mandated)";
			break;
		case "02":
			settledStatus = "Written-off";
			break;
		case "03":
			settledStatus = "Settled";
			break;
		case "04":
			settledStatus = "Post (WO) Settled";
			break;
		case "05":
			settledStatus = "Account Sold";
			break;
		case "06":
			settledStatus = "Written Off and Account Sold";
			break;
		case "07":
			settledStatus = "Account Purchased";
			break;
		case "08":
			settledStatus = "Account Purchased and Written Off";
			break;
		case "09":
			settledStatus = "Account Purchased and Settled";
			break;
		case "10":
			settledStatus = "Account Purchased and Restructured";
			break;

		default:
			break;
		}
		return settledStatus;
	}

	private String getSuitFiledORSWilfulDefault(String suitFiledORSWilful_Default) {
		String suitFiled = "";
		switch (suitFiledORSWilful_Default) {
		case "00":
			suitFiled = "No Suit Filed";
			break;
		case "01":
			suitFiled = "Suit Filed";
			break;
		case "02":
			suitFiled = "Wilful default";
			break;
		case "03":
			suitFiled = "Suit filed (Wilful default)";
			break;

		default:
			break;
		}
		return suitFiled;
	}

	private JSONObject parseSecondaryDetailsresponse(HashMap<String, String> detailsResult) throws Exception {
		logger.debug(Literal.ENTERING);

		String key = null;
		try {
			LinkedHashMap<String, String> requiredValue = new LinkedHashMap<String, String>();
			Iterator<String> itr = detailsResult.keySet().iterator();
			while (itr.hasNext()) {
				key = itr.next();
				// Name Segment Non repeated segment
				if ("PN".equals(key)) {
					cd = new JSONObject();
					String pnSegment = detailsResult.get("PN");
					String[] required = pnSegment.split("PN03N01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String PnKey = it.next();

						for (int i = 0; i < StaticListUtil.getNameSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getNameSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getNameSegmentFieldTypes().get(i).getLabel();
							if (PnKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								cd.put(label, requiredValue.get(value));

							}
						}
					}

					String gender = cd.get("Gender").toString();
					if ("1".equals(gender)) {
						cd.put("Gender", "Female");
					} else if ("2".equals(gender)) {
						cd.put("Gender", "Male");
					}

					String dob = cd.get("DateofBirth").toString();
					String date = getFormattedDate(dob);

					cd.put("DateofBirth", date);

					secondaryApplicant.put("CDetails", cd);
				}
				// Id Segment repeated segment
				if ("ID".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject id = null;
					String idSegment = detailsResult.get("ID");
					String[] required = idSegment.split("ID03I0");

					for (int i = 1; i < required.length; i++) {
						String idNo = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", idNo);
						Iterator<String> it = requiredValue.keySet().iterator();
						id = new JSONObject();

						while (it.hasNext()) {
							String idKey = it.next();
							for (int j = 0; j < StaticListUtil.getIdSegmentFieldTypes().size(); j++) {
								String value = StaticListUtil.getIdSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getIdSegmentFieldTypes().get(j).getLabel();
								if (idKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									id.put(label, requiredValue.get(value));

								}
							}
						}

						String idType = id.get("IDType").toString();
						id.put("IDType", cibilIdTypes.get(idType));

						if (!jsonObject.isNull("IssueDate")) {
							String dob = jsonObject.get("IssueDate").toString();
							String date = getFormattedDate(dob);
							secondaryApplicant.put("IssueDate", date);
						}

						if (!jsonObject.isNull("ExpirationDate")) {
							String dob = jsonObject.get("ExpirationDate").toString();
							String date = getFormattedDate(dob);
							secondaryApplicant.put("ExpirationDate", date);
						}

						Array.add(id);
						id = null;
					}

					secondaryApplicant.put("ID", Array);

				}

				// Telephone Segment repeated segment
				if ("PT".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject pt = null;

					String ptSegment = detailsResult.get("PT");
					String[] required = ptSegment.split("PT03T0");
					for (int i = 1; i < required.length; i++) {
						String telePhone = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", telePhone);
						Iterator<String> it = requiredValue.keySet().iterator();
						pt = new JSONObject();
						while (it.hasNext()) {
							String ptKey = it.next();
							for (int j = 0; j < StaticListUtil.getTelePhoneSegmentFieldTypes().size(); j++) {
								String value = StaticListUtil.getTelePhoneSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getTelePhoneSegmentFieldTypes().get(j).getLabel();

								if (ptKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									pt.put(label, requiredValue.get(value));
								}
							}
						}

						if (!pt.isNull("TelephoneType")) {
							String phoneType = pt.get("TelephoneType").toString();
							pt.put("TelephoneType", cibilPhoneTypes.get(phoneType));
						}

						Array.add(pt);
						pt = null;
					}
					secondaryApplicant.put("TelephoneSegment", Array);
				}

				// Email Contact Segment repeated segment
				if ("EC".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject ec = null;
					String ecSegment = detailsResult.get("EC");
					String[] required = ecSegment.split("EC03C0");
					for (int i = 1; i < required.length; i++) {
						String email = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", email);
						Iterator<String> it = requiredValue.keySet().iterator();
						ec = new JSONObject();
						while (it.hasNext()) {
							String ecKey = it.next();
							if (ecKey.equals("00") && !StringUtils.trimToEmpty(requiredValue.get("00")).equals("")) {
								ec.put("EMail", requiredValue.get("00"));
							}
							if (ecKey.equals("01") && !StringUtils.trimToEmpty(requiredValue.get("01")).equals("")) {
								ec.put("EMailID", requiredValue.get("01"));
							}
						}
						Array.add(ec);
						ec = null;
					}
					secondaryApplicant.put("EmailContactSegment", Array);
				}
				// Employment Segment Non repeated segment
				if ("EM".equals(key)) {
					String pnSegment = detailsResult.get("EM");
					String[] required = pnSegment.split("EM03E01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String PnKey = it.next();

						for (int i = 0; i < StaticListUtil.getEmpSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getEmpSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getEmpSegmentFieldTypes().get(i).getLabel();
							if (PnKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								jsonObject.put(label, requiredValue.get(value));
							}
						}
					}

					if (!jsonObject.isNull("OccupationCode")) {
						String occCode = (String) jsonObject.get("OccupationCode");
						secondaryApplicant.put("OccupationCode", cibilOccupationTypes.get(occCode));
					}

					if (!jsonObject.isNull("NetORGrossIncomeIndicator")) {
						String netOrGrossIndicator = (String) jsonObject.get("NetORGrossIncomeIndicator");
						secondaryApplicant.put("NetORGrossIncomeIndicator",
								cibilIncomeIndicator.get(netOrGrossIndicator));
					}

					if (!jsonObject.isNull("MonthlyORAnnualIncomeIndicator")) {
						String monOrAnnualIncomeIndicator = (String) jsonObject.get("MonthlyORAnnualIncomeIndicator");
						secondaryApplicant.put("MonthlyORAnnualIncomeIndicator",
								cibilMonthlyAnnualIncomeIndicator.get(monOrAnnualIncomeIndicator));
					}
				}
				// Enquiry Account Number Segment repeated segment
				if ("PI".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject pi = null;

					String piSegment = detailsResult.get("PI");
					String[] required = piSegment.split("PI03I0");
					for (int i = 1; i < required.length; i++) {
						String accNo = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", accNo);
						Iterator<String> it = requiredValue.keySet().iterator();
						pi = new JSONObject();
						while (it.hasNext()) {
							String piKey = it.next();
							if (piKey.equals("00") && !StringUtils.trimToEmpty(requiredValue.get("00")).equals("")) {
								pi.put("Accno", requiredValue.get("00"));
							}
							if (piKey.equals("01") && !StringUtils.trimToEmpty(requiredValue.get("01")).equals("")) {
								pi.put("EnqAccountNumber", requiredValue.get("01"));
							}
						}
						Array.add(pi);
						pi = null;
					}

					secondaryApplicant.put("EnquiryAccountNumberSegment", Array);

				}
				// Score Segment Non repeated segment
				//				if ("SC".equals(key)) {
				//					String scSegment = detailsResult.get("SC");
				//					String[] req = scSegment.split("SC10");
				//					if (req[1].substring(0, 10).equals("CIBILTUSCR")) {
				//						secondaryApplicant.put("ScoreName", "CIBILTUSCR");
				//					}
				//					String[] reqScSegment = scSegment.split("SC10CIBILTUSCR");

				if ("SC".equals(key)) {
					String scSegment = detailsResult.get("SC");
					String scoreName = null;
					if (StringUtils.equalsIgnoreCase(scSegment.substring(0, 4), "SC10")) {
						String[] req = scSegment.split("SC10");

						scoreName = req[1].substring(0, 10);

						if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("01") || this.CBIL_ENQUIRY_SCORE_TYPE.equals("03"))
							secondaryApplicant.put("ScoreName", scoreName);

						else if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("04"))
							secondaryApplicant.put("ScoreName", scoreName);

						else if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("08"))
							secondaryApplicant.put("ScoreName", scoreName);

						else if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("12"))
							secondaryApplicant.put("ScoreName", scoreName);

					} else if (StringUtils.equalsAnyIgnoreCase(scSegment.substring(0, 4), "SC07")) {
						String[] req = scSegment.split("SC07");
						scoreName = req[1].substring(0, 7);
						if (this.CBIL_ENQUIRY_SCORE_TYPE.equals("02"))
							secondaryApplicant.put("ScoreName", scoreName);
					}
					String[] reqScSegment = scSegment.split(scoreName);

					requiredValue = responseDetails.getCibilResponseDetails(reqScSegment[1]);
					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String ScKey = it.next();
						for (int i = 0; i < StaticListUtil.getScoreSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getScoreSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getScoreSegmentFieldTypes().get(i).getLabel();
							if (ScKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								secondaryApplicant.put(label, requiredValue.get(value));
							}
						}
					}
				}

				// Address Segment Repeated Segment
				if ("PA".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject pa = null;

					String paSegment = detailsResult.get("PA");
					String[] required = paSegment.split("PA03A0");
					for (int i = 1; i < required.length; i++) {
						String address = required[i].substring(0, 1);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(1, required[i].length()));
						requiredValue.put("00", address);
						Iterator<String> it = requiredValue.keySet().iterator();
						pa = new JSONObject();
						while (it.hasNext()) {
							String paKey = it.next();

							for (int j = 0; j < StaticListUtil.getAddressSegmentFieldTypes().size(); j++) {

								String value = StaticListUtil.getAddressSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getAddressSegmentFieldTypes().get(j).getLabel();

								if (paKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									pa.put(label, requiredValue.get(value));
								}
							}
						}

						if (!pa.isNull("StateCode")) {
							String stateCode = pa.get("StateCode").toString();
							pa.put("StateCode", cibilStateCodes.get(stateCode));
						}

						if (!pa.isNull("AddressCategory")) {
							String addCategory = (String) pa.get("AddressCategory");
							pa.put("AddressCategory", cibilAddrCategory.get(addCategory));
						}

						if (!pa.isNull("ResidenceCode")) {
							String residenceCode = (String) pa.get("ResidenceCode");
							pa.put("ResidenceCode", cibilResidenceCode.get(residenceCode));
						}

						if (!pa.isNull("DateReported")) {
							String date = pa.get("DateReported").toString();
							String formatteddate = getFormattedDate(date);
							pa.put("DateReported", formatteddate);
						}

						Array.add(pa);
						pa = null;
					}
					secondaryApplicant.put("AddressSegment", Array);
				}

				// Account Segment repeated Segment
				if ("TL".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject tl = null;
					String tlSegment = detailsResult.get("TL");
					String[] required = tlSegment.split("TL04T");
					for (int i = 1; i < required.length; i++) {
						String AccSno = required[i].substring(0, 3);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(3, required[i].length()));
						requiredValue.put("00", AccSno);
						Iterator<String> it = requiredValue.keySet().iterator();
						tl = new JSONObject();
						while (it.hasNext()) {
							String tlKey = it.next();

							for (int j = 0; j < StaticListUtil.getAccountSegmentFieldTypes().size(); j++) {

								String value = StaticListUtil.getAccountSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getAccountSegmentFieldTypes().get(j).getLabel();

								if (tlKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									tl.put(label, requiredValue.get(value));
								}
							}

						}

						if (!tl.isNull("DateOpenedORDisbursed")) {
							String date = tl.get("DateOpenedORDisbursed").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateOpenedORDisbursed", formatteddate);
						}

						if (!tl.isNull("DateofLastPayment")) {
							String date = tl.get("DateofLastPayment").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateofLastPayment", formatteddate);
						}

						if (!tl.isNull("DateClosed")) {
							String date = tl.get("DateClosed").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateClosed", formatteddate);
						}

						if (!tl.isNull("DateReportedandCertified")) {
							String date = tl.get("DateReportedandCertified").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("DateReportedandCertified", formatteddate);
						}

						if (!tl.isNull("PaymentHistoryStartDate")) {
							String date = tl.get("PaymentHistoryStartDate").toString();
							String formatteddate = getFormattedDate(date);
							tl.put("PaymentHistoryStartDate", formatteddate);
						}
						String formatteddate = null;
						if (!tl.isNull("PaymentHistoryEndDate")) {
							String date = tl.get("PaymentHistoryEndDate").toString();
							formatteddate = getFormattedDate(date);
							tl.put("PaymentHistoryEndDate", formatteddate);
						}
						String ownershipCode = null;
						if (!tl.isNull("OwnershipIndicator")) {
							ownershipCode = (String) tl.get("OwnershipIndicator");
							tl.put("OwnershipIndicator", cibilOwnershipTypes.get(ownershipCode));
						}
						String accType = null;
						if (!tl.isNull("AccountType")) {
							accType = (String) tl.get("AccountType");
							tl.put("AccountType", cibilloanTypes.get(accType));

						}
						String HighCreditORSanctionedAmount = null;
						if (!tl.isNull("HighCreditORSanctionedAmount")) {
							String data = tl.get("HighCreditORSanctionedAmount").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							HighCreditORSanctionedAmount = formatAmount(amount, 2, false);
							tl.put("HighCreditORSanctionedAmount", HighCreditORSanctionedAmount);
						}

						if (!tl.isNull("CurrentBalance")) {
							String data = tl.get("CurrentBalance").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							tl.put("CurrentBalance", formattedAmount);
						}
						String amountOverDue = null;
						if (!tl.isNull("AmountOverdue")) {
							String data = tl.get("AmountOverdue").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							amountOverDue = formatAmount(amount, 2, false);
							tl.put("AmountOverdue", amountOverDue);
						}
						String CreditLimit = null;
						if (!tl.isNull("CreditLimit")) {
							String data = tl.get("CreditLimit").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							CreditLimit = formatAmount(amount, 2, false);
							tl.put("CreditLimit", CreditLimit);
						}

						if (!tl.isNull("CashLimit")) {
							String data = tl.get("CashLimit").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							tl.put("CashLimit", formattedAmount);
						}

						if (!tl.isNull("EMIAmount")) {
							String data = tl.get("EMIAmount").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							tl.put("EMIAmount", formattedAmount);
						}

						if (!tl.isNull("PaymentFrequency")) {
							String paymentFreq = (String) tl.get("PaymentFrequency");
							tl.put("PaymentFrequency", cibilPaymentFreqTypes.get(paymentFreq));
						}

						if (!tl.isNull("PaymentHistory1") && !tl.isNull("PaymentHistoryEndDate")
								&& !tl.isNull("PaymentHistoryStartDate")) {
							String paymentHistory = (String) tl.get("PaymentHistory1");
							String paymentHistoryStDate = (String) tl.get("PaymentHistoryStartDate");

							SimpleDateFormat sdf = new SimpleDateFormat(InterfaceConstants.dateFormat);
							Date date = sdf.parse(paymentHistoryStDate);

							int startMonth = DateUtil.getMonth(date);
							String startYear = String.valueOf(DateUtil.getYear(date));
							int reqYear = Integer.parseInt(startYear.substring(2));

							List<String> ph = java.util.Arrays.asList(paymentHistory.split("(?<=\\G...)"));
							String finalKey = "";
							for (String t : ph) {
								t = t.concat("(" + startMonth + "-" + reqYear + ")   ");
								startMonth = startMonth - 1;
								if (startMonth == 0) {
									startMonth = 12;
									reqYear = reqYear - 1;
								}

								finalKey = finalKey.concat(t);
							}

							tl.put("PaymentHistory1", finalKey);
						}

						Array.add(tl);

					}
					secondaryApplicant.put("AccountSegment", Array);
				}

				// Enquiry Segment repeated segment
				if ("IQ".equals(key)) {
					JSONArray Array = new JSONArray();
					JSONObject iq = null;

					String iqSegment = detailsResult.get("IQ");
					String[] required = iqSegment.split("IQ04I");
					for (int i = 1; i < required.length; i++) {
						String EnqSno = required[i].substring(0, 3);
						requiredValue = responseDetails
								.getCibilResponseDetails(required[i].substring(3, required[i].length()));
						requiredValue.put("00", EnqSno);
						Iterator<String> it = requiredValue.keySet().iterator();
						iq = new JSONObject();
						while (it.hasNext()) {
							String iqKey = it.next();
							for (int j = 0; j < StaticListUtil.getEnqSegmentFieldTypes().size(); j++) {

								String value = StaticListUtil.getEnqSegmentFieldTypes().get(j).getValue();
								String label = StaticListUtil.getEnqSegmentFieldTypes().get(j).getLabel();

								if (iqKey.equals(value)
										&& !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
									iq.put(label, requiredValue.get(value));
								}
							}
						}

						if (!iq.isNull("EnquiryPurpose")) {
							String enqPurpose = iq.get("EnquiryPurpose").toString();
							if (StringUtils.equalsIgnoreCase(enqPurpose, "00")) {
								iq.put("EnquiryPurpose", "Others");
							} else {
								iq.put("EnquiryPurpose", cibilloanTypes.get(enqPurpose + "  "));
							}
						}

						if (!iq.isNull("DateofEnquiry")) {
							String date = iq.get("DateofEnquiry").toString();
							String formatteddate = getFormattedDate(date);
							iq.put("DateofEnquiry", formatteddate);
						}

						if (!iq.isNull("EnquiryAmount")) {
							String data = iq.get("EnquiryAmount").toString();
							BigDecimal amount = BigDecimal.valueOf(Long.valueOf(data));
							String formattedAmount = formatAmount(amount, 2, false);
							iq.put("EnquiryAmount", formattedAmount);
						}

						Array.add(iq);
						iq = null;
					}
					secondaryApplicant.put("EnquirySegment", Array);
				}
				// Consumer Dispute Remarks Segment(DR) non repeated segment
				if ("DR".equals(key)) {

					String drSegment = detailsResult.get("DR");
					String[] required = drSegment.split("DR03D01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String drKey = it.next();

						for (int i = 0; i < StaticListUtil.getDrSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getDrSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getDrSegmentFieldTypes().get(i).getLabel();

							if (drKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								secondaryApplicant.put(label, requiredValue.get(value));
							}
						}
					}

				}
				// Error Segment-Non repeated segment
				if ("UR".equals(key)) {

					String drSegment = detailsResult.get("UR");
					String[] required = drSegment.split("UR03U01");
					requiredValue = responseDetails.getCibilResponseDetails(required[1]);

					Iterator<String> it = requiredValue.keySet().iterator();
					while (it.hasNext()) {
						String drKey = it.next();

						for (int i = 0; i < StaticListUtil.getUrSegmentFieldTypes().size(); i++) {
							String value = StaticListUtil.getUrSegmentFieldTypes().get(i).getValue();
							String label = StaticListUtil.getUrSegmentFieldTypes().get(i).getLabel();

							if (drKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) {
								secondaryApplicant.put(label, requiredValue.get(value));
							}
						}
					}

				}
				// End Segment non repeated segment
				if ("ES".equals(key)) {
					String drSegment = detailsResult.get("ES");
					String[] required = drSegment.split("ES07");
					secondaryApplicant.put("LengthofTransmission", required[1].substring(0, 7));
					secondaryApplicant.put("EndCharacters", required[1].substring(7, 11) + "**");

				}

			}
			//	secondaryApplicant.put("CDetails",cdetails);

			/*
			 * // Account Segment repeated Segment JSONArray Array = new JSONArray(); JSONObject jo = null; String
			 * tlSegment = detailsResult.get("TL"); String[] required = tlSegment.split("TL04T"); for (int i = 1; i <
			 * required.length; i++) {
			 * 
			 * String AccSno = required[i].substring(0, 3); requiredValue =
			 * responseDetails.getCibilResponseDetails(required[i].substring(3, required[i].length()));
			 * requiredValue.put("00", AccSno); Iterator<String> it = requiredValue.keySet().iterator(); jo = new
			 * JSONObject(); while (it.hasNext()) { String tlKey = it.next();
			 * 
			 * for (int j = 0; j < StaticListUtil.getAccountSummary().size(); j++) {
			 * 
			 * String value = StaticListUtil.getAccountSummary().get(j).getValue(); String label =
			 * StaticListUtil.getAccountSummary().get(j).getLabel();
			 * 
			 * if (tlKey.equals(value) && !StringUtils.trimToEmpty(requiredValue.get(value)).equals("")) { jo.put(label,
			 * requiredValue.get(value)); } }
			 * 
			 * }
			 * 
			 * 
			 * 
			 * Array.add(jo); jo = null; } jsonObject.put("AccountSegment", Array);
			 */

			logger.debug(Literal.LEAVING);
		} catch (Exception e) {
			logger.debug("Error parsing response in  " + key + " segment");
			throw e;

		}
		return secondaryApplicant;
	}

	private void getAccountSegmentExtFields(JSONObject tl, String formatteddate, String ownershipCode, String accType,
			String formattedAmount1, String amountOverDue, String creditLimit, String accountType)
			throws ParseException {

		if (accountType != null) {
			switch (accountType) {
			case "Credit Card":
				if (StringUtils.isNotEmpty(amountOverDue) && StringUtils.equalsIgnoreCase(accType, "10")) {
					tl.put("CIBIL_CCOA", amountOverDue);
				}
				getValidation(amountOverDue, accType, "10", null, null, ownershipCode, formatteddate, creditLimit, tl,
						false, "CIBIL_LCCO");
				break;
			case "Housing Loan":
				getValidation(amountOverDue, accType, "02", "03", null, ownershipCode, formatteddate, formattedAmount1,
						tl, true, "CIBIL_LNAMT");
				break;
			case "Loan to Professional":
				getValidation(amountOverDue, accType, "02", "03", null, ownershipCode, formatteddate, formattedAmount1,
						tl, true, "CIBIL_LNAMT");
				break;
			case "Two-Wheeler Loan":
				getValidation(amountOverDue, accType, "13", null, null, ownershipCode, formatteddate, formattedAmount1,
						tl, true, "CIBIL_WLLNAMNT");
				break;
			case "Auto Loan (Personal)":
				getValidation(amountOverDue, accType, "50", "51", "61", ownershipCode, formatteddate, formattedAmount1,
						tl, true, "CIBIL_ATLNAMNT");
				break;
			case "Business Loan":
				getValidation(amountOverDue, accType, "13", null, null, ownershipCode, formatteddate, formattedAmount1,
						tl, true, "CIBIL_BLLNAMNT");
				break;
			case "Personal Loan":
				getValidation(amountOverDue, accType, "05", null, null, ownershipCode, formatteddate, formattedAmount1,
						tl, true, "CIBIL_PLLNAMNT");
				break;
			case "Education Loan":
				getValidation(amountOverDue, accType, "08", null, null, ownershipCode, formatteddate, formattedAmount1,
						tl, true, "CIBIL_EDULNAMNT");
				break;

			default:
				break;
			}

		}

	}

	private void getValidation(String amountOverDue, String accType, String acctype1, String acctype2, String acctype3,
			String ownershipCode, String formatteddate, String formattedAmount1, JSONObject tl, boolean ownershipcode2,
			String extField) {
		if (StringUtils.isNotEmpty(amountOverDue)) {
			Date closedDate = null;
			if (StringUtils.equalsIgnoreCase(accType, acctype1) || StringUtils.equalsIgnoreCase(accType, acctype2)
					|| StringUtils.equalsIgnoreCase(accType, acctype3)) {
				if (ownershipcode2 && ownershipCode != "3") {
					Date date = new Date();

					try {
						closedDate = new SimpleDateFormat("dd/MM/yyyy").parse(formatteddate);
					} catch (ParseException e) {
						e.printStackTrace();
					}
					if (date.after(closedDate)) {
						tl.put(extField, formattedAmount1);
					}
				} else {
					Date date = new Date();

					try {
						closedDate = new SimpleDateFormat("dd/MM/yyyy").parse(formatteddate);
					} catch (ParseException e) {
						e.printStackTrace();
					}
					if (date.after(closedDate)) {
						tl.put(extField, formattedAmount1);
					}
				}
			} else {
				tl.put(extField, "0");
			}
		}
	}

	private String getFormattedDate(String date) {
		try {
			SimpleDateFormat df = new SimpleDateFormat(InterfaceConstants.cibildateFormat);
			java.util.Date uDate = null;
			uDate = df.parse(date);
			return (DateUtil.format(uDate, InterfaceConstants.dateFormat));
		} catch (ParseException e) {
			logger.debug("ParseException...." + e.getMessage());
		}
		return null;
	}

	public static String formatAmount(BigDecimal value, int decPos, boolean debitCreditSymbol) {

		if (value != null && value.compareTo(BigDecimal.ZERO) != 0) {
			DecimalFormat df = new DecimalFormat();

			String format = "";

			if (InterfaceConstants.INDIAN_IMPLEMENTATION) {
				format = "###,###,###,###";// Can be modified for Local Currency
											// format indication
			} else {
				format = "###,###,###,###";
			}

			StringBuffer sb = new StringBuffer(format);
			boolean negSign = false;

			if (decPos > 0) {
				// sb.append('.');
				for (int i = 0; i < decPos; i++) {
					// sb.append('0');
				}

				if (value.compareTo(BigDecimal.ZERO) == -1) {
					negSign = true;
					value = value.multiply(new BigDecimal("-1"));
				}

				if (negSign) {
					value = value.multiply(new BigDecimal("-1"));
				}
			}

			if (debitCreditSymbol) {
				String s = sb.toString();
				sb.append(" 'Cr';").append(s).append(" 'Dr'");
			}

			df.applyPattern(sb.toString());
			return df.format(value);
		} else {
			String string = "0.";
			for (int i = 0; i < decPos; i++) {
				string = string.concat("0");
			}
			return string;
		}
	}

	/**
	 * Method for prepare the Extended Field details map according to the given response.
	 * 
	 * @param extendedResMapObject
	 * @param financeDetail
	 */
	public void prepareResponseObj(Map<String, Object> validatedMap, CustomerDetails customerDetails) {
		logger.debug(Literal.ENTERING);
		if (validatedMap != null) {
			Map<String, Object> extendedMapObject = null;
			extendedMapObject = getExtendedMapValues(customerDetails);
			if (customerDetails.getExtendedFieldRender() != null) {
				extendedMapObject = customerDetails.getExtendedFieldRender().getMapValues();
			}
			if (extendedMapObject == null) {
				extendedMapObject = new HashMap<String, Object>();
			}
			for (Entry<String, Object> entry : validatedMap.entrySet()) {
				extendedMapObject.put(entry.getKey(), entry.getValue());
			}

			if (customerDetails.getExtendedFieldRender() == null) {
				customerDetails.setExtendedFieldRender(new ExtendedFieldRender());
			}

			try {
				customerDetails.getExtendedFieldRender().setMapValues(extendedMapObject);

			} catch (Exception e) {
				e.printStackTrace();
			}

		}
		logger.debug(Literal.LEAVING);
	}

	protected Map<String, Object> getExtendedMapValues(Object object) {
		Map<String, Object> extendedMapObject = null;
		if (object instanceof FinanceDetail) {
			FinanceDetail financeDetail = (FinanceDetail) object;
			if (financeDetail.getExtendedFieldRender() != null) {
				extendedMapObject = financeDetail.getExtendedFieldRender().getMapValues();
			}
		} else if (object instanceof CustomerDetails) {
			CustomerDetails customerDetails = (CustomerDetails) object;
			extendedMapObject = customerDetails.getExtendedFieldRender().getMapValues();
		} else {
			extendedMapObject = null;
		}
		return extendedMapObject;
	}

	private void prepareResponseObjforCoapp(Map<String, Object> validatedMap, CustomerDetails customerDetail,
			FinanceDetail financeDetail) {
		logger.debug(Literal.ENTERING);
		if (validatedMap != null) {
			Map<String, Object> extendedMapObject = customerDetail.getExtendedFieldRender().getMapValues();
			if (extendedMapObject == null) {
				extendedMapObject = new HashMap<String, Object>();
			}
			for (Entry<String, Object> entry : validatedMap.entrySet()) {
				extendedMapObject.put(entry.getKey(), entry.getValue());
			}
			customerDetail.getExtendedFieldRender().setMapValues(extendedMapObject);
		}

		List<JointAccountDetail> coApplist = financeDetail.getJountAccountDetailList();
		for (JointAccountDetail jointAccountDetail : coApplist) {
			if (jointAccountDetail.getCustID() == customerDetail.getCustomer().getCustID()) {
				jointAccountDetail.setCustomerDetails(customerDetail);
				break;
			}
		}

		logger.debug(Literal.LEAVING);

	}

	/**
	 * Method for validate the jsonResponseMap based on the configuration.
	 * 
	 * @param extendedFieldMap
	 * @return validatedMap
	 */
	public Map<String, Object> validateExtendedMapValues(Map<String, Object> extendedFieldMap) {
		logger.debug(Literal.ENTERING);

		Map<String, Object> validatedMap = new HashMap<>(1);
		Set<String> fieldNames = extendedFieldMap.keySet();
		List<ExtendedFieldDetail> configurationList = null;
		if (fieldNames == null || (fieldNames != null && fieldNames.isEmpty())) {
			logger.info("Response Elements Not Configured.");
		} else {

			configurationList = creditInterfaceDao.getExtendedFieldDetailsByFieldName(fieldNames);
			for (String field : fieldNames) {
				try {
					String key = field;
					Object fieldValue = extendedFieldMap.get(field);
					ExtendedFieldDetail configuration = null;
					if (configurationList == null || configurationList.isEmpty()) {
						return validatedMap;
					}
					for (ExtendedFieldDetail extdetail : configurationList) {
						if (StringUtils.equals(key, extdetail.getFieldName())) {
							configuration = extdetail;
							break;
						}
					}
					if (configuration == null) {
						continue;
					}

					String jsonRespValue = Objects.toString(fieldValue, null);
					if (jsonRespValue == null) {
						continue;
					}

					switch (configuration.getFieldType()) {
					case InterfaceConstants.FIELDTYPE_TEXT:
					case InterfaceConstants.FIELDTYPE_MULTILINETEXT:
					case InterfaceConstants.FIELDTYPE_LISTFIELD:
						if (jsonRespValue.length() > configuration.getFieldLength()) {
							validatedMap.put(key, jsonRespValue.substring(0, configuration.getFieldLength()));
						} else {
							validatedMap.put(key, jsonRespValue);

						}
						break;
					case InterfaceConstants.FIELDTYPE_UPPERTEXT:
						if (jsonRespValue.length() > configuration.getFieldLength()) {
							String value = jsonRespValue.substring(0, configuration.getFieldLength());
							validatedMap.put(key, value.toUpperCase());
						} else {
							validatedMap.put(key, jsonRespValue.toUpperCase());
						}
						break;

					case InterfaceConstants.FIELDTYPE_ADDRESS:
						if (jsonRespValue.length() > 100) {
							validatedMap.put(key, jsonRespValue.substring(0, 100));
						} else {
							validatedMap.put(key, jsonRespValue);
						}
						break;

					case InterfaceConstants.FIELDTYPE_DATE:
						Date dateValue = null;
						try {
							if (StringUtils.isNotBlank(jsonRespValue)) {
								dateValue = DateUtil.parse(jsonRespValue, InterfaceConstants.dateFormat);
							}
						} catch (Exception e) {
							logger.error("Exception : ", e);
						}
						validatedMap.put(key, dateValue);
						break;

					case InterfaceConstants.FIELDTYPE_TIME:
						String time = null;
						try {
							if (StringUtils.isNotBlank(jsonRespValue) && jsonRespValue.length() == 6) {
								time = jsonRespValue.substring(0, 2) + ":" + jsonRespValue.substring(2, 4) + ":"
										+ jsonRespValue.substring(4, 6);
								dateValue = DateUtil.parse(time, InterfaceConstants.DBTimeFormat);
							}
						} catch (Exception e) {
							logger.error("Exception : ", e);
						}
						// validatedMap.put(key, time);
						break;

					case InterfaceConstants.FIELDTYPE_DATETIME:
						Date dateTimeVal = null;
						try {
							DateFormat formatter = new SimpleDateFormat(InterfaceConstants.InterfaceDateFormatter);
							dateTimeVal = formatter.parse(jsonRespValue);
						} catch (Exception e) {
							logger.error("Exception : ", e);
						}
						validatedMap.put(key, dateTimeVal);
						break;

					case InterfaceConstants.FIELDTYPE_BOOLEAN:
						Boolean booleanValue = false;
						if (StringUtils.equals(jsonRespValue, "true") || StringUtils.equals(jsonRespValue, "false")) {
							booleanValue = jsonRespValue.equals("true") ? true : false;
						} else if (StringUtils.equals(jsonRespValue, "1") || StringUtils.equals(jsonRespValue, "0")) {
							booleanValue = jsonRespValue.equals("1") ? true : false;
						} else {
							logger.error(InterfaceConstants.wrongValueMSG + configuration.getFieldLabel());
						}
						validatedMap.put(key, booleanValue);
						break;

					case InterfaceConstants.FIELDTYPE_AMOUNT:
						BigDecimal decimalValue = BigDecimal.ZERO;
						try {
							double rateValue = Double.parseDouble(jsonRespValue);
							decimalValue = BigDecimal.valueOf(rateValue);
						} catch (Exception e) {
							logger.error("Exception : ", e);
						}
						if (jsonRespValue.length() > configuration.getFieldLength() + 2) {
							logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
						}
						decimalValue = decimalValue.setScale(configuration.getFieldPrec(), RoundingMode.HALF_DOWN);
						validatedMap.put(key, decimalValue);
						break;

					case InterfaceConstants.FIELDTYPE_INT:
						int intValue = 0;
						if (jsonRespValue.length() > configuration.getFieldLength()) {
							logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
						}
						try {
							if (!StringUtils.isEmpty(jsonRespValue)) {
								intValue = Integer.parseInt(jsonRespValue);
							}
						} catch (Exception e) {
							logger.error("Exception : ", e);
						}
						if (configuration.getFieldMaxValue() > 0 || configuration.getFieldMinValue() > 0) {
							if (!(intValue >= configuration.getFieldMinValue()
									&& intValue <= configuration.getFieldMaxValue())) {
								logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
							}
						}
						validatedMap.put(key, intValue);
						break;

					case InterfaceConstants.FIELDTYPE_LONG:
						long longValue = 0;
						if (jsonRespValue.length() > configuration.getFieldLength()) {
							logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
						}
						try {
							longValue = Long.parseLong(jsonRespValue);
						} catch (Exception e) {
							logger.error("Exception : ", e);
						}
						if (configuration.getFieldMaxValue() > 0 || configuration.getFieldMinValue() > 0) {
							if (!(longValue >= configuration.getFieldMinValue()
									&& longValue <= configuration.getFieldMaxValue())) {
								logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
							}
						}
						validatedMap.put(key, longValue);
						break;

					case InterfaceConstants.FIELDTYPE_RADIO:
						int radioValue = 0;
						if (StringUtils.equals(InterfaceConstants.FIELDTYPE_RADIO, configuration.getFieldType())) {
							try {
								radioValue = Integer.parseInt(jsonRespValue);
							} catch (Exception e) {
								logger.error("Exception : ", e);
							}
							if (radioValue > configuration.getFieldLength()) {
								logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
							} else {
								validatedMap.put(key, radioValue);
							}
						}
						break;

					case InterfaceConstants.FIELDTYPE_STATICCOMBO:
						String[] values = new String[0];
						String staticList = configuration.getFieldList();
						if (staticList != null) {
							if (staticList.contains(InterfaceConstants.DELIMITER_COMMA)) {
								values = staticList.split(InterfaceConstants.DELIMITER_COMMA);
								for (String vale : values) {
									if (vale.equals(jsonRespValue)) {
										validatedMap.put(key, jsonRespValue);
										break;
									}
								}
							} else if (staticList.equals(jsonRespValue)) {
								validatedMap.put(key, jsonRespValue);
								break;
							} else {
								logger.error(InterfaceConstants.wrongValueMSG + configuration.getFieldLabel());
							}
						} else {
							logger.error(InterfaceConstants.wrongValueMSG + configuration.getFieldLabel());
						}
						break;

					case InterfaceConstants.FIELDTYPE_PHONE:
						if (jsonRespValue.length() > 10) {
							validatedMap.put(key, jsonRespValue.substring(0, 10));
							break;
						} else {
							validatedMap.put(key, jsonRespValue);
						}
						break;
					case InterfaceConstants.FIELDTYPE_DECIMAL:
					case InterfaceConstants.FIELDTYPE_ACTRATE:
						Double decValue = getDecimalValue(configuration, jsonRespValue);
						validatedMap.put(key, decValue);
						break;

					case InterfaceConstants.FIELDTYPE_PERCENTAGE:
						double percentage = 0;
						if (jsonRespValue.length() > (configuration.getFieldLength() - configuration.getFieldPrec())) {
							logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
						}
						try {
							percentage = Double.valueOf(jsonRespValue);
						} catch (Exception e) {
							logger.error("Exception : ", e);
						}
						if (percentage < 0 || percentage > 100) {
							logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
						}
						if (configuration.getFieldMaxValue() > 0 || configuration.getFieldMinValue() > 0) {
							if (percentage > configuration.getFieldMaxValue()
									|| percentage < configuration.getFieldMinValue()) {
								logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
							}
						}
						validatedMap.put(key, percentage);
						break;

					case InterfaceConstants.FIELDTYPE_MULTISTATICCOMBO:
						String[] values1 = new String[0];
						String[] fieldvalues = new String[0];
						String multiStaticList = configuration.getFieldList();
						if (multiStaticList != null && multiStaticList.contains(InterfaceConstants.DELIMITER_COMMA)) {
							values1 = multiStaticList.split(InterfaceConstants.DELIMITER_COMMA);
						}
						if (fieldValue != null && jsonRespValue.contains(InterfaceConstants.DELIMITER_COMMA)) {
							fieldvalues = jsonRespValue.split(InterfaceConstants.DELIMITER_COMMA);
						}
						if (values1.length > 0) {
							for (int i = 0; i <= fieldvalues.length - 1; i++) {
								boolean isValid1 = false;
								for (int j = 0; j <= values1.length - 1; j++) {
									if (StringUtils.equals(fieldvalues[i], values1[j])) {
										isValid1 = true;
									}
								}
								if (!isValid1) {
									logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());

								} else {
									validatedMap.put(key, jsonRespValue);
								}
							}
						}
						break;

					case InterfaceConstants.FIELDTYPE_FRQ:
						if (jsonRespValue.length() <= InterfaceConstants.LENGTH_FREQUENCY) {
							validatedMap.put(key, jsonRespValue);
						} else {
							logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
						}

						break;

					case InterfaceConstants.FIELDTYPE_ACCOUNT:
						if (jsonRespValue.length() <= InterfaceConstants.LENGTH_ACCOUNT) {
							validatedMap.put(key, jsonRespValue);
						} else {
							logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
						}
						break;

					case InterfaceConstants.FIELDTYPE_MULTIEXTENDEDCOMBO:
					case InterfaceConstants.FIELDTYPE_EXTENDEDCOMBO:
					case InterfaceConstants.FIELDTYPE_BASERATE:
						validatedMap.put(key, jsonRespValue);
						break;
					default:
						break;
					}

				} catch (Exception e) {
					logger.error("Exception", e);
				}
			}
		}
		logger.debug(Literal.LEAVING);
		return validatedMap;
	}

	/**
	 * Method for validate the response value and return decimal value.
	 * 
	 * @param configuration
	 * @param jsonRespValue
	 * @return
	 */
	private double getDecimalValue(ExtendedFieldDetail configuration, String jsonRespValue) {
		logger.debug(Literal.ENTERING);

		double decValue = 0;
		String beforePrcsnValue = null;
		String aftrPrcsnValue = null;

		if (jsonRespValue.contains(".")) {
			beforePrcsnValue = jsonRespValue.substring(0, jsonRespValue.indexOf("."));
			aftrPrcsnValue = jsonRespValue.substring(jsonRespValue.indexOf(".") + 1, jsonRespValue.length());
		} else {
			beforePrcsnValue = jsonRespValue;
		}

		if (beforePrcsnValue.length() > configuration.getFieldLength()) {
			logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
		}

		if (aftrPrcsnValue != null && aftrPrcsnValue.length() > configuration.getFieldPrec()) {
			logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
		}
		try {
			decValue = Double.parseDouble(jsonRespValue);
		} catch (Exception e) {
			logger.error("Exception : ", e);
		}

		if (configuration.getFieldMaxValue() > 0 || configuration.getFieldMinValue() > 0) {
			if (Math.round(decValue) > configuration.getFieldMaxValue()
					|| Math.round(decValue) < configuration.getFieldMinValue()) {
				logger.error(InterfaceConstants.wrongLengthMSG + configuration.getFieldLabel());
			}
		}
		BigDecimal amount = new BigDecimal(decValue);
		amount = amount.setScale(configuration.getFieldPrec(), RoundingMode.HALF_DOWN);

		logger.debug(Literal.LEAVING);
		return amount.doubleValue();
	}

	protected void logInterfaceDetails(InterfaceLogDetail interfaceLogDetail) {
		try {
			interfaceLoggingDAO.save(interfaceLogDetail);
		} catch (Exception e) {
			logger.error("Exception", e);
		}
	}

	/*
	 * private void prepareAccountNumSegment(StringBuilder builder, FinanceDetail finDetail) { FinanceMain financeMain =
	 * finDetail.getFinScheduleData().getFinanceMain(); writeValue(builder, "06", financeMain.getFinReference(), "02");
	 * }
	 */

	private void jsonResopnseHeader(String responseHeader) {
		logger.debug(Literal.ENTERING);
		String[] values = StaticListUtil.getHeaderIndexes();
		JSONObject cibilHeader = new JSONObject();

		for (int i = 0; i < values.length; i++) {
			String index = values[i];
			String[] value = index.split(",");
			cibilHeader.put(StaticListUtil.getResponseHeaders().get(i),
					responseHeader.substring(Integer.parseInt(value[0]), Integer.parseInt(value[1])));
			/*
			 * jsonObject.put(StaticListUtil.getResponseHeaders().get(i),
			 * responseHeader.substring(Integer.parseInt(value[0]), Integer.parseInt(value[1])));
			 */
		}

		String date = cibilHeader.get("DateProcessed").toString();
		String foramtteddate = getFormattedDate(date);
		cibilHeader.put("DateProcessed", foramtteddate);

		String time = cibilHeader.get("TimeProcessed").toString();
		String formattedTime = time.substring(0, 2) + ":" + time.substring(2, 4) + ":" + time.substring(4, 6);
		cibilHeader.put("TimeProcessed", formattedTime);
		jsonObject.put("cibilHeader", cibilHeader);
		System.out.println(jsonObject.toString());
		logger.debug("Parsed header respone :" + cibilHeader.toString());
		logger.debug(Literal.LEAVING);

	}

	private void parseErrorHeder(String errorHeader) {
		logger.debug(Literal.ENTERING);
		String[] values = StaticListUtil.getErrorHeaderIndexes();

		for (int i = 0; i < values.length; i++) {
			String index = values[i];
			String[] value = index.split(",");
			jsonObject.put(StaticListUtil.getErrorResponseHeader().get(i),
					errorHeader.substring(Integer.parseInt(value[0]), Integer.parseInt(value[1])));
		}
		logger.debug("Parsed Error header respone " + jsonObject.toString());

		logger.debug(Literal.LEAVING);
	}

	protected int getCibilIntiDays(String dateProcessed) {
		logger.debug("getCibilIntiDays :" + Literal.ENTERING);
		int diffDays = -1;
		SimpleDateFormat dateFormat = new SimpleDateFormat(InterfaceConstants.dateFormat);
		try {
			String strDate = dateFormat.format(new Date());
			Date currentDate = dateFormat.parse(strDate);
			Date dateProcess = dateFormat.parse(dateProcessed);
			//Comparing dates
			long difference = Math.abs(currentDate.getTime() - dateProcess.getTime());
			diffDays = (int) difference / (24 * 60 * 60 * 1000);
		} catch (Exception e) {
			logger.error(e.getMessage(), e);
			diffDays = -1;
		}
		logger.debug("getCibilIntiDays :" + Literal.LEAVING);
		return diffDays;
	}

	//checking in which segment getting error
	private String getCibilSegment(String resSegment) {
		logger.debug("getCibilSegment :" + Literal.ENTERING);
		String value = "";
		Map<String, String> segments = StaticListUtil.getSegment();
		for (String key : segments.keySet()) {
			if (resSegment.contains(key)) {
				if (value != "")
					value += " or ";

				value += segments.get(key);
			}
		}
		logger.debug("getCibilSegment :" + Literal.LEAVING);
		return value;
	}
}
