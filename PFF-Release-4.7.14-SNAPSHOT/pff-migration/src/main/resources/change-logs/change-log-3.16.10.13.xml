<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<property name="add.schema" value="dbo." dbms="mssql" />
	<property name="add.schema" value=" " dbms="oracle" />
	<property name="call.substr" value="substring" dbms="mssql" />
	<property name="call.substr" value="substr" dbms="oracle" />
	<property name="call.substr" value="substring" dbms="postgresql" />
	<property name="call.auditdb" value="PFFBFSQCAudit.." dbms="mssql" />
	<property name="call.auditdb" value=" " dbms="oracle" />
	<property name="call.concatenate" value="+" dbms="mssql" />
	<property name="call.concatenate" value="||" dbms="oracle" />
	<property name="call.concatenate" value="||" dbms="postgresql" />
	<property name="call.collength" value="LEN" dbms="mssql" />
	<property name="call.collength" value="LENGTH" dbms="oracle" />
	<property name="call.collength" value="LENGTH" dbms="postgresql" />
	<property name="call.date" value="getdate()" dbms="mssql" />
	<property name="call.date" value="sysdate" dbms="oracle" />
	<property name="call.date" value="now()::timestamp" dbms="postgresql" />
	
	<changeSet id="1" author="madhubabu.p">
		<createView viewName="FINRECEIPTHEADER_FEVIEW" replaceIfExists="true">
			 SELECT     T1.ReceiptID, T1.ReceiptDate, T1.ReceiptType,T1.RecAgainst,T1.Reference, T1.ReceiptPurpose, 
				 T1.ReceiptMode, T1.ExcessAdjustTo,T1.AllocationType,T1.ReceiptAmount,T1.EffectSchdMethod, 
				 T1.ReceiptModeStatus, T1.Version, T1.LastMntBy, T1.LastMntOn,T1.RecordStatus,T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,
				 T2.FinType,  T2.FinBranch, T3.CustCIF , 	T3.CustShrtName, T2.FinCcy, T1.RealizationDate,
				 T1.CancelReason, T4.FinTypeDesc,  T6.BranchDesc FinBranchDesc, T5.CcyDesc FinCcyDesc, T7.RejectDesc CancelReasonDesc, T2.FinIsActive, 
				 T2.ScheduleMethod, T2.ProfitDaysBasis PftDaysBasis, T1.WaviedAmt, T3.CustID, T1.TotFeeAmount, T1.BounceDate , T1.Remarks , T1.RcdMaintainSts
							FROM         FinReceiptHeader_Temp T1 INNER JOIN
				       FinanceMain_Temp T2 ON T1.Reference = T2.FinReference INNER JOIN
				       Customers T3 ON T2.CustId = T3.CustId INNER JOIN
				       RMTFinanceTypes T4 ON T2.FinType = T4.FinType INNER JOIN
				       RMTCurrencies T5 ON T2.FinCcy = T5.CcyCode INNER JOIN
				       RMTBranches T6 ON T2.FinBranch = T6.BranchCode LEFT JOIN
				       BMTRejectCodes T7 ON T1.CancelReason = T7.RejectCode
			UNION ALL
      SELECT     T1.ReceiptID, T1.ReceiptDate, T1.ReceiptType,T1.RecAgainst,T1.Reference, T1.ReceiptPurpose, 
                 T1.ReceiptMode, T1.ExcessAdjustTo,T1.AllocationType,T1.ReceiptAmount,T1.EffectSchdMethod, 
                 T1.ReceiptModeStatus, T1.Version, T1.LastMntBy, T1.LastMntOn,T1.RecordStatus,T1.RoleCode, T1.NextRoleCode, T1.TaskId, T1.NextTaskId, T1.RecordType, T1.WorkflowId,
                 T2.FinType,  T2.FinBranch, T3.CustCIF , 	T3.CustShrtName, T2.FinCcy, T1.RealizationDate,
                 T1.CancelReason, T4.FinTypeDesc,  T6.BranchDesc FinBranchDesc, T5.CcyDesc FinCcyDesc, T7.RejectDesc CancelReasonDesc, T2.FinIsActive, 
                 T2.ScheduleMethod, T2.ProfitDaysBasis PftDaysBasis, T1.WaviedAmt, T3.CustID, T1.TotFeeAmount, T1.BounceDate , T1.Remarks , T1.RcdMaintainSts
				FROM   FinReceiptHeader T1 INNER JOIN
				       (Select FinReference,FinBranch,FinType,FinCcy,ScheduleMethod,ProfitDaysBasis,FinIsActive,custid  from FinanceMain_Temp union 
                Select FinReference,FinBranch,FinType,FinCcy,ScheduleMethod,ProfitDaysBasis,FinIsActive,custid from FinanceMain )T2 ON T1.Reference = T2.FinReference INNER JOIN
				       Customers T3 ON T2.CustId = T3.CustId INNER JOIN
				       RMTFinanceTypes T4 ON T2.FinType = T4.FinType INNER JOIN
				       RMTCurrencies T5 ON T2.FinCcy = T5.CcyCode INNER JOIN
				       RMTBranches T6 ON T2.FinBranch = T6.BranchCode LEFT JOIN
				       BMTRejectCodes T7 ON T1.CancelReason = T7.RejectCode				   
               	WHERE     NOT EXISTS
				                          (SELECT     1
				                            FROM          FinReceiptHeader_TEMP 
				                            WHERE      ReceiptID = T1.ReceiptID)
		</createView>
	</changeSet>
	<changeSet id="2" author="Chaitanya">	
		<sql>
			<![CDATA[
				Delete from ErrorDetails where ErrorCode = '60408';	
				Insert into ErrorDetails Values ('60408', 'EN', 'E','Loan Cannot be cancelled since there are disbursement instructions with status Awaiting Confirmation',null, 'Approved', null, null, null, null, null, 0, null, 1000, 0);
			]]>
		</sql>
	</changeSet>
	<changeSet id="3" author="Jayant" dbms="oracle">
	    <sql splitStatements="false">
	        begin
	        	SP_INVALIDVIEWS;
	        	RESEED_SEQUENCE_TABLES;
	        end;
	    </sql>
	</changeSet>
</databaseChangeLog>